import{diffLines as e}from'https://testingcf.jsdelivr.net/npm/diff/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var t={480(e,n,t){t.r(n),t.d(n,{default:()=>l});var a=t(781),r=t.n(a),o=t(11),i=t.n(o)()(r());i.push([e.id,'.wb-assistant-root[data-v-ff2a69a2]{flex:1;min-height:0;width:100%;box-sizing:border-box;display:flex;flex-direction:column;padding:10px;gap:10px;background:var(--wb-bg-root);color:var(--wb-text-main);font-size:13px;line-height:1.35;border-radius:10px;overflow:hidden}.wb-scroll-area[data-v-ff2a69a2]{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:10px}.wb-settings-wrapper[data-v-ff2a69a2]{width:100%}.wb-header[data-v-ff2a69a2]{display:flex;justify-content:space-between;align-items:center;border-radius:12px;padding:12px 16px;background:var(--wb-bg-panel);margin-bottom:8px}.wb-title[data-v-ff2a69a2]{display:flex;flex-direction:column;gap:2px}.wb-title strong[data-v-ff2a69a2]{font-size:16px}.wb-title span[data-v-ff2a69a2]{color:var(--wb-text-muted)}.wb-header-actions[data-v-ff2a69a2],.list-actions[data-v-ff2a69a2],.tool-line[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.wb-toolbar[data-v-ff2a69a2]{display:flex;gap:8px;flex-wrap:wrap;align-items:center;border-radius:12px;padding:10px 12px;background:var(--wb-bg-panel)}.toolbar-label[data-v-ff2a69a2]{display:inline-flex;align-items:center;gap:6px;color:var(--wb-text-muted);min-width:320px;flex:1 1 520px}.toolbar-select[data-v-ff2a69a2]{min-width:200px}.toolbar-select.small[data-v-ff2a69a2]{min-width:160px}.worldbook-picker[data-v-ff2a69a2]{position:relative;flex:1 1 auto;min-width:240px}.worldbook-picker-trigger[data-v-ff2a69a2]{width:100%;box-sizing:border-box;border:1px solid transparent;border-radius:8px;padding:8px 10px;background:var(--wb-input-bg);color:var(--wb-text-main);display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}.worldbook-picker-trigger[data-v-ff2a69a2]:hover{border-color:var(--wb-primary-light)}.worldbook-picker-trigger-text[data-v-ff2a69a2]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}.worldbook-picker-trigger-arrow[data-v-ff2a69a2]{flex-shrink:0;color:var(--wb-text-muted)}.worldbook-picker-dropdown[data-v-ff2a69a2]{position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:10120;border:1px solid var(--wb-border-subtle);border-radius:8px;background:var(--wb-input-bg-focus);box-shadow:var(--wb-shadow-main);padding:8px;display:grid;gap:8px}.worldbook-picker-search[data-v-ff2a69a2]{width:100%}.worldbook-picker-list[data-v-ff2a69a2]{max-height:260px;overflow:auto;border:none;border-radius:8px;background:var(--wb-bg-panel);display:flex;flex-direction:column}.worldbook-picker-item[data-v-ff2a69a2]{width:100%;border:none;border-bottom:1px solid var(--wb-border-subtle);background:transparent;color:var(--wb-text-main);padding:8px 10px;text-align:left;cursor:pointer}.worldbook-picker-item[data-v-ff2a69a2]:last-child{border-bottom:none}.worldbook-picker-item[data-v-ff2a69a2]:hover{background:var(--wb-primary-soft)}.worldbook-picker-item.active[data-v-ff2a69a2]{background:var(--wb-primary-soft);color:var(--wb-primary-light)}.wb-bindings[data-v-ff2a69a2]{border-radius:12px;padding:12px;display:grid;gap:8px;background:var(--wb-bg-panel)}.wb-history-shortcuts[data-v-ff2a69a2]{display:flex;justify-content:flex-start;gap:8px;flex-wrap:wrap;align-items:center}.global-mode-panel[data-v-ff2a69a2]{border-radius:12px;background:var(--wb-bg-panel);padding:12px;display:grid;gap:12px}.global-mode-head[data-v-ff2a69a2]{display:flex;justify-content:space-between;align-items:center;gap:8px}.global-mode-title[data-v-ff2a69a2]{color:var(--wb-primary-light);font-weight:700;letter-spacing:0.02em}.global-preset-panel[data-v-ff2a69a2]{border-radius:8px;background:var(--wb-bg-panel);padding:10px;display:grid;gap:8px}.preset-role-panel[data-v-ff2a69a2]{border-radius:8px;background:var(--wb-bg-panel);padding:10px;display:grid;gap:6px}.preset-role-head[data-v-ff2a69a2]{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}.preset-role-current[data-v-ff2a69a2]{color:var(--wb-primary);font-size:12px}.preset-role-current.empty[data-v-ff2a69a2]{color:var(--wb-text-muted)}.preset-role-actions[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.role-picker[data-v-ff2a69a2]{position:relative}.role-picker-trigger[data-v-ff2a69a2]{width:100%;box-sizing:border-box;border:1px solid transparent;border-radius:8px;padding:8px 10px;background:var(--wb-input-bg);color:var(--wb-text-main);display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}.role-picker-trigger[data-v-ff2a69a2]:disabled{opacity:0.55;cursor:default}.role-picker-trigger[data-v-ff2a69a2]:hover:not(:disabled){border-color:var(--wb-primary-light)}.role-picker-trigger-text[data-v-ff2a69a2]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}.role-picker-trigger-arrow[data-v-ff2a69a2]{flex-shrink:0;color:var(--wb-text-muted)}.role-picker-dropdown[data-v-ff2a69a2]{position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:10130;border:1px solid var(--wb-border-subtle);border-radius:8px;background:var(--wb-input-bg-focus);box-shadow:var(--wb-shadow-main);padding:8px;display:grid;gap:8px}.role-picker-search[data-v-ff2a69a2]{width:100%}.role-picker-list[data-v-ff2a69a2]{border:none;border-radius:8px;background:var(--wb-bg-panel);max-height:220px;overflow:auto;display:flex;flex-direction:column}.role-picker-item[data-v-ff2a69a2]{width:100%;border:none;border-bottom:1px solid var(--wb-border-subtle);background:transparent;color:var(--wb-text-main);padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px;text-align:left;cursor:pointer}.role-picker-item[data-v-ff2a69a2]:last-child{border-bottom:none}.role-picker-item[data-v-ff2a69a2]:hover:not(:disabled){background:var(--wb-primary-soft)}.role-picker-item[data-v-ff2a69a2]:disabled{opacity:0.55;cursor:default}.role-picker-item .name[data-v-ff2a69a2]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.role-picker-item .meta[data-v-ff2a69a2]{color:var(--wb-primary-light);flex-shrink:0;font-size:11px}.preset-role-tags[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.preset-role-tag[data-v-ff2a69a2]{border:1px solid var(--wb-border-subtle);border-radius:999px;background:var(--wb-bg-panel);color:var(--wb-text-main);padding:2px 10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}.preset-role-tag[data-v-ff2a69a2]:hover{border-color:#f43f5e}.preset-role-tag .remove[data-v-ff2a69a2]{color:#fca5a5}.global-mode-grid[data-v-ff2a69a2]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.global-mode-column[data-v-ff2a69a2]{border-radius:8px;padding:10px;background:var(--wb-bg-panel);display:grid;gap:6px;min-height:168px}.global-mode-list[data-v-ff2a69a2]{border-radius:8px;background:var(--wb-input-bg);max-height:176px;min-height:88px;overflow:auto;display:flex;flex-direction:column}.global-mode-item[data-v-ff2a69a2]{width:100%;border:none;border-bottom:1px solid var(--wb-border-subtle);background:transparent;color:var(--wb-text-main);padding:7px 8px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;text-align:left}.global-mode-item[data-v-ff2a69a2]:last-child{border-bottom:none}.global-mode-item[data-v-ff2a69a2]:hover{background:var(--wb-primary-soft)}.global-mode-item.add .global-mode-item-action[data-v-ff2a69a2]{color:#86efac}.global-mode-item.active .global-mode-item-action[data-v-ff2a69a2]{color:#fca5a5}.global-mode-item-name[data-v-ff2a69a2]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.global-mode-item-action[data-v-ff2a69a2]{font-size:12px;flex-shrink:0}.global-mode-actions[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.history-btn[data-v-ff2a69a2]{border-color:var(--wb-primary);background:var(--wb-primary-soft)}.utility-btn[data-v-ff2a69a2]{border-color:var(--wb-primary-light);background:var(--wb-primary-soft)}.utility-btn.active[data-v-ff2a69a2]{border-color:var(--wb-primary-light);background:var(--wb-primary-soft);color:var(--wb-primary-light)}.wb-main-layout[data-v-ff2a69a2]{flex:1;min-height:60vh;display:grid;grid-template-columns:320px 10px minmax(0,1fr);gap:0}.wb-entry-list[data-v-ff2a69a2],.wb-editor[data-v-ff2a69a2]{border-radius:12px;padding:0;display:flex;flex-direction:column;gap:8px;background:transparent;min-height:0}.list-search[data-v-ff2a69a2]{display:grid;gap:6px;padding:0 8px}.list-summary[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:12px;padding:0 8px}.list-scroll[data-v-ff2a69a2]{flex:1 1 auto;min-height:210px;max-height:calc(70vh - 210px);overflow:auto;display:flex;flex-direction:column;gap:6px}.entry-item[data-v-ff2a69a2]{width:100%;text-align:left;border:none;background:transparent;color:var(--wb-text-main);border-radius:8px;padding:10px 12px 10px 14px;cursor:pointer;display:grid;gap:6px;position:relative;transition:background-color 0.15s ease;margin-bottom:4px}.entry-item[data-v-ff2a69a2]::before{content:\'\';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:8px 0 0 8px;background:linear-gradient(to bottom,#64748b,rgba(100,116,139,0.05))}.entry-item[data-status=\'constant\'][data-v-ff2a69a2]::before{background:linear-gradient(to bottom,#3b82f6,rgba(59,130,246,0))}.entry-item[data-status=\'vector\'][data-v-ff2a69a2]::before{background:linear-gradient(to bottom,#a855f7,rgba(168,85,247,0))}.entry-item[data-status=\'normal\'][data-v-ff2a69a2]::before{background:linear-gradient(to bottom,#22c55e,rgba(34,197,94,0))}.entry-item[data-status=\'disabled\'][data-v-ff2a69a2]::before{background:linear-gradient(to bottom,#6b7280,rgba(107,114,128,0))}.entry-item[data-v-ff2a69a2]:hover{background:var(--wb-primary-hover);transform:none}.entry-item.selected[data-v-ff2a69a2]{background:var(--wb-primary-soft);box-shadow:none}.entry-item.disabled[data-v-ff2a69a2]{opacity:0.74}.entry-item-head[data-v-ff2a69a2]{display:flex;align-items:center;gap:7px;min-width:0}.entry-status-dot[data-v-ff2a69a2]{width:9px;height:9px;border-radius:999px;background:#64748b;flex-shrink:0;box-shadow:0 0 0 2px var(--wb-bg-panel)}.entry-status-dot[data-status=\'constant\'][data-v-ff2a69a2]{background:#3b82f6}.entry-status-dot[data-status=\'vector\'][data-v-ff2a69a2]{background:#a855f7}.entry-status-dot[data-status=\'normal\'][data-v-ff2a69a2]{background:#22c55e}.entry-status-dot[data-status=\'disabled\'][data-v-ff2a69a2]{background:#6b7280}.entry-item-title[data-v-ff2a69a2]{font-weight:700;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.entry-item-tags[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.entry-chip[data-v-ff2a69a2]{display:inline-flex;align-items:center;gap:4px;border:none;border-radius:999px;padding:2px 8px;color:var(--wb-text-muted);font-size:11px;background:var(--wb-bg-panel)}.entry-chip.uid[data-v-ff2a69a2]{color:var(--wb-primary-light);font-size:10px;padding:1px 7px}.entry-chip.mono[data-v-ff2a69a2]{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\'Liberation Mono\',\'Courier New\',monospace;font-size:10px}.entry-chip.status[data-status=\'constant\'][data-v-ff2a69a2]{color:#93c5fd;background:rgba(59,130,246,0.16)}.entry-chip.status[data-status=\'vector\'][data-v-ff2a69a2]{color:#d8b4fe;background:rgba(168,85,247,0.16)}.entry-chip.status[data-status=\'normal\'][data-v-ff2a69a2]{color:#86efac;background:rgba(34,197,94,0.16)}.entry-chip.status[data-status=\'disabled\'][data-v-ff2a69a2]{color:#cbd5e1;background:rgba(100,116,139,0.15)}.entry-item-preview[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-left:16px;opacity:0.85}.entry-item-preview[data-v-ff2a69a2]::before{content:\'Keys: \';color:var(--wb-text-muted);margin-right:4px}.wb-editor[data-v-ff2a69a2]{max-height:70vh;overflow:hidden}.wb-editor-shell[data-v-ff2a69a2]{height:100%;min-height:0;display:grid;grid-template-columns:minmax(0,1fr) 10px 360px;gap:0}.wb-resize-handle[data-v-ff2a69a2]{position:relative;width:10px;cursor:col-resize;-webkit-user-select:none;user-select:none;touch-action:none}.wb-resize-handle[data-v-ff2a69a2]::before{content:\'\';position:absolute;left:4px;top:12px;bottom:12px;width:2px;border-radius:999px;background:var(--wb-primary-hover);transition:background-color 0.15s ease}.wb-resize-handle[data-v-ff2a69a2]:hover::before,.wb-resize-handle.dragging[data-v-ff2a69a2]::before{background:var(--wb-primary-light)}.editor-center[data-v-ff2a69a2]{border:none;border-radius:12px;background:var(--wb-bg-panel);padding:16px;display:flex;flex-direction:column;gap:10px;min-height:0;overflow:auto}.editor-head[data-v-ff2a69a2]{display:flex;justify-content:space-between;gap:10px;align-items:flex-end;border-bottom:1px solid var(--wb-border-subtle);padding-bottom:12px}.editor-comment[data-v-ff2a69a2]{flex:1}.editor-badges[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}.editor-badge[data-v-ff2a69a2]{font-size:10px;border:none;border-radius:999px;padding:2px 8px;color:var(--wb-text-muted);background:var(--wb-bg-panel);white-space:nowrap}.editor-badge.mono[data-v-ff2a69a2]{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\'Liberation Mono\',\'Courier New\',monospace}.editor-badge.on[data-v-ff2a69a2]{color:#86efac;background:rgba(34,197,94,0.12)}.editor-badge.off[data-v-ff2a69a2]{color:#cbd5e1;background:rgba(100,116,139,0.15)}.editor-badge.strategy[data-status=\'constant\'][data-v-ff2a69a2]{color:#93c5fd;background:rgba(59,130,246,0.12)}.editor-badge.strategy[data-status=\'vector\'][data-v-ff2a69a2]{color:#d8b4fe;background:rgba(168,85,247,0.12)}.editor-badge.strategy[data-status=\'normal\'][data-v-ff2a69a2]{color:#86efac;background:rgba(34,197,94,0.12)}.editor-badge.strategy[data-status=\'disabled\'][data-v-ff2a69a2]{color:#cbd5e1;background:rgba(100,116,139,0.12)}.editor-keyword-grid .text-area.compact[data-v-ff2a69a2]{min-height:36px;height:36px;line-height:1.35}.editor-content-block[data-v-ff2a69a2]{min-height:0;display:flex;flex-direction:column;gap:6px;flex:1}.editor-content-title[data-v-ff2a69a2]{font-size:12px;color:var(--wb-primary-light);letter-spacing:0.01em}.editor-content-area[data-v-ff2a69a2]{min-height:320px;flex:1;resize:none;line-height:1.5}.content-resize-handle[data-v-ff2a69a2]{display:none;align-items:center;justify-content:center;height:18px;cursor:ns-resize;background:var(--wb-bg-panel);border:1px solid var(--wb-border);border-top:none;border-radius:0 0 6px 6px;touch-action:none;-webkit-user-select:none;user-select:none}.content-resize-grip[data-v-ff2a69a2]{font-size:14px;color:var(--wb-text-dim);letter-spacing:2px;line-height:1}.editor-advanced[data-v-ff2a69a2]{border:none;border-radius:8px;padding:10px;background:var(--wb-input-bg)}.editor-advanced>summary[data-v-ff2a69a2]{cursor:pointer;font-size:12px;color:var(--wb-text-muted)}.editor-advanced[open]>summary[data-v-ff2a69a2]{margin-bottom:7px}.editor-side[data-v-ff2a69a2]{display:flex;flex-direction:column;gap:8px;min-height:0;overflow:auto}.editor-card[data-v-ff2a69a2]{border:none;border-radius:12px;padding:12px;background:var(--wb-bg-panel);display:grid;gap:7px}.editor-card h4[data-v-ff2a69a2]{margin:0;font-size:12px;color:var(--wb-primary)}.strategy-switch[data-v-ff2a69a2]{display:grid;gap:6px}.strategy-pill[data-v-ff2a69a2]{border:none;border-radius:6px;background:var(--wb-input-bg);color:var(--wb-text-muted);padding:6px 10px;font-size:12px;cursor:pointer;text-align:left;transition:background-color 0.15s ease}.strategy-pill[data-v-ff2a69a2]:hover{background:var(--wb-primary-hover)}.strategy-pill.active.constant[data-v-ff2a69a2]{background:rgba(59,130,246,0.16);color:#93c5fd}.strategy-pill.active.vector[data-v-ff2a69a2]{background:rgba(168,85,247,0.16);color:#d8b4fe}.strategy-pill.active.selective[data-v-ff2a69a2]{background:rgba(34,197,94,0.16);color:#86efac}.editor-grid[data-v-ff2a69a2]{display:grid;gap:8px}.editor-grid.two-cols[data-v-ff2a69a2]{grid-template-columns:1fr 1fr}.editor-grid.three-cols[data-v-ff2a69a2]{grid-template-columns:repeat(3,minmax(0,1fr))}.field[data-v-ff2a69a2]{display:flex;flex-direction:column;gap:4px}.field>span[data-v-ff2a69a2]{color:var(--wb-primary-light)}.field.disabled[data-v-ff2a69a2]{opacity:0.56}.field-end[data-v-ff2a69a2]{align-self:end}.field-actions[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.text-input[data-v-ff2a69a2],.text-area[data-v-ff2a69a2],.toolbar-select[data-v-ff2a69a2]{width:100%;box-sizing:border-box;border:1px solid transparent;border-radius:6px;padding:8px 10px;color:var(--wb-text-main);background:var(--wb-input-bg);transition:all 0.2s ease}.text-input[data-v-ff2a69a2]:hover,.text-area[data-v-ff2a69a2]:hover,.toolbar-select[data-v-ff2a69a2]:hover{background:var(--wb-input-bg-hover)}.text-input[data-v-ff2a69a2]:focus,.text-area[data-v-ff2a69a2]:focus,.toolbar-select[data-v-ff2a69a2]:focus{background:var(--wb-input-bg-focus);border-color:var(--wb-primary-glow);outline:none;box-shadow:0 0 0 3px var(--wb-primary-soft)}.text-area[data-v-ff2a69a2]{min-height:96px;resize:vertical}.text-area.compact[data-v-ff2a69a2]{min-height:84px}.text-area.large[data-v-ff2a69a2]{min-height:190px}.checkbox-inline[data-v-ff2a69a2]{display:inline-flex;align-items:center;gap:6px}.wb-tools-grid[data-v-ff2a69a2]{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))}.tool-card[data-v-ff2a69a2]{border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:170px;background:var(--wb-bg-panel)}.tool-card h4[data-v-ff2a69a2]{margin:0;font-size:13px;color:var(--wb-primary-light)}.tool-line.stacked[data-v-ff2a69a2]{display:grid;gap:6px}.find-flags[data-v-ff2a69a2]{display:flex;flex-wrap:wrap;gap:8px}.find-scope-line[data-v-ff2a69a2]{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.find-summary-text[data-v-ff2a69a2]{margin-left:auto;color:var(--wb-primary-light);font-size:12px}.find-active-hit[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);border-radius:7px;padding:6px 8px;display:grid;gap:2px;background:var(--wb-bg-panel)}.find-active-hit strong[data-v-ff2a69a2]{color:var(--wb-text-main);font-size:12px}.find-active-hit span[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.batch-exclude-note[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:11px}.batch-exclude-chips[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.exclude-chip[data-v-ff2a69a2]{border:1px solid var(--wb-border-subtle);border-radius:999px;padding:1px 8px;font-size:11px;color:var(--wb-text-main);background:var(--wb-bg-panel)}.tool-details[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);border-radius:8px;padding:6px;background:var(--wb-bg-panel)}.tool-details>summary[data-v-ff2a69a2]{cursor:pointer;color:var(--wb-text-main);font-size:12px}.tool-details[open]>summary[data-v-ff2a69a2]{margin-bottom:6px}.history-compare[data-v-ff2a69a2]{display:grid;gap:6px}.history-preview-grid[data-v-ff2a69a2]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}.history-preview-card[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);border-radius:8px;padding:6px;display:grid;gap:3px;background:var(--wb-bg-panel)}.history-preview-card strong[data-v-ff2a69a2]{color:var(--wb-primary-light);font-size:11px}.history-preview-card span[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:11px;line-height:1.35}.history-note[data-v-ff2a69a2]{border:1px dashed var(--wb-border-main);border-radius:8px;padding:6px;color:var(--wb-text-muted);font-size:11px;background:var(--wb-bg-panel)}.tool-scroll[data-v-ff2a69a2]{overflow:auto;display:flex;flex-direction:column;gap:6px}.tool-list-item[data-v-ff2a69a2]{border-radius:8px;padding:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;background:var(--wb-input-bg)}.item-main[data-v-ff2a69a2]{display:flex;flex-direction:column;gap:2px;min-width:0}.item-main strong[data-v-ff2a69a2],.activation-main strong[data-v-ff2a69a2]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.item-main span[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:12px}.item-actions[data-v-ff2a69a2]{display:flex;gap:6px}.activation-item[data-v-ff2a69a2]{border-radius:8px;padding:8px;display:grid;gap:3px;background:var(--wb-input-bg)}.activation-main[data-v-ff2a69a2],.activation-sub[data-v-ff2a69a2]{display:flex;justify-content:space-between;gap:6px}.activation-main span[data-v-ff2a69a2],.activation-sub[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:12px}.activation-sub span[data-v-ff2a69a2]:last-child{flex:1;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.wb-floating-window[data-v-ff2a69a2]{position:fixed;max-width:calc(100vw - 16px);max-height:min(74vh,760px);border:1px solid var(--wb-border-subtle);border-radius:10px;background:var(--wb-bg-root);box-shadow:var(--wb-shadow-main);display:flex;flex-direction:column;overflow:hidden}.wb-floating-header[data-v-ff2a69a2]{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--wb-border-subtle);background:var(--wb-bg-panel);cursor:move;-webkit-user-select:none;user-select:none;touch-action:none}.wb-floating-header strong[data-v-ff2a69a2]{font-size:12px;color:var(--wb-text-main)}.wb-floating-header-actions[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.wb-floating-body[data-v-ff2a69a2]{min-height:0;padding:8px;display:grid;gap:8px;overflow:auto}.find-window .wb-floating-body[data-v-ff2a69a2]{gap:10px}.activation-window .tool-scroll[data-v-ff2a69a2]{max-height:min(58vh,520px)}.wb-status[data-v-ff2a69a2]{border-radius:10px;background:var(--wb-bg-panel);padding:10px 12px;display:flex;justify-content:space-between;gap:8px;color:var(--wb-text-main);flex-wrap:wrap}.btn[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);background:var(--wb-bg-panel);color:var(--wb-text-main);border-radius:7px;padding:5px 10px;cursor:pointer}.btn[data-v-ff2a69a2]:hover:not(:disabled){border-color:var(--wb-primary-light)}.btn[data-v-ff2a69a2]:disabled{opacity:0.5;cursor:default}.btn.primary[data-v-ff2a69a2]{background:var(--wb-primary-soft);border-color:var(--wb-primary)}.btn.danger[data-v-ff2a69a2]{background:rgba(225,29,72,0.12);border-color:#e11d48;color:#e11d48}.btn.mini[data-v-ff2a69a2]{padding:4px 8px;font-size:12px}.empty-note[data-v-ff2a69a2],.empty-block[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:12px}.empty-block[data-v-ff2a69a2]{padding:14px;border:1px dashed var(--wb-border-main);border-radius:8px}.hidden-input[data-v-ff2a69a2]{display:none}.wb-modal-backdrop[data-v-ff2a69a2]{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:10020;padding:14px;box-sizing:border-box}.wb-history-modal[data-v-ff2a69a2]{width:min(1260px,100%);max-height:min(88vh,940px);border:1px solid var(--wb-border-main);border-radius:12px;background:var(--wb-bg-root);box-shadow:var(--wb-shadow-main);display:flex;flex-direction:column;overflow:hidden;box-sizing:border-box}.wb-history-modal-header[data-v-ff2a69a2]{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--wb-border-main);background:var(--wb-bg-panel)}.wb-history-modal-header strong[data-v-ff2a69a2]{display:block;font-size:14px}.wb-history-modal-header span[data-v-ff2a69a2]{color:var(--wb-text-muted);font-size:11px}.wb-history-modal-actions[data-v-ff2a69a2]{display:flex;gap:6px;flex-wrap:wrap}.wb-history-modal-main[data-v-ff2a69a2]{min-height:0;flex:1;display:grid;grid-template-columns:300px 1fr;overflow:hidden}.wb-history-versions[data-v-ff2a69a2]{border-right:1px solid var(--wb-border-main);background:var(--wb-bg-panel);display:flex;flex-direction:column;min-height:0}.wb-history-versions-title[data-v-ff2a69a2]{padding:8px 10px;font-size:11px;color:var(--wb-text-muted);border-bottom:1px solid var(--wb-border-main)}.wb-history-versions-scroll[data-v-ff2a69a2]{flex:1;min-height:0;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:7px}.wb-history-version-item[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);border-radius:8px;padding:6px;display:grid;gap:4px;background:var(--wb-bg-panel)}.wb-history-version-line[data-v-ff2a69a2]{display:flex;justify-content:space-between;gap:6px;align-items:center}.wb-history-version-line strong[data-v-ff2a69a2]{font-size:11px;color:var(--wb-text-main)}.wb-history-version-item span[data-v-ff2a69a2]{font-size:11px;color:var(--wb-text-muted);word-break:break-all}.wb-history-lr[data-v-ff2a69a2]{display:inline-flex;gap:4px}.mini-lr[data-v-ff2a69a2]{border:1px solid var(--wb-border-main);background:var(--wb-input-bg);color:var(--wb-text-muted);border-radius:6px;min-width:24px;font-size:10px;cursor:pointer}.mini-lr.active[data-v-ff2a69a2]{border-color:#22d3ee;color:#67e8f9}.wb-history-diff-wrap[data-v-ff2a69a2]{min-height:0;flex:1;display:flex;flex-direction:column;overflow:hidden}.wb-history-diff-head[data-v-ff2a69a2]{border-bottom:1px solid var(--wb-border-main);background:var(--wb-bg-panel);padding:8px 10px;display:flex;justify-content:space-between;gap:8px;align-items:center;font-size:11px;color:var(--wb-text-muted)}.wb-history-diff-grid[data-v-ff2a69a2]{min-height:0;flex:1;display:grid;grid-template-columns:1fr 1fr}.wb-history-diff-grid>div[data-v-ff2a69a2]{min-height:0;min-width:0;display:flex;flex-direction:column;overflow:hidden}.wb-history-diff-grid>div+div[data-v-ff2a69a2]{border-left:1px solid var(--wb-border-main)}.wb-history-diff-title[data-v-ff2a69a2]{padding:8px 10px;border-bottom:1px solid var(--wb-border-main);font-size:11px;color:var(--wb-primary-light)}.wb-history-diff-body[data-v-ff2a69a2]{min-height:0;flex:1;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\'Liberation Mono\',\'Courier New\',monospace;font-size:11px;background:var(--wb-input-bg-focus);word-break:break-all;overflow-wrap:break-word}.diff-row[data-v-ff2a69a2]{display:grid;grid-template-columns:54px 1fr;align-items:start;border-bottom:1px solid var(--wb-border-subtle)}.line-no[data-v-ff2a69a2]{color:var(--wb-text-muted);padding:2px 8px;border-right:1px solid var(--wb-border-subtle);-webkit-user-select:none;user-select:none}.line-text[data-v-ff2a69a2]{white-space:pre-wrap;word-break:break-word;padding:2px 8px;color:var(--wb-text-main)}.diff-row.add[data-v-ff2a69a2]{background:rgba(34,197,94,0.18)}.diff-row.del[data-v-ff2a69a2]{background:rgba(239,68,68,0.18)}.diff-row.empty[data-v-ff2a69a2]{background:rgba(100,116,139,0.08)}@media (max-width:1380px){.wb-editor-shell[data-v-ff2a69a2]{grid-template-columns:1fr}.editor-side[data-v-ff2a69a2]{overflow:visible;max-height:none}.wb-history-modal-main[data-v-ff2a69a2]{grid-template-columns:1fr}.wb-history-versions[data-v-ff2a69a2]{border-right:none;border-bottom:1px solid var(--wb-border-main);max-height:120px}.wb-modal-backdrop[data-v-ff2a69a2]{padding:2px}.wb-history-modal[data-v-ff2a69a2]{width:100%;max-height:calc(100vh - 4px);height:calc(100vh - 4px);border-radius:6px}.wb-history-modal-header[data-v-ff2a69a2]{flex-wrap:wrap;gap:4px;padding:6px 8px;flex-shrink:0}.wb-history-modal-header strong[data-v-ff2a69a2]{font-size:12px}.wb-history-modal-header>div:first-child span[data-v-ff2a69a2]{display:none}.wb-history-modal-actions[data-v-ff2a69a2]{gap:4px}.wb-history-modal-actions .btn[data-v-ff2a69a2]{font-size:10px;padding:3px 6px}.wb-history-modal-main[data-v-ff2a69a2]{grid-template-columns:1fr;overflow-y:auto;flex:1;min-height:0}.wb-history-diff-wrap[data-v-ff2a69a2]{overflow-y:auto;min-height:0}.wb-history-diff-grid[data-v-ff2a69a2]{grid-template-columns:1fr;overflow:visible}.wb-history-diff-grid>div[data-v-ff2a69a2]{max-height:30vh;overflow:auto}.wb-history-diff-grid>div+div[data-v-ff2a69a2]{border-left:none;border-top:1px solid var(--wb-border-main)}.diff-row[data-v-ff2a69a2]{grid-template-columns:1fr}.line-no[data-v-ff2a69a2]{display:none}.wb-history-diff-body[data-v-ff2a69a2]{font-size:10px}.wb-history-diff-head[data-v-ff2a69a2]{flex-wrap:wrap;gap:4px;padding:6px 8px}.wb-history-diff-head>div[data-v-ff2a69a2]{font-size:10px}}@media (max-width:1100px){.global-mode-grid[data-v-ff2a69a2]{grid-template-columns:1fr}.wb-resize-handle[data-v-ff2a69a2]{display:none}.wb-main-layout[data-v-ff2a69a2]{grid-template-columns:1fr}.wb-tools-grid[data-v-ff2a69a2]{grid-template-columns:1fr}.editor-grid.two-cols[data-v-ff2a69a2],.editor-grid.three-cols[data-v-ff2a69a2]{grid-template-columns:1fr}.editor-head[data-v-ff2a69a2]{flex-direction:column;align-items:stretch}.editor-badges[data-v-ff2a69a2]{justify-content:flex-start}.history-preview-grid[data-v-ff2a69a2]{grid-template-columns:1fr}.wb-history-diff-grid[data-v-ff2a69a2]{grid-template-columns:1fr}.wb-history-diff-grid>div+div[data-v-ff2a69a2]{border-left:none;border-top:1px solid var(--wb-border-main)}.wb-status[data-v-ff2a69a2]{flex-direction:column}.wb-floating-window[data-v-ff2a69a2]{width:calc(100vw - 16px) !important;left:8px !important;right:8px}}.editor-back-btn[data-v-ff2a69a2]{display:flex;align-items:center;gap:8px;padding:10px 12px;margin:0 0 8px 0;background:var(--wb-bg-panel);border:none;border-radius:6px;color:var(--wb-primary);font-weight:600;cursor:pointer}.editor-back-btn[data-v-ff2a69a2]:hover{background:var(--wb-primary-hover)}.mobile-tab-view[data-v-ff2a69a2]{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}.mobile-tab-content[data-v-ff2a69a2]{flex:1;min-height:0;position:relative}.mobile-pane[data-v-ff2a69a2]{position:absolute;inset:0;overflow-y:auto;padding:8px;-webkit-overflow-scrolling:touch}.mobile-entry-list[data-v-ff2a69a2]{display:flex;flex-direction:column;gap:4px}.mobile-ai-panel[data-v-ff2a69a2]{height:100%;display:flex;flex-direction:column}.mobile-ai-panel .ai-chat-area[data-v-ff2a69a2]{flex:1;min-height:0;display:flex;flex-direction:column}.mobile-danger-zone[data-v-ff2a69a2]{display:flex;gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid var(--wb-border)}.mobile-danger-zone .btn[data-v-ff2a69a2]{flex:1}.mobile-tab-bar[data-v-ff2a69a2]{position:fixed;bottom:0;left:0;right:0;z-index:10100;display:flex;border-top:1px solid var(--wb-border);background:var(--wb-bg-secondary);height:52px}.mobile-tab-bar button[data-v-ff2a69a2]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:transparent;color:var(--wb-text-dim);font-size:10px;padding:4px 0;cursor:pointer;transition:color 0.15s,background 0.15s;-webkit-tap-highlight-color:transparent}.mobile-tab-bar button.active[data-v-ff2a69a2]{color:var(--wb-accent);background:color-mix(in srgb,var(--wb-accent) 8%,transparent)}.mobile-tab-bar .tab-icon[data-v-ff2a69a2]{font-size:20px;line-height:1}.mobile-tab-bar .tab-label[data-v-ff2a69a2]{font-weight:500}@media (max-width:768px){.wb-assistant-root[data-v-ff2a69a2]{padding:6px;gap:8px}.wb-header[data-v-ff2a69a2],.wb-bindings[data-v-ff2a69a2],.global-mode-panel[data-v-ff2a69a2],.wb-toolbar[data-v-ff2a69a2]{padding:6px;gap:6px}.toolbar-label[data-v-ff2a69a2]{min-width:100%}.toolbar-select[data-v-ff2a69a2]{width:100%}.worldbook-picker-trigger[data-v-ff2a69a2]{white-space:normal}.wb-main-layout[data-v-ff2a69a2]{display:block !important;height:auto !important;overflow:visible !important}.wb-entry-list[data-v-ff2a69a2],.wb-editor[data-v-ff2a69a2],.wb-editor-shell[data-v-ff2a69a2],.editor-side[data-v-ff2a69a2]{width:100% !important;height:auto !important;max-height:none !important;border:none !important;padding:0 !important}.wb-entry-list[data-v-ff2a69a2]{max-height:80vh !important;overflow-y:auto}.wb-editor-shell[data-v-ff2a69a2]{display:block !important}.list-scroll[data-v-ff2a69a2]{max-height:60vh}.wb-floating-window[data-v-ff2a69a2]{left:8px !important;right:8px !important;width:auto !important;max-width:none !important}}.list-actions[data-v-ff2a69a2]{padding:0 8px}.wb-assistant-root input[data-v-ff2a69a2],.wb-assistant-root textarea[data-v-ff2a69a2],.wb-assistant-root select[data-v-ff2a69a2],.wb-assistant-root option[data-v-ff2a69a2],.wb-assistant-root button[data-v-ff2a69a2]{color:var(--wb-text-main) !important}.wb-assistant-root input[type="text"][data-v-ff2a69a2],.wb-assistant-root input[type="number"][data-v-ff2a69a2],.wb-assistant-root textarea[data-v-ff2a69a2],.wb-assistant-root select[data-v-ff2a69a2]{background:var(--wb-input-bg) !important;border-color:transparent !important}.wb-assistant-root input[type="text"][data-v-ff2a69a2]:hover,.wb-assistant-root input[type="number"][data-v-ff2a69a2]:hover,.wb-assistant-root textarea[data-v-ff2a69a2]:hover,.wb-assistant-root select[data-v-ff2a69a2]:hover{background:var(--wb-input-bg-hover) !important}.wb-assistant-root input[type="text"][data-v-ff2a69a2]:focus,.wb-assistant-root input[type="number"][data-v-ff2a69a2]:focus,.wb-assistant-root textarea[data-v-ff2a69a2]:focus,.wb-assistant-root select[data-v-ff2a69a2]:focus{background:var(--wb-input-bg-focus) !important;border-color:var(--wb-primary-glow) !important;outline:none !important;box-shadow:0 0 0 3px var(--wb-primary-soft) !important}.ai-generator-panel[data-v-ff2a69a2]{display:flex;gap:0;flex:1;min-height:0;border-radius:var(--wb-radius);overflow:hidden;background:var(--wb-bg-secondary)}.ai-sidebar[data-v-ff2a69a2]{width:220px;min-width:180px;border-right:1px solid var(--wb-border);display:flex;flex-direction:column;background:var(--wb-bg-main)}.ai-sidebar-head[data-v-ff2a69a2]{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--wb-border)}.ai-sidebar-title[data-v-ff2a69a2]{font-weight:600;font-size:0.9em;color:var(--wb-text-main)}.ai-session-list[data-v-ff2a69a2]{flex:1;overflow-y:auto;padding:6px}.ai-session-item[data-v-ff2a69a2]{display:flex;flex-wrap:wrap;align-items:center;width:100%;padding:8px 10px;margin-bottom:2px;border:none;border-radius:var(--wb-radius-sm,6px);background:transparent;cursor:pointer;text-align:left;transition:background 0.15s;position:relative}.ai-session-item[data-v-ff2a69a2]:hover{background:var(--wb-bg-highlight)}.ai-session-item.active[data-v-ff2a69a2]{background:var(--wb-primary-soft)}.ai-session-title[data-v-ff2a69a2]{flex:1;font-size:0.85em;color:var(--wb-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ai-session-meta[data-v-ff2a69a2]{font-size:0.72em;color:var(--wb-text-dim);width:100%;margin-top:2px}.ai-session-delete[data-v-ff2a69a2]{position:absolute;top:4px;right:4px;width:20px;height:20px;border:none;background:transparent;color:var(--wb-text-dim);font-size:1em;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.15s,background 0.15s}.ai-session-item:hover .ai-session-delete[data-v-ff2a69a2]{opacity:1}.ai-session-delete[data-v-ff2a69a2]:hover{background:var(--wb-danger,#e74c3c);color:#fff}.ai-chat-area[data-v-ff2a69a2]{flex:1;display:flex;flex-direction:column;min-width:0}.ai-chat-empty[data-v-ff2a69a2]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--wb-text-dim)}.ai-chat-empty-icon[data-v-ff2a69a2]{font-size:3em;opacity:0.5}.ai-chat-empty-text[data-v-ff2a69a2]{font-size:0.95em}.ai-chat-messages[data-v-ff2a69a2]{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}.ai-chat-bubble[data-v-ff2a69a2]{max-width:85%;padding:10px 14px;border-radius:12px;line-height:1.55;white-space:pre-wrap;word-break:break-word}.ai-chat-bubble.user[data-v-ff2a69a2]{align-self:flex-end;background:var(--wb-primary-soft);border-bottom-right-radius:4px}.ai-chat-bubble.assistant[data-v-ff2a69a2]{align-self:flex-start;background:var(--wb-bg-main);border:1px solid var(--wb-border);border-bottom-left-radius:4px}.ai-chat-bubble-role[data-v-ff2a69a2]{font-size:0.72em;font-weight:600;color:var(--wb-text-dim);margin-bottom:4px}.ai-chat-bubble-content[data-v-ff2a69a2]{font-size:0.88em;color:var(--wb-text-main)}.ai-cursor[data-v-ff2a69a2]{animation:ai-blink-ff2a69a2 0.7s infinite;color:var(--wb-primary)}@keyframes ai-blink-ff2a69a2{0%,100%{opacity:1}50%{opacity:0}}.ai-thinking[data-v-ff2a69a2]{color:var(--wb-text-dim);font-style:italic}.ai-chat-input-bar[data-v-ff2a69a2]{display:flex;flex-wrap:wrap;gap:8px;padding:12px 16px;border-top:1px solid var(--wb-border);background:var(--wb-bg-main);align-items:flex-end}.ai-context-toggle[data-v-ff2a69a2]{width:100%;display:flex;align-items:center;gap:6px;font-size:0.78em;color:var(--wb-text-dim);cursor:pointer;-webkit-user-select:none;user-select:none}.ai-context-toggle input[data-v-ff2a69a2]{margin:0}.ai-context-toggle span[data-v-ff2a69a2]{white-space:nowrap}.ai-chat-input[data-v-ff2a69a2]{flex:1;resize:vertical;min-height:40px;max-height:140px;font-size:0.88em}.ai-send-btn[data-v-ff2a69a2],.ai-stop-btn[data-v-ff2a69a2]{min-width:64px;height:40px}.ai-tag-review-overlay[data-v-ff2a69a2]{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center}.ai-tag-review-modal[data-v-ff2a69a2]{background:var(--wb-bg-main);border-radius:var(--wb-radius);box-shadow:0 12px 40px rgba(0,0,0,0.35);width:580px;max-width:92vw;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}.ai-tag-review-head[data-v-ff2a69a2]{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--wb-border)}.ai-tag-review-title[data-v-ff2a69a2]{font-weight:600;font-size:1em;color:var(--wb-text-main)}.ai-tag-review-close[data-v-ff2a69a2]{width:28px;height:28px;border:none;background:transparent;color:var(--wb-text-dim);font-size:1.2em;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center}.ai-tag-review-close[data-v-ff2a69a2]:hover{background:var(--wb-bg-highlight)}.ai-tag-review-target[data-v-ff2a69a2]{padding:12px 18px;border-bottom:1px solid var(--wb-border)}.ai-tag-list[data-v-ff2a69a2]{flex:1;overflow-y:auto;padding:8px 18px}.ai-tag-item[data-v-ff2a69a2]{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--wb-border);cursor:pointer}.ai-tag-item[data-v-ff2a69a2]:last-child{border-bottom:none}.ai-tag-item input[type="checkbox"][data-v-ff2a69a2]{margin-top:3px}.ai-tag-info[data-v-ff2a69a2]{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0}.ai-tag-name[data-v-ff2a69a2]{font-weight:600;font-size:0.9em;color:var(--wb-primary)}.ai-tag-preview[data-v-ff2a69a2]{font-size:0.8em;color:var(--wb-text-dim);white-space:pre-wrap;word-break:break-all;line-height:1.4}.ai-tag-review-actions[data-v-ff2a69a2]{display:flex;gap:8px;padding:12px 18px;border-top:1px solid var(--wb-border);justify-content:flex-end}.btn.primary[data-v-ff2a69a2]{background:var(--wb-primary);color:#fff;border-color:var(--wb-primary)}.btn.primary[data-v-ff2a69a2]:hover{filter:brightness(1.1)}.btn.primary[data-v-ff2a69a2]:disabled{opacity:0.5;cursor:not-allowed}@media (max-width:768px){.wb-assistant-root[data-v-ff2a69a2]{padding:6px;gap:6px;border-radius:0}.toolbar-label[data-v-ff2a69a2]{min-width:unset;width:100%}.toolbar-label select[data-v-ff2a69a2]{flex:1;min-width:0}.toolbar-btns[data-v-ff2a69a2]{width:100%;display:flex;flex-wrap:wrap;gap:4px}.toolbar-btns .btn[data-v-ff2a69a2]{font-size:0.78em;padding:4px 8px}.wb-bindings[data-v-ff2a69a2]{flex-wrap:wrap;gap:4px;padding:6px 8px;font-size:0.78em}.wb-main-layout[data-v-ff2a69a2]{display:block !important;overflow:visible;flex:none}.wb-resize-handle[data-v-ff2a69a2]{display:none !important}.wb-entry-list[data-v-ff2a69a2],.wb-editor[data-v-ff2a69a2]{min-height:0;max-height:none}.ai-generator-panel[data-v-ff2a69a2]{flex-direction:column}.ai-sidebar[data-v-ff2a69a2]{width:100%;min-width:unset;max-height:110px;border-right:none;border-bottom:1px solid var(--wb-border)}.ai-sidebar-head[data-v-ff2a69a2]{padding:6px 10px}.ai-session-list[data-v-ff2a69a2]{overflow-x:auto;overflow-y:hidden;display:flex;flex-direction:row;gap:4px;padding:4px 8px}.ai-session-item[data-v-ff2a69a2]{flex-shrink:0;min-width:140px;max-width:200px}.ai-chat-messages[data-v-ff2a69a2]{padding:10px;gap:8px}.ai-chat-bubble[data-v-ff2a69a2]{max-width:95%}.ai-chat-input-bar[data-v-ff2a69a2]{padding:8px 10px;gap:6px}.ai-chat-input[data-v-ff2a69a2]{min-height:36px;font-size:0.85em}.ai-tag-review-modal[data-v-ff2a69a2]{width:95vw;max-height:85vh}.ai-tag-review-actions[data-v-ff2a69a2]{flex-wrap:wrap;gap:6px;padding:8px 12px}.ai-tag-review-actions .btn[data-v-ff2a69a2]{flex:1;min-width:0;font-size:0.82em}.wb-status[data-v-ff2a69a2]{font-size:0.72em;padding:4px 8px;gap:6px}.editor-content-area[data-v-ff2a69a2]{flex:1;min-height:40vh}.content-resize-handle[data-v-ff2a69a2]{display:flex;height:28px}.text-area.compact[data-v-ff2a69a2]{min-height:60px}.editor-center[data-v-ff2a69a2]{padding:8px}.editor-side[data-v-ff2a69a2]{padding:8px}.editor-grid.two-cols[data-v-ff2a69a2]{grid-template-columns:1fr}}\n','',{version:3,sources:['webpack://./src/worldbook_assistant_build/App.vue'],names:[],mappings:'AAm+KA,oCACE,MAAO,CACP,YAAa,CACb,UAAW,CACX,qBAAsB,CACtB,YAAa,CACb,qBAAsB,CACtB,YAAa,CACb,QAAS,CACT,4BAA6B,CAC7B,yBAA0B,CAC1B,cAAe,CACf,gBAAiB,CACjB,kBAAmB,CACnB,eACF,CAGA,iCACE,MAAO,CACP,YAAa,CACb,eAAgB,CAChB,YAAa,CACb,qBAAsB,CACtB,QACF,CAEA,sCACE,UACF,CAEA,4BACE,YAAa,CACb,6BAA8B,CAC9B,kBAAmB,CACnB,kBAAmB,CACnB,iBAAkB,CAClB,6BAA8B,CAC9B,iBACF,CAEA,2BACE,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,kCACE,cACF,CAEA,gCACE,0BACF,CAEA,+FAGE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,6BACE,YAAa,CACb,OAAQ,CACR,cAAe,CACf,kBAAmB,CACnB,kBAAmB,CACnB,iBAAkB,CAClB,6BACF,CAEA,gCACE,mBAAoB,CACpB,kBAAmB,CACnB,OAAQ,CACR,0BAA2B,CAC3B,eAAgB,CAChB,cACF,CAEA,iCACE,eACF,CAEA,uCACE,eACF,CAEA,mCACE,iBAAkB,CAClB,aAAc,CACd,eACF,CAEA,2CACE,UAAW,CACX,qBAAsB,CACtB,4BAA6B,CAC7B,iBAAkB,CAClB,gBAAiB,CACjB,6BAA8B,CAC9B,yBAA0B,CAC1B,YAAa,CACb,kBAAmB,CACnB,6BAA8B,CAC9B,QAAS,CACT,cACF,CAEA,iDACE,oCACF,CAEA,gDACE,eAAgB,CAChB,sBAAuB,CACvB,kBAAmB,CACnB,eACF,CAEA,iDACE,aAAc,CACd,0BACF,CAEA,4CACE,iBAAkB,CAClB,MAAO,CACP,OAAQ,CACR,oBAAqB,CACrB,aAAc,CACd,wCAAyC,CACzC,iBAAkB,CAClB,mCAAoC,CACpC,gCAAiC,CACjC,WAAY,CACZ,YAAa,CACb,OACF,CAEA,0CACE,UACF,CAEA,wCACE,gBAAiB,CACjB,aAAc,CACd,WAAY,CACZ,iBAAkB,CAClB,6BAA8B,CAC9B,YAAa,CACb,qBACF,CAEA,wCACE,UAAW,CACX,WAAY,CACZ,+CAAgD,CAChD,sBAAuB,CACvB,yBAA0B,CAC1B,gBAAiB,CACjB,eAAgB,CAChB,cACF,CAEA,mDACE,kBACF,CAEA,8CACE,iCACF,CAEA,+CACE,iCAAkC,CAClC,6BACF,CAEA,8BACE,kBAAmB,CACnB,YAAa,CACb,YAAa,CACb,OAAQ,CACR,6BACF,CAEA,uCACE,YAAa,CACb,0BAA2B,CAC3B,OAAQ,CACR,cAAe,CACf,kBACF,CAEA,oCACE,kBAAmB,CACnB,6BAA8B,CAC9B,YAAa,CACb,YAAa,CACb,QACF,CAEA,mCACE,YAAa,CACb,6BAA8B,CAC9B,kBAAmB,CACnB,OACF,CAEA,oCACE,6BAA8B,CAC9B,eAAgB,CAChB,qBACF,CAEA,sCACE,iBAAkB,CAClB,6BAA8B,CAC9B,YAAa,CACb,YAAa,CACb,OACF,CAEA,oCACE,iBAAkB,CAClB,6BAA8B,CAC9B,YAAa,CACb,YAAa,CACb,OACF,CAEA,mCACE,YAAa,CACb,6BAA8B,CAC9B,kBAAmB,CACnB,OAAQ,CACR,cACF,CAEA,sCACE,uBAAwB,CACxB,cACF,CAEA,4CACE,0BACF,CAEA,sCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,8BACE,iBACF,CAEA,sCACE,UAAW,CACX,qBAAsB,CACtB,4BAA6B,CAC7B,iBAAkB,CAClB,gBAAiB,CACjB,6BAA8B,CAC9B,yBAA0B,CAC1B,YAAa,CACb,kBAAmB,CACnB,6BAA8B,CAC9B,QAAS,CACT,cACF,CAEA,+CACE,YAAa,CACb,cACF,CAEA,2DACE,oCACF,CAEA,2CACE,eAAgB,CAChB,sBAAuB,CACvB,kBAAmB,CACnB,eACF,CAEA,4CACE,aAAc,CACd,0BACF,CAEA,uCACE,iBAAkB,CAClB,MAAO,CACP,OAAQ,CACR,oBAAqB,CACrB,aAAc,CACd,wCAAyC,CACzC,iBAAkB,CAClB,mCAAoC,CACpC,gCAAiC,CACjC,WAAY,CACZ,YAAa,CACb,OACF,CAEA,qCACE,UACF,CAEA,mCACE,WAAY,CACZ,iBAAkB,CAClB,6BAA8B,CAC9B,gBAAiB,CACjB,aAAc,CACd,YAAa,CACb,qBACF,CAEA,mCACE,UAAW,CACX,WAAY,CACZ,+CAAgD,CAChD,sBAAuB,CACvB,yBAA0B,CAC1B,gBAAiB,CACjB,YAAa,CACb,kBAAmB,CACnB,6BAA8B,CAC9B,OAAQ,CACR,eAAgB,CAChB,cACF,CAEA,8CACE,kBACF,CAEA,wDACE,iCACF,CAEA,4CACE,YAAa,CACb,cACF,CAEA,yCACE,eAAgB,CAChB,sBAAuB,CACvB,kBACF,CAEA,yCACE,6BAA8B,CAC9B,aAAc,CACd,cACF,CAEA,mCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,kCACE,wCAAyC,CACzC,mBAAoB,CACpB,6BAA8B,CAC9B,yBAA0B,CAC1B,gBAAiB,CACjB,mBAAoB,CACpB,kBAAmB,CACnB,OAAQ,CACR,cACF,CAEA,wCACE,oBACF,CAEA,0CACE,aACF,CAEA,mCACE,YAAa,CACb,6CAAgD,CAChD,OACF,CAEA,qCACE,iBAAkB,CAClB,YAAa,CACb,6BAA8B,CAC9B,YAAa,CACb,OAAQ,CACR,gBACF,CAEA,mCACE,iBAAkB,CAClB,6BAA8B,CAC9B,gBAAiB,CACjB,eAAgB,CAChB,aAAc,CACd,YAAa,CACb,qBACF,CAEA,mCACE,UAAW,CACX,WAAY,CACZ,+CAAgD,CAChD,sBAAuB,CACvB,yBAA0B,CAC1B,eAAgB,CAChB,YAAa,CACb,6BAA8B,CAC9B,kBAAmB,CACnB,QAAS,CACT,cAAe,CACf,eACF,CAEA,8CACE,kBACF,CAEA,yCACE,iCACF,CAEA,gEACE,aACF,CAEA,mEACE,aACF,CAEA,wCACE,eAAgB,CAChB,sBAAuB,CACvB,kBACF,CAEA,0CACE,cAAe,CACf,aACF,CAEA,sCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,8BACE,8BAA+B,CAC/B,iCACF,CAEA,8BACE,oCAAqC,CACrC,iCACF,CAEA,qCACE,oCAAqC,CACrC,iCAAkC,CAClC,6BACF,CAEA,iCACE,MAAO,CACP,eAAgB,CAChB,YAAa,CACb,8CAAgD,CAChD,KACF,CAEA,4DAEE,kBAAmB,CACnB,SAAU,CACV,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,sBAAuB,CACvB,YACF,CAEA,8BACE,YAAa,CACb,OAAQ,CACR,aACF,CAEA,+BACE,0BAA2B,CAC3B,cAAe,CACf,aACF,CAEA,8BACE,aAAc,CACd,gBAAiB,CACjB,6BAA8B,CAC9B,aAAc,CACd,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,6BACE,UAAW,CACX,eAAgB,CAChB,WAAY,CACZ,sBAAuB,CACvB,yBAA0B,CAC1B,iBAAkB,CAClB,2BAA4B,CAC5B,cAAe,CACf,YAAa,CACb,OAAQ,CACR,iBAAkB,CAClB,sCAAuC,CACvC,iBACF,CAEA,qCACE,UAAW,CACX,iBAAkB,CAClB,MAAO,CACP,KAAM,CACN,QAAS,CACT,SAAU,CACV,yBAA0B,CAC1B,oEACF,CAEA,6DACE,gEACF,CAEA,2DACE,gEACF,CAEA,2DACE,+DACF,CAEA,6DACE,iEACF,CAEA,mCACE,kCAAmC,CACnC,cACF,CAEA,sCACE,iCAAkC,CAClC,eACF,CAEA,sCACE,YACF,CAEA,kCACE,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,WACF,CAEA,mCACE,SAAU,CACV,UAAW,CACX,mBAAoB,CACpB,kBAAmB,CACnB,aAAc,CACd,uCACF,CAEA,2DACE,kBACF,CAEA,yDACE,kBACF,CAEA,yDACE,kBACF,CAEA,2DACE,kBACF,CAEA,mCACE,eAAgB,CAChB,MAAO,CACP,WAAY,CACZ,kBAAmB,CACnB,eAAgB,CAChB,sBACF,CAEA,kCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,6BACE,mBAAoB,CACpB,kBAAmB,CACnB,OAAQ,CACR,WAAY,CACZ,mBAAoB,CACpB,eAAgB,CAChB,0BAA2B,CAC3B,cAAe,CACf,6BACF,CAEA,iCACE,6BAA8B,CAC9B,cAAe,CACf,eACF,CAEA,kCACE,uGAA+G,CAC/G,cACF,CAEA,4DACE,aAAc,CACd,gCACF,CAEA,0DACE,aAAc,CACd,gCACF,CAEA,0DACE,aAAc,CACd,+BACF,CAEA,4DACE,aAAc,CACd,iCACF,CAEA,qCACE,0BAA2B,CAC3B,cAAe,CACf,kBAAmB,CACnB,eAAgB,CAChB,sBAAuB,CACvB,iBAAkB,CAClB,YACF,CAEA,6CACE,gBAAiB,CACjB,0BAA2B,CAC3B,gBACF,CAEA,4BACE,eAAgB,CAChB,eACF,CAEA,kCACE,WAAY,CACZ,YAAa,CACb,YAAa,CACb,8CAAgD,CAChD,KACF,CAEA,mCACE,iBAAkB,CAClB,UAAW,CACX,iBAAkB,CAClB,wBAAiB,CAAjB,gBAAiB,CACjB,iBACF,CAEA,2CACE,UAAW,CACX,iBAAkB,CAClB,QAAS,CACT,QAAS,CACT,WAAY,CACZ,SAAU,CACV,mBAAoB,CACpB,kCAAmC,CACnC,sCACF,CAEA,qGAEE,kCACF,CAEA,gCACE,WAAY,CACZ,kBAAmB,CACnB,6BAA8B,CAC9B,YAAa,CACb,YAAa,CACb,qBAAsB,CACtB,QAAS,CACT,YAAa,CACb,aACF,CAEA,8BACE,YAAa,CACb,6BAA8B,CAC9B,QAAS,CACT,oBAAqB,CACrB,+CAAgD,CAChD,mBACF,CAEA,iCACE,MACF,CAEA,gCACE,YAAa,CACb,OAAQ,CACR,cAAe,CACf,wBACF,CAEA,+BACE,cAAe,CACf,WAAY,CACZ,mBAAoB,CACpB,eAAgB,CAChB,0BAA2B,CAC3B,6BAA8B,CAC9B,kBACF,CAEA,oCACE,uGACF,CAEA,kCACE,aAAc,CACd,+BACF,CAEA,mCACE,aAAc,CACd,iCACF,CAEA,gEACE,aAAc,CACd,gCACF,CAEA,8DACE,aAAc,CACd,gCACF,CAEA,8DACE,aAAc,CACd,+BACF,CAEA,gEACE,aAAc,CACd,iCACF,CAEA,yDACE,eAAgB,CAChB,WAAY,CACZ,gBACF,CAEA,uCACE,YAAa,CACb,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,MACF,CAEA,uCACE,cAAe,CACf,6BAA8B,CAC9B,qBACF,CAEA,sCACE,gBAAiB,CACjB,MAAO,CACP,WAAY,CACZ,eACF,CAEA,wCACE,YAAa,CACb,kBAAmB,CACnB,sBAAuB,CACvB,WAAY,CACZ,gBAAiB,CACjB,6BAA8B,CAC9B,iCAAkC,CAClC,eAAgB,CAChB,yBAA0B,CAC1B,iBAAkB,CAClB,wBAAiB,CAAjB,gBACF,CAEA,sCACE,cAAe,CACf,wBAAyB,CACzB,kBAAmB,CACnB,aACF,CAEA,kCACE,WAAY,CACZ,iBAAkB,CAClB,YAAa,CACb,6BACF,CAEA,0CACE,cAAe,CACf,cAAe,CACf,0BACF,CAEA,gDACE,iBACF,CAEA,8BACE,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,YAAa,CACb,aACF,CAEA,8BACE,WAAY,CACZ,kBAAmB,CACnB,YAAa,CACb,6BAA8B,CAC9B,YAAa,CACb,OACF,CAEA,iCACE,QAAS,CACT,cAAe,CACf,uBACF,CAEA,kCACE,YAAa,CACb,OACF,CAEA,gCACE,WAAY,CACZ,iBAAkB,CAClB,6BAA8B,CAC9B,0BAA2B,CAC3B,gBAAiB,CACjB,cAAe,CACf,cAAe,CACf,eAAgB,CAChB,sCACF,CAEA,sCACE,kCACF,CAEA,gDACE,gCAAoC,CACpC,aACF,CAEA,8CACE,gCAAoC,CACpC,aACF,CAEA,iDACE,+BAAmC,CACnC,aACF,CAEA,8BACE,YAAa,CACb,OACF,CAEA,uCACE,6BACF,CAEA,yCACE,6CACF,CAEA,wBACE,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,6BACE,6BACF,CAEA,iCACE,YACF,CAEA,4BACE,cACF,CAEA,gCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,0FAGE,UAAW,CACX,qBAAsB,CACtB,4BAA6B,CAC7B,iBAAkB,CAClB,gBAAiB,CACjB,yBAA0B,CAC1B,6BAA8B,CAC9B,wBACF,CAEA,4GAGE,mCACF,CAEA,4GAGE,mCAAoC,CACpC,mCAAoC,CACpC,YAAa,CACb,2CACF,CAEA,4BACE,eAAgB,CAChB,eACF,CAEA,oCACE,eACF,CAEA,kCACE,gBACF,CAEA,kCACE,mBAAoB,CACpB,kBAAmB,CACnB,OACF,CAEA,gCACE,YAAa,CACb,OAAQ,CACR,6CACF,CAEA,4BACE,kBAAmB,CACnB,YAAa,CACb,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,gBAAiB,CACjB,6BACF,CAEA,+BACE,QAAS,CACT,cAAe,CACf,6BACF,CAEA,oCACE,YAAa,CACb,OACF,CAEA,6BACE,YAAa,CACb,cAAe,CACf,OACF,CAEA,kCACE,YAAa,CACb,kBAAmB,CACnB,QAAS,CACT,cACF,CAEA,oCACE,gBAAiB,CACjB,6BAA8B,CAC9B,cACF,CAEA,kCACE,sCAAuC,CACvC,iBAAkB,CAClB,eAAgB,CAChB,YAAa,CACb,OAAQ,CACR,6BACF,CAEA,yCACE,yBAA0B,CAC1B,cACF,CAEA,uCACE,0BAA2B,CAC3B,cAAe,CACf,kBAAmB,CACnB,eAAgB,CAChB,sBACF,CAEA,qCACE,0BAA2B,CAC3B,cACF,CAEA,sCACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,+BACE,wCAAyC,CACzC,mBAAoB,CACpB,eAAgB,CAChB,cAAe,CACf,yBAA0B,CAC1B,6BACF,CAEA,+BACE,sCAAuC,CACvC,iBAAkB,CAClB,WAAY,CACZ,6BACF,CAEA,uCACE,cAAe,CACf,yBAA0B,CAC1B,cACF,CAEA,6CACE,iBACF,CAEA,kCACE,YAAa,CACb,OACF,CAEA,uCACE,YAAa,CACb,6CAAgD,CAChD,OACF,CAEA,uCACE,sCAAuC,CACvC,iBAAkB,CAClB,WAAY,CACZ,YAAa,CACb,OAAQ,CACR,6BACF,CAEA,8CACE,6BAA8B,CAC9B,cACF,CAEA,4CACE,0BAA2B,CAC3B,cAAe,CACf,gBACF,CAEA,+BACE,uCAAwC,CACxC,iBAAkB,CAClB,WAAY,CACZ,0BAA2B,CAC3B,cAAe,CACf,6BACF,CAEA,8BACE,aAAc,CACd,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,iCACE,iBAAkB,CAClB,WAAY,CACZ,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,kBAAmB,CACnB,6BACF,CAEA,4BACE,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,WACF,CAEA,4EAEE,kBAAmB,CACnB,eAAgB,CAChB,sBACF,CAEA,iCACE,0BAA2B,CAC3B,cACF,CAEA,+BACE,YAAa,CACb,OACF,CAEA,kCACE,iBAAkB,CAClB,WAAY,CACZ,YAAa,CACb,OAAQ,CACR,6BACF,CAEA,mEAEE,YAAa,CACb,6BAA8B,CAC9B,OACF,CAEA,wEAEE,0BAA2B,CAC3B,cACF,CAEA,iDACE,MAAO,CACP,gBAAiB,CACjB,kBAAmB,CACnB,eAAgB,CAChB,sBACF,CAEA,qCACE,cAAe,CACf,4BAA6B,CAC7B,0BAA4B,CAC5B,wCAAyC,CACzC,kBAAmB,CACnB,4BAA6B,CAC7B,gCAAiC,CACjC,YAAa,CACb,qBAAsB,CACtB,eACF,CAEA,qCACE,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,kBAAmB,CACnB,gBAAiB,CACjB,+CAAgD,CAChD,6BAA8B,CAC9B,WAAY,CACZ,wBAAiB,CAAjB,gBAAiB,CACjB,iBACF,CAEA,4CACE,cAAe,CACf,yBACF,CAEA,6CACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,mCACE,YAAa,CACb,WAAY,CACZ,YAAa,CACb,OAAQ,CACR,aACF,CAEA,gDACE,QACF,CAEA,iDACE,0BACF,CAEA,4BACE,kBAAmB,CACnB,6BAA8B,CAC9B,iBAAkB,CAClB,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,yBAA0B,CAC1B,cACF,CAEA,sBACE,sCAAuC,CACvC,6BAA8B,CAC9B,yBAA0B,CAC1B,iBAAkB,CAClB,gBAAiB,CACjB,cACF,CAEA,2CACE,oCACF,CAEA,+BACE,WAAY,CACZ,cACF,CAEA,8BACE,iCAAkC,CAClC,8BACF,CAEA,6BACE,+BAAmC,CACnC,oBAAqB,CACrB,aACF,CAEA,2BACE,eAAgB,CAChB,cACF,CAEA,2DAEE,0BAA2B,CAC3B,cACF,CAEA,8BACE,YAAa,CACb,uCAAwC,CACxC,iBACF,CAEA,+BACE,YACF,CAEA,oCACE,cAAe,CACf,OAAQ,CACR,2BAA+B,CAC/B,YAAa,CACb,kBAAmB,CACnB,sBAAuB,CACvB,aAAc,CACd,YAAa,CACb,qBACF,CAEA,mCACE,sBAAwB,CACxB,0BAA4B,CAC5B,sCAAuC,CACvC,kBAAmB,CACnB,4BAA6B,CAC7B,gCAAiC,CACjC,YAAa,CACb,qBAAsB,CACtB,eAAgB,CAChB,qBACF,CAEA,0CACE,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,kBAAmB,CACnB,iBAAkB,CAClB,6CAA8C,CAC9C,6BACF,CAEA,iDACE,aAAc,CACd,cACF,CAEA,+CACE,0BAA2B,CAC3B,cACF,CAEA,2CACE,YAAa,CACb,OAAQ,CACR,cACF,CAEA,wCACE,YAAa,CACb,MAAO,CACP,YAAa,CACb,+BAAgC,CAChC,eACF,CAEA,sCACE,4CAA6C,CAC7C,6BAA8B,CAC9B,YAAa,CACb,qBAAsB,CACtB,YACF,CAEA,4CACE,gBAAiB,CACjB,cAAe,CACf,0BAA2B,CAC3B,6CACF,CAEA,6CACE,MAAO,CACP,YAAa,CACb,aAAc,CACd,WAAY,CACZ,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,0CACE,sCAAuC,CACvC,iBAAkB,CAClB,WAAY,CACZ,YAAa,CACb,OAAQ,CACR,6BACF,CAEA,0CACE,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,kBACF,CAEA,iDACE,cAAe,CACf,yBACF,CAEA,+CACE,cAAe,CACf,0BAA2B,CAC3B,oBACF,CAEA,gCACE,mBAAoB,CACpB,OACF,CAEA,0BACE,sCAAuC,CACvC,6BAA8B,CAC9B,0BAA2B,CAC3B,iBAAkB,CAClB,cAAe,CACf,cAAe,CACf,cACF,CAEA,iCACE,oBAAqB,CACrB,aACF,CAEA,uCACE,YAAa,CACb,MAAO,CACP,YAAa,CACb,qBAAsB,CACtB,eACF,CAEA,uCACE,6CAA8C,CAC9C,6BAA8B,CAC9B,gBAAiB,CACjB,YAAa,CACb,6BAA8B,CAC9B,OAAQ,CACR,kBAAmB,CACnB,cAAe,CACf,0BACF,CAEA,uCACE,YAAa,CACb,MAAO,CACP,YAAa,CACb,6BACF,CAEA,2CACE,YAAa,CACb,WAAY,CACZ,YAAa,CACb,qBAAsB,CACtB,eACF,CAEA,+CACE,2CACF,CAEA,wCACE,gBAAiB,CACjB,6CAA8C,CAC9C,cAAe,CACf,6BACF,CAEA,uCACE,YAAa,CACb,MAAO,CACP,aAAc,CACd,uGAA+G,CAC/G,cAAe,CACf,mCAAoC,CACpC,oBAAqB,CACrB,wBACF,CAEA,2BACE,YAAa,CACb,8BAA+B,CAC/B,iBAAkB,CAClB,+CACF,CAEA,0BACE,0BAA2B,CAC3B,eAAgB,CAChB,8CAA+C,CAC/C,wBAAiB,CAAjB,gBACF,CAEA,4BACE,oBAAqB,CACrB,qBAAsB,CACtB,eAAgB,CAChB,yBACF,CAEA,+BACE,+BACF,CAEA,+BACE,+BACF,CAEA,iCACE,iCACF,CAEA,0BACE,kCACE,yBACF,CAEA,8BACE,gBAAiB,CACjB,eACF,CAEA,wCACE,yBACF,CAEA,sCACE,iBAAkB,CAClB,6CAA8C,CAC9C,gBACF,CAEA,oCACE,WACF,CAEA,mCACE,UAAW,CACX,4BAA6B,CAC7B,wBAAyB,CACzB,iBACF,CAEA,0CACE,cAAe,CACf,OAAQ,CACR,eAAgB,CAChB,aACF,CAEA,iDACE,cACF,CAEA,+DACE,YACF,CAEA,2CACE,OACF,CAEA,gDACE,cAAe,CACf,eACF,CAEA,wCACE,yBAA0B,CAC1B,eAAgB,CAChB,MAAO,CACP,YACF,CAEA,uCACE,eAAgB,CAChB,YACF,CAEA,uCACE,yBAA0B,CAC1B,gBACF,CAEA,2CACE,eAAgB,CAChB,aACF,CAEA,+CACE,gBAAiB,CACjB,0CACF,CAEA,2BACE,yBACF,CAEA,0BACE,YACF,CAEA,uCACE,cACF,CAEA,uCACE,cAAe,CACf,OAAQ,CACR,eACF,CAEA,2CACE,cACF,CACF,CAEA,0BACE,mCACE,yBACF,CAEA,mCACE,YACF,CAEA,iCACE,yBACF,CAEA,gCACE,yBACF,CAEA,gFAEE,yBACF,CAEA,8BACE,qBAAsB,CACtB,mBACF,CAEA,gCACE,0BACF,CAEA,uCACE,yBACF,CAEA,uCACE,yBACF,CAEA,+CACE,gBAAiB,CACjB,0CACF,CAEA,4BACE,qBACF,CAGA,qCACE,mCAAoC,CACpC,mBAAoB,CACpB,SACF,CACF,CAEA,kCACE,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,iBAAkB,CAClB,gBAAiB,CACjB,6BAA8B,CAC9B,WAAY,CACZ,iBAAkB,CAClB,uBAAwB,CACxB,eAAgB,CAChB,cACF,CAEA,wCACE,kCACF,CAGA,kCACE,YAAa,CACb,qBAAsB,CACtB,MAAO,CACP,YAAa,CACb,eACF,CAEA,qCACE,MAAO,CACP,YAAa,CACb,iBACF,CAEA,8BACE,iBAAkB,CAClB,OAAQ,CACR,eAAgB,CAChB,WAAY,CACZ,gCACF,CAEA,oCACE,YAAa,CACb,qBAAsB,CACtB,OACF,CAEA,kCACE,WAAY,CACZ,YAAa,CACb,qBACF,CAEA,gDACE,MAAO,CACP,YAAa,CACb,YAAa,CACb,qBACF,CAEA,qCACE,YAAa,CACb,OAAQ,CACR,eAAgB,CAChB,gBAAiB,CACjB,qCACF,CAEA,0CACE,MACF,CAEA,iCACE,cAAe,CACf,QAAS,CACT,MAAO,CACP,OAAQ,CACR,aAAc,CACd,YAAa,CACb,qCAAsC,CACtC,iCAAkC,CAClC,WACF,CAEA,wCACE,MAAO,CACP,YAAa,CACb,qBAAsB,CACtB,kBAAmB,CACnB,sBAAuB,CACvB,OAAQ,CACR,WAAY,CACZ,sBAAuB,CACvB,wBAAyB,CACzB,cAAe,CACf,aAAc,CACd,cAAe,CACf,uCAAyC,CACzC,uCACF,CAEA,+CACE,sBAAuB,CACvB,6DACF,CAEA,2CACE,cAAe,CACf,aACF,CAEA,4CACE,eACF,CAEA,yBACE,oCACE,WAAY,CACZ,OACF,CAEA,2HAIE,WAAY,CACZ,OACF,CAEA,gCACE,cACF,CAEA,iCACE,UACF,CAEA,2CACE,kBACF,CAEA,iCACE,wBAAyB,CACzB,sBAAuB,CACvB,2BACF,CAEA,4HAIE,qBAAsB,CACtB,sBAAuB,CACvB,0BAA2B,CAC3B,sBAAuB,CACvB,oBACF,CAEA,gCACE,0BAA2B,CAC3B,eACF,CAEA,kCACE,wBACF,CAEA,8BACE,eACF,CAEA,qCACE,mBAAoB,CACpB,oBAAqB,CACrB,qBAAsB,CACtB,yBACF,CACF,CAEA,+BACE,aACF,CAOA,wNAKE,oCACF,CAEA,wMAIE,wCAAyC,CACzC,mCACF,CAEA,gOAIE,8CACF,CAEA,gOAIE,8CAA+C,CAC/C,8CAA+C,CAC/C,uBAAwB,CACxB,sDACF,CAIA,qCACE,YAAa,CACb,KAAM,CACN,MAAO,CACP,YAAa,CACb,8BAA+B,CAC/B,eAAgB,CAChB,iCACF,CAGA,6BACE,WAAY,CACZ,eAAgB,CAChB,uCAAwC,CACxC,YAAa,CACb,qBAAsB,CACtB,4BACF,CAEA,kCACE,YAAa,CACb,kBAAmB,CACnB,6BAA8B,CAC9B,iBAAkB,CAClB,wCACF,CAEA,mCACE,eAAgB,CAChB,eAAgB,CAChB,yBACF,CAEA,kCACE,MAAO,CACP,eAAgB,CAChB,WACF,CAEA,kCACE,YAAa,CACb,cAAe,CACf,kBAAmB,CACnB,UAAW,CACX,gBAAiB,CACjB,iBAAkB,CAClB,WAAY,CACZ,qCAAuC,CACvC,sBAAuB,CACvB,cAAe,CACf,eAAgB,CAChB,2BAA4B,CAC5B,iBACF,CAEA,wCACE,iCACF,CAEA,yCACE,iCACF,CAEA,mCACE,MAAO,CACP,gBAAiB,CACjB,yBAA0B,CAC1B,kBAAmB,CACnB,eAAgB,CAChB,sBACF,CAEA,kCACE,gBAAiB,CACjB,wBAAyB,CACzB,UAAW,CACX,cACF,CAEA,oCACE,iBAAkB,CAClB,OAAQ,CACR,SAAU,CACV,UAAW,CACX,WAAY,CACZ,WAAY,CACZ,sBAAuB,CACvB,wBAAyB,CACzB,aAAc,CACd,cAAe,CACf,iBAAkB,CAClB,YAAa,CACb,kBAAmB,CACnB,sBAAuB,CACvB,SAAU,CACV,yCACF,CAEA,2DACE,SACF,CAEA,0CACE,mCAAqC,CACrC,UACF,CAGA,+BACE,MAAO,CACP,YAAa,CACb,qBAAsB,CACtB,WACF,CAEA,gCACE,MAAO,CACP,YAAa,CACb,qBAAsB,CACtB,kBAAmB,CACnB,sBAAuB,CACvB,QAAS,CACT,wBACF,CAEA,qCACE,aAAc,CACd,WACF,CAEA,qCACE,gBACF,CAEA,mCACE,MAAO,CACP,eAAgB,CAChB,YAAa,CACb,YAAa,CACb,qBAAsB,CACtB,QACF,CAGA,iCACE,aAAc,CACd,iBAAkB,CAClB,kBAAmB,CACnB,gBAAiB,CACjB,oBAAqB,CACrB,qBACF,CAEA,sCACE,mBAAoB,CACpB,iCAAkC,CAClC,8BACF,CAEA,2CACE,qBAAsB,CACtB,4BAA6B,CAC7B,iCAAkC,CAClC,6BACF,CAEA,sCACE,gBAAiB,CACjB,eAAgB,CAChB,wBAAyB,CACzB,iBACF,CAEA,yCACE,gBAAiB,CACjB,yBACF,CAEA,4BACE,yCAAiC,CACjC,uBACF,CAEA,6BACE,QAAW,SAAY,CACvB,IAAM,SAAY,CACpB,CAEA,8BACE,wBAAyB,CACzB,iBACF,CAGA,oCACE,YAAa,CACb,cAAe,CACf,OAAQ,CACR,iBAAkB,CAClB,qCAAsC,CACtC,4BAA6B,CAC7B,oBACF,CAEA,oCACE,UAAW,CACX,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,gBAAiB,CACjB,wBAAyB,CACzB,cAAe,CACf,wBAAiB,CAAjB,gBACF,CAEA,0CACE,QACF,CAEA,yCACE,kBACF,CAEA,gCACE,MAAO,CACP,eAAgB,CAChB,eAAgB,CAChB,gBAAiB,CACjB,gBACF,CAEA,4DAEE,cAAe,CACf,WACF,CAKA,wCACE,cAAe,CACf,OAAQ,CACR,YAAa,CACb,2BAA+B,CAC/B,YAAa,CACb,kBAAmB,CACnB,sBACF,CAEA,sCACE,4BAA6B,CAC7B,8BAA+B,CAC/B,uCAA2C,CAC3C,WAAY,CACZ,cAAe,CACf,eAAgB,CAChB,YAAa,CACb,qBAAsB,CACtB,eACF,CAEA,qCACE,YAAa,CACb,kBAAmB,CACnB,6BAA8B,CAC9B,iBAAkB,CAClB,wCACF,CAEA,sCACE,eAAgB,CAChB,aAAc,CACd,yBACF,CAEA,sCACE,UAAW,CACX,WAAY,CACZ,WAAY,CACZ,sBAAuB,CACvB,wBAAyB,CACzB,eAAgB,CAChB,cAAe,CACf,iBAAkB,CAClB,YAAa,CACb,kBAAmB,CACnB,sBACF,CAEA,4CACE,iCACF,CAEA,uCACE,iBAAkB,CAClB,wCACF,CAEA,8BACE,MAAO,CACP,eAAgB,CAChB,gBACF,CAEA,8BACE,YAAa,CACb,sBAAuB,CACvB,QAAS,CACT,cAAe,CACf,wCAAyC,CACzC,cACF,CAEA,yCACE,kBACF,CAEA,qDACE,cACF,CAEA,8BACE,MAAO,CACP,YAAa,CACb,qBAAsB,CACtB,OAAQ,CACR,WACF,CAEA,8BACE,eAAgB,CAChB,eAAgB,CAChB,uBACF,CAEA,iCACE,eAAgB,CAChB,wBAAyB,CACzB,oBAAqB,CACrB,oBAAqB,CACrB,eACF,CAEA,wCACE,YAAa,CACb,OAAQ,CACR,iBAAkB,CAClB,qCAAsC,CACtC,wBACF,CAEA,8BACE,4BAA6B,CAC7B,UAAW,CACX,8BACF,CAEA,oCACE,sBACF,CAEA,uCACE,WAAY,CACZ,kBACF,CAKA,yBACE,oCACE,WAAY,CACZ,OAAQ,CACR,eACF,CAGA,gCACE,eAAgB,CAChB,UACF,CAEA,uCACE,MAAO,CACP,WACF,CAEA,+BACE,UAAW,CACX,YAAa,CACb,cAAe,CACf,OACF,CAEA,oCACE,gBAAiB,CACjB,eACF,CAGA,8BACE,cAAe,CACf,OAAQ,CACR,eAAgB,CAChB,gBACF,CAGA,iCACE,wBAAyB,CACzB,gBAAiB,CACjB,SACF,CAEA,mCACE,uBACF,CAEA,4DAEE,YAAa,CACb,eACF,CAGA,qCACE,qBACF,CAEA,6BACE,UAAW,CACX,eAAgB,CAChB,gBAAiB,CACjB,iBAAkB,CAClB,wCACF,CAEA,kCACE,gBACF,CAEA,kCACE,eAAgB,CAChB,iBAAkB,CAClB,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,eACF,CAEA,kCACE,aAAc,CACd,eAAgB,CAChB,eACF,CAEA,mCACE,YAAa,CACb,OACF,CAEA,iCACE,aACF,CAEA,oCACE,gBAAiB,CACjB,OACF,CAEA,gCACE,eAAgB,CAChB,gBACF,CAGA,sCACE,UAAW,CACX,eACF,CAEA,wCACE,cAAe,CACf,OAAQ,CACR,gBACF,CAEA,6CACE,MAAO,CACP,WAAY,CACZ,gBACF,CAGA,4BACE,gBAAiB,CACjB,eAAgB,CAChB,OACF,CAGA,sCACE,MAAO,CACP,eACF,CAEA,wCACE,YAAa,CACb,WACF,CAEA,oCACE,eACF,CAEA,gCACE,WACF,CAEA,8BACE,WACF,CAEA,uCACE,yBACF,CACF',sourcesContent:['<template>\n  <div ref="rootRef" class="wb-assistant-root" :style="themeStyles">\n\n    \x3c!--  Mobile Tab View  --\x3e\n    <template v-if="isMobile">\n      <div class="mobile-tab-view">\n        <div class="mobile-tab-content">\n\n          \x3c!-- Tab:  --\x3e\n          <div v-show="mobileTab === \'list\'" class="mobile-pane">\n            <section class="wb-toolbar">\n              <label class="toolbar-label">\n                <span></span>\n                <div ref="worldbookPickerRef" class="worldbook-picker">\n                  <button class="worldbook-picker-trigger" type="button" @click="toggleWorldbookPicker">\n                    <span class="worldbook-picker-trigger-text" :title="selectedWorldbookName || \'\'">\n                      {{ selectedWorldbookName || \'\' }}\n                    </span>\n                    <span class="worldbook-picker-arrow"></span>\n                  </button>\n                  <div v-if="worldbookPickerOpen" class="worldbook-picker-dropdown">\n                    <input\n                      v-model="worldbookPickerSearchText"\n                      type="text"\n                      class="text-input worldbook-picker-search"\n                      placeholder="..."\n                      @keydown.enter.prevent="filteredSelectableWorldbookNames[0] && selectWorldbookFromPicker(filteredSelectableWorldbookNames[0])"\n                    />\n                    <div class="worldbook-picker-list">\n                      <button\n                        v-for="name in filteredSelectableWorldbookNames"\n                        :key="`wb-pick-m-${name}`"\n                        class="worldbook-picker-item"\n                        :class="{ active: name === selectedWorldbookName }"\n                        type="button"\n                        @click="selectWorldbookFromPicker(name)"\n                      >{{ name }}</button>\n                      <div v-if="!filteredSelectableWorldbookNames.length" class="empty-note"></div>\n                    </div>\n                  </div>\n                </div>\n              </label>\n              <div class="toolbar-btns" style="display:flex;gap:6px;flex-wrap:wrap;">\n                <button class="btn" type="button" :disabled="!hasUnsavedChanges" @click="saveCurrentWorldbook" style="padding:8px 14px;font-size:13px;"> </button>\n                <button class="btn" type="button" @click="addEntry" style="padding:8px 14px;font-size:13px;">+ </button>\n                <button class="btn" type="button" @click="triggerImport" style="padding:8px 14px;font-size:13px;"> </button>\n                <button class="btn" type="button" :disabled="!selectedWorldbookName" @click="exportCurrentWorldbook" style="padding:8px 14px;font-size:13px;"> </button>\n                <button class="btn" type="button" @click="toggleGlobalMode" :style="{ padding:\'8px 14px\', fontSize:\'13px\', background: globalWorldbookMode ? \'#2563eb\' : \'\', color: globalWorldbookMode ? \'#fff\' : \'\' }"> </button>\n              </div>\n            </section>\n            <div class="wb-bindings" v-if="bindings.global.length || bindings.charPrimary || bindings.charAdditional.length || bindings.chat">\n              <span v-for="name in bindings.global" :key="`bg-m-${name}`" class="binding-chip global" :title="name">{{ name }}</span>\n              <span v-if="bindings.charPrimary" :key="`bc-m-${bindings.charPrimary}`" class="binding-chip char" :title="bindings.charPrimary">{{ bindings.charPrimary }}</span>\n              <span v-for="name in bindings.charAdditional" :key="`bca-m-${name}`" class="binding-chip char" :title="name">{{ name }}</span>\n              <span v-if="bindings.chat" :key="`bch-m-${bindings.chat}`" class="binding-chip chat" :title="bindings.chat">{{ bindings.chat }}</span>\n            </div>\n            \x3c!-- Global Mode Panel (mobile) --\x3e\n            <div v-if="globalWorldbookMode" style="border:1px solid var(--wb-border-subtle);border-radius:8px;padding:10px;margin-bottom:8px;background:var(--wb-bg-card);">\n              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">\n                <span style="font-weight:600;font-size:13px;"> {{ bindings.global.length }}</span>\n                <button class="btn mini danger" type="button" :disabled="!bindings.global.length" @click="clearGlobalWorldbooks" style="font-size:11px;"></button>\n              </div>\n              <label class="field" style="margin-bottom:6px;">\n                <span style="font-size:12px;"></span>\n                <select v-model="selectedGlobalPresetId" class="text-input" @change="onGlobalPresetSelectionChanged" style="font-size:12px;">\n                  <option value=""></option>\n                  <option v-for="preset in globalWorldbookPresets" :key="preset.id" :value="preset.id">\n                    {{ preset.name }}{{ preset.worldbooks.length }}\n                  </option>\n                </select>\n              </label>\n              <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;">\n                <button class="btn mini" type="button" :disabled="!bindings.global.length" @click="saveCurrentAsGlobalPreset" style="font-size:11px;"></button>\n                <button class="btn mini" type="button" :disabled="!selectedGlobalPreset" @click="overwriteSelectedGlobalPreset" style="font-size:11px;"></button>\n                <button class="btn mini danger" type="button" :disabled="!selectedGlobalPreset" @click="deleteSelectedGlobalPreset" style="font-size:11px;"></button>\n              </div>\n              <label class="field" style="margin-bottom:6px;">\n                <span style="font-size:12px;"></span>\n                <input v-model="globalAddSearchText" type="text" class="text-input" placeholder="..." @keydown.enter.prevent="addFirstGlobalCandidate" style="font-size:12px;" />\n              </label>\n              <div v-if="globalAddCandidates.length" style="max-height:120px;overflow-y:auto;margin-bottom:6px;">\n                <button v-for="name in globalAddCandidates" :key="`m-add-${name}`" type="button" style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:6px 8px;border:none;background:var(--wb-input-bg);border-radius:4px;color:var(--wb-text-main);font-size:12px;margin-bottom:2px;cursor:pointer;" @click="addGlobalWorldbook(name)">\n                  <span>{{ name }}</span><span style="color:#22c55e;">+ </span>\n                </button>\n              </div>\n              <div v-if="filteredGlobalWorldbooks.length" style="font-size:12px;margin-bottom:4px;opacity:0.7;"></div>\n              <div style="display:flex;flex-direction:column;gap:2px;margin-bottom:8px;">\n                <button v-for="name in filteredGlobalWorldbooks" :key="`m-gl-${name}`" type="button" style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:6px 8px;border:none;background:var(--wb-input-bg);border-radius:4px;color:var(--wb-text-main);font-size:12px;cursor:pointer;" @click="removeGlobalWorldbook(name)">\n                  <span>{{ name }}</span><span style="color:#ef4444;"></span>\n                </button>\n              </div>\n              \x3c!-- Role Binding Section --\x3e\n              <div style="border-top:1px solid var(--wb-border-subtle);padding-top:8px;margin-top:4px;">\n                <div style="font-size:12px;font-weight:600;margin-bottom:6px;"></div>\n                <div style="font-size:11px;margin-bottom:6px;opacity:0.8;" :style="{ color: currentRoleContext ? \'#60a5fa\' : \'#94a3b8\' }">\n                  {{ currentRoleContext ? `: ${currentRoleContext.name}` : \'\' }}\n                </div>\n                <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">\n                  <button class="btn mini" type="button" :disabled="!selectedGlobalPreset || !currentRoleContext" @click="bindCurrentRoleToSelectedPreset" style="font-size:11px;"></button>\n                  <button class="btn mini" type="button" :disabled="!selectedGlobalPreset || !isCurrentRoleBoundToSelectedPreset" @click="unbindCurrentRoleFromSelectedPreset" style="font-size:11px;"></button>\n                </div>\n                <div style="margin-bottom:6px;">\n                  <button type="button" :disabled="!selectedGlobalPreset" @click="toggleRolePicker" style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:6px 8px;border:1px solid var(--wb-border-subtle);border-radius:4px;background:var(--wb-input-bg);color:var(--wb-text-main);font-size:12px;cursor:pointer;">\n                    <span>{{ selectedGlobalPreset ? \'\' : \'\' }}</span>\n                    <span>{{ rolePickerOpen ? \'\' : \'\' }}</span>\n                  </button>\n                  <div v-if="rolePickerOpen" style="margin-top:4px;">\n                    <input v-model="roleBindSearchText" type="text" class="text-input" placeholder="..." style="font-size:12px;margin-bottom:4px;" @keydown.enter.prevent="bindFirstRoleCandidate" />\n                    <div style="max-height:120px;overflow-y:auto;">\n                      <button v-for="candidate in roleBindingCandidates" :key="`m-role-${candidate.key}`" type="button" :disabled="candidate.bound" style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:6px 8px;border:none;background:var(--wb-input-bg);border-radius:4px;color:var(--wb-text-main);font-size:12px;margin-bottom:2px;cursor:pointer;opacity: 1;" :style="{ opacity: candidate.bound ? \'0.5\' : \'1\' }" @click="bindRoleCandidateToSelectedPreset(candidate)">\n                        <span>{{ candidate.name }}</span><span :style="{ color: candidate.bound ? \'#94a3b8\' : \'#22c55e\' }">{{ candidate.bound ? \'\' : \'\' }}</span>\n                      </button>\n                      <div v-if="!roleBindingCandidates.length" style="font-size:11px;opacity:0.5;padding:4px;"></div>\n                    </div>\n                  </div>\n                </div>\n                <div v-if="selectedGlobalPreset" style="display:flex;flex-wrap:wrap;gap:4px;">\n                  <button v-for="binding in selectedGlobalPresetRoleBindings" :key="`m-rb-${selectedGlobalPreset?.id}-${binding.key}`" type="button" style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border:1px solid var(--wb-border-subtle);border-radius:4px;background:var(--wb-input-bg);color:var(--wb-text-main);font-size:11px;cursor:pointer;" @click="removeRoleBindingFromSelectedPreset(binding.key)">\n                    {{ binding.name }} <span style="color:#ef4444;"></span>\n                  </button>\n                  <div v-if="!selectedGlobalPresetRoleBindings.length" style="font-size:11px;opacity:0.5;"></div>\n                </div>\n                <div v-else style="font-size:11px;opacity:0.5;"></div>\n              </div>\n            </div>\n            <div class="mobile-entry-list">\n              <button\n                v-for="entry in filteredEntries"\n                :key="`me-${entry.uid}`"\n                type="button"\n                class="entry-item"\n                :data-status="getEntryVisualStatus(entry)"\n                :class="{ selected: entry.uid === selectedEntryUid, disabled: !entry.enabled }"\n                @click="selectEntry(entry.uid)"\n                style="border: 1px solid var(--wb-border-subtle); border-radius: 8px; padding: 8px 10px; margin-bottom: 4px;"\n              >\n                <div class="entry-item-head">\n                  <span class="entry-status-dot" :data-status="getEntryVisualStatus(entry)"></span>\n                  <div class="entry-item-title">{{ entry.name || ` ${entry.uid}` }}</div>\n                  <span class="entry-chip uid">#{{ entry.uid }}</span>\n                </div>\n                <div class="entry-item-keys" v-if="entry.strategy.keys?.length">\n                  {{ entry.strategy.keys.join(\', \') }}\n                </div>\n                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;font-size:10px;opacity:0.8;">\n                  <span style="background:var(--wb-input-bg);padding:2px 6px;border-radius:4px;"> {{ getPositionTypeLabel(entry.position.type) }}</span>\n                  <span style="background:var(--wb-input-bg);padding:2px 6px;border-radius:4px;"> #{{ entry.position.order }}</span>\n                  <span v-if="entry.recursion.prevent_incoming" style="background:var(--wb-input-bg);padding:2px 6px;border-radius:4px;color:#f59e0b;"></span>\n                  <span v-if="entry.recursion.prevent_outgoing" style="background:var(--wb-input-bg);padding:2px 6px;border-radius:4px;color:#f59e0b;"></span>\n                </div>\n              </button>\n              <div v-if="!filteredEntries.length" class="empty-note"></div>\n            </div>\n          </div>\n\n          \x3c!-- Tab:  --\x3e\n          <div v-show="mobileTab === \'edit\'" class="mobile-pane">\n            <template v-if="selectedEntry">\n              <header class="editor-head">\n                <label class="field editor-comment">\n                  <span> (COMMENT)</span>\n                  <input v-model="selectedEntry.name" type="text" class="text-input" />\n                </label>\n                <div class="editor-badges">\n                  <span class="editor-badge" :class="selectedEntry.enabled ? \'on\' : \'off\'">{{ selectedEntry.enabled ? \'EN\' : \'OFF\' }}</span>\n                  <span class="editor-badge mono">#{{ selectedEntry.uid }}</span>\n                  <span class="editor-badge mono">~{{ selectedTokenEstimate }}T</span>\n                </div>\n              </header>\n              <section class="editor-grid two-cols editor-keyword-grid">\n                <label class="field">\n                  <span> (KEYS)</span>\n                  <textarea v-model="selectedKeysText" class="text-area compact"></textarea>\n                </label>\n                <label class="field">\n                  <span> (SECONDARY)</span>\n                  <textarea v-model="selectedSecondaryKeysText" class="text-area compact"></textarea>\n                </label>\n              </section>\n              <section class="editor-content-block">\n                <div class="editor-content-title"> /  (CONTENT)</div>\n                <textarea\n                  ref="contentTextareaRef"\n                  v-model="selectedEntry.content"\n                  class="text-area large editor-content-area"\n                  style="min-height: calc(100vh - 500px);"\n                ></textarea>\n                <div class="content-resize-handle" @pointerdown="startContentResize">\n                  <span class="content-resize-grip"></span>\n                </div>\n              </section>\n            </template>\n            <div v-else class="empty-block"></div>\n          </div>\n\n          \x3c!-- Tab:  --\x3e\n          <div v-show="mobileTab === \'settings\'" class="mobile-pane">\n            <template v-if="selectedEntry">\n              <article class="editor-card">\n                <h4> (STRATEGY)</h4>\n                <label class="field checkbox-inline">\n                  <input v-model="selectedEntry.enabled" type="checkbox" />\n                  <span></span>\n                </label>\n                <div class="strategy-switch">\n                  <button type="button" class="strategy-pill constant" :class="{ active: selectedEntry.strategy.type === \'constant\' }" @click="selectedEntry.strategy.type = \'constant\'"> </button>\n                  <button type="button" class="strategy-pill vector" :class="{ active: selectedEntry.strategy.type === \'vectorized\' }" @click="selectedEntry.strategy.type = \'vectorized\'"> </button>\n                  <button type="button" class="strategy-pill selective" :class="{ active: selectedEntry.strategy.type === \'selective\' }" @click="selectedEntry.strategy.type = \'selective\'"> </button>\n                </div>\n                <details class="editor-advanced">\n                  <summary></summary>\n                  <label class="field">\n                    <span> (LOGIC)</span>\n                    <select v-model="selectedEntry.strategy.keys_secondary.logic" class="text-input">\n                      <option v-for="item in secondaryLogicOptions" :key="`ml-${item}`" :value="item">{{ getSecondaryLogicLabel(item) }}</option>\n                    </select>\n                  </label>\n                  <label class="field">\n                    <span></span>\n                    <input v-model="selectedScanDepthText" type="text" class="text-input" placeholder=" same_as_global" />\n                  </label>\n                  <label class="field">\n                    <span>(0-100)</span>\n                    <input v-model.number="selectedEntry.probability" type="number" class="text-input" min="0" max="100" step="1" />\n                  </label>\n                </details>\n              </article>\n              <article class="editor-card">\n                <h4> (INSERTION)</h4>\n                <label class="field">\n                  <span> (Position)</span>\n                  <select v-model="selectedEntry.position.type" class="text-input" @change="handleSelectedPositionTypeChanged">\n                    <option v-for="item in positionTypeOptions" :key="`mp-${item}`" :value="item">{{ getPositionTypeLabel(item) }}</option>\n                  </select>\n                </label>\n                <label class="field">\n                  <span> (Order)</span>\n                  <input v-model.number="selectedEntry.position.order" type="number" class="text-input" step="1" />\n                </label>\n                <div class="editor-grid two-cols">\n                  <label class="field" :class="{ disabled: selectedEntry.position.type !== \'at_depth\' }">\n                    <span>at_depth role</span>\n                    <select v-model="selectedEntry.position.role" class="text-input" :disabled="selectedEntry.position.type !== \'at_depth\'">\n                      <option value="system">system</option>\n                      <option value="assistant">assistant</option>\n                      <option value="user">user</option>\n                    </select>\n                  </label>\n                  <label class="field" :class="{ disabled: selectedEntry.position.type !== \'at_depth\' }">\n                    <span>at_depth depth</span>\n                    <input v-model.number="selectedEntry.position.depth" type="number" class="text-input" min="1" step="1" :disabled="selectedEntry.position.type !== \'at_depth\'" />\n                  </label>\n                </div>\n              </article>\n              <article class="editor-card">\n                <h4> (RECURSION)</h4>\n                <label class="field checkbox-inline">\n                  <input v-model="selectedEntry.recursion.prevent_incoming" type="checkbox" />\n                  <span></span>\n                </label>\n                <label class="field checkbox-inline">\n                  <input v-model="selectedEntry.recursion.prevent_outgoing" type="checkbox" />\n                  <span></span>\n                </label>\n              </article>\n              <details class="editor-advanced">\n                <summary> / extra JSON</summary>\n                <label class="field">\n                  <span>extra JSON</span>\n                  <textarea v-model="selectedExtraText" class="text-area compact" placeholder="{ ... }"></textarea>\n                </label>\n                <div class="field-actions">\n                  <button class="btn" type="button" @click="applyExtraJson"> extra</button>\n                  <button class="btn" type="button" @click="clearExtra"> extra</button>\n                </div>\n              </details>\n              <div class="mobile-danger-zone">\n                <button class="btn danger" type="button" @click="removeSelectedEntry"> </button>\n                <button class="btn" type="button" @click="duplicateSelectedEntry"> </button>\n              </div>\n            </template>\n            <div v-else class="empty-block"></div>\n          </div>\n\n          \x3c!-- Tab: AI --\x3e\n          <div v-show="mobileTab === \'ai\'" class="mobile-pane">\n            <section class="ai-generator-panel mobile-ai-panel">\n              <div class="ai-chat-area">\n                <div v-if="!aiActiveSession" class="ai-chat-empty">\n                  <div class="ai-chat-empty-icon"></div>\n                  <div class="ai-chat-empty-text"></div>\n                  <button class="btn" type="button" @click="aiCreateSession">+ </button>\n                </div>\n                <template v-else>\n                  <div class="ai-chat-messages" ref="aiChatMessagesRef">\n                    <div v-for="(msg, idx) in aiActiveMessages" :key="`mmsg-${idx}`" class="ai-chat-bubble" :class="msg.role">\n                      <div class="ai-chat-bubble-role">{{ msg.role === \'user\' ? \' \' : \' AI\' }}</div>\n                      <div class="ai-chat-bubble-content">{{ msg.content }}</div>\n                    </div>\n                    <div v-if="aiIsGenerating && aiStreamingText" class="ai-chat-bubble assistant streaming">\n                      <div class="ai-chat-bubble-role"> AI</div>\n                      <div class="ai-chat-bubble-content">{{ aiStreamingText }}<span class="ai-cursor"></span></div>\n                    </div>\n                    <div v-if="aiIsGenerating && !aiStreamingText" class="ai-chat-bubble assistant streaming">\n                      <div class="ai-chat-bubble-role"> AI</div>\n                      <div class="ai-chat-bubble-content"><span class="ai-thinking">...</span></div>\n                    </div>\n                  </div>\n                  <div class="ai-chat-input-bar">\n                    <label class="ai-context-toggle" title="AI ">\n                      <input v-model="aiUseContext" type="checkbox" />\n                      <span>{{ aiUseContext ? \' \' : \' \' }}</span>\n                    </label>\n                    <textarea v-model="aiChatInputText" class="text-input ai-chat-input" placeholder="..." rows="2" :disabled="aiIsGenerating" @keydown.enter.exact.prevent="aiSendMessage"></textarea>\n                    <button v-if="!aiIsGenerating" class="btn ai-send-btn" type="button" :disabled="!aiChatInputText.trim()" @click="aiSendMessage"></button>\n                    <button v-else class="btn danger ai-stop-btn" type="button" @click="aiStopGeneration"></button>\n                  </div>\n                </template>\n              </div>\n            </section>\n          </div>\n\n        </div>\n      </div>\n      \x3c!-- Tab Bar: bottom, direct child of wb-assistant-root via fragment --\x3e\n      <div style="display:flex !important;flex-shrink:0;height:52px;background:#1e293b;border-top:1px solid #334155;z-index:99999;">\n        <button @click="mobileTab = \'list\'" :style="{ flex:1,display:\'flex\',flexDirection:\'column\',alignItems:\'center\',justifyContent:\'center\',border:\'none\',borderTop: mobileTab===\'list\' ? \'2px solid #60a5fa\' : \'2px solid transparent\',background:\'transparent\',color: mobileTab===\'list\' ? \'#e2e8f0\' : \'#94a3b8\',fontSize:\'10px\',padding:\'4px 0\',gap:\'2px\' }">\n          <span style="font-size:20px;"></span><span></span>\n        </button>\n        <button @click="mobileTab = \'edit\'" :style="{ flex:1,display:\'flex\',flexDirection:\'column\',alignItems:\'center\',justifyContent:\'center\',border:\'none\',borderTop: mobileTab===\'edit\' ? \'2px solid #60a5fa\' : \'2px solid transparent\',background:\'transparent\',color: mobileTab===\'edit\' ? \'#e2e8f0\' : \'#94a3b8\',fontSize:\'10px\',padding:\'4px 0\',gap:\'2px\' }">\n          <span style="font-size:20px;"></span><span></span>\n        </button>\n        <button @click="mobileTab = \'settings\'" :style="{ flex:1,display:\'flex\',flexDirection:\'column\',alignItems:\'center\',justifyContent:\'center\',border:\'none\',borderTop: mobileTab===\'settings\' ? \'2px solid #60a5fa\' : \'2px solid transparent\',background:\'transparent\',color: mobileTab===\'settings\' ? \'#e2e8f0\' : \'#94a3b8\',fontSize:\'10px\',padding:\'4px 0\',gap:\'2px\' }">\n          <span style="font-size:20px;"></span><span></span>\n        </button>\n        <button @click="mobileTab = \'ai\'" :style="{ flex:1,display:\'flex\',flexDirection:\'column\',alignItems:\'center\',justifyContent:\'center\',border:\'none\',borderTop: mobileTab===\'ai\' ? \'2px solid #60a5fa\' : \'2px solid transparent\',background:\'transparent\',color: mobileTab===\'ai\' ? \'#e2e8f0\' : \'#94a3b8\',fontSize:\'10px\',padding:\'4px 0\',gap:\'2px\' }">\n          <span style="font-size:20px;"></span><span>AI</span>\n        </button>\n      </div>\n    </template>\n\n    \x3c!--  Desktop Layout  --\x3e\n    <template v-if="!isMobile">\n    <section class="wb-toolbar">\n            <label class="toolbar-label">\n              <span></span>\n              <div ref="worldbookPickerRef" class="worldbook-picker">\n                <button class="worldbook-picker-trigger" type="button" @click="toggleWorldbookPicker">\n                  <span class="worldbook-picker-trigger-text" :title="selectedWorldbookName || \'\'">\n                    {{ selectedWorldbookName || \'\' }}\n                  </span>\n                  <span class="worldbook-picker-trigger-arrow">{{ worldbookPickerOpen ? \'\' : \'\' }}</span>\n                </button>\n                <div v-if="worldbookPickerOpen" class="worldbook-picker-dropdown">\n                  <input\n                    ref="worldbookPickerSearchInputRef"\n                    v-model="worldbookPickerSearchText"\n                    type="text"\n                    class="text-input worldbook-picker-search"\n                    placeholder="..."\n                    @keydown.enter.prevent="filteredSelectableWorldbookNames[0] && selectWorldbookFromPicker(filteredSelectableWorldbookNames[0])"\n                  />\n                  <div class="worldbook-picker-list">\n                    <button\n                      v-for="name in filteredSelectableWorldbookNames"\n                      :key="`worldbook-${name}`"\n                      class="worldbook-picker-item"\n                      :class="{ active: name === selectedWorldbookName }"\n                      type="button"\n                      @click="selectWorldbookFromPicker(name)"\n                    >\n                      {{ name }}\n                    </button>\n                    <div v-if="!filteredSelectableWorldbookNames.length" class="empty-note"></div>\n                  </div>\n                </div>\n              </div>\n            </label>\n            <button class="btn" type="button" @click="createNewWorldbook"></button>\n            <button class="btn" type="button" :disabled="!selectedWorldbookName" @click="duplicateWorldbook">\n              \n            </button>\n            <button class="btn danger" type="button" :disabled="!selectedWorldbookName" @click="deleteCurrentWorldbook">\n              \n            </button>\n            <button class="btn" type="button" :disabled="!selectedWorldbookName" @click="exportCurrentWorldbook">\n              \n            </button>\n            <button class="btn" type="button" @click="triggerImport"></button>\n            <input\n              ref="importFileInput"\n              class="hidden-input"\n              type="file"\n              accept=".json,application/json"\n              @change="onImportChange"\n            />\n          </section>\n\n          <div class="wb-scroll-area">\n          <section class="wb-bindings">\n            <div class="wb-history-shortcuts">\n              <button\n                class="btn history-btn utility-btn"\n                type="button"\n                :class="{ active: globalWorldbookMode }"\n                @click="toggleGlobalMode"\n              >\n                 \n              </button>\n              <button class="btn history-btn" type="button" :disabled="!selectedEntry" @click="openEntryHistoryModal">\n                 \n              </button>\n              <button\n                class="btn history-btn"\n                type="button"\n                :disabled="!selectedWorldbookName"\n                @click="openWorldbookHistoryModal"\n              >\n                 \n              </button>\n              <button\n                class="btn history-btn utility-btn"\n                type="button"\n                :class="{ active: floatingPanels.find.visible }"\n                :disabled="!draftEntries.length"\n                @click="toggleFloatingPanel(\'find\')"\n              >\n                 \n              </button>\n              <button\n                class="btn history-btn utility-btn"\n                type="button"\n                :class="{ active: floatingPanels.activation.visible }"\n                @click="toggleFloatingPanel(\'activation\')"\n              >\n                 \n              </button>\n              <button\n                class="btn history-btn utility-btn"\n                type="button"\n                :class="{ active: aiGeneratorMode }"\n                @click="aiToggleMode"\n              >\n                 AI \n              </button>\n            </div>\n            <div v-if="globalWorldbookMode" class="global-mode-panel">\n              <div class="global-mode-head">\n                <span class="global-mode-title">{{ bindings.global.length }}</span>\n                <button class="btn mini danger" type="button" :disabled="!bindings.global.length" @click="clearGlobalWorldbooks">\n                  \n                </button>\n              </div>\n              <div class="global-preset-panel">\n                <label class="field">\n                  <span></span>\n                  <select v-model="selectedGlobalPresetId" class="text-input" @change="onGlobalPresetSelectionChanged">\n                    <option value=""></option>\n                    <option v-for="preset in globalWorldbookPresets" :key="preset.id" :value="preset.id">\n                      {{ preset.name }}{{ preset.worldbooks.length }}\n                    </option>\n                  </select>\n                </label>\n                <div class="global-mode-actions">\n                  <button class="btn" type="button" :disabled="!bindings.global.length" @click="saveCurrentAsGlobalPreset">\n                    \n                  </button>\n                  <button class="btn" type="button" :disabled="!selectedGlobalPreset" @click="overwriteSelectedGlobalPreset">\n                    \n                  </button>\n                  <button class="btn danger" type="button" :disabled="!selectedGlobalPreset" @click="deleteSelectedGlobalPreset">\n                    \n                  </button>\n                </div>\n                <div class="preset-role-panel">\n                  <div class="preset-role-head">\n                    <span></span>\n                    <span class="preset-role-current" :class="{ empty: !currentRoleContext }">\n                      {{ currentRoleContext ? `: ${currentRoleContext.name}` : \'\' }}\n                    </span>\n                  </div>\n                  <div class="preset-role-actions">\n                    <button\n                      class="btn mini"\n                      type="button"\n                      :disabled="!selectedGlobalPreset || !currentRoleContext"\n                      @click="bindCurrentRoleToSelectedPreset"\n                    >\n                      \n                    </button>\n                    <button\n                      class="btn mini"\n                      type="button"\n                      :disabled="!selectedGlobalPreset || !isCurrentRoleBoundToSelectedPreset"\n                      @click="unbindCurrentRoleFromSelectedPreset"\n                    >\n                      \n                    </button>\n                  </div>\n                  <div ref="rolePickerRef" class="role-picker">\n                    <button\n                      class="role-picker-trigger"\n                      type="button"\n                      :disabled="!selectedGlobalPreset"\n                      @click="toggleRolePicker"\n                    >\n                      <span class="role-picker-trigger-text">\n                        {{ selectedGlobalPreset ? \'\' : \'\' }}\n                      </span>\n                      <span class="role-picker-trigger-arrow">{{ rolePickerOpen ? \'\' : \'\' }}</span>\n                    </button>\n                    <div v-if="rolePickerOpen" class="role-picker-dropdown">\n                      <input\n                        ref="rolePickerSearchInputRef"\n                        v-model="roleBindSearchText"\n                        type="text"\n                        class="text-input role-picker-search"\n                        placeholder=" / avatar..."\n                        @keydown.enter.prevent="bindFirstRoleCandidate"\n                      />\n                      <div class="role-picker-list">\n                        <button\n                          v-for="candidate in roleBindingCandidates"\n                          :key="`role-candidate-${candidate.key}`"\n                          class="role-picker-item"\n                          type="button"\n                          :disabled="candidate.bound"\n                          @click="bindRoleCandidateToSelectedPreset(candidate)"\n                        >\n                          <span class="name">{{ candidate.name }}</span>\n                          <span class="meta">{{ candidate.bound ? \'\' : \'\' }}</span>\n                        </button>\n                        <div v-if="!roleBindingCandidates.length" class="empty-note"></div>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="preset-role-tags">\n                    <button\n                      v-for="binding in selectedGlobalPresetRoleBindings"\n                      :key="`binding-${selectedGlobalPreset?.id}-${binding.key}`"\n                      class="preset-role-tag"\n                      type="button"\n                      :title="`: ${binding.name}`"\n                      @click="removeRoleBindingFromSelectedPreset(binding.key)"\n                    >\n                      <span>{{ binding.name }}</span>\n                      <span class="remove"></span>\n                    </button>\n                    <div v-if="selectedGlobalPreset && !selectedGlobalPresetRoleBindings.length" class="empty-note">\n                      \n                    </div>\n                    <div v-if="!selectedGlobalPreset" class="empty-note"></div>\n                  </div>\n                </div>\n              </div>\n              <div class="global-mode-grid">\n                <div class="global-mode-column">\n                  <label class="field">\n                    <span></span>\n                    <input\n                      v-model="globalAddSearchText"\n                      type="text"\n                      class="text-input"\n                      placeholder="..."\n                      @keydown.enter.prevent="addFirstGlobalCandidate"\n                    />\n                  </label>\n                  <div class="global-mode-list">\n                    <button\n                      v-for="name in globalAddCandidates"\n                      :key="`add-${name}`"\n                      class="global-mode-item add"\n                      type="button"\n                      @click="addGlobalWorldbook(name)"\n                    >\n                      <span class="global-mode-item-name">{{ name }}</span>\n                      <span class="global-mode-item-action"></span>\n                    </button>\n                    <div v-if="!globalAddCandidates.length" class="empty-note"></div>\n                  </div>\n                </div>\n                <div class="global-mode-column">\n                  <label class="field">\n                    <span></span>\n                    <input\n                      v-model="globalFilterText"\n                      type="text"\n                      class="text-input"\n                      placeholder="..."\n                    />\n                  </label>\n                  <div class="global-mode-list">\n                    <button\n                      v-for="name in filteredGlobalWorldbooks"\n                      :key="`global-${name}`"\n                      class="global-mode-item active"\n                      type="button"\n                      @click="removeGlobalWorldbook(name)"\n                    >\n                      <span class="global-mode-item-name">{{ name }}</span>\n                      <span class="global-mode-item-action"></span>\n                    </button>\n                    <div v-if="!filteredGlobalWorldbooks.length" class="empty-note">\n                      {{ bindings.global.length ? \'\' : \'\' }}\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class="global-mode-actions">\n                <button class="btn" type="button" :disabled="!selectedWorldbookName" @click="toggleGlobalBinding">\n                  {{ isGlobalBound ? \'\' : \'\' }}\n                </button>\n              </div>\n            </div>\n          </section>\n\n          \x3c!--  AI Generator Panel  --\x3e\n          <section v-if="aiGeneratorMode" class="ai-generator-panel">\n            <div class="ai-sidebar">\n              <div class="ai-sidebar-head">\n                <span class="ai-sidebar-title"></span>\n                <button class="btn mini" type="button" @click="aiCreateSession">+ </button>\n              </div>\n              <div class="ai-session-list">\n                <button\n                  v-for="session in aiSessions"\n                  :key="session.id"\n                  class="ai-session-item"\n                  :class="{ active: session.id === aiActiveSession?.id }"\n                  type="button"\n                  @click="aiSwitchSession(session.id)"\n                >\n                  <span class="ai-session-title">{{ session.title }}</span>\n                  <span class="ai-session-meta">{{ session.messages.length }} </span>\n                  <button\n                    class="ai-session-delete"\n                    type="button"\n                    title=""\n                    @click.stop="aiDeleteSession(session.id)"\n                  ></button>\n                </button>\n                <div v-if="!aiSessions.length" class="empty-note"></div>\n              </div>\n            </div>\n            <div class="ai-chat-area">\n              <div v-if="!aiActiveSession" class="ai-chat-empty">\n                <div class="ai-chat-empty-icon"></div>\n                <div class="ai-chat-empty-text"></div>\n              </div>\n              <template v-else>\n                <div class="ai-chat-messages" ref="aiChatMessagesRef">\n                  <div\n                    v-for="(msg, idx) in aiActiveMessages"\n                    :key="`msg-${idx}`"\n                    class="ai-chat-bubble"\n                    :class="msg.role"\n                  >\n                    <div class="ai-chat-bubble-role">{{ msg.role === \'user\' ? \' \' : \' AI\' }}</div>\n                    <div class="ai-chat-bubble-content">{{ msg.content }}</div>\n                  </div>\n                  <div v-if="aiIsGenerating && aiStreamingText" class="ai-chat-bubble assistant streaming">\n                    <div class="ai-chat-bubble-role"> AI</div>\n                    <div class="ai-chat-bubble-content">{{ aiStreamingText }}<span class="ai-cursor"></span></div>\n                  </div>\n                  <div v-if="aiIsGenerating && !aiStreamingText" class="ai-chat-bubble assistant streaming">\n                    <div class="ai-chat-bubble-role"> AI</div>\n                    <div class="ai-chat-bubble-content"><span class="ai-thinking">...</span></div>\n                  </div>\n                </div>\n                <div class="ai-chat-input-bar">\n                  <label class="ai-context-toggle" title="AI ">\n                    <input v-model="aiUseContext" type="checkbox" />\n                    <span>{{ aiUseContext ? \' \' : \' \' }}</span>\n                  </label>\n                  <textarea\n                    v-model="aiChatInputText"\n                    class="text-input ai-chat-input"\n                    placeholder=" AI ..."\n                    rows="2"\n                    :disabled="aiIsGenerating"\n                    @keydown.enter.exact.prevent="aiSendMessage"\n                  ></textarea>\n                  <button\n                    v-if="!aiIsGenerating"\n                    class="btn ai-send-btn"\n                    type="button"\n                    :disabled="!aiChatInputText.trim()"\n                    @click="aiSendMessage"\n                  ></button>\n                  <button\n                    v-else\n                    class="btn danger ai-stop-btn"\n                    type="button"\n                    @click="aiStopGeneration"\n                  ></button>\n                </div>\n              </template>\n            </div>\n          </section>\n\n          \x3c!--  Tag Review Modal  --\x3e\n          <div v-if="aiShowTagReview" class="ai-tag-review-overlay" @click.self="aiShowTagReview = false">\n            <div class="ai-tag-review-modal">\n              <div class="ai-tag-review-head">\n                <span class="ai-tag-review-title"> {{ aiExtractedTags.length }}</span>\n                <button class="ai-tag-review-close" type="button" @click="aiShowTagReview = false"></button>\n              </div>\n              <div class="ai-tag-review-target">\n                <label class="field">\n                  <span></span>\n                  <select v-model="aiTargetWorldbook" class="text-input">\n                    <option value=""></option>\n                    <option v-for="name in worldbookNames" :key="`ai-wb-${name}`" :value="name">{{ name }}</option>\n                  </select>\n                </label>\n              </div>\n              <div class="ai-tag-list">\n                <label\n                  v-for="(tag, idx) in aiExtractedTags"\n                  :key="`tag-${idx}`"\n                  class="ai-tag-item"\n                >\n                  <input v-model="tag.selected" type="checkbox" />\n                  <div class="ai-tag-info">\n                    <span class="ai-tag-name">{{ tag.tag }}</span>\n                    <span class="ai-tag-preview">{{ tag.content.slice(0, 120) }}{{ tag.content.length > 120 ? \'...\' : \'\' }}</span>\n                  </div>\n                </label>\n              </div>\n              <div class="ai-tag-review-actions">\n                <button class="btn" type="button" @click="aiExtractedTags.forEach(t => t.selected = true)"></button>\n                <button class="btn" type="button" @click="aiExtractedTags.forEach(t => t.selected = false)"></button>\n                <button\n                  class="btn primary"\n                  type="button"\n                  :disabled="!aiTargetWorldbook || !aiExtractedTags.some(t => t.selected)"\n                  @click="aiCreateSelectedEntries"\n                >{{ aiExtractedTags.filter(t => t.selected).length }}</button>\n              </div>\n            </div>\n          </div>\n\n          <section v-show="!aiGeneratorMode" ref="mainLayoutRef" class="wb-main-layout" :style="mainLayoutStyle">\n            <aside v-show="!showMobileEditor" class="wb-entry-list">\n              <div class="list-search">\n                <input v-model="searchText" type="text" class="text-input" placeholder=" /  / " />\n                <label class="checkbox-inline">\n                  <input v-model="onlyEnabled" type="checkbox" />\n                  <span></span>\n                </label>\n              </div>\n              <div class="list-summary">\n                 {{ filteredEntries.length }} / {{ draftEntries.length }} |  {{ enabledEntryCount }}\n              </div>\n              <div class="list-scroll">\n                <button\n                  v-for="entry in filteredEntries"\n                  :key="entry.uid"\n                  type="button"\n                  class="entry-item"\n                  :data-status="getEntryVisualStatus(entry)"\n                  :class="{\n                    selected: entry.uid === selectedEntryUid,\n                    disabled: !entry.enabled,\n                  }"\n                  @click="selectEntry(entry.uid)"\n                >\n                  <div class="entry-item-head">\n                    <span class="entry-status-dot" :data-status="getEntryVisualStatus(entry)"></span>\n                    <div class="entry-item-title">{{ entry.name || ` ${entry.uid}` }}</div>\n                    <span class="entry-chip uid">#{{ entry.uid }}</span>\n                  </div>\n                  <div class="entry-item-tags">\n                    <span class="entry-chip status" :data-status="getEntryVisualStatus(entry)">\n                      {{ getEntryStatusLabel(entry) }}\n                    </span>\n                    <span class="entry-chip"> {{ entry.strategy.keys.length }}</span>\n                    <span class="entry-chip"> {{ entry.probability }}</span>\n                    <span class="entry-chip mono">#{{ entry.position.order }}</span>\n                  </div>\n                  <div class="entry-item-preview">{{ getEntryKeyPreview(entry) }}</div>\n                </button>\n              </div>\n              <div class="list-actions">\n                <button class="btn" type="button" :disabled="!selectedWorldbookName" @click="addEntry"></button>\n                <button class="btn" type="button" :disabled="!selectedEntry" @click="duplicateSelectedEntry">\n                  \n                </button>\n                <button class="btn danger" type="button" :disabled="!selectedEntry" @click="removeSelectedEntry">\n                  \n                </button>\n                <button class="btn" type="button" :disabled="!selectedEntry" @click="moveSelectedEntry(-1)">\n                  \n                </button>\n                <button class="btn" type="button" :disabled="!selectedEntry" @click="moveSelectedEntry(1)"></button>\n              </div>\n            </aside>\n            <div\n              v-show="!isMobile"\n              class="wb-resize-handle main"\n              :class="{ dragging: paneResizeState?.key === \'main\' }"\n              @pointerdown="startPaneResize(\'main\', $event)"\n            ></div>\n\n            <main v-show="!isMobile || showMobileEditor" class="wb-editor">\n              <template v-if="selectedEntry">\n                <div ref="editorShellRef" class="wb-editor-shell" :style="editorShellStyle">\n                  <section class="editor-center">\n                    <header class="editor-head">\n                      <div v-if="isMobile" class="editor-back-btn" @click="goBackToList">\n                         \n                      </div>\n                      <label class="field editor-comment">\n                        <span> (COMMENT)</span>\n                        <input v-model="selectedEntry.name" type="text" class="text-input" />\n                      </label>\n                      <div class="editor-badges">\n                        <span class="editor-badge" :class="selectedEntry.enabled ? \'on\' : \'off\'">\n                          {{ selectedEntry.enabled ? \'EN\' : \'OFF\' }}\n                        </span>\n                        <span class="editor-badge strategy" :data-status="getEntryVisualStatus(selectedEntry)">\n                          {{ getEntryStatusLabel(selectedEntry) }}\n                        </span>\n                        <span class="editor-badge mono">#{{ selectedEntry.uid }}</span>\n                        <span class="editor-badge mono">Chars {{ selectedContentChars }}</span>\n                        <span class="editor-badge mono">~{{ selectedTokenEstimate }}T</span>\n                      </div>\n                    </header>\n\n                    <section class="editor-grid two-cols editor-keyword-grid">\n                      <label class="field">\n                        <span> (KEYS)</span>\n                        <textarea v-model="selectedKeysText" class="text-area compact"></textarea>\n                      </label>\n                      <label class="field">\n                        <span> (SECONDARY)</span>\n                        <textarea v-model="selectedSecondaryKeysText" class="text-area compact"></textarea>\n                      </label>\n                    </section>\n\n                    <section class="editor-content-block">\n                      <div class="editor-content-title"> /  (CONTENT)</div>\n                      <textarea\n                        ref="contentTextareaRef"\n                        v-model="selectedEntry.content"\n                        class="text-area large editor-content-area"\n                      ></textarea>\n                      <div\n                        class="content-resize-handle"\n                        @pointerdown="startContentResize"\n                      >\n                        <span class="content-resize-grip"></span>\n                      </div>\n                    </section>\n\n                    <details class="editor-advanced">\n                      <summary> / extra JSON</summary>\n                      <label class="field">\n                        <span>extra JSON</span>\n                        <textarea v-model="selectedExtraText" class="text-area compact" placeholder="{ ... }"></textarea>\n                      </label>\n                      <div class="field-actions">\n                        <button class="btn" type="button" @click="applyExtraJson"> extra</button>\n                        <button class="btn" type="button" @click="clearExtra"> extra</button>\n                      </div>\n                    </details>\n                  </section>\n                  <div\n                    v-show="!isMobile"\n                    class="wb-resize-handle editor"\n                    :class="{ dragging: paneResizeState?.key === \'editor\' }"\n                    @pointerdown="startPaneResize(\'editor\', $event)"\n                  ></div>\n\n                  <aside class="editor-side">\n                    <article class="editor-card">\n                      <h4> (STRATEGY)</h4>\n                      <label class="field checkbox-inline">\n                        <input v-model="selectedEntry.enabled" type="checkbox" />\n                        <span></span>\n                      </label>\n                      <div class="strategy-switch">\n                        <button\n                          type="button"\n                          class="strategy-pill constant"\n                          :class="{ active: selectedEntry.strategy.type === \'constant\' }"\n                          @click="selectedEntry.strategy.type = \'constant\'"\n                        >\n                            (Constant)\n                        </button>\n                        <button\n                          type="button"\n                          class="strategy-pill vector"\n                          :class="{ active: selectedEntry.strategy.type === \'vectorized\' }"\n                          @click="selectedEntry.strategy.type = \'vectorized\'"\n                        >\n                            (Vector)\n                        </button>\n                        <button\n                          type="button"\n                          class="strategy-pill selective"\n                          :class="{ active: selectedEntry.strategy.type === \'selective\' }"\n                          @click="selectedEntry.strategy.type = \'selective\'"\n                        >\n                            (Selective)\n                        </button>\n                      </div>\n                      <details class="editor-advanced">\n                        <summary></summary>\n                        <label class="field">\n                          <span> (LOGIC)</span>\n                          <select v-model="selectedEntry.strategy.keys_secondary.logic" class="text-input">\n                            <option v-for="item in secondaryLogicOptions" :key="item" :value="item">\n                              {{ getSecondaryLogicLabel(item) }}\n                            </option>\n                          </select>\n                        </label>\n                        <label class="field">\n                          <span></span>\n                          <input\n                            v-model="selectedScanDepthText"\n                            type="text"\n                            class="text-input"\n                            placeholder=" same_as_global"\n                          />\n                        </label>\n                        <label class="field">\n                          <span>(0-100)</span>\n                          <input\n                            v-model.number="selectedEntry.probability"\n                            type="number"\n                            class="text-input"\n                            min="0"\n                            max="100"\n                            step="1"\n                          />\n                        </label>\n                      </details>\n                    </article>\n\n                    <article class="editor-card">\n                      <h4> (INSERTION)</h4>\n                      <label class="field">\n                        <span> (Position)</span>\n                        <select\n                          v-model="selectedEntry.position.type"\n                          class="text-input"\n                          @change="handleSelectedPositionTypeChanged"\n                        >\n                          <option v-for="item in positionTypeOptions" :key="item" :value="item">\n                            {{ getPositionTypeLabel(item) }}\n                          </option>\n                        </select>\n                      </label>\n                      <label class="field">\n                        <span> (Order)</span>\n                        <input v-model.number="selectedEntry.position.order" type="number" class="text-input" step="1" />\n                      </label>\n                      <div class="editor-grid two-cols">\n                        <label class="field" :class="{ disabled: selectedEntry.position.type !== \'at_depth\' }">\n                          <span>at_depth role</span>\n                          <select\n                            v-model="selectedEntry.position.role"\n                            class="text-input"\n                            :disabled="selectedEntry.position.type !== \'at_depth\'"\n                          >\n                            <option value="system">system</option>\n                            <option value="assistant">assistant</option>\n                            <option value="user">user</option>\n                          </select>\n                        </label>\n                        <label class="field" :class="{ disabled: selectedEntry.position.type !== \'at_depth\' }">\n                          <span>at_depth depth</span>\n                          <input\n                            v-model.number="selectedEntry.position.depth"\n                            type="number"\n                            class="text-input"\n                            min="1"\n                            step="1"\n                            :disabled="selectedEntry.position.type !== \'at_depth\'"\n                          />\n                        </label>\n                      </div>\n                    </article>\n\n                    <article class="editor-card">\n                      <h4> (RECURSION)</h4>\n                      <label class="field checkbox-inline">\n                        <input v-model="selectedEntry.recursion.prevent_incoming" type="checkbox" />\n                        <span> (Exclude Incoming)</span>\n                      </label>\n                      <label class="field checkbox-inline">\n                        <input v-model="selectedEntry.recursion.prevent_outgoing" type="checkbox" />\n                        <span> (Prevent Outgoing)</span>\n                      </label>\n                      <label class="field">\n                        <span></span>\n                        <input\n                          v-model="selectedRecursionDelayText"\n                          type="text"\n                          class="text-input"\n                          placeholder=" null"\n                        />\n                      </label>\n                      <div class="editor-grid two-cols">\n                        <label class="field">\n                          <span>sticky</span>\n                          <input\n                            v-model="selectedStickyText"\n                            type="text"\n                            class="text-input"\n                            placeholder=" null"\n                          />\n                        </label>\n                        <label class="field">\n                          <span>cooldown</span>\n                          <input\n                            v-model="selectedCooldownText"\n                            type="text"\n                            class="text-input"\n                            placeholder=" null"\n                          />\n                        </label>\n                      </div>\n                      <label class="field">\n                        <span>delay</span>\n                        <input\n                          v-model="selectedEffectDelayText"\n                          type="text"\n                          class="text-input"\n                          placeholder=" null"\n                        />\n                      </label>\n                    </article>\n                  </aside>\n                </div>\n              </template>\n              <template v-else>\n                <div class="empty-block"></div>\n              </template>\n            </main>\n          </section>\n          </div>\n\n          <footer class="wb-status">\n            <span>{{ isBusy ? \'...\' : statusMessage }}</span>\n            <span>\n              : {{ draftEntries.length }} | : {{ totalContentChars }} |\n              {{ hasUnsavedChanges ? \'\' : \'\' }}\n            </span>\n          </footer>\n    </template>\n    \x3c!--  End Desktop Layout  --\x3e\n\n          <div v-if="showEntryHistoryModal" class="wb-modal-backdrop" @click.self="showEntryHistoryModal = false">\n            <div class="wb-history-modal">\n              <div class="wb-history-modal-header">\n                <div>\n                  <strong> </strong>\n                  <span>{{ entryHistorySummary }}</span>\n                </div>\n                <div class="wb-history-modal-actions">\n                  <button class="btn mini" type="button" :disabled="!selectedEntry" @click="createManualEntrySnapshot">\n                    \n                  </button>\n                  <button\n                    class="btn mini danger"\n                    type="button"\n                    :disabled="!entrySnapshotsForSelected.length"\n                    @click="clearCurrentEntrySnapshots"\n                  >\n                    \n                  </button>\n                  <button class="btn mini" type="button" @click="showEntryHistoryModal = false"></button>\n                </div>\n              </div>\n\n              <div class="wb-history-modal-main">\n                <aside class="wb-history-versions">\n                  <div class="wb-history-versions-title">L/R</div>\n                  <div class="wb-history-versions-scroll">\n                    <div v-for="ver in entryVersionViews" :key="ver.id" class="wb-history-version-item">\n                      <div class="wb-history-version-line">\n                        <strong>{{ formatHistoryOptionLabel(ver.label, ver.ts, ver.isCurrent) }}</strong>\n                        <div class="wb-history-lr">\n                          <button class="mini-lr" :class="{ active: entryHistoryLeftId === ver.id }" @click="entryHistoryLeftId = ver.id">L</button>\n                          <button class="mini-lr" :class="{ active: entryHistoryRightId === ver.id }" @click="entryHistoryRightId = ver.id">R</button>\n                        </div>\n                      </div>\n                      <span>{{ ver.name }}</span>\n                    </div>\n                    <div v-if="entryVersionViews.length <= 1" class="empty-note"></div>\n                  </div>\n                </aside>\n\n                <section class="wb-history-diff-wrap">\n                  <div class="wb-history-diff-head">\n                    <div>\n                      Left: {{ selectedEntryHistoryLeft ? formatHistoryOptionLabel(selectedEntryHistoryLeft.label, selectedEntryHistoryLeft.ts, selectedEntryHistoryLeft.isCurrent) : \'-\' }}\n                      |\n                      Right: {{ selectedEntryHistoryRight ? formatHistoryOptionLabel(selectedEntryHistoryRight.label, selectedEntryHistoryRight.ts, selectedEntryHistoryRight.isCurrent) : \'-\' }}\n                    </div>\n                    <button class="btn mini" type="button" :disabled="!canRestoreEntryFromLeft" @click="restoreEntryFromLeftHistory">\n                       Left\n                    </button>\n                  </div>\n                  <div class="wb-history-diff-grid">\n                    <div>\n                      <div class="wb-history-diff-title">Left</div>\n                      <div class="wb-history-diff-body" v-html="entryHistoryDiff.leftHtml"></div>\n                    </div>\n                    <div>\n                      <div class="wb-history-diff-title">Right</div>\n                      <div class="wb-history-diff-body" v-html="entryHistoryDiff.rightHtml"></div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            </div>\n          </div>\n\n          <div v-if="showWorldbookHistoryModal" class="wb-modal-backdrop" @click.self="showWorldbookHistoryModal = false">\n            <div class="wb-history-modal">\n              <div class="wb-history-modal-header">\n                <div>\n                  <strong> </strong>\n                  <span>{{ getWorldbookVersionDiffSummary(selectedWorldbookHistoryLeft, selectedWorldbookHistoryRight) }}</span>\n                </div>\n                <div class="wb-history-modal-actions">\n                  <button class="btn mini" type="button" :disabled="!selectedWorldbookName" @click="createManualSnapshot">\n                    \n                  </button>\n                  <button\n                    class="btn mini danger"\n                    type="button"\n                    :disabled="!snapshotsForCurrent.length"\n                    @click="clearCurrentSnapshots"\n                  >\n                    \n                  </button>\n                  <button class="btn mini" type="button" @click="showWorldbookHistoryModal = false"></button>\n                </div>\n              </div>\n\n              <div class="wb-history-modal-main">\n                <aside class="wb-history-versions">\n                  <div class="wb-history-versions-title">L/R</div>\n                  <div class="wb-history-versions-scroll">\n                    <div v-for="ver in worldbookVersionViews" :key="ver.id" class="wb-history-version-item">\n                      <div class="wb-history-version-line">\n                        <strong>{{ formatHistoryOptionLabel(ver.label, ver.ts, ver.isCurrent) }}</strong>\n                        <div class="wb-history-lr">\n                          <button class="mini-lr" :class="{ active: worldbookHistoryLeftId === ver.id }" @click="worldbookHistoryLeftId = ver.id">L</button>\n                          <button class="mini-lr" :class="{ active: worldbookHistoryRightId === ver.id }" @click="worldbookHistoryRightId = ver.id">R</button>\n                        </div>\n                      </div>\n                      <span>entries: {{ ver.entries.length }}</span>\n                    </div>\n                  </div>\n                </aside>\n\n                <section class="wb-history-diff-wrap">\n                  <div class="wb-history-diff-head">\n                    <div>\n                      Left: {{ selectedWorldbookHistoryLeft ? formatHistoryOptionLabel(selectedWorldbookHistoryLeft.label, selectedWorldbookHistoryLeft.ts, selectedWorldbookHistoryLeft.isCurrent) : \'-\' }}\n                      |\n                      Right: {{ selectedWorldbookHistoryRight ? formatHistoryOptionLabel(selectedWorldbookHistoryRight.label, selectedWorldbookHistoryRight.ts, selectedWorldbookHistoryRight.isCurrent) : \'-\' }}\n                    </div>\n                    <button\n                      class="btn mini"\n                      type="button"\n                      :disabled="!canRestoreWorldbookFromLeft"\n                      @click="restoreWorldbookFromLeftHistory"\n                    >\n                       Left\n                    </button>\n                  </div>\n                  <div class="wb-history-diff-grid">\n                    <div>\n                      <div class="wb-history-diff-title">Left</div>\n                      <div class="wb-history-diff-body" v-html="worldbookHistoryDiff.leftHtml"></div>\n                    </div>\n                    <div>\n                      <div class="wb-history-diff-title">Right</div>\n                      <div class="wb-history-diff-body" v-html="worldbookHistoryDiff.rightHtml"></div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            </div>\n          </div>\n\n          <div\n            v-if="floatingPanels.find.visible"\n            class="wb-floating-window find-window"\n            :style="getFloatingPanelStyle(\'find\')"\n            @pointerdown="bringFloatingToFront(\'find\')"\n          >\n            <div class="wb-floating-header" @pointerdown="startFloatingDrag(\'find\', $event)">\n              <strong> </strong>\n              <div class="wb-floating-header-actions">\n                <button\n                  class="btn mini"\n                  type="button"\n                  :disabled="!draftEntries.length"\n                  @pointerdown.stop\n                  @click="findFirstMatch"\n                >\n                  \n                </button>\n                <button\n                  class="btn mini"\n                  type="button"\n                  :disabled="!draftEntries.length"\n                  @pointerdown.stop\n                  @click="findPreviousMatch"\n                >\n                  \n                </button>\n                <button\n                  class="btn mini"\n                  type="button"\n                  :disabled="!draftEntries.length"\n                  @pointerdown.stop\n                  @click="findNextMatch"\n                >\n                  \n                </button>\n                <button\n                  class="btn mini"\n                  type="button"\n                  :disabled="!draftEntries.length"\n                  @pointerdown.stop\n                  @click="applyBatchReplace"\n                >\n                  \n                </button>\n                <button class="btn mini danger" type="button" @pointerdown.stop @click="closeFloatingPanel(\'find\')">\n                  \n                </button>\n              </div>\n            </div>\n            <div class="wb-floating-body">\n              <div class="tool-line stacked">\n                <input v-model="batchFindText" type="text" class="text-input" placeholder=" / " />\n                <input v-model="batchReplaceText" type="text" class="text-input" placeholder="" />\n                <div class="find-scope-line">\n                  <label class="checkbox-inline">\n                    <input v-model="batchSearchScope" type="radio" value="all" />\n                    <span></span>\n                  </label>\n                  <label class="checkbox-inline">\n                    <input v-model="batchSearchScope" type="radio" value="current" :disabled="!selectedEntry" />\n                    <span></span>\n                  </label>\n                  <span class="find-summary-text">{{ findHitSummaryText }}</span>\n                </div>\n                <input\n                  v-model="batchExcludeText"\n                  type="text"\n                  class="text-input"\n                  placeholder="#UID /  /  / "\n                />\n                <div v-if="activeFindHit" class="find-active-hit">\n                  <strong>#{{ activeFindHit.entryUid }} {{ activeFindHit.entryName || ` ${activeFindHit.entryUid}` }}</strong>\n                  <span>{{ getFindFieldLabel(activeFindHit.field) }}  {{ activeFindHit.preview }}</span>\n                </div>\n                <div class="batch-exclude-note">\n                  : `#12, name:, content:{{user}}, keys:`//\n                </div>\n                <div v-if="batchExcludeTokensPreview.length" class="batch-exclude-chips">\n                  <span v-for="token in batchExcludeTokensPreview" :key="token" class="exclude-chip">{{ token }}</span>\n                </div>\n                <div class="find-flags">\n                  <label class="checkbox-inline">\n                    <input v-model="batchUseRegex" type="checkbox" />\n                    <span></span>\n                  </label>\n                  <label class="checkbox-inline">\n                    <input v-model="batchInName" type="checkbox" />\n                    <span></span>\n                  </label>\n                  <label class="checkbox-inline">\n                    <input v-model="batchInContent" type="checkbox" />\n                    <span></span>\n                  </label>\n                  <label class="checkbox-inline">\n                    <input v-model="batchInKeys" type="checkbox" />\n                    <span></span>\n                  </label>\n                </div>\n              </div>\n              <details class="tool-details">\n                <summary></summary>\n                <div class="tool-line">\n                  <button class="btn" type="button" :disabled="!draftEntries.length" @click="normalizeAllEntries">\n                    \n                  </button>\n                  <button class="btn" type="button" :disabled="!draftEntries.length" @click="sortEntriesByOrderDesc">\n                     order \n                  </button>\n                </div>\n                <div class="tool-line">\n                  <button class="btn" type="button" :disabled="!draftEntries.length" @click="setEnabledForAll(true)">\n                    \n                  </button>\n                  <button class="btn" type="button" :disabled="!draftEntries.length" @click="setEnabledForAll(false)">\n                    \n                  </button>\n                </div>\n              </details>\n            </div>\n          </div>\n\n          <div\n            v-if="floatingPanels.activation.visible"\n            class="wb-floating-window activation-window"\n            :style="getFloatingPanelStyle(\'activation\')"\n            @pointerdown="bringFloatingToFront(\'activation\')"\n          >\n            <div class="wb-floating-header" @pointerdown="startFloatingDrag(\'activation\', $event)">\n              <strong> WORLD_INFO_ACTIVATED</strong>\n              <div class="wb-floating-header-actions">\n                <button\n                  class="btn mini danger"\n                  type="button"\n                  :disabled="!activationLogs.length"\n                  @pointerdown.stop\n                  @click="clearActivationLogs"\n                >\n                  \n                </button>\n                <button\n                  class="btn mini danger"\n                  type="button"\n                  @pointerdown.stop\n                  @click="closeFloatingPanel(\'activation\')"\n                >\n                  \n                </button>\n              </div>\n            </div>\n            <div class="wb-floating-body">\n              <div class="tool-scroll">\n                <div v-for="log in activationLogs" :key="log.id" class="activation-item">\n                  <div class="activation-main">\n                    <strong>{{ log.world }}</strong>\n                    <span>#{{ log.uid }}  {{ log.name }}</span>\n                  </div>\n                  <div class="activation-sub">\n                    <span>{{ formatDateTime(log.time) }}</span>\n                    <span>{{ log.contentPreview }}</span>\n                  </div>\n                </div>\n                <div v-if="!activationLogs.length" class="empty-note"></div>\n              </div>\n            </div>\n          </div>\n  </div>\n</template>\n\n<script setup lang="ts">\nimport { diffLines } from \'https://testingcf.jsdelivr.net/npm/diff/+esm\';\nimport { klona } from \'klona\';\n\ntype StrategyType = WorldbookEntry[\'strategy\'][\'type\'];\ntype SecondaryLogic = WorldbookEntry[\'strategy\'][\'keys_secondary\'][\'logic\'];\ntype PositionType = WorldbookEntry[\'position\'][\'type\'];\ntype RoleType = WorldbookEntry[\'position\'][\'role\'];\ntype EntryVisualStatus = \'constant\' | \'vector\' | \'normal\' | \'disabled\';\ntype FloatingPanelKey = \'find\' | \'activation\';\ntype PaneResizeKey = \'main\' | \'editor\';\ntype BatchSearchScope = \'all\' | \'current\';\ntype FindFieldKey = \'name\' | \'content\' | \'keys\';\n\ninterface FloatingPanelState {\n  visible: boolean;\n  x: number;\n  y: number;\n  z: number;\n  width: number;\n}\n\ninterface PaneResizeState {\n  key: PaneResizeKey;\n  pointerId: number;\n  doc: Document;\n  win: Window;\n}\n\ntype ThemeKey = \'ocean\' | \'nebula\' | \'forest\' | \'sunset\' | \'coffee\' | \'paper\' | \'snow\';\n\nconst THEMES: Record<ThemeKey, { name: string; label: string; colors: Record<string, string> }> = {\n  ocean: {\n    name: \'Ocean (Deep)\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#0f172a\',\n      \'--wb-bg-panel\': \'#1e293b\',\n      \'--wb-text-main\': \'#f1f5f9\',\n      \'--wb-text-muted\': \'#94a3b8\',\n      \'--wb-primary\': \'#0ea5e9\',\n      \'--wb-primary-light\': \'#38bdf8\',\n      \'--wb-primary-hover\': \'rgba(56, 189, 248, 0.15)\',\n      \'--wb-primary-soft\': \'rgba(14, 165, 233, 0.15)\',\n      \'--wb-primary-glow\': \'rgba(14, 165, 233, 0.4)\',\n      \'--wb-input-bg\': \'rgba(0, 0, 0, 0.25)\',\n      \'--wb-input-bg-hover\': \'rgba(0, 0, 0, 0.35)\',\n      \'--wb-input-bg-focus\': \'rgba(0, 0, 0, 0.45)\',\n      \'--wb-border-subtle\': \'rgba(255, 255, 255, 0.08)\',\n      \'--wb-border-main\': \'rgba(255, 255, 255, 0.12)\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.5)\',\n      \'--wb-scrollbar-thumb\': \'rgba(255, 255, 255, 0.2)\',\n    },\n  },\n  nebula: {\n    name: \'Nebula (Dark)\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#170b25\',\n      \'--wb-bg-panel\': \'#261836\',\n      \'--wb-text-main\': \'#f3e8ff\',\n      \'--wb-text-muted\': \'#a855f7\',\n      \'--wb-primary\': \'#c084fc\',\n      \'--wb-primary-light\': \'#d8b4fe\',\n      \'--wb-primary-hover\': \'rgba(192, 132, 252, 0.15)\',\n      \'--wb-primary-soft\': \'rgba(168, 85, 247, 0.15)\',\n      \'--wb-primary-glow\': \'rgba(192, 132, 252, 0.4)\',\n      \'--wb-input-bg\': \'rgba(0, 0, 0, 0.25)\',\n      \'--wb-input-bg-hover\': \'rgba(0, 0, 0, 0.35)\',\n      \'--wb-input-bg-focus\': \'rgba(0, 0, 0, 0.45)\',\n      \'--wb-border-subtle\': \'rgba(255, 255, 255, 0.08)\',\n      \'--wb-border-main\': \'rgba(255, 255, 255, 0.12)\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.5)\',\n      \'--wb-scrollbar-thumb\': \'rgba(255, 255, 255, 0.2)\',\n    },\n  },\n  forest: {\n    name: \'Forest\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#051812\',\n      \'--wb-bg-panel\': \'#0d2b21\',\n      \'--wb-text-main\': \'#ecfdf5\',\n      \'--wb-text-muted\': \'#34d399\',\n      \'--wb-primary\': \'#10b981\',\n      \'--wb-primary-light\': \'#34d399\',\n      \'--wb-primary-hover\': \'rgba(16, 185, 129, 0.15)\',\n      \'--wb-primary-soft\': \'rgba(5, 150, 105, 0.15)\',\n      \'--wb-primary-glow\': \'rgba(16, 185, 129, 0.4)\',\n      \'--wb-input-bg\': \'rgba(0, 0, 0, 0.25)\',\n      \'--wb-input-bg-hover\': \'rgba(0, 0, 0, 0.35)\',\n      \'--wb-input-bg-focus\': \'rgba(0, 0, 0, 0.45)\',\n      \'--wb-border-subtle\': \'rgba(255, 255, 255, 0.08)\',\n      \'--wb-border-main\': \'rgba(255, 255, 255, 0.12)\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.5)\',\n      \'--wb-scrollbar-thumb\': \'rgba(255, 255, 255, 0.2)\',\n    },\n  },\n  sunset: {\n    name: \'Sunset\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#1a0f0f\',\n      \'--wb-bg-panel\': \'#2e1818\',\n      \'--wb-text-main\': \'#fff1f2\',\n      \'--wb-text-muted\': \'#fb7185\',\n      \'--wb-primary\': \'#fb923c\',\n      \'--wb-primary-light\': \'#fdba74\',\n      \'--wb-primary-hover\': \'rgba(251, 146, 60, 0.15)\',\n      \'--wb-primary-soft\': \'rgba(234, 88, 12, 0.15)\',\n      \'--wb-primary-glow\': \'rgba(251, 146, 60, 0.4)\',\n      \'--wb-input-bg\': \'rgba(0, 0, 0, 0.25)\',\n      \'--wb-input-bg-hover\': \'rgba(0, 0, 0, 0.35)\',\n      \'--wb-input-bg-focus\': \'rgba(0, 0, 0, 0.45)\',\n      \'--wb-border-subtle\': \'rgba(255, 255, 255, 0.08)\',\n      \'--wb-border-main\': \'rgba(255, 255, 255, 0.12)\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.5)\',\n      \'--wb-scrollbar-thumb\': \'rgba(255, 255, 255, 0.2)\',\n    },\n  },\n  coffee: {\n    name: \'Coffee\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#161009\',\n      \'--wb-bg-panel\': \'#291e16\',\n      \'--wb-text-main\': \'#fffbeb\',\n      \'--wb-text-muted\': \'#d97706\',\n      \'--wb-primary\': \'#fbbf24\',\n      \'--wb-primary-light\': \'#fcd34d\',\n      \'--wb-primary-hover\': \'rgba(251, 191, 36, 0.15)\',\n      \'--wb-primary-soft\': \'rgba(217, 119, 6, 0.15)\',\n      \'--wb-primary-glow\': \'rgba(251, 191, 36, 0.4)\',\n      \'--wb-input-bg\': \'rgba(0, 0, 0, 0.25)\',\n      \'--wb-input-bg-hover\': \'rgba(0, 0, 0, 0.35)\',\n      \'--wb-input-bg-focus\': \'rgba(0, 0, 0, 0.45)\',\n      \'--wb-border-subtle\': \'rgba(255, 255, 255, 0.08)\',\n      \'--wb-border-main\': \'rgba(255, 255, 255, 0.12)\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.5)\',\n      \'--wb-scrollbar-thumb\': \'rgba(255, 255, 255, 0.2)\',\n    },\n  },\n  paper: {\n    name: \'Paper (Light)\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#fbf9f5\',\n      \'--wb-bg-panel\': \'#f0eadd\',\n      \'--wb-text-main\': \'#4a3b32\',\n      \'--wb-text-muted\': \'#8c7b70\',\n      \'--wb-primary\': \'#d97706\',\n      \'--wb-primary-light\': \'#b45309\',\n      \'--wb-primary-hover\': \'rgba(217, 119, 6, 0.1)\',\n      \'--wb-primary-soft\': \'rgba(180, 83, 9, 0.1)\',\n      \'--wb-primary-glow\': \'rgba(217, 119, 6, 0.25)\',\n      \'--wb-input-bg\': \'#f7f3ec\',\n      \'--wb-input-bg-hover\': \'#f2ece2\',\n      \'--wb-input-bg-focus\': \'#ffffff\',\n      \'--wb-border-subtle\': \'rgba(74, 59, 50, 0.12)\',\n      \'--wb-border-main\': \'rgba(74, 59, 50, 0.2)\',\n      \'--wb-shadow-main\': \'0 8px 24px rgba(74, 59, 50, 0.12)\',\n      \'--wb-scrollbar-thumb\': \'rgba(74, 59, 50, 0.25)\',\n    },\n  },\n  snow: {\n    name: \'Snow (Light)\',\n    label: \'\',\n    colors: {\n      \'--wb-bg-root\': \'#ffffff\',\n      \'--wb-bg-panel\': \'#f4f4f5\',\n      \'--wb-text-main\': \'#18181b\',\n      \'--wb-text-muted\': \'#71717a\',\n      \'--wb-primary\': \'#2563eb\',\n      \'--wb-primary-light\': \'#3b82f6\',\n      \'--wb-primary-hover\': \'rgba(37, 99, 235, 0.1)\',\n      \'--wb-primary-soft\': \'rgba(37, 99, 235, 0.08)\',\n      \'--wb-primary-glow\': \'rgba(37, 99, 235, 0.25)\',\n      \'--wb-input-bg\': \'#ffffff\',\n      \'--wb-input-bg-hover\': \'#fafafa\',\n      \'--wb-input-bg-focus\': \'#ffffff\',\n      \'--wb-border-subtle\': \'#e4e4e7\',\n      \'--wb-border-main\': \'#d4d4d8\',\n      \'--wb-shadow-main\': \'0 12px 28px rgba(0, 0, 0, 0.08)\',\n      \'--wb-scrollbar-thumb\': \'#a1a1aa\',\n    },\n  },\n};\n\ninterface WorldbookSnapshot {\n  id: string;\n  label: string;\n  ts: number;\n  entries: WorldbookEntry[];\n}\n\ninterface EntrySnapshot {\n  id: string;\n  label: string;\n  ts: number;\n  uid: number;\n  name: string;\n  entry: WorldbookEntry;\n}\n\ninterface EntryVersionView {\n  id: string;\n  label: string;\n  ts: number;\n  name: string;\n  entry: WorldbookEntry;\n  isCurrent: boolean;\n}\n\ninterface WorldbookVersionView {\n  id: string;\n  label: string;\n  ts: number;\n  entries: WorldbookEntry[];\n  isCurrent: boolean;\n}\n\ninterface PresetRoleBinding {\n  key: string;\n  name: string;\n  avatar: string;\n  updated_at: number;\n}\n\ninterface RoleBindingCandidate extends PresetRoleBinding {\n  bound: boolean;\n}\n\ninterface GlobalWorldbookPreset {\n  id: string;\n  name: string;\n  worldbooks: string[];\n  role_bindings: PresetRoleBinding[];\n  updated_at: number;\n}\n\ninterface AIChatMessage {\n  role: \'user\' | \'assistant\';\n  content: string;\n  timestamp: number;\n}\n\ninterface AIChatSession {\n  id: string;\n  title: string;\n  createdAt: number;\n  messages: AIChatMessage[];\n}\n\ninterface AIGeneratorState {\n  sessions: AIChatSession[];\n  activeSessionId: string | null;\n}\n\ninterface ExtractedTag {\n  tag: string;\n  content: string;\n  selected: boolean;\n}\n\ninterface PersistedState {\n  last_worldbook: string;\n  history: Record<string, WorldbookSnapshot[]>;\n  entry_history: Record<string, Record<string, EntrySnapshot[]>>;\n  global_presets: GlobalWorldbookPreset[];\n  last_global_preset_id: string;\n  role_override_baseline: { preset_id: string; worldbooks: string[] } | null;\n  theme: ThemeKey;\n  ai_chat: AIGeneratorState;\n}\n\ninterface ActivationLog {\n  id: string;\n  time: number;\n  world: string;\n  uid: number | string;\n  name: string;\n  contentPreview: string;\n}\n\ninterface ImportedPayload {\n  name: string;\n  entries: WorldbookEntry[];\n}\n\ninterface EventSubscription {\n  stop: () => void;\n}\n\ninterface FindHit {\n  entryUid: number;\n  entryName: string;\n  field: FindFieldKey;\n  start: number;\n  end: number;\n  matchedText: string;\n  preview: string;\n}\n\nconst STORAGE_KEY = \'worldbook_assistant_state_v1\';\nconst DIRTY_STATE_KEY = \'__WB_ASSISTANT_HAS_UNSAVED_CHANGES__\';\nconst HISTORY_LIMIT = 12;\nconst ENTRY_HISTORY_LIMIT = 7;\nconst ACTIVATION_LOG_LIMIT = 120;\nconst RESIZE_HANDLE_SIZE = 10;\nconst MAIN_PANE_MIN = 220;\nconst MAIN_EDITOR_MIN = 540;\nconst EDITOR_SIDE_MIN = 280;\nconst EDITOR_CENTER_MIN = 420;\nconst GLOBAL_PRESET_LIMIT = 64;\n\nconst strategyTypeOptions: StrategyType[] = [\'constant\', \'selective\', \'vectorized\'];\nconst secondaryLogicOptions: SecondaryLogic[] = [\'and_any\', \'and_all\', \'not_all\', \'not_any\'];\nconst positionTypeOptions: PositionType[] = [\n  \'before_character_definition\',\n  \'after_character_definition\',\n  \'before_example_messages\',\n  \'after_example_messages\',\n  \'before_author_note\',\n  \'after_author_note\',\n  \'at_depth\',\n];\n\nconst worldbookNames = ref<string[]>([]);\nconst selectedWorldbookName = ref(\'\');\nconst worldbookPickerOpen = ref(false);\nconst worldbookPickerSearchText = ref(\'\');\nconst worldbookPickerRef = ref<HTMLElement | null>(null);\nconst worldbookPickerSearchInputRef = ref<HTMLInputElement | null>(null);\nconst rolePickerOpen = ref(false);\nconst rolePickerRef = ref<HTMLElement | null>(null);\nconst rolePickerSearchInputRef = ref<HTMLInputElement | null>(null);\nconst currentTheme = ref<ThemeKey>(\'ocean\');\nconst themePickerOpen = ref(false);\nconst globalWorldbookMode = ref(false);\nconst aiGeneratorMode = ref(false);\nconst aiIsGenerating = ref(false);\nconst aiCurrentGenerationId = ref<string | null>(null);\nconst aiStreamingText = ref(\'\');\nconst aiExtractedTags = ref<ExtractedTag[]>([]);\nconst aiShowTagReview = ref(false);\nconst aiTargetWorldbook = ref(\'\');\nconst aiChatInputText = ref(\'\');\nconst aiUseContext = ref(true);\nconst aiChatMessagesRef = ref<HTMLDivElement | null>(null);\n\nconst AI_CHAT_SESSION_LIMIT = 50;\nconst AI_CHAT_MESSAGE_LIMIT = 200;\nconst selectedGlobalPresetId = ref(\'\');\nconst currentRoleContext = ref<PresetRoleBinding | null>(null);\nconst roleBindingSourceCandidates = ref<PresetRoleBinding[]>([]);\nconst originalEntries = ref<WorldbookEntry[]>([]);\nconst draftEntries = ref<WorldbookEntry[]>([]);\nconst selectedEntryUid = ref<number | null>(null);\n\nconst searchText = ref(\'\');\nconst onlyEnabled = ref(false);\nconst importFileInput = ref<HTMLInputElement | null>(null);\nconst selectedExtraText = ref(\'\');\nconst globalAddSearchText = ref(\'\');\nconst globalFilterText = ref(\'\');\nconst roleBindSearchText = ref(\'\');\n\nconst batchFindText = ref(\'\');\nconst batchReplaceText = ref(\'\');\nconst batchExcludeText = ref(\'\');\nconst batchUseRegex = ref(false);\nconst batchInName = ref(true);\nconst batchInContent = ref(true);\nconst batchInKeys = ref(false);\nconst batchSearchScope = ref<BatchSearchScope>(\'all\');\nconst findHits = ref<FindHit[]>([]);\nconst findHitIndex = ref(-1);\n\nconst statusMessage = ref(\'\');\nconst isBusy = ref(false);\nconst isSaving = ref(false);\nconst showEntryHistoryModal = ref(false);\nconst showWorldbookHistoryModal = ref(false);\nconst entryHistoryLeftId = ref(\'\');\nconst entryHistoryRightId = ref(\'\');\nconst worldbookHistoryLeftId = ref(\'\');\nconst worldbookHistoryRightId = ref(\'\');\nconst floatingZCounter = ref(10005);\nconst floatingPanels = reactive<Record<FloatingPanelKey, FloatingPanelState>>({\n  find: { visible: false, x: 420, y: 170, z: 10006, width: 500 },\n  activation: { visible: false, x: 760, y: 230, z: 10008, width: 480 },\n});\nconst activeFloatingDrag = ref<{\n  key: FloatingPanelKey;\n  pointerId: number;\n  offsetX: number;\n  offsetY: number;\n  doc: Document;\n  win: Window;\n} | null>(null);\nconst floatingPanelKeys: FloatingPanelKey[] = [\'find\', \'activation\'];\nconst viewportWidth = ref(typeof window !== \'undefined\' ? window.innerWidth : 1440);\nconst mainLayoutRef = ref<HTMLElement | null>(null);\nconst editorShellRef = ref<HTMLElement | null>(null);\nconst contentTextareaRef = ref<HTMLTextAreaElement | null>(null);\nconst mainPaneWidth = ref(320);\nconst editorSideWidth = ref(360);\nconst paneResizeState = ref<PaneResizeState | null>(null);\nconst hostResizeWindow = ref<Window | null>(null);\n\nconst _mobileDebugInfo = ref(\'\');\nconst _isMobileDevice = (() => {\n  const info: string[] = [];\n  try {\n    info.push(`win.iW=${window.innerWidth}`);\n    info.push(`scr=${window.screen.width}x${window.screen.height}`);\n    info.push(`tp=${navigator.maxTouchPoints}`);\n    info.push(`parent==win:${window.parent === window}`);\n    try {\n      const pw = window.parent;\n      info.push(`p.scr=${pw.screen.width}x${pw.screen.height}`);\n      info.push(`p.iW=${pw.innerWidth}`);\n    } catch (e) {\n      info.push(\'p.err:cross-origin\');\n    }\n  } catch (e) {\n    info.push(`ERR:${e}`);\n  }\n  _mobileDebugInfo.value = info.join(\' | \');\n\n  // Detection: use current window\'s screen (works in both iframe and non-iframe)\n  const sw = window.screen.width;\n  const sh = window.screen.height;\n  const minDim = Math.min(sw, sh);\n  if (minDim <= 768) return true;\n  if (navigator.maxTouchPoints > 0 && minDim <= 1024) return true;\n  return false;\n})();\nconst isMobile = computed(() => _isMobileDevice);\nconst showMobileEditor = computed(() => isMobile.value && selectedEntryUid.value !== null);\nconst mobileTab = ref<\'list\' | \'edit\' | \'settings\' | \'ai\'>(\'list\');\n\nconst bindings = reactive({\n  global: [] as string[],\n  charPrimary: null as string | null,\n  charAdditional: [] as string[],\n  chat: null as string | null,\n});\n\nconst activationLogs = ref<ActivationLog[]>([]);\nconst persistedState = ref<PersistedState>(createDefaultPersistedState());\n\nconst subscriptions: EventSubscription[] = [];\n\nconst selectedEntry = computed(() => {\n  if (selectedEntryUid.value === null) {\n    return null;\n  }\n  return draftEntries.value.find(entry => entry.uid === selectedEntryUid.value) ?? null;\n});\n\nconst selectedEntryIndex = computed(() => {\n  if (!selectedEntry.value) {\n    return -1;\n  }\n  return draftEntries.value.findIndex(entry => entry.uid === selectedEntry.value?.uid);\n});\n\nconst filteredEntries = computed(() => {\n  const keyword = searchText.value.trim().toLowerCase();\n  return draftEntries.value.filter(entry => {\n    if (onlyEnabled.value && !entry.enabled) {\n      return false;\n    }\n    if (!keyword) {\n      return true;\n    }\n    const keysJoined = entry.strategy.keys.map(stringifyKeyword).join(\' \').toLowerCase();\n    return (\n      entry.name.toLowerCase().includes(keyword) ||\n      entry.content.toLowerCase().includes(keyword) ||\n      keysJoined.includes(keyword)\n    );\n  });\n});\n\nconst enabledEntryCount = computed(() => draftEntries.value.filter(entry => entry.enabled).length);\n\nconst totalContentChars = computed(() =>\n  draftEntries.value.reduce((sum, entry) => {\n    return sum + entry.content.length;\n  }, 0),\n);\n\nconst hasUnsavedChanges = computed(() => JSON.stringify(draftEntries.value) !== JSON.stringify(originalEntries.value));\nconst isCompactLayout = computed(() => viewportWidth.value <= 1100);\n\nconst mainLayoutStyle = computed<Record<string, string> | undefined>(() => {\n  if (isMobile.value) {\n    return {\n      display: \'block\',\n      height: \'auto\',\n      overflow: \'visible\',\n    };\n  }\n  if (isCompactLayout.value) {\n    return undefined;\n  }\n  return {\n    gridTemplateColumns: `minmax(${MAIN_PANE_MIN}px, min(${mainPaneWidth.value}px, calc(100% - ${MAIN_EDITOR_MIN + RESIZE_HANDLE_SIZE}px))) ${RESIZE_HANDLE_SIZE}px minmax(0, 1fr)`,\n  };\n});\n\nconst editorShellStyle = computed<Record<string, string> | undefined>(() => {\n  if (isCompactLayout.value) {\n    return undefined;\n  }\n  return {\n    gridTemplateColumns: `minmax(0, 1fr) ${RESIZE_HANDLE_SIZE}px minmax(${EDITOR_SIDE_MIN}px, min(${editorSideWidth.value}px, calc(100% - ${EDITOR_CENTER_MIN + RESIZE_HANDLE_SIZE}px)))`,\n  };\n});\n\nconst themeStyles = computed(() => {\n  return THEMES[currentTheme.value].colors;\n});\n\nconst selectableWorldbookNames = computed(() => {\n  if (!globalWorldbookMode.value) {\n    return worldbookNames.value;\n  }\n  return bindings.global.filter(name => worldbookNames.value.includes(name));\n});\n\nconst globalWorldbookPresets = computed(() => persistedState.value.global_presets ?? []);\n\nconst selectedGlobalPreset = computed(() => {\n  return globalWorldbookPresets.value.find(item => item.id === selectedGlobalPresetId.value) ?? null;\n});\n\nconst selectedGlobalPresetRoleBindings = computed(() => selectedGlobalPreset.value?.role_bindings ?? []);\n\nconst isCurrentRoleBoundToSelectedPreset = computed(() => {\n  const role = currentRoleContext.value;\n  const preset = selectedGlobalPreset.value;\n  if (!role || !preset) {\n    return false;\n  }\n  return preset.role_bindings.some(item => item.key === role.key);\n});\n\nconst roleBindingCandidates = computed<RoleBindingCandidate[]>(() => {\n  const keyword = roleBindSearchText.value.trim().toLowerCase();\n  const boundSet = new Set(selectedGlobalPresetRoleBindings.value.map(item => item.key));\n  const list = roleBindingSourceCandidates.value;\n  const filtered = keyword\n    ? list.filter(item => {\n        return (\n          item.name.toLowerCase().includes(keyword) ||\n          item.avatar.toLowerCase().includes(keyword) ||\n          item.key.toLowerCase().includes(keyword)\n        );\n      })\n    : list;\n  return filtered.map(item => ({\n    ...item,\n    bound: boundSet.has(item.key),\n  }));\n});\n\nconst filteredSelectableWorldbookNames = computed(() => {\n  const keyword = worldbookPickerSearchText.value.trim().toLowerCase();\n  if (!keyword) {\n    return selectableWorldbookNames.value;\n  }\n  return selectableWorldbookNames.value.filter(name => name.toLowerCase().includes(keyword));\n});\n\nconst globalAddCandidates = computed(() => {\n  const keyword = globalAddSearchText.value.trim().toLowerCase();\n  return worldbookNames.value.filter(name => {\n    if (bindings.global.includes(name)) {\n      return false;\n    }\n    if (!keyword) {\n      return true;\n    }\n    return name.toLowerCase().includes(keyword);\n  });\n});\n\nconst filteredGlobalWorldbooks = computed(() => {\n  const keyword = globalFilterText.value.trim().toLowerCase();\n  if (!keyword) {\n    return bindings.global;\n  }\n  return bindings.global.filter(name => name.toLowerCase().includes(keyword));\n});\n\nconst isGlobalBound = computed(() => {\n  if (!selectedWorldbookName.value) {\n    return false;\n  }\n  return bindings.global.includes(selectedWorldbookName.value);\n});\n\nconst snapshotsForCurrent = computed(() => {\n  if (!selectedWorldbookName.value) {\n    return [];\n  }\n  return persistedState.value.history[selectedWorldbookName.value] ?? [];\n});\n\nconst entrySnapshotsForSelected = computed(() => {\n  if (!selectedWorldbookName.value || !selectedEntry.value) {\n    return [];\n  }\n  const byWorldbook = persistedState.value.entry_history[selectedWorldbookName.value] ?? {};\n  return byWorldbook[String(selectedEntry.value.uid)] ?? [];\n});\n\nconst entryVersionViews = computed<EntryVersionView[]>(() => {\n  if (!selectedEntry.value) {\n    return [];\n  }\n  const baselineEntry = originalEntries.value.find(item => item.uid === selectedEntry.value?.uid) ?? null;\n  const current: EntryVersionView = {\n    id: \'__current__\',\n    label: \'\',\n    ts: Date.now(),\n    name: selectedEntry.value.name,\n    entry: selectedEntry.value,\n    isCurrent: true,\n  };\n  const baseline = baselineEntry\n    ? ({\n        id: \'__baseline__\',\n        label: \'\',\n        ts: 0,\n        name: baselineEntry.name,\n        entry: baselineEntry,\n        isCurrent: false,\n      } satisfies EntryVersionView)\n    : null;\n  const history = entrySnapshotsForSelected.value.map(item => ({\n    id: item.id,\n    label: item.label,\n    ts: item.ts,\n    name: item.name,\n    entry: item.entry,\n    isCurrent: false,\n  }));\n  return [current, ...(baseline ? [baseline] : []), ...history];\n});\n\nconst selectedEntryHistoryLeft = computed(() => {\n  return entryVersionViews.value.find(item => item.id === entryHistoryLeftId.value) ?? null;\n});\n\nconst selectedEntryHistoryRight = computed(() => {\n  return entryVersionViews.value.find(item => item.id === entryHistoryRightId.value) ?? null;\n});\n\nconst canRestoreEntryFromLeft = computed(() => {\n  return Boolean(selectedEntry.value && selectedEntryHistoryLeft.value && !selectedEntryHistoryLeft.value.isCurrent);\n});\n\nconst worldbookVersionViews = computed<WorldbookVersionView[]>(() => {\n  if (!selectedWorldbookName.value) {\n    return [];\n  }\n  const current: WorldbookVersionView = {\n    id: \'__current__\',\n    label: \'\',\n    ts: Date.now(),\n    entries: draftEntries.value,\n    isCurrent: true,\n  };\n  const baseline: WorldbookVersionView | null = {\n    id: \'__baseline__\',\n    label: \'\',\n    ts: 0,\n    entries: originalEntries.value,\n    isCurrent: false,\n  };\n  const history = snapshotsForCurrent.value.map(item => ({\n    id: item.id,\n    label: item.label,\n    ts: item.ts,\n    entries: item.entries,\n    isCurrent: false,\n  }));\n  return [current, ...(originalEntries.value.length ? [baseline] : []), ...history];\n});\n\nconst selectedWorldbookHistoryLeft = computed(() => {\n  return worldbookVersionViews.value.find(item => item.id === worldbookHistoryLeftId.value) ?? null;\n});\n\nconst selectedWorldbookHistoryRight = computed(() => {\n  return worldbookVersionViews.value.find(item => item.id === worldbookHistoryRightId.value) ?? null;\n});\n\nconst canRestoreWorldbookFromLeft = computed(() => {\n  return Boolean(selectedWorldbookHistoryLeft.value && !selectedWorldbookHistoryLeft.value.isCurrent);\n});\n\nconst batchExcludeTokensPreview = computed(() => parseBatchExcludeTokens(batchExcludeText.value));\n\nconst activeFindHit = computed(() => {\n  if (findHitIndex.value < 0 || findHitIndex.value >= findHits.value.length) {\n    return null;\n  }\n  return findHits.value[findHitIndex.value] ?? null;\n});\n\nconst findHitSummaryText = computed(() => {\n  if (!batchFindText.value.trim()) {\n    return \'\';\n  }\n  if (!findHits.value.length) {\n    return \'\';\n  }\n  if (!activeFindHit.value) {\n    return ` 0 / ${findHits.value.length}`;\n  }\n  return ` ${findHitIndex.value + 1} / ${findHits.value.length}`;\n});\n\nconst entryHistoryDiff = computed(() => {\n  return buildDiffHtml(\n    serializeEntryVersionForDiff(selectedEntryHistoryLeft.value),\n    serializeEntryVersionForDiff(selectedEntryHistoryRight.value),\n  );\n});\n\nconst entryHistorySummary = computed(() => {\n  return getEntryVersionDiffSummary(selectedEntryHistoryLeft.value, selectedEntryHistoryRight.value);\n});\n\nconst worldbookHistoryDiff = computed(() => {\n  return buildDiffHtml(\n    serializeWorldbookVersionForDiff(selectedWorldbookHistoryLeft.value),\n    serializeWorldbookVersionForDiff(selectedWorldbookHistoryRight.value),\n  );\n});\n\nconst selectedKeysText = computed({\n  get: () => {\n    if (!selectedEntry.value) {\n      return \'\';\n    }\n    return selectedEntry.value.strategy.keys.map(stringifyKeyword).join(\', \');\n  },\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.strategy.keys = parseKeywordsFromText(value);\n  },\n});\n\nconst selectedSecondaryKeysText = computed({\n  get: () => {\n    if (!selectedEntry.value) {\n      return \'\';\n    }\n    return selectedEntry.value.strategy.keys_secondary.keys.map(stringifyKeyword).join(\', \');\n  },\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.strategy.keys_secondary.keys = parseKeywordsFromText(value);\n  },\n});\n\nconst selectedScanDepthText = computed({\n  get: () => {\n    if (!selectedEntry.value) {\n      return \'\';\n    }\n    const depth = selectedEntry.value.strategy.scan_depth;\n    return typeof depth === \'number\' ? String(depth) : \'same_as_global\';\n  },\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.strategy.scan_depth = normalizeScanDepth(value);\n  },\n});\n\nconst selectedRecursionDelayText = computed({\n  get: () => (selectedEntry.value ? nullableNumberToText(selectedEntry.value.recursion.delay_until) : \'\'),\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.recursion.delay_until = parseNullableInteger(value);\n  },\n});\n\nconst selectedStickyText = computed({\n  get: () => (selectedEntry.value ? nullableNumberToText(selectedEntry.value.effect.sticky) : \'\'),\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.effect.sticky = parseNullableInteger(value);\n  },\n});\n\nconst selectedCooldownText = computed({\n  get: () => (selectedEntry.value ? nullableNumberToText(selectedEntry.value.effect.cooldown) : \'\'),\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.effect.cooldown = parseNullableInteger(value);\n  },\n});\n\nconst selectedEffectDelayText = computed({\n  get: () => (selectedEntry.value ? nullableNumberToText(selectedEntry.value.effect.delay) : \'\'),\n  set: (value: string) => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    selectedEntry.value.effect.delay = parseNullableInteger(value);\n  },\n});\n\nconst selectedContentChars = computed(() => {\n  return selectedEntry.value?.content.length ?? 0;\n});\n\nconst selectedTokenEstimate = computed(() => {\n  const chars = selectedContentChars.value;\n  if (chars <= 0) {\n    return 0;\n  }\n  return Math.max(1, Math.round(chars / 3.6));\n});\n\nwatch(selectedWorldbookName, name => {\n  closeWorldbookPicker();\n  if (!name) {\n    draftEntries.value = [];\n    originalEntries.value = [];\n    selectedEntryUid.value = null;\n    return;\n  }\n  updatePersistedState(state => {\n    state.last_worldbook = name;\n  });\n  void loadWorldbook(name);\n});\n\nwatch(\n  () => selectedEntryUid.value,\n  () => {\n    syncExtraTextWithSelection();\n  },\n);\n\nwatch(\n  [\n    batchFindText,\n    batchReplaceText,\n    batchExcludeText,\n    batchUseRegex,\n    batchInName,\n    batchInContent,\n    batchInKeys,\n    batchSearchScope,\n  ],\n  () => {\n    resetFindState();\n  },\n);\n\nwatch(\n  entryVersionViews,\n  views => {\n    if (!views.length) {\n      entryHistoryLeftId.value = \'\';\n      entryHistoryRightId.value = \'\';\n      return;\n    }\n\n    const ids = new Set(views.map(item => item.id));\n    if (!ids.has(entryHistoryRightId.value)) {\n      entryHistoryRightId.value = \'__current__\';\n    }\n    if (!ids.has(entryHistoryLeftId.value)) {\n      const fallback = views.find(item => !item.isCurrent) ?? views[0];\n      entryHistoryLeftId.value = fallback.id;\n    }\n    if (entryHistoryLeftId.value === entryHistoryRightId.value && views.length > 1) {\n      const fallback = views.find(item => item.id !== entryHistoryRightId.value);\n      if (fallback) {\n        entryHistoryLeftId.value = fallback.id;\n      }\n    }\n  },\n  { immediate: true },\n);\n\nwatch(\n  worldbookVersionViews,\n  views => {\n    if (!views.length) {\n      worldbookHistoryLeftId.value = \'\';\n      worldbookHistoryRightId.value = \'\';\n      return;\n    }\n\n    const ids = new Set(views.map(item => item.id));\n    if (!ids.has(worldbookHistoryRightId.value)) {\n      worldbookHistoryRightId.value = \'__current__\';\n    }\n    if (!ids.has(worldbookHistoryLeftId.value)) {\n      const fallback = views.find(item => !item.isCurrent) ?? views[0];\n      worldbookHistoryLeftId.value = fallback.id;\n    }\n    if (worldbookHistoryLeftId.value === worldbookHistoryRightId.value && views.length > 1) {\n      const fallback = views.find(item => item.id !== worldbookHistoryRightId.value);\n      if (fallback) {\n        worldbookHistoryLeftId.value = fallback.id;\n      }\n    }\n  },\n  { immediate: true },\n);\n\nwatch(\n  () => selectedEntry.value?.position.type,\n  () => {\n    if (!selectedEntry.value) {\n      return;\n    }\n    if (selectedEntry.value.position.type !== \'at_depth\') {\n      selectedEntry.value.position.role = \'system\';\n      selectedEntry.value.position.depth = 4;\n    }\n  },\n);\n\nwatch(\n  hasUnsavedChanges,\n  dirty => {\n    const target = window as unknown as Record<string, unknown>;\n    target[DIRTY_STATE_KEY] = dirty;\n  },\n  { immediate: true },\n);\n\nfunction createId(prefix: string): string {\n  return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 9)}`;\n}\n\nfunction asRecord(value: unknown): Record<string, unknown> | null {\n  if (value && typeof value === \'object\' && !Array.isArray(value)) {\n    return value as Record<string, unknown>;\n  }\n  return null;\n}\n\nfunction toStringSafe(value: unknown, fallback = \'\'): string {\n  if (typeof value === \'string\') {\n    return value;\n  }\n  if (value === null || value === undefined) {\n    return fallback;\n  }\n  return String(value);\n}\n\nfunction toNumberSafe(value: unknown, fallback: number): number {\n  if (typeof value === \'number\' && Number.isFinite(value)) {\n    return value;\n  }\n  if (typeof value === \'string\' && value.trim()) {\n    const parsed = Number(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n  return fallback;\n}\n\nfunction clampNumber(value: number, min: number, max: number): number {\n  return Math.min(max, Math.max(min, value));\n}\n\nfunction parseNullableInteger(value: unknown): number | null {\n  if (value === null || value === undefined) {\n    return null;\n  }\n  if (typeof value === \'string\' && !value.trim()) {\n    return null;\n  }\n  const parsed = Number(value);\n  if (!Number.isFinite(parsed)) {\n    return null;\n  }\n  return Math.max(0, Math.floor(parsed));\n}\n\nfunction nullableNumberToText(value: number | null): string {\n  return value === null ? \'\' : String(value);\n}\n\nfunction stringifyKeyword(value: string | RegExp): string {\n  return value instanceof RegExp ? value.toString() : value;\n}\n\nfunction parseKeywordToken(token: string): string | RegExp {\n  const trimmed = token.trim();\n  if (!trimmed) {\n    return \'\';\n  }\n  const regexMatch = trimmed.match(/^\\/(.+)\\/([dgimsuy]*)$/);\n  if (!regexMatch) {\n    return trimmed;\n  }\n  try {\n    return new RegExp(regexMatch[1], regexMatch[2]);\n  } catch {\n    return trimmed;\n  }\n}\n\nfunction normalizeKeywordList(value: unknown): (string | RegExp)[] {\n  const sourceList = Array.isArray(value) ? value : typeof value === \'string\' ? value.split(/[\\n,]/g) : [];\n  const normalized: (string | RegExp)[] = [];\n  const seen = new Set<string>();\n\n  for (const item of sourceList) {\n    const token = item instanceof RegExp ? item : parseKeywordToken(toStringSafe(item).trim());\n    const tokenString = stringifyKeyword(token);\n    if (!tokenString) {\n      continue;\n    }\n    const dedupeKey = tokenString.toLowerCase();\n    if (seen.has(dedupeKey)) {\n      continue;\n    }\n    seen.add(dedupeKey);\n    normalized.push(token);\n  }\n\n  return normalized;\n}\n\nfunction parseKeywordsFromText(value: string): (string | RegExp)[] {\n  return normalizeKeywordList(value.split(/[\\n,]/g));\n}\n\nfunction normalizePresetRoleBindings(rawList: unknown): PresetRoleBinding[] {\n  if (!Array.isArray(rawList)) {\n    return [];\n  }\n  const normalized: PresetRoleBinding[] = [];\n  const seen = new Set<string>();\n  for (const item of rawList) {\n    const record = asRecord(item);\n    if (!record) {\n      continue;\n    }\n    const key = toStringSafe(record.key).trim();\n    if (!key || seen.has(key)) {\n      continue;\n    }\n    seen.add(key);\n    normalized.push({\n      key,\n      name: toStringSafe(record.name, key),\n      avatar: toStringSafe(record.avatar),\n      updated_at: toNumberSafe(record.updated_at, Date.now()),\n    });\n  }\n  return normalized;\n}\n\nfunction getStrategyTypeLabel(type: StrategyType): string {\n  if (type === \'constant\') {\n    return \'  (constant)\';\n  }\n  if (type === \'vectorized\') {\n    return \'  (vectorized)\';\n  }\n  return \'  (selective)\';\n}\n\nfunction getSecondaryLogicLabel(logic: SecondaryLogic): string {\n  const map: Record<SecondaryLogic, string> = {\n    and_any: \' (and_any)\',\n    and_all: \' (and_all)\',\n    not_all: \' (not_all)\',\n    not_any: \' (not_any)\',\n  };\n  return map[logic];\n}\n\nfunction getPositionTypeLabel(type: PositionType): string {\n  const map: Record<PositionType, string> = {\n    before_character_definition: \'\',\n    after_character_definition: \'\',\n    before_example_messages: \'\',\n    after_example_messages: \'\',\n    before_author_note: \'\',\n    after_author_note: \'\',\n    at_depth: \'\',\n  };\n  return map[type];\n}\n\nfunction getEntryVisualStatus(entry: WorldbookEntry): EntryVisualStatus {\n  if (!entry.enabled) {\n    return \'disabled\';\n  }\n  if (entry.strategy.type === \'constant\') {\n    return \'constant\';\n  }\n  if (entry.strategy.type === \'vectorized\') {\n    return \'vector\';\n  }\n  return \'normal\';\n}\n\nfunction getEntryStatusLabel(entry: WorldbookEntry): string {\n  const status = getEntryVisualStatus(entry);\n  if (status === \'disabled\') {\n    return \' \';\n  }\n  if (status === \'constant\') {\n    return \' \';\n  }\n  if (status === \'vector\') {\n    return \' \';\n  }\n  return \' \';\n}\n\nfunction getEntryKeyPreview(entry: WorldbookEntry): string {\n  const rendered = entry.strategy.keys\n    .slice(0, 3)\n    .map(key => stringifyKeyword(key))\n    .join(\' / \');\n  if (!rendered) {\n    return \'\';\n  }\n  if (entry.strategy.keys.length > 3) {\n    return `${rendered} ...`;\n  }\n  return rendered;\n}\n\nfunction normalizeSecondaryLogic(value: unknown): SecondaryLogic {\n  if (typeof value === \'string\' && secondaryLogicOptions.includes(value as SecondaryLogic)) {\n    return value as SecondaryLogic;\n  }\n  if (typeof value === \'number\') {\n    const map: SecondaryLogic[] = [\'and_any\', \'and_all\', \'not_all\', \'not_any\'];\n    return map[value] ?? \'and_any\';\n  }\n  return \'and_any\';\n}\n\nfunction normalizeStrategyType(\n  raw: Record<string, unknown>,\n  strategyRecord: Record<string, unknown> | null,\n): StrategyType {\n  const directType = strategyRecord?.type;\n  if (typeof directType === \'string\' && strategyTypeOptions.includes(directType as StrategyType)) {\n    return directType as StrategyType;\n  }\n  if (raw.constant) {\n    return \'constant\';\n  }\n  if (raw.vectorized) {\n    return \'vectorized\';\n  }\n  return \'selective\';\n}\n\nfunction normalizePositionType(value: unknown): PositionType {\n  if (typeof value === \'string\') {\n    if (positionTypeOptions.includes(value as PositionType)) {\n      return value as PositionType;\n    }\n    const depthMatch = value.match(/^at_depth_as_(system|assistant|user)$/);\n    if (depthMatch) {\n      return \'at_depth\';\n    }\n  }\n  if (typeof value === \'number\') {\n    const map: Record<number, PositionType> = {\n      0: \'before_character_definition\',\n      1: \'after_character_definition\',\n      2: \'before_example_messages\',\n      3: \'after_example_messages\',\n      4: \'before_author_note\',\n      5: \'after_author_note\',\n      6: \'at_depth\',\n    };\n    return map[value] ?? \'after_character_definition\';\n  }\n  return \'after_character_definition\';\n}\n\nfunction normalizeRole(value: unknown): RoleType {\n  if (value === \'assistant\' || value === \'user\' || value === \'system\') {\n    return value;\n  }\n  if (typeof value === \'number\') {\n    const map: Record<number, RoleType> = {\n      0: \'system\',\n      1: \'assistant\',\n      2: \'user\',\n    };\n    return map[value] ?? \'system\';\n  }\n  if (typeof value === \'string\') {\n    if (value.includes(\'assistant\')) {\n      return \'assistant\';\n    }\n    if (value.includes(\'user\')) {\n      return \'user\';\n    }\n  }\n  return \'system\';\n}\n\nfunction normalizeScanDepth(value: unknown): \'same_as_global\' | number {\n  if (value === \'same_as_global\') {\n    return \'same_as_global\';\n  }\n  const numeric = Math.floor(toNumberSafe(value, NaN));\n  if (Number.isFinite(numeric) && numeric > 0) {\n    return numeric;\n  }\n  return \'same_as_global\';\n}\n\nfunction createDefaultEntry(uid: number): WorldbookEntry {\n  return {\n    uid,\n    name: ` ${uid}`,\n    enabled: true,\n    strategy: {\n      type: \'selective\',\n      keys: [],\n      keys_secondary: {\n        logic: \'and_any\',\n        keys: [],\n      },\n      scan_depth: \'same_as_global\',\n    },\n    position: {\n      type: \'after_character_definition\',\n      role: \'system\',\n      depth: 4,\n      order: 100,\n    },\n    content: \'\',\n    probability: 100,\n    recursion: {\n      prevent_incoming: false,\n      prevent_outgoing: false,\n      delay_until: null,\n    },\n    effect: {\n      sticky: null,\n      cooldown: null,\n      delay: null,\n    },\n  };\n}\n\nfunction collectExtraFields(raw: Record<string, unknown>): Record<string, unknown> | undefined {\n  const known = new Set([\n    \'uid\',\n    \'id\',\n    \'name\',\n    \'comment\',\n    \'enabled\',\n    \'disable\',\n    \'strategy\',\n    \'position\',\n    \'content\',\n    \'probability\',\n    \'recursion\',\n    \'effect\',\n    \'extra\',\n    \'keys\',\n    \'key\',\n    \'secondary_keys\',\n    \'keysecondary\',\n    \'filters\',\n    \'logic\',\n    \'selectiveLogic\',\n    \'scan_depth\',\n    \'constant\',\n    \'vectorized\',\n    \'selective\',\n    \'insertion_order\',\n    \'order\',\n    \'role\',\n    \'depth\',\n    \'preventRecursion\',\n    \'excludeRecursion\',\n    \'delayUntilRecursion\',\n    \'sticky\',\n    \'cooldown\',\n    \'delay\',\n    \'useProbability\',\n  ]);\n\n  const extra: Record<string, unknown> = {};\n  for (const [key, value] of Object.entries(raw)) {\n    if (!known.has(key)) {\n      extra[key] = value;\n    }\n  }\n  if (Object.keys(extra).length === 0) {\n    return undefined;\n  }\n  return extra;\n}\n\nfunction normalizeEntry(rawInput: unknown, fallbackUid: number): WorldbookEntry {\n  const raw = asRecord(rawInput) ?? {};\n  const base = createDefaultEntry(fallbackUid);\n  const strategyRecord = asRecord(raw.strategy);\n  const positionRecord = asRecord(raw.position);\n  const recursionRecord = asRecord(raw.recursion);\n  const effectRecord = asRecord(raw.effect);\n  const secondaryRecord = asRecord(strategyRecord?.keys_secondary);\n\n  const uid = Math.max(0, Math.floor(toNumberSafe(raw.uid ?? raw.id, fallbackUid)));\n  const name = toStringSafe(raw.name ?? raw.comment, ` ${uid}`).trim() || ` ${uid}`;\n  const strategyType = normalizeStrategyType(raw, strategyRecord);\n  const keys = normalizeKeywordList(strategyRecord?.keys ?? raw.keys ?? raw.key);\n  const secondaryKeys = normalizeKeywordList(\n    secondaryRecord?.keys ?? raw.secondary_keys ?? raw.keysecondary ?? raw.filters,\n  );\n  const secondaryLogic = normalizeSecondaryLogic(secondaryRecord?.logic ?? raw.logic ?? raw.selectiveLogic);\n  const positionType = normalizePositionType(positionRecord?.type ?? raw.position);\n  const role = normalizeRole(positionRecord?.role ?? raw.role);\n  const depth = Math.max(1, Math.floor(toNumberSafe(positionRecord?.depth ?? raw.depth, 4)));\n  const order = Math.floor(toNumberSafe(positionRecord?.order ?? raw.insertion_order ?? raw.order, 100));\n  const probability = clampNumber(toNumberSafe(raw.probability, 100), 0, 100);\n\n  const preventIncoming = recursionRecord?.prevent_incoming ?? raw.preventRecursion;\n  const preventOutgoing = recursionRecord?.prevent_outgoing ?? raw.excludeRecursion;\n\n  const entry: WorldbookEntry = {\n    ...base,\n    uid,\n    name,\n    enabled: raw.enabled === undefined ? !Boolean(raw.disable) : Boolean(raw.enabled),\n    strategy: {\n      type: strategyType,\n      keys,\n      keys_secondary: {\n        logic: secondaryLogic,\n        keys: secondaryKeys,\n      },\n      scan_depth: normalizeScanDepth(strategyRecord?.scan_depth ?? raw.scan_depth),\n    },\n    position: {\n      type: positionType,\n      role: positionType === \'at_depth\' ? role : \'system\',\n      depth: positionType === \'at_depth\' ? depth : 4,\n      order,\n    },\n    content: toStringSafe(raw.content),\n    probability,\n    recursion: {\n      prevent_incoming: Boolean(preventIncoming),\n      prevent_outgoing: Boolean(preventOutgoing),\n      delay_until: parseNullableInteger(recursionRecord?.delay_until ?? raw.delayUntilRecursion),\n    },\n    effect: {\n      sticky: parseNullableInteger(effectRecord?.sticky ?? raw.sticky),\n      cooldown: parseNullableInteger(effectRecord?.cooldown ?? raw.cooldown),\n      delay: parseNullableInteger(effectRecord?.delay ?? raw.delay),\n    },\n  };\n\n  const directExtra = asRecord(raw.extra);\n  if (directExtra && Object.keys(directExtra).length > 0) {\n    entry.extra = klona(directExtra);\n  } else {\n    const extras = collectExtraFields(raw);\n    if (extras) {\n      entry.extra = klona(extras);\n    }\n  }\n\n  return entry;\n}\n\nfunction normalizeEntryList(rawEntries: unknown[]): WorldbookEntry[] {\n  const result: WorldbookEntry[] = [];\n  const uidSet = new Set<number>();\n\n  for (let index = 0; index < rawEntries.length; index += 1) {\n    const rawRecord = asRecord(rawEntries[index]);\n    let uid = Math.max(0, Math.floor(toNumberSafe(rawRecord?.uid ?? rawRecord?.id, index)));\n    while (uidSet.has(uid)) {\n      uid += 1;\n    }\n    uidSet.add(uid);\n    result.push(normalizeEntry(rawEntries[index], uid));\n  }\n\n  return result;\n}\n\nfunction getNextUid(entries: WorldbookEntry[]): number {\n  if (entries.length === 0) {\n    return 0;\n  }\n  return Math.max(...entries.map(entry => entry.uid)) + 1;\n}\n\nfunction createDefaultPersistedState(): PersistedState {\n  return {\n    last_worldbook: \'\',\n    history: {},\n    entry_history: {},\n    global_presets: [],\n    last_global_preset_id: \'\',\n    role_override_baseline: null,\n    theme: \'ocean\',\n    ai_chat: { sessions: [], activeSessionId: null },\n  };\n}\n\nfunction normalizePersistedState(input: unknown): PersistedState {\n  const root = asRecord(input);\n  if (!root) {\n    return createDefaultPersistedState();\n  }\n\n  const historyRoot = asRecord(root.history) ?? {};\n  const history: Record<string, WorldbookSnapshot[]> = {};\n  for (const [name, rawSnapshots] of Object.entries(historyRoot)) {\n    if (!Array.isArray(rawSnapshots)) {\n      continue;\n    }\n    history[name] = rawSnapshots\n      .map(item => {\n        const record = asRecord(item);\n        if (!record) {\n          return null;\n        }\n        const entriesRaw = Array.isArray(record.entries) ? record.entries : [];\n        return {\n          id: toStringSafe(record.id, createId(\'snapshot\')),\n          label: toStringSafe(record.label, \'\'),\n          ts: toNumberSafe(record.ts, Date.now()),\n          entries: normalizeEntryList(entriesRaw),\n        } satisfies WorldbookSnapshot;\n      })\n      .filter((item): item is WorldbookSnapshot => item !== null)\n      .slice(0, HISTORY_LIMIT);\n  }\n\n  const entryHistoryRoot = asRecord(root.entry_history) ?? {};\n  const entryHistory: Record<string, Record<string, EntrySnapshot[]>> = {};\n  for (const [worldbookName, rawByUid] of Object.entries(entryHistoryRoot)) {\n    const uidRecord = asRecord(rawByUid);\n    if (!uidRecord) {\n      continue;\n    }\n    const normalizedByUid: Record<string, EntrySnapshot[]> = {};\n    for (const [uidKey, rawItems] of Object.entries(uidRecord)) {\n      if (!Array.isArray(rawItems)) {\n        continue;\n      }\n      const uidNumber = Math.max(0, Math.floor(toNumberSafe(uidKey, 0)));\n      normalizedByUid[uidKey] = rawItems\n        .map(item => {\n          const record = asRecord(item);\n          if (!record) {\n            return null;\n          }\n          return {\n            id: toStringSafe(record.id, createId(\'entry-snapshot\')),\n            label: toStringSafe(record.label, \'\'),\n            ts: toNumberSafe(record.ts, Date.now()),\n            uid: uidNumber,\n            name: toStringSafe(record.name, ` ${uidNumber}`),\n            entry: normalizeEntry(record.entry, uidNumber),\n          } satisfies EntrySnapshot;\n        })\n        .filter((item): item is EntrySnapshot => item !== null)\n        .slice(0, ENTRY_HISTORY_LIMIT);\n    }\n    if (Object.keys(normalizedByUid).length > 0) {\n      entryHistory[worldbookName] = normalizedByUid;\n    }\n  }\n\n  const globalPresetsRaw = Array.isArray(root.global_presets) ? root.global_presets : [];\n  const globalPresets = globalPresetsRaw\n    .map(item => {\n      const record = asRecord(item);\n      if (!record) {\n        return null;\n      }\n      const worldbooksRaw = Array.isArray(record.worldbooks) ? record.worldbooks : [];\n      const worldbooks = [...new Set(worldbooksRaw.map(name => toStringSafe(name).trim()).filter(Boolean))];\n      const roleBindings = normalizePresetRoleBindings(record.role_bindings);\n      return {\n        id: toStringSafe(record.id, createId(\'global-preset\')),\n        name: toStringSafe(record.name, \'\'),\n        worldbooks,\n        role_bindings: roleBindings,\n        updated_at: toNumberSafe(record.updated_at, Date.now()),\n      } satisfies GlobalWorldbookPreset;\n    })\n    .filter((item): item is GlobalWorldbookPreset => item !== null)\n    .slice(0, GLOBAL_PRESET_LIMIT);\n\n  const rawBaseline = asRecord(root.role_override_baseline);\n  let roleOverrideBaseline: PersistedState[\'role_override_baseline\'] = null;\n  if (rawBaseline) {\n    const baselineWorldbooks = Array.isArray(rawBaseline.worldbooks)\n      ? rawBaseline.worldbooks.map(name => toStringSafe(name).trim()).filter(Boolean)\n      : [];\n    roleOverrideBaseline = {\n      preset_id: toStringSafe(rawBaseline.preset_id),\n      worldbooks: [...new Set(baselineWorldbooks)],\n    };\n  }\n\n  const aiChatRaw = asRecord(root.ai_chat);\n  const aiChat: AIGeneratorState = { sessions: [], activeSessionId: null };\n  if (aiChatRaw) {\n    aiChat.activeSessionId = toStringSafe(aiChatRaw.activeSessionId) || null;\n    if (Array.isArray(aiChatRaw.sessions)) {\n      aiChat.sessions = aiChatRaw.sessions\n        .map((s: unknown) => {\n          const sr = asRecord(s);\n          if (!sr) return null;\n          const msgs = Array.isArray(sr.messages)\n            ? sr.messages.map((m: unknown) => {\n                const mr = asRecord(m);\n                if (!mr) return null;\n                return {\n                  role: mr.role === \'assistant\' ? \'assistant\' : \'user\',\n                  content: toStringSafe(mr.content),\n                  timestamp: toNumberSafe(mr.timestamp, Date.now()),\n                } satisfies AIChatMessage;\n              }).filter((m): m is AIChatMessage => m !== null)\n            : [];\n          return {\n            id: toStringSafe(sr.id, createId(\'ai-chat\')),\n            title: toStringSafe(sr.title, \'\'),\n            createdAt: toNumberSafe(sr.createdAt, Date.now()),\n            messages: msgs.slice(0, AI_CHAT_MESSAGE_LIMIT),\n          } satisfies AIChatSession;\n        })\n        .filter((s): s is AIChatSession => s !== null)\n        .slice(0, AI_CHAT_SESSION_LIMIT);\n    }\n  }\n\n  return {\n    last_worldbook: toStringSafe(root.last_worldbook),\n    history,\n    entry_history: entryHistory,\n    global_presets: globalPresets,\n    last_global_preset_id: toStringSafe(root.last_global_preset_id),\n    role_override_baseline: roleOverrideBaseline,\n    theme: (toStringSafe(root.theme) as ThemeKey) || \'ocean\',\n    ai_chat: aiChat,\n  };\n}\n\nfunction readPersistedState(): PersistedState {\n  const vars = getVariables({ type: \'script\', script_id: getScriptId() });\n  return normalizePersistedState(vars[STORAGE_KEY]);\n}\n\nfunction syncSelectedGlobalPresetFromState(): void {\n  const presets = persistedState.value.global_presets;\n  const byId = new Set(presets.map(item => item.id));\n  const preferredId = persistedState.value.last_global_preset_id;\n  if (preferredId && byId.has(preferredId)) {\n    selectedGlobalPresetId.value = preferredId;\n    return;\n  }\n  if (selectedGlobalPresetId.value && byId.has(selectedGlobalPresetId.value)) {\n    return;\n  }\n  selectedGlobalPresetId.value = \'\';\n}\n\nfunction writePersistedState(state: PersistedState): void {\n  const vars = getVariables({ type: \'script\', script_id: getScriptId() });\n  vars[STORAGE_KEY] = state;\n  replaceVariables(vars, { type: \'script\', script_id: getScriptId() });\n  persistedState.value = state;\n  syncSelectedGlobalPresetFromState();\n}\n\nfunction updatePersistedState(mutator: (state: PersistedState) => void): void {\n  const state = readPersistedState();\n  mutator(state);\n  writePersistedState(state);\n}\n\n//  AI Chat: computed \nconst aiSessions = computed(() => persistedState.value.ai_chat.sessions);\n\nconst aiActiveSession = computed((): AIChatSession | null => {\n  const id = persistedState.value.ai_chat.activeSessionId;\n  if (!id) return null;\n  return aiSessions.value.find(s => s.id === id) ?? null;\n});\n\nconst aiActiveMessages = computed((): AIChatMessage[] => aiActiveSession.value?.messages ?? []);\n\n//  AI Chat: CRUD \nfunction aiCreateSession(): void {\n  const id = createId(\'ai-chat\');\n  const session: AIChatSession = {\n    id,\n    title: ` ${aiSessions.value.length + 1}`,\n    createdAt: Date.now(),\n    messages: [],\n  };\n  updatePersistedState(state => {\n    state.ai_chat.sessions.unshift(session);\n    state.ai_chat.activeSessionId = id;\n  });\n  setStatus(\'\');\n}\n\nfunction aiDeleteSession(id: string): void {\n  updatePersistedState(state => {\n    state.ai_chat.sessions = state.ai_chat.sessions.filter(s => s.id !== id);\n    if (state.ai_chat.activeSessionId === id) {\n      state.ai_chat.activeSessionId = state.ai_chat.sessions[0]?.id ?? null;\n    }\n  });\n  setStatus(\'\');\n}\n\nfunction aiSwitchSession(id: string): void {\n  updatePersistedState(state => {\n    state.ai_chat.activeSessionId = id;\n  });\n}\n\nfunction aiRenameSession(id: string, title: string): void {\n  updatePersistedState(state => {\n    const session = state.ai_chat.sessions.find(s => s.id === id);\n    if (session) {\n      session.title = title.trim() || session.title;\n    }\n  });\n}\n\nfunction aiAddMessage(role: \'user\' | \'assistant\', content: string): void {\n  const sessionId = persistedState.value.ai_chat.activeSessionId;\n  if (!sessionId) return;\n  updatePersistedState(state => {\n    const session = state.ai_chat.sessions.find(s => s.id === sessionId);\n    if (session) {\n      session.messages.push({ role, content, timestamp: Date.now() });\n      if (session.messages.length > AI_CHAT_MESSAGE_LIMIT) {\n        session.messages = session.messages.slice(-AI_CHAT_MESSAGE_LIMIT);\n      }\n    }\n  });\n}\n\n//  AI Chat: generate \nlet aiStreamSubscription: { stop: () => void } | null = null;\n\nasync function aiSendMessage(): Promise<void> {\n  const text = aiChatInputText.value.trim();\n  if (!text || aiIsGenerating.value) return;\n\n  const sessionId = persistedState.value.ai_chat.activeSessionId;\n  if (!sessionId) {\n    aiCreateSession();\n  }\n\n  aiChatInputText.value = \'\';\n  aiAddMessage(\'user\', text);\n\n  const session = persistedState.value.ai_chat.sessions.find(\n    s => s.id === persistedState.value.ai_chat.activeSessionId\n  );\n  if (!session) return;\n\n  // Build prompts from session history (excluding the user message we just added since generate will use user_input)\n  const historyPrompts: RolePrompt[] = session.messages.slice(0, -1).map(m => ({\n    role: m.role,\n    content: m.content,\n  }));\n\n  const generationId = createId(\'ai-gen\');\n  aiCurrentGenerationId.value = generationId;\n  aiIsGenerating.value = true;\n  aiStreamingText.value = \'\';\n\n  // Subscribe to streaming events\n  aiStreamSubscription = eventOn(\n    iframe_events.STREAM_TOKEN_RECEIVED_FULLY,\n    (fullText: string, genId: string) => {\n      if (genId === generationId) {\n        aiStreamingText.value = fullText;\n      }\n    }\n  );\n\n  try {\n    const generateConfig: Parameters<typeof generate>[0] = {\n      generation_id: generationId,\n      user_input: text,\n      should_stream: true,\n      should_silence: true,\n    };\n\n    if (!aiUseContext.value) {\n      // :  chat_history, \n      generateConfig.overrides = {\n        chat_history: { prompts: historyPrompts },\n      };\n    }\n    // :  chat_history,  prompt (++)\n\n    const result = await generate(generateConfig);\n\n    aiAddMessage(\'assistant\', result);\n    aiStreamingText.value = \'\';\n\n    // Auto-extract tags\n    const tags = aiExtractTags(result);\n    if (tags.length > 0) {\n      aiExtractedTags.value = tags;\n      aiShowTagReview.value = true;\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`AI : ${message}`);\n    setStatus(`AI : ${message}`);\n  } finally {\n    aiIsGenerating.value = false;\n    aiCurrentGenerationId.value = null;\n    aiStreamSubscription?.stop();\n    aiStreamSubscription = null;\n  }\n}\n\nfunction aiStopGeneration(): void {\n  if (aiCurrentGenerationId.value) {\n    stopGenerationById(aiCurrentGenerationId.value);\n  }\n}\n\n//  AI Chat: tag extraction \nfunction aiExtractTags(text: string): ExtractedTag[] {\n  const regex = /<([^/<>\\s]+)>([\\s\\S]*?)<\\/\\1>/g;\n  const results: ExtractedTag[] = [];\n  let match: RegExpExecArray | null;\n  while ((match = regex.exec(text)) !== null) {\n    results.push({\n      tag: match[1],\n      content: match[0],\n      selected: true,\n    });\n  }\n  return results;\n}\n\nasync function aiCreateSelectedEntries(): Promise<void> {\n  const selected = aiExtractedTags.value.filter(t => t.selected);\n  if (selected.length === 0) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  const targetName = aiTargetWorldbook.value;\n  if (!targetName) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  try {\n    const newEntries = selected.map(t => ({\n      name: t.tag,\n      content: t.content,\n    }));\n\n    await createWorldbookEntries(targetName, newEntries);\n    toastr.success(` ${selected.length}  "${targetName}"`);\n    setStatus(` ${selected.length}  "${targetName}"`);\n    aiShowTagReview.value = false;\n    aiExtractedTags.value = [];\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n  }\n}\n\nfunction aiToggleMode(): void {\n  aiGeneratorMode.value = !aiGeneratorMode.value;\n  if (aiGeneratorMode.value) {\n    globalWorldbookMode.value = false;\n  }\n}\n\nfunction setStatus(message: string): void {\n  statusMessage.value = message;\n}\n\nfunction syncExtraTextWithSelection(): void {\n  if (!selectedEntry.value || !selectedEntry.value.extra) {\n    selectedExtraText.value = \'\';\n    return;\n  }\n  selectedExtraText.value = JSON.stringify(selectedEntry.value.extra, null, 2);\n}\n\nfunction formatDateTime(timestamp: number): string {\n  try {\n    return new Date(timestamp).toLocaleString(\'zh-CN\', { hour12: false });\n  } catch {\n    return String(timestamp);\n  }\n}\n\nfunction formatHistoryOptionLabel(label: string, ts: number, isCurrent: boolean): string {\n  if (isCurrent) {\n    return \'Current\';\n  }\n  if (label === \'\' || ts <= 0) {\n    return label;\n  }\n  return `${label}  ${formatDateTime(ts)}`;\n}\n\nfunction getEntryVersionPreview(view: EntryVersionView | null): string {\n  if (!view) {\n    return \'\';\n  }\n  const content = toStringSafe(view.entry.content).replace(/\\s+/g, \' \').trim();\n  if (!content) {\n    return \'()\';\n  }\n  return content.slice(0, 160);\n}\n\nfunction getWorldbookVersionDiffSummary(\n  left: WorldbookVersionView | null,\n  right: WorldbookVersionView | null,\n): string {\n  if (!left || !right) {\n    return \'\';\n  }\n  const leftMap = new Map<number, WorldbookEntry>();\n  const rightMap = new Map<number, WorldbookEntry>();\n  left.entries.forEach(entry => leftMap.set(entry.uid, entry));\n  right.entries.forEach(entry => rightMap.set(entry.uid, entry));\n\n  let added = 0;\n  let removed = 0;\n  let changed = 0;\n\n  for (const [uid, rightEntry] of rightMap) {\n    const leftEntry = leftMap.get(uid);\n    if (!leftEntry) {\n      added += 1;\n      continue;\n    }\n    if (JSON.stringify(leftEntry) !== JSON.stringify(rightEntry)) {\n      changed += 1;\n    }\n  }\n  for (const uid of leftMap.keys()) {\n    if (!rightMap.has(uid)) {\n      removed += 1;\n    }\n  }\n\n  return ` ${added} /  ${changed} /  ${removed}`;\n}\n\nfunction getEntryVersionDiffSummary(left: EntryVersionView | null, right: EntryVersionView | null): string {\n  if (!left || !right) {\n    return \'\';\n  }\n  const leftText = serializeEntryVersionForDiff(left);\n  const rightText = serializeEntryVersionForDiff(right);\n  const parts = diffLines(leftText, rightText) as Array<{ value: string; added?: boolean; removed?: boolean }>;\n  let addLines = 0;\n  let delLines = 0;\n  for (const part of parts) {\n    const lines = part.value.split(\'\\n\');\n    if (lines.length && lines[lines.length - 1] === \'\') {\n      lines.pop();\n    }\n    if (part.added) {\n      addLines += lines.length;\n    } else if (part.removed) {\n      delLines += lines.length;\n    }\n  }\n  const changed = Math.min(addLines, delLines);\n  const added = Math.max(0, addLines - changed);\n  const removed = Math.max(0, delLines - changed);\n  return ` ${added} /  ${changed} /  ${removed}`;\n}\n\nfunction escapeHtml(text: string): string {\n  return text\n    .replaceAll(\'&\', \'&amp;\')\n    .replaceAll(\'<\', \'&lt;\')\n    .replaceAll(\'>\', \'&gt;\')\n    .replaceAll(\'"\', \'&quot;\')\n    .replaceAll("\'", \'&#39;\');\n}\n\nfunction serializeEntryVersionForDiff(view: EntryVersionView | null): string {\n  if (!view) {\n    return \'\';\n  }\n  const entry = view.entry;\n  const payload = {\n    uid: entry.uid,\n    name: entry.name,\n    enabled: entry.enabled,\n    strategy: entry.strategy,\n    position: entry.position,\n    probability: entry.probability,\n    recursion: entry.recursion,\n    effect: entry.effect,\n    content: entry.content,\n    extra: entry.extra ?? null,\n  };\n  return JSON.stringify(payload, null, 2);\n}\n\nfunction serializeWorldbookVersionForDiff(view: WorldbookVersionView | null): string {\n  if (!view) {\n    return \'\';\n  }\n  const entries = view.entries\n    .map(entry => ({\n      uid: entry.uid,\n      name: entry.name,\n      enabled: entry.enabled,\n      type: entry.strategy.type,\n      keys: entry.strategy.keys.map(stringifyKeyword),\n      position: entry.position,\n      probability: entry.probability,\n      content: entry.content,\n    }))\n    .sort((left, right) => left.uid - right.uid);\n  return JSON.stringify({ entries }, null, 2);\n}\n\nfunction buildDiffHtml(leftText: string, rightText: string): { leftHtml: string; rightHtml: string } {\n  const leftRendered: string[] = [];\n  const rightRendered: string[] = [];\n  let leftLineNo = 1;\n  let rightLineNo = 1;\n  const parts = diffLines(leftText, rightText);\n\n  for (const part of parts as Array<{ value: string; added?: boolean; removed?: boolean }>) {\n    const lines = part.value.split(\'\\n\');\n    if (lines.length && lines[lines.length - 1] === \'\') {\n      lines.pop();\n    }\n    if (!lines.length) {\n      continue;\n    }\n\n    if (part.added) {\n      for (const line of lines) {\n        leftRendered.push(`<div class="diff-row empty"><span class="line-no"></span><span class="line-text">&nbsp;</span></div>`);\n        rightRendered.push(\n          `<div class="diff-row add"><span class="line-no">${rightLineNo}</span><span class="line-text">${escapeHtml(line) || \'&nbsp;\'}</span></div>`,\n        );\n        rightLineNo += 1;\n      }\n      continue;\n    }\n\n    if (part.removed) {\n      for (const line of lines) {\n        leftRendered.push(\n          `<div class="diff-row del"><span class="line-no">${leftLineNo}</span><span class="line-text">${escapeHtml(line) || \'&nbsp;\'}</span></div>`,\n        );\n        rightRendered.push(`<div class="diff-row empty"><span class="line-no"></span><span class="line-text">&nbsp;</span></div>`);\n        leftLineNo += 1;\n      }\n      continue;\n    }\n\n    for (const line of lines) {\n      const safe = escapeHtml(line) || \'&nbsp;\';\n      leftRendered.push(`<div class="diff-row"><span class="line-no">${leftLineNo}</span><span class="line-text">${safe}</span></div>`);\n      rightRendered.push(`<div class="diff-row"><span class="line-no">${rightLineNo}</span><span class="line-text">${safe}</span></div>`);\n      leftLineNo += 1;\n      rightLineNo += 1;\n    }\n  }\n\n  return {\n    leftHtml: leftRendered.join(\'\'),\n    rightHtml: rightRendered.join(\'\'),\n  };\n}\n\nfunction parseBatchExcludeTokens(value: string): string[] {\n  const seen = new Set<string>();\n  const tokens: string[] = [];\n  for (const raw of value.split(/[\\n,]/g)) {\n    const token = raw.trim().toLowerCase();\n    if (!token || seen.has(token)) {\n      continue;\n    }\n    seen.add(token);\n    tokens.push(token);\n  }\n  return tokens;\n}\n\nfunction shouldExcludeEntryForBatch(entry: WorldbookEntry, tokens: string[]): boolean {\n  if (!tokens.length) {\n    return false;\n  }\n  const name = entry.name.toLowerCase();\n  const content = entry.content.toLowerCase();\n  const keys = entry.strategy.keys.map(key => stringifyKeyword(key).toLowerCase()).join(\' \');\n  const secondaryKeys = entry.strategy.keys_secondary.keys.map(key => stringifyKeyword(key).toLowerCase()).join(\' \');\n\n  for (const token of tokens) {\n    const uidMatch = token.match(/^(?:#|uid:)?(\\d+)$/);\n    if (uidMatch && Number(uidMatch[1]) === entry.uid) {\n      return true;\n    }\n\n    const scoped = token.match(/^(name|content|keys|secondary|secondary_keys):(.+)$/);\n    if (scoped) {\n      const scope = scoped[1];\n      const needle = scoped[2].trim();\n      if (!needle) {\n        continue;\n      }\n\n      if (scope === \'name\' && name.includes(needle)) {\n        return true;\n      }\n      if (scope === \'content\' && content.includes(needle)) {\n        return true;\n      }\n      if (scope === \'keys\' && keys.includes(needle)) {\n        return true;\n      }\n      if ((scope === \'secondary\' || scope === \'secondary_keys\') && secondaryKeys.includes(needle)) {\n        return true;\n      }\n      continue;\n    }\n\n    const plain = token.trim();\n    if (!plain) {\n      continue;\n    }\n\n    if (\n      name.includes(plain) ||\n      content.includes(plain) ||\n      keys.includes(plain) ||\n      secondaryKeys.includes(plain)\n    ) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction getFindFieldLabel(field: FindFieldKey): string {\n  if (field === \'name\') {\n    return \'\';\n  }\n  if (field === \'content\') {\n    return \'\';\n  }\n  return \'\';\n}\n\nfunction resolveBatchRegex(findText: string): RegExp | null {\n  if (!batchUseRegex.value) {\n    return null;\n  }\n  try {\n    return new RegExp(findText, \'g\');\n  } catch (error) {\n    toastr.error(`: ${error instanceof Error ? error.message : String(error)}`);\n    return null;\n  }\n}\n\nfunction getBatchTargetEntries(): WorldbookEntry[] {\n  if (batchSearchScope.value === \'current\') {\n    return selectedEntry.value ? [selectedEntry.value] : [];\n  }\n  return draftEntries.value;\n}\n\nfunction getEnabledFindFields(): FindFieldKey[] {\n  const fields: FindFieldKey[] = [];\n  if (batchInName.value) {\n    fields.push(\'name\');\n  }\n  if (batchInContent.value) {\n    fields.push(\'content\');\n  }\n  if (batchInKeys.value) {\n    fields.push(\'keys\');\n  }\n  return fields;\n}\n\nfunction getEntryFieldText(entry: WorldbookEntry, field: FindFieldKey): string {\n  if (field === \'name\') {\n    return entry.name;\n  }\n  if (field === \'content\') {\n    return entry.content;\n  }\n  return entry.strategy.keys.map(key => stringifyKeyword(key)).join(\', \');\n}\n\nfunction collectMatchIndexes(text: string, findText: string, regex: RegExp | null): Array<{ start: number; end: number; matchedText: string }> {\n  const hits: Array<{ start: number; end: number; matchedText: string }> = [];\n  if (!text || !findText) {\n    return hits;\n  }\n\n  if (!regex) {\n    let cursor = 0;\n    while (cursor <= text.length) {\n      const start = text.indexOf(findText, cursor);\n      if (start < 0) {\n        break;\n      }\n      const end = start + findText.length;\n      hits.push({\n        start,\n        end,\n        matchedText: text.slice(start, end),\n      });\n      cursor = Math.max(end, start + 1);\n    }\n    return hits;\n  }\n\n  const runtime = new RegExp(regex.source, regex.flags.includes(\'g\') ? regex.flags : `${regex.flags}g`);\n  let result: RegExpExecArray | null = null;\n  while ((result = runtime.exec(text)) !== null) {\n    const matched = result[0] ?? \'\';\n    if (!matched) {\n      runtime.lastIndex += 1;\n      continue;\n    }\n    const start = result.index;\n    const end = start + matched.length;\n    hits.push({\n      start,\n      end,\n      matchedText: matched,\n    });\n  }\n  return hits;\n}\n\nfunction buildFindPreview(text: string, start: number, end: number): string {\n  const left = Math.max(0, start - 18);\n  const right = Math.min(text.length, end + 22);\n  const prefix = left > 0 ? \'...\' : \'\';\n  const suffix = right < text.length ? \'...\' : \'\';\n  return `${prefix}${text.slice(left, right).replace(/\\s+/g, \' \')}${suffix}`;\n}\n\nfunction collectFindHits(findText: string, regex: RegExp | null, excludeTokens: string[]): FindHit[] {\n  const fields = getEnabledFindFields();\n  if (!fields.length) {\n    return [];\n  }\n  const entries = getBatchTargetEntries();\n  const hits: FindHit[] = [];\n\n  for (const entry of entries) {\n    if (shouldExcludeEntryForBatch(entry, excludeTokens)) {\n      continue;\n    }\n    for (const field of fields) {\n      const text = getEntryFieldText(entry, field);\n      const indexes = collectMatchIndexes(text, findText, regex);\n      for (const match of indexes) {\n        hits.push({\n          entryUid: entry.uid,\n          entryName: entry.name,\n          field,\n          start: match.start,\n          end: match.end,\n          matchedText: match.matchedText,\n          preview: buildFindPreview(text, match.start, match.end),\n        });\n      }\n    }\n  }\n\n  return hits;\n}\n\nfunction isSameFindHit(left: FindHit, right: FindHit): boolean {\n  return (\n    left.entryUid === right.entryUid &&\n    left.field === right.field &&\n    left.start === right.start &&\n    left.end === right.end &&\n    left.matchedText === right.matchedText\n  );\n}\n\nfunction resetFindState(): void {\n  findHits.value = [];\n  findHitIndex.value = -1;\n}\n\nfunction getFindTargetElement(field: FindFieldKey): HTMLInputElement | HTMLTextAreaElement | null {\n  const root = editorShellRef.value;\n  if (!root) {\n    return null;\n  }\n  if (field === \'name\') {\n    return root.querySelector(\'.editor-comment input.text-input\');\n  }\n  if (field === \'content\') {\n    return root.querySelector(\'.editor-content-area\');\n  }\n  return root.querySelector(\'.editor-keyword-grid .field textarea\');\n}\n\nfunction getTextareaLineHeight(element: HTMLTextAreaElement): number {\n  const style = window.getComputedStyle(element);\n  const lineHeight = Number.parseFloat(style.lineHeight);\n  if (Number.isFinite(lineHeight) && lineHeight > 0) {\n    return lineHeight;\n  }\n  const fontSize = Number.parseFloat(style.fontSize);\n  if (Number.isFinite(fontSize) && fontSize > 0) {\n    return fontSize * 1.4;\n  }\n  return 18;\n}\n\nfunction scrollTextareaToSelection(element: HTMLTextAreaElement, start: number): void {\n  const lineHeight = getTextareaLineHeight(element);\n  const before = element.value.slice(0, start);\n  const lineIndex = before.split(\'\\n\').length - 1;\n  const desiredTop = Math.max(0, lineIndex * lineHeight - element.clientHeight * 0.35);\n  element.scrollTop = desiredTop;\n}\n\nasync function revealFindHitInEditor(hit: FindHit): Promise<void> {\n  await nextTick();\n  let target = getFindTargetElement(hit.field);\n  if (!target) {\n    await nextTick();\n    target = getFindTargetElement(hit.field);\n    if (!target) {\n      return;\n    }\n  }\n\n  const maxLen = target.value.length;\n  const start = Math.max(0, Math.min(hit.start, maxLen));\n  const end = Math.max(start, Math.min(hit.end, maxLen));\n\n  target.focus();\n  target.setSelectionRange(start, end);\n  if (target instanceof HTMLTextAreaElement) {\n    scrollTextareaToSelection(target, start);\n  }\n  target.scrollIntoView({ block: \'center\', inline: \'nearest\' });\n  requestAnimationFrame(() => {\n    target?.scrollIntoView({ block: \'center\', inline: \'nearest\' });\n    if (target instanceof HTMLTextAreaElement) {\n      scrollTextareaToSelection(target, start);\n    }\n  });\n}\n\nfunction moveToFindHit(hit: FindHit, index: number, total: number): void {\n  findHitIndex.value = index;\n  selectedEntryUid.value = hit.entryUid;\n  void revealFindHitInEditor(hit);\n  const entryLabel = hit.entryName || ` ${hit.entryUid}`;\n  setStatus(` ${index + 1}/${total}: ${entryLabel}  ${getFindFieldLabel(hit.field)}  ${hit.preview}`);\n}\n\nfunction runFind(step: -1 | 0 | 1): void {\n  const findText = batchFindText.value;\n  if (!findText) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  if (!getEnabledFindFields().length) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  if (batchSearchScope.value === \'current\' && !selectedEntry.value) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  const excludeTokens = parseBatchExcludeTokens(batchExcludeText.value);\n  const regex = resolveBatchRegex(findText);\n  if (batchUseRegex.value && !regex) {\n    return;\n  }\n\n  const hits = collectFindHits(findText, regex, excludeTokens);\n  findHits.value = hits;\n\n  if (!hits.length) {\n    findHitIndex.value = -1;\n    setStatus(\'\');\n    toastr.info(\'\');\n    return;\n  }\n\n  if (step === 0) {\n    moveToFindHit(hits[0], 0, hits.length);\n    return;\n  }\n\n  const prevHit = activeFindHit.value;\n  const currentIndex = prevHit ? hits.findIndex(item => isSameFindHit(item, prevHit)) : findHitIndex.value;\n  let nextIndex: number;\n  if (currentIndex < 0) {\n    nextIndex = step > 0 ? 0 : hits.length - 1;\n  } else {\n    nextIndex = (currentIndex + step + hits.length) % hits.length;\n  }\n  moveToFindHit(hits[nextIndex], nextIndex, hits.length);\n}\n\nfunction findFirstMatch(): void {\n  runFind(0);\n}\n\nfunction findNextMatch(): void {\n  runFind(1);\n}\n\nfunction findPreviousMatch(): void {\n  runFind(-1);\n}\n\nfunction ensureSelectedEntryExists(): void {\n  if (!draftEntries.value.length) {\n    selectedEntryUid.value = null;\n    return;\n  }\n  if (selectedEntryUid.value === null) {\n    selectedEntryUid.value = draftEntries.value[0].uid;\n    return;\n  }\n  const exists = draftEntries.value.some(entry => entry.uid === selectedEntryUid.value);\n  if (!exists) {\n    selectedEntryUid.value = draftEntries.value[0].uid;\n  }\n}\n\nfunction selectEntry(uid: number): void {\n  selectedEntryUid.value = uid;\n  if (isMobile.value) {\n    mobileTab.value = \'edit\';\n  }\n}\n\nfunction goBackToList(): void {\n  selectedEntryUid.value = null;\n  mobileTab.value = \'list\';\n}\n\nfunction createEntrySnapshotRecord(\n  label: string,\n  uid: number,\n  name: string,\n  entry: WorldbookEntry,\n): EntrySnapshot {\n  return {\n    id: createId(\'entry-snapshot\'),\n    label,\n    ts: Date.now(),\n    uid,\n    name: name || ` ${uid}`,\n    entry: normalizeEntry(klona(entry), uid),\n  };\n}\n\nfunction pushEntrySnapshotsBulk(\n  items: Array<{\n    label: string;\n    uid: number;\n    name: string;\n    entry: WorldbookEntry;\n  }>,\n): number {\n  if (!selectedWorldbookName.value || !items.length) {\n    return 0;\n  }\n\n  let added = 0;\n  const worldbookName = selectedWorldbookName.value;\n\n  updatePersistedState(state => {\n    const byWorldbook = state.entry_history[worldbookName] ?? {};\n\n    for (const item of items) {\n      const uidKey = String(item.uid);\n      const incoming = createEntrySnapshotRecord(item.label, item.uid, item.name, item.entry);\n      const list = byWorldbook[uidKey] ?? [];\n\n      if (list[0] && JSON.stringify(list[0].entry) === JSON.stringify(incoming.entry)) {\n        continue;\n      }\n\n      list.unshift(incoming);\n      if (list.length > ENTRY_HISTORY_LIMIT) {\n        list.length = ENTRY_HISTORY_LIMIT;\n      }\n      byWorldbook[uidKey] = list;\n      added += 1;\n    }\n\n    state.entry_history[worldbookName] = byWorldbook;\n  });\n\n  return added;\n}\n\nfunction pushEntrySnapshot(label: string, entry: WorldbookEntry): boolean {\n  const added = pushEntrySnapshotsBulk([\n    {\n      label,\n      uid: entry.uid,\n      name: entry.name,\n      entry,\n    },\n  ]);\n  return added > 0;\n}\n\nfunction collectEntrySnapshotsBeforeSave(): Array<{\n  label: string;\n  uid: number;\n  name: string;\n  entry: WorldbookEntry;\n}> {\n  const result: Array<{\n    label: string;\n    uid: number;\n    name: string;\n    entry: WorldbookEntry;\n  }> = [];\n  const draftByUid = new Map<number, WorldbookEntry>();\n  draftEntries.value.forEach(entry => {\n    draftByUid.set(entry.uid, entry);\n  });\n\n  for (const previous of originalEntries.value) {\n    const current = draftByUid.get(previous.uid);\n    if (!current) {\n      result.push({\n        label: \'\',\n        uid: previous.uid,\n        name: previous.name,\n        entry: previous,\n      });\n      continue;\n    }\n    if (JSON.stringify(previous) !== JSON.stringify(current)) {\n      result.push({\n        label: \'\',\n        uid: previous.uid,\n        name: previous.name,\n        entry: previous,\n      });\n    }\n  }\n\n  return result;\n}\n\nfunction pushSnapshot(label: string): void {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  const worldbookName = selectedWorldbookName.value;\n  const snapshot: WorldbookSnapshot = {\n    id: createId(\'snapshot\'),\n    label,\n    ts: Date.now(),\n    entries: klona(draftEntries.value),\n  };\n\n  updatePersistedState(state => {\n    const list = state.history[worldbookName] ?? [];\n    list.unshift(snapshot);\n    if (list.length > HISTORY_LIMIT) {\n      list.length = HISTORY_LIMIT;\n    }\n    state.history[worldbookName] = list;\n  });\n}\n\nfunction createManualSnapshot(): void {\n  if (!selectedWorldbookName.value) {\n    toastr.warning(\'\');\n    return;\n  }\n  pushSnapshot(\'\');\n  toastr.success(\'\');\n}\n\nfunction openEntryHistoryModal(): void {\n  if (!selectedEntry.value) {\n    toastr.warning(\'\');\n    return;\n  }\n  const nonCurrent = entryVersionViews.value.find(item => !item.isCurrent) ?? null;\n  entryHistoryRightId.value = \'__current__\';\n  entryHistoryLeftId.value = nonCurrent?.id ?? \'__current__\';\n  showEntryHistoryModal.value = true;\n}\n\nfunction openWorldbookHistoryModal(): void {\n  if (!selectedWorldbookName.value) {\n    toastr.warning(\'\');\n    return;\n  }\n  const nonCurrent = worldbookVersionViews.value.find(item => !item.isCurrent) ?? null;\n  worldbookHistoryRightId.value = \'__current__\';\n  worldbookHistoryLeftId.value = nonCurrent?.id ?? \'__current__\';\n  showWorldbookHistoryModal.value = true;\n}\n\nfunction createManualEntrySnapshot(): void {\n  if (!selectedEntry.value) {\n    toastr.warning(\'\');\n    return;\n  }\n  const added = pushEntrySnapshot(\'\', selectedEntry.value);\n  if (added) {\n    toastr.success(\'\');\n  } else {\n    toastr.info(\'\');\n  }\n}\n\nfunction restoreSnapshot(snapshotId: string): void {\n  const snapshot = snapshotsForCurrent.value.find(item => item.id === snapshotId);\n  if (!snapshot) {\n    return;\n  }\n  if (!confirm(` "${snapshot.label}" ? `)) {\n    return;\n  }\n  draftEntries.value = normalizeEntryList(snapshot.entries);\n  ensureSelectedEntryExists();\n  setStatus(`${snapshot.label}`);\n}\n\nfunction restoreWorldbookFromLeftHistory(): void {\n  const target = selectedWorldbookHistoryLeft.value;\n  if (!target || target.isCurrent) {\n    return;\n  }\n  if (!confirm(` Left  "${target.label}" ? `)) {\n    return;\n  }\n  draftEntries.value = normalizeEntryList(klona(target.entries));\n  ensureSelectedEntryExists();\n  setStatus(`${target.label}`);\n  toastr.success(\' Left \');\n}\n\nfunction deleteSnapshot(snapshotId: string): void {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  updatePersistedState(state => {\n    const list = state.history[selectedWorldbookName.value] ?? [];\n    state.history[selectedWorldbookName.value] = list.filter(item => item.id !== snapshotId);\n  });\n}\n\nfunction clearCurrentSnapshots(): void {\n  if (!selectedWorldbookName.value || !snapshotsForCurrent.value.length) {\n    return;\n  }\n  if (!confirm(` "${selectedWorldbookName.value}" `)) {\n    return;\n  }\n  updatePersistedState(state => {\n    delete state.history[selectedWorldbookName.value];\n  });\n}\n\nfunction restoreEntrySnapshot(snapshotId: string): void {\n  if (!selectedEntry.value || selectedEntryIndex.value < 0) {\n    return;\n  }\n  const snapshot = entrySnapshotsForSelected.value.find(item => item.id === snapshotId);\n  if (!snapshot) {\n    return;\n  }\n  if (!confirm(` "${snapshot.label}" ?`)) {\n    return;\n  }\n\n  // \n  pushEntrySnapshot(\'\', selectedEntry.value);\n\n  const restored = normalizeEntry(klona(snapshot.entry), selectedEntry.value.uid);\n  restored.uid = selectedEntry.value.uid;\n  draftEntries.value.splice(selectedEntryIndex.value, 1, restored);\n  selectedEntryUid.value = restored.uid;\n  setStatus(`${snapshot.label}`);\n  toastr.success(\'\');\n}\n\nfunction restoreEntryFromLeftHistory(): void {\n  const target = selectedEntryHistoryLeft.value;\n  if (!target || target.isCurrent) {\n    return;\n  }\n  if (!selectedEntry.value || selectedEntryIndex.value < 0) {\n    return;\n  }\n  if (!confirm(` "${target.label}" ?`)) {\n    return;\n  }\n  pushEntrySnapshot(\'\', selectedEntry.value);\n  const restored = normalizeEntry(klona(target.entry), selectedEntry.value.uid);\n  restored.uid = selectedEntry.value.uid;\n  draftEntries.value.splice(selectedEntryIndex.value, 1, restored);\n  selectedEntryUid.value = restored.uid;\n  setStatus(`${target.label}`);\n  toastr.success(\' Left \');\n}\n\nfunction deleteEntrySnapshot(snapshotId: string): void {\n  if (!selectedWorldbookName.value || !selectedEntry.value) {\n    return;\n  }\n  const worldbookName = selectedWorldbookName.value;\n  const uidKey = String(selectedEntry.value.uid);\n  updatePersistedState(state => {\n    const byWorldbook = state.entry_history[worldbookName] ?? {};\n    const list = byWorldbook[uidKey] ?? [];\n    byWorldbook[uidKey] = list.filter(item => item.id !== snapshotId);\n    state.entry_history[worldbookName] = byWorldbook;\n  });\n}\n\nfunction clearCurrentEntrySnapshots(): void {\n  if (!selectedWorldbookName.value || !selectedEntry.value || !entrySnapshotsForSelected.value.length) {\n    return;\n  }\n  if (!confirm(` #${selectedEntry.value.uid} `)) {\n    return;\n  }\n  const worldbookName = selectedWorldbookName.value;\n  const uidKey = String(selectedEntry.value.uid);\n  updatePersistedState(state => {\n    const byWorldbook = state.entry_history[worldbookName] ?? {};\n    delete byWorldbook[uidKey];\n    state.entry_history[worldbookName] = byWorldbook;\n  });\n}\n\nfunction handleSelectedPositionTypeChanged(): void {\n  if (!selectedEntry.value) {\n    return;\n  }\n  if (selectedEntry.value.position.type !== \'at_depth\') {\n    selectedEntry.value.position.role = \'system\';\n    selectedEntry.value.position.depth = 4;\n  }\n}\n\nfunction applyExtraJson(): void {\n  if (!selectedEntry.value) {\n    return;\n  }\n  const text = selectedExtraText.value.trim();\n  if (!text) {\n    selectedEntry.value.extra = undefined;\n    return;\n  }\n  try {\n    const parsed = JSON.parse(text);\n    const parsedRecord = asRecord(parsed);\n    if (!parsedRecord) {\n      throw new Error(\'extra  JSON \');\n    }\n    selectedEntry.value.extra = klona(parsedRecord);\n    toastr.success(\'extra \');\n  } catch (error) {\n    toastr.error(`extra JSON : ${error instanceof Error ? error.message : String(error)}`);\n  }\n}\n\nfunction clearExtra(): void {\n  if (!selectedEntry.value) {\n    return;\n  }\n  selectedEntry.value.extra = undefined;\n  selectedExtraText.value = \'\';\n}\n\nfunction addEntry(): void {\n  const uid = getNextUid(draftEntries.value);\n  const entry = createDefaultEntry(uid);\n  draftEntries.value.push(entry);\n  selectedEntryUid.value = uid;\n  setStatus(` #${uid}`);\n}\n\nfunction duplicateSelectedEntry(): void {\n  if (!selectedEntry.value || selectedEntryIndex.value < 0) {\n    return;\n  }\n  const uid = getNextUid(draftEntries.value);\n  const duplicated = normalizeEntry(klona(selectedEntry.value), uid);\n  duplicated.uid = uid;\n  duplicated.name = `${duplicated.name} ()`;\n  draftEntries.value.splice(selectedEntryIndex.value + 1, 0, duplicated);\n  selectedEntryUid.value = uid;\n  setStatus(` #${selectedEntry.value.uid}`);\n}\n\nfunction removeSelectedEntry(): void {\n  if (!selectedEntry.value || selectedEntryIndex.value < 0) {\n    return;\n  }\n  if (!confirm(` "${selectedEntry.value.name}" ?`)) {\n    return;\n  }\n  pushEntrySnapshot(\'\', selectedEntry.value);\n  draftEntries.value.splice(selectedEntryIndex.value, 1);\n  if (isMobile.value) {\n    selectedEntryUid.value = null;\n  } else {\n    ensureSelectedEntryExists();\n  }\n  setStatus(\'\');\n}\n\nfunction moveSelectedEntry(direction: -1 | 1): void {\n  if (selectedEntryIndex.value < 0) {\n    return;\n  }\n  const target = selectedEntryIndex.value + direction;\n  if (target < 0 || target >= draftEntries.value.length) {\n    return;\n  }\n  const [entry] = draftEntries.value.splice(selectedEntryIndex.value, 1);\n  draftEntries.value.splice(target, 0, entry);\n  selectedEntryUid.value = entry.uid;\n}\n\nfunction normalizeAllEntries(): void {\n  draftEntries.value = normalizeEntryList(draftEntries.value.map(entry => klona(entry)));\n  ensureSelectedEntryExists();\n  setStatus(\'\');\n}\n\nfunction sortEntriesByOrderDesc(): void {\n  draftEntries.value.sort((left, right) => right.position.order - left.position.order);\n  ensureSelectedEntryExists();\n  setStatus(\' order \');\n}\n\nfunction setEnabledForAll(enabled: boolean): void {\n  draftEntries.value.forEach(entry => {\n    entry.enabled = enabled;\n  });\n  setStatus(enabled ? \'\' : \'\');\n}\n\nfunction applyBatchReplace(): void {\n  const findText = batchFindText.value;\n  if (!findText) {\n    toastr.warning(\'\');\n    return;\n  }\n  if (!getEnabledFindFields().length) {\n    toastr.warning(\'\');\n    return;\n  }\n  if (batchSearchScope.value === \'current\' && !selectedEntry.value) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  const targetEntries = getBatchTargetEntries();\n  if (!targetEntries.length) {\n    toastr.warning(\'\');\n    return;\n  }\n\n  const excludeTokens = parseBatchExcludeTokens(batchExcludeText.value);\n  const regex = resolveBatchRegex(findText);\n  if (batchUseRegex.value && !regex) {\n    return;\n  }\n\n  let touched = 0;\n  let skipped = 0;\n  for (const entry of targetEntries) {\n    if (shouldExcludeEntryForBatch(entry, excludeTokens)) {\n      skipped += 1;\n      continue;\n    }\n\n    let changed = false;\n\n    if (batchInName.value) {\n      const next = regex\n        ? entry.name.replace(regex, batchReplaceText.value)\n        : entry.name.split(findText).join(batchReplaceText.value);\n      if (next !== entry.name) {\n        entry.name = next;\n        changed = true;\n      }\n    }\n\n    if (batchInContent.value) {\n      const next = regex\n        ? entry.content.replace(regex, batchReplaceText.value)\n        : entry.content.split(findText).join(batchReplaceText.value);\n      if (next !== entry.content) {\n        entry.content = next;\n        changed = true;\n      }\n    }\n\n    if (batchInKeys.value) {\n      const nextKeys = entry.strategy.keys.map(key => {\n        const text = stringifyKeyword(key);\n        return regex ? text.replace(regex, batchReplaceText.value) : text.split(findText).join(batchReplaceText.value);\n      });\n      const normalized = normalizeKeywordList(nextKeys);\n      if (\n        JSON.stringify(normalized.map(stringifyKeyword)) !== JSON.stringify(entry.strategy.keys.map(stringifyKeyword))\n      ) {\n        entry.strategy.keys = normalized;\n        changed = true;\n      }\n    }\n\n    if (changed) {\n      touched += 1;\n    }\n  }\n\n  resetFindState();\n  setStatus(\n    `${batchSearchScope.value === \'current\' ? \'\' : \'\'} ${touched}  ${skipped} `,\n  );\n}\n\nfunction downloadJson(filename: string, payload: unknown): void {\n  const text = JSON.stringify(payload, null, 2);\n  const blob = new Blob([text], { type: \'application/json\' });\n  const url = URL.createObjectURL(blob);\n  const anchor = document.createElement(\'a\');\n  anchor.href = url;\n  anchor.download = filename;\n  document.body.appendChild(anchor);\n  anchor.click();\n  document.body.removeChild(anchor);\n  URL.revokeObjectURL(url);\n}\n\nfunction exportCurrentWorldbook(): void {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  const payload = {\n    format: \'worldbook_assistant_v1\',\n    name: selectedWorldbookName.value,\n    exported_at: new Date().toISOString(),\n    entries: draftEntries.value,\n  };\n  const filename = `${selectedWorldbookName.value.replace(/[\\\\/:*?"<>|]/g, \'_\')}.json`;\n  downloadJson(filename, payload);\n}\n\nfunction collectRawEntries(root: Record<string, unknown>): unknown[] {\n  if (Array.isArray(root.entries)) {\n    return root.entries;\n  }\n  const entriesMap = asRecord(root.entries);\n  if (entriesMap) {\n    return Object.values(entriesMap);\n  }\n  const dataRoot = asRecord(root.data);\n  if (dataRoot) {\n    if (Array.isArray(dataRoot.entries)) {\n      return dataRoot.entries;\n    }\n    const dataEntriesMap = asRecord(dataRoot.entries);\n    if (dataEntriesMap) {\n      return Object.values(dataEntriesMap);\n    }\n  }\n  return [];\n}\n\nfunction parseImportedPayload(fileName: string, text: string): ImportedPayload {\n  const parsed = JSON.parse(text) as unknown;\n  const fallbackName = fileName.replace(/\\.[^/.]+$/, \'\') || \'\';\n\n  if (Array.isArray(parsed)) {\n    return {\n      name: fallbackName,\n      entries: normalizeEntryList(parsed),\n    };\n  }\n\n  const root = asRecord(parsed);\n  if (!root) {\n    throw new Error(\' JSON \');\n  }\n\n  const entries = collectRawEntries(root);\n  if (!entries.length) {\n    throw new Error(\' entries\');\n  }\n\n  const dataRoot = asRecord(root.data);\n  const nameCandidate = toStringSafe(root.name ?? dataRoot?.name, fallbackName).trim();\n\n  return {\n    name: nameCandidate || fallbackName,\n    entries: normalizeEntryList(entries),\n  };\n}\n\nfunction triggerImport(): void {\n  importFileInput.value?.click();\n}\n\nasync function onImportChange(event: Event): Promise<void> {\n  const target = event.target as HTMLInputElement | null;\n  const file = target?.files?.[0];\n  if (!file) {\n    return;\n  }\n\n  const fileText = await file.text();\n  try {\n    const payload = parseImportedPayload(file.name, fileText);\n    const suggested = payload.name || file.name.replace(/\\.[^/.]+$/, \'\');\n    const newNameRaw = prompt(\'\', suggested);\n    const newName = toStringSafe(newNameRaw).trim();\n    if (!newName) {\n      return;\n    }\n    await createOrReplaceWorldbook(newName, payload.entries, { render: \'immediate\' });\n    await reloadWorldbookNames(newName);\n    await refreshBindings();\n    toastr.success(`: ${newName}`);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    const shouldFallback = confirm(`: ${message}\\n`);\n    if (!shouldFallback) {\n      return;\n    }\n    const response = await importRawWorldbook(file.name, fileText);\n    if (!response.ok) {\n      throw new Error(`: HTTP ${response.status}`);\n    }\n    await hardRefresh();\n    toastr.success(\'\');\n  } finally {\n    if (target) {\n      target.value = \'\';\n    }\n  }\n}\n\nasync function refreshBindings(): Promise<void> {\n  bindings.global = [...getGlobalWorldbookNames()];\n  try {\n    const charBindings = getCharWorldbookNames(\'current\');\n    bindings.charPrimary = charBindings.primary;\n    bindings.charAdditional = [...charBindings.additional];\n  } catch {\n    bindings.charPrimary = null;\n    bindings.charAdditional = [];\n  }\n\n  try {\n    bindings.chat = getChatWorldbookName(\'current\');\n  } catch {\n    bindings.chat = null;\n  }\n  if (globalWorldbookMode.value) {\n    ensureSelectionForGlobalMode();\n  }\n}\n\nfunction resolveContextWorldbookCandidate(): string | null {\n  const available = worldbookNames.value;\n  if (!available.length) {\n    return null;\n  }\n  const chatBound = toStringSafe(bindings.chat).trim();\n  if (chatBound && available.includes(chatBound)) {\n    return chatBound;\n  }\n  const charPrimary = toStringSafe(bindings.charPrimary).trim();\n  if (charPrimary && available.includes(charPrimary)) {\n    return charPrimary;\n  }\n  const charAdditional = bindings.charAdditional.find(name => available.includes(name));\n  return charAdditional ?? null;\n}\n\nfunction ensureSelectionForGlobalMode(): void {\n  if (!globalWorldbookMode.value) {\n    return;\n  }\n  const globals = selectableWorldbookNames.value;\n  if (!globals.length) {\n    selectedWorldbookName.value = \'\';\n    return;\n  }\n  if (!globals.includes(selectedWorldbookName.value)) {\n    selectedWorldbookName.value = globals[0];\n  }\n}\n\nfunction trySelectWorldbookByContext(options: { preferWhenEmptyOnly?: boolean; force?: boolean } = {}): boolean {\n  if (globalWorldbookMode.value) {\n    return false;\n  }\n  if (options.preferWhenEmptyOnly && selectedWorldbookName.value) {\n    return false;\n  }\n  const candidate = resolveContextWorldbookCandidate();\n  if (!candidate || candidate === selectedWorldbookName.value) {\n    return false;\n  }\n  if (!options.force && hasUnsavedChanges.value) {\n    setStatus(\'/\');\n    return false;\n  }\n  selectedWorldbookName.value = candidate;\n  setStatus(`: ${candidate}`);\n  return true;\n}\n\nfunction toggleGlobalMode(): void {\n  globalWorldbookMode.value = !globalWorldbookMode.value;\n  if (globalWorldbookMode.value) {\n    aiGeneratorMode.value = false;\n    ensureSelectionForGlobalMode();\n    setStatus(\'\');\n    return;\n  }\n  if (!selectedWorldbookName.value) {\n    trySelectWorldbookByContext({ force: true });\n  }\n  setStatus(\'\');\n}\n\nasync function applyGlobalWorldbooks(nextGlobal: string[], statusLabel = \'\'): Promise<boolean> {\n  const normalized = [...new Set(nextGlobal.map(name => name.trim()).filter(Boolean))].filter(name =>\n    worldbookNames.value.includes(name),\n  );\n  try {\n    await rebindGlobalWorldbooks(normalized);\n    await refreshBindings();\n    ensureSelectionForGlobalMode();\n    setStatus(`${statusLabel}${normalized.length} `);\n    return true;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n    return false;\n  }\n}\n\nfunction addFirstGlobalCandidate(): void {\n  const first = globalAddCandidates.value[0];\n  if (!first) {\n    return;\n  }\n  void addGlobalWorldbook(first);\n}\n\nasync function addGlobalWorldbook(name: string): Promise<void> {\n  if (!name || bindings.global.includes(name)) {\n    return;\n  }\n  const success = await applyGlobalWorldbooks([...bindings.global, name], `: ${name}`);\n  if (success) {\n    globalAddSearchText.value = \'\';\n    updatePersistedState(state => {\n      state.role_override_baseline = null;\n    });\n  }\n}\n\nasync function removeGlobalWorldbook(name: string): Promise<void> {\n  if (!name || !bindings.global.includes(name)) {\n    return;\n  }\n  const success = await applyGlobalWorldbooks(\n    bindings.global.filter(item => item !== name),\n    `: ${name}`,\n  );\n  if (success) {\n    updatePersistedState(state => {\n      state.role_override_baseline = null;\n    });\n  }\n}\n\nasync function clearGlobalWorldbooks(): Promise<void> {\n  if (!bindings.global.length) {\n    return;\n  }\n  if (!confirm(\'\')) {\n    return;\n  }\n  const success = await applyGlobalWorldbooks([], \'\');\n  if (success) {\n    updatePersistedState(state => {\n      state.role_override_baseline = null;\n    });\n  }\n}\n\nfunction getCurrentGlobalWorldbookSet(): string[] {\n  return [...new Set(bindings.global.map(name => name.trim()).filter(Boolean))];\n}\n\nfunction normalizeWorldbookSet(input: string[]): string[] {\n  return [...new Set(input.map(name => name.trim()).filter(Boolean))];\n}\n\nfunction isSameWorldbookSet(left: string[], right: string[]): boolean {\n  const leftSorted = [...normalizeWorldbookSet(left)].sort();\n  const rightSorted = [...normalizeWorldbookSet(right)].sort();\n  if (leftSorted.length !== rightSorted.length) {\n    return false;\n  }\n  for (let index = 0; index < leftSorted.length; index += 1) {\n    if (leftSorted[index] !== rightSorted[index]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction refreshRoleBindingCandidates(): void {\n  let names: string[] = [];\n  try {\n    names = typeof getCharacterNames === \'function\' ? getCharacterNames() : [];\n  } catch (error) {\n    console.warn(\'[WorldbookAssistant] getCharacterNames failed:\', error);\n  }\n\n  const dedupe = new Set<string>();\n  const result: PresetRoleBinding[] = [];\n\n  for (const charName of names) {\n    const trimmed = charName.trim();\n    if (!trimmed) {\n      continue;\n    }\n    const key = `char:${trimmed}`;\n    if (dedupe.has(key)) {\n      continue;\n    }\n    dedupe.add(key);\n    result.push({\n      key,\n      name: trimmed,\n      avatar: \'\',\n      updated_at: Date.now(),\n    });\n  }\n\n  result.sort((left, right) => left.name.localeCompare(right.name, \'zh-Hans-CN\'));\n\n  const current = resolveCurrentRoleContext();\n  if (current && !result.some(item => item.key === current.key)) {\n    result.unshift(current);\n  }\n  roleBindingSourceCandidates.value = result;\n}\n\nfunction resolveCurrentRoleContext(): PresetRoleBinding | null {\n  let name: string | null = null;\n  try {\n    name = typeof getCurrentCharacterName === \'function\' ? getCurrentCharacterName() : null;\n  } catch (error) {\n    console.warn(\'[WorldbookAssistant] getCurrentCharacterName failed:\', error);\n  }\n  if (!name) {\n    return null;\n  }\n  const trimmed = name.trim();\n  if (!trimmed) {\n    return null;\n  }\n  return {\n    key: `char:${trimmed}`,\n    name: trimmed,\n    avatar: \'\',\n    updated_at: Date.now(),\n  };\n}\n\nfunction refreshCurrentRoleContext(): void {\n  currentRoleContext.value = resolveCurrentRoleContext();\n}\n\nasync function applyPresetWorldbooks(\n  preset: GlobalWorldbookPreset,\n  options: { statusPrefix?: string; silentWhenSame?: boolean } = {},\n): Promise<boolean> {\n  const normalized = normalizeWorldbookSet(preset.worldbooks);\n  const missing = normalized.filter(name => !worldbookNames.value.includes(name));\n  const matched = normalized.filter(name => worldbookNames.value.includes(name));\n\n  if (options.silentWhenSame && isSameWorldbookSet(getCurrentGlobalWorldbookSet(), matched)) {\n    updatePersistedState(state => {\n      state.last_global_preset_id = preset.id;\n    });\n    return true;\n  }\n\n  const statusPrefix = options.statusPrefix ?? \'\';\n  const success = await applyGlobalWorldbooks(matched, `${statusPrefix}: ${preset.name}`);\n  if (!success) {\n    return false;\n  }\n  updatePersistedState(state => {\n    state.last_global_preset_id = preset.id;\n  });\n  if (missing.length) {\n    toastr.warning(` ${missing.length} `);\n  }\n  return true;\n}\n\nasync function applySelectedGlobalPreset(): Promise<void> {\n  const preset = selectedGlobalPreset.value;\n  if (!preset) {\n    return;\n  }\n  const success = await applyPresetWorldbooks(preset);\n  if (success) {\n    updatePersistedState(state => {\n      state.role_override_baseline = null;\n    });\n  }\n}\n\nfunction getRoleBoundPresetForCurrentContext(): GlobalWorldbookPreset | null {\n  const role = currentRoleContext.value;\n  if (!role) {\n    return null;\n  }\n  return (\n    globalWorldbookPresets.value.find(item => item.role_bindings.some(binding => binding.key === role.key)) ?? null\n  );\n}\n\nasync function autoApplyRoleBoundPreset(): Promise<void> {\n  const rolePreset = getRoleBoundPresetForCurrentContext();\n  if (!rolePreset) {\n    const baseline = persistedState.value.role_override_baseline;\n    if (baseline) {\n      updatePersistedState(state => {\n        state.role_override_baseline = null;\n        state.last_global_preset_id = baseline.preset_id;\n      });\n      selectedGlobalPresetId.value = baseline.preset_id;\n      if (baseline.preset_id) {\n        const baselinePreset = globalWorldbookPresets.value.find(item => item.id === baseline.preset_id);\n        if (baselinePreset) {\n          await applyPresetWorldbooks(baselinePreset, {\n            statusPrefix: \'\',\n            silentWhenSame: true,\n          });\n        } else {\n          await applyGlobalWorldbooks(\n            baseline.worldbooks,\n            \'\',\n          );\n        }\n      } else {\n        await applyGlobalWorldbooks(\n          baseline.worldbooks,\n          \'\',\n        );\n      }\n    }\n    return;\n  }\n  if (!persistedState.value.role_override_baseline) {\n    updatePersistedState(state => {\n      state.role_override_baseline = {\n        preset_id: selectedGlobalPresetId.value,\n        worldbooks: getCurrentGlobalWorldbookSet(),\n      };\n    });\n  }\n  selectedGlobalPresetId.value = rolePreset.id;\n  await applyPresetWorldbooks(rolePreset, {\n    statusPrefix: `${currentRoleContext.value?.name ?? \'\'}`,\n    silentWhenSame: true,\n  });\n}\n\nfunction onGlobalPresetSelectionChanged(): void {\n  closeRolePicker();\n  if (!selectedGlobalPresetId.value) {\n    updatePersistedState(state => {\n      state.last_global_preset_id = \'\';\n      state.role_override_baseline = null;\n    });\n    if (bindings.global.length) {\n      void applyGlobalWorldbooks([], \'\');\n    } else {\n      setStatus(\'\');\n    }\n    return;\n  }\n  void applySelectedGlobalPreset();\n}\n\nfunction bindRoleToSelectedPreset(role: PresetRoleBinding): void {\n  const preset = selectedGlobalPreset.value;\n  if (!preset) {\n    toastr.warning(\'\');\n    return;\n  }\n  updatePersistedState(state => {\n    state.global_presets = (state.global_presets ?? []).map(item => {\n      if (item.id !== preset.id) {\n        return item;\n      }\n      const nextBindings = normalizePresetRoleBindings([\n        ...item.role_bindings.filter(binding => binding.key !== role.key),\n        {\n          key: role.key,\n          name: role.name,\n          avatar: role.avatar,\n          updated_at: Date.now(),\n        } satisfies PresetRoleBinding,\n      ]);\n      return {\n        ...item,\n        role_bindings: nextBindings,\n        updated_at: Date.now(),\n      };\n    });\n    state.last_global_preset_id = preset.id;\n  });\n  setStatus(`: ${role.name}  ${preset.name}`);\n}\n\nfunction bindCurrentRoleToSelectedPreset(): void {\n  const role = currentRoleContext.value;\n  if (!role) {\n    toastr.warning(\'\');\n    return;\n  }\n  bindRoleToSelectedPreset(role);\n}\n\nfunction bindRoleCandidateToSelectedPreset(candidate: RoleBindingCandidate): void {\n  if (candidate.bound) {\n    return;\n  }\n  bindRoleToSelectedPreset(candidate);\n  closeRolePicker();\n}\n\nfunction removeRoleBindingFromSelectedPreset(bindingKey: string): void {\n  const preset = selectedGlobalPreset.value;\n  if (!preset || !bindingKey) {\n    return;\n  }\n  updatePersistedState(state => {\n    state.global_presets = (state.global_presets ?? []).map(item => {\n      if (item.id !== preset.id) {\n        return item;\n      }\n      return {\n        ...item,\n        role_bindings: item.role_bindings.filter(binding => binding.key !== bindingKey),\n        updated_at: Date.now(),\n      };\n    });\n  });\n}\n\nfunction unbindCurrentRoleFromSelectedPreset(): void {\n  const role = currentRoleContext.value;\n  if (!role) {\n    toastr.warning(\'\');\n    return;\n  }\n  removeRoleBindingFromSelectedPreset(role.key);\n  setStatus(`: ${role.name}`);\n}\n\nfunction saveCurrentAsGlobalPreset(): void {\n  const current = getCurrentGlobalWorldbookSet();\n  if (!current.length) {\n    toastr.warning(\'\');\n    return;\n  }\n  const defaultName = selectedGlobalPreset.value?.name || ` ${globalWorldbookPresets.value.length + 1}`;\n  const nameRaw = prompt(\'\', defaultName);\n  const name = toStringSafe(nameRaw).trim();\n  if (!name) {\n    return;\n  }\n  const sameNamePreset = globalWorldbookPresets.value.find(item => item.name === name);\n  if (sameNamePreset && !confirm(` "${name}" `)) {\n    return;\n  }\n  const presetId = sameNamePreset?.id || createId(\'global-preset\');\n  const nextPreset: GlobalWorldbookPreset = {\n    id: presetId,\n    name,\n    worldbooks: current,\n    role_bindings: sameNamePreset?.role_bindings ?? [],\n    updated_at: Date.now(),\n  };\n  updatePersistedState(state => {\n    const list = (state.global_presets ?? []).filter(item => item.id !== presetId);\n    list.unshift(nextPreset);\n    state.global_presets = list.slice(0, GLOBAL_PRESET_LIMIT);\n    state.last_global_preset_id = presetId;\n  });\n  selectedGlobalPresetId.value = presetId;\n  setStatus(`: ${name}${current.length} `);\n  toastr.success(`: ${name}`);\n}\n\nfunction overwriteSelectedGlobalPreset(): void {\n  const preset = selectedGlobalPreset.value;\n  if (!preset) {\n    return;\n  }\n  const current = getCurrentGlobalWorldbookSet();\n  if (!current.length) {\n    toastr.warning(\'\');\n    return;\n  }\n  if (!confirm(` "${preset.name}" `)) {\n    return;\n  }\n  updatePersistedState(state => {\n    state.global_presets = (state.global_presets ?? []).map(item => {\n      if (item.id !== preset.id) {\n        return item;\n      }\n      return {\n        ...item,\n        worldbooks: current,\n        updated_at: Date.now(),\n      };\n    });\n    state.last_global_preset_id = preset.id;\n  });\n  setStatus(`: ${preset.name}${current.length} `);\n  toastr.success(`: ${preset.name}`);\n}\n\nfunction deleteSelectedGlobalPreset(): void {\n  const preset = selectedGlobalPreset.value;\n  if (!preset) {\n    return;\n  }\n  if (!confirm(` "${preset.name}" `)) {\n    return;\n  }\n  updatePersistedState(state => {\n    state.global_presets = (state.global_presets ?? []).filter(item => item.id !== preset.id);\n    if (state.last_global_preset_id === preset.id) {\n      state.last_global_preset_id = \'\';\n    }\n  });\n  selectedGlobalPresetId.value = \'\';\n  setStatus(`: ${preset.name}`);\n}\n\nfunction closeWorldbookPicker(): void {\n  worldbookPickerOpen.value = false;\n}\n\nfunction closeRolePicker(): void {\n  rolePickerOpen.value = false;\n}\n\nfunction openWorldbookPicker(): void {\n  worldbookPickerSearchText.value = \'\';\n  worldbookPickerOpen.value = true;\n  void nextTick(() => {\n    worldbookPickerSearchInputRef.value?.focus();\n  });\n}\n\nfunction openRolePicker(): void {\n  if (!selectedGlobalPreset.value) {\n    return;\n  }\n  roleBindSearchText.value = \'\';\n  refreshRoleBindingCandidates();\n  rolePickerOpen.value = true;\n  void nextTick(() => {\n    rolePickerSearchInputRef.value?.focus();\n  });\n}\n\nfunction toggleWorldbookPicker(): void {\n  if (worldbookPickerOpen.value) {\n    closeWorldbookPicker();\n    return;\n  }\n  openWorldbookPicker();\n}\n\nfunction toggleRolePicker(): void {\n  if (rolePickerOpen.value) {\n    closeRolePicker();\n    return;\n  }\n  void openRolePicker();\n}\n\nfunction toggleTheme(): void {\n  const keys = Object.keys(THEMES) as ThemeKey[];\n  const index = keys.indexOf(currentTheme.value);\n  const nextIndex = (index + 1) % keys.length;\n  currentTheme.value = keys[nextIndex];\n  setStatus(`: ${THEMES[currentTheme.value].name}`);\n}\n\nfunction setTheme(key: ThemeKey): void {\n  currentTheme.value = key;\n  themePickerOpen.value = false;\n  setStatus(`: ${THEMES[key].label}`);\n}\n\nfunction onSetThemeEvent(event: Event): void {\n  const key = (event as CustomEvent).detail as string;\n  if (key && key in THEMES) {\n    setTheme(key as ThemeKey);\n  }\n}\n\nfunction selectWorldbookFromPicker(name: string): void {\n  if (!name) {\n    return;\n  }\n  selectedWorldbookName.value = name;\n  closeWorldbookPicker();\n}\n\nfunction bindFirstRoleCandidate(): void {\n  const first = roleBindingCandidates.value.find(item => !item.bound);\n  if (!first) {\n    return;\n  }\n  bindRoleCandidateToSelectedPreset(first);\n}\n\nfunction onHostPointerDownForWorldbookPicker(event: PointerEvent): void {\n  if (!worldbookPickerOpen.value && !rolePickerOpen.value && !themePickerOpen.value) {\n    return;\n  }\n  const target = event.target as Node | null;\n  if (!target) {\n    closeWorldbookPicker();\n    closeRolePicker();\n    themePickerOpen.value = false;\n    return;\n  }\n\n  if (worldbookPickerOpen.value) {\n    const worldbookRoot = worldbookPickerRef.value;\n    if (!worldbookRoot || !worldbookRoot.contains(target)) {\n      closeWorldbookPicker();\n    }\n  }\n\n  if (rolePickerOpen.value) {\n    const roleRoot = rolePickerRef.value;\n    if (!roleRoot || !roleRoot.contains(target)) {\n      closeRolePicker();\n    }\n  }\n\n  if (themePickerOpen.value) {\n    themePickerOpen.value = false;\n  }\n}\n\nfunction onHostKeyDownForWorldbookPicker(event: KeyboardEvent): void {\n  if (!worldbookPickerOpen.value && !rolePickerOpen.value) {\n    return;\n  }\n  if (event.key === \'Escape\') {\n    closeWorldbookPicker();\n    closeRolePicker();\n  }\n}\n\nasync function loadWorldbook(name: string): Promise<void> {\n  if (!name) {\n    return;\n  }\n  isBusy.value = true;\n  try {\n    const rawEntries = await getWorldbook(name);\n    const normalized = normalizeEntryList(rawEntries);\n    draftEntries.value = klona(normalized);\n    originalEntries.value = klona(normalized);\n    ensureSelectedEntryExists();\n    setStatus(` "${name}" ${normalized.length}`);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n    setStatus(`: ${message}`);\n  } finally {\n    isBusy.value = false;\n  }\n}\n\nasync function reloadWorldbookNames(preferred?: string): Promise<void> {\n  const names = [...getWorldbookNames()].sort((left, right) => left.localeCompare(right, \'zh-Hans-CN\'));\n  worldbookNames.value = names;\n\n  if (!names.length) {\n    selectedWorldbookName.value = \'\';\n    draftEntries.value = [];\n    originalEntries.value = [];\n    selectedEntryUid.value = null;\n    return;\n  }\n\n  const fallbackName = persistedState.value.last_worldbook;\n  const candidate =\n    (preferred && names.includes(preferred) && preferred) ||\n    (fallbackName && names.includes(fallbackName) && fallbackName) ||\n    selectedWorldbookName.value ||\n    names[0];\n\n  if (candidate && selectedWorldbookName.value !== candidate) {\n    selectedWorldbookName.value = candidate;\n    return;\n  }\n\n  if (selectedWorldbookName.value && !draftEntries.value.length) {\n    await loadWorldbook(selectedWorldbookName.value);\n  }\n}\n\nasync function hardRefresh(): Promise<void> {\n  persistedState.value = readPersistedState();\n  syncSelectedGlobalPresetFromState();\n  await reloadWorldbookNames(selectedWorldbookName.value || undefined);\n  await refreshBindings();\n  refreshRoleBindingCandidates();\n  refreshCurrentRoleContext();\n  await autoApplyRoleBoundPreset();\n  if (globalWorldbookMode.value) {\n    ensureSelectionForGlobalMode();\n  } else {\n    trySelectWorldbookByContext({ preferWhenEmptyOnly: true });\n  }\n  setStatus(\'\');\n}\n\nasync function saveCurrentWorldbook(): Promise<void> {\n  if (!selectedWorldbookName.value) {\n    toastr.warning(\'\');\n    return;\n  }\n  if (!hasUnsavedChanges.value) {\n    setStatus(\'\');\n    return;\n  }\n  isSaving.value = true;\n  try {\n    draftEntries.value = normalizeEntryList(draftEntries.value.map(entry => klona(entry)));\n    const pendingEntrySnapshots = collectEntrySnapshotsBeforeSave();\n    const savedEntrySnapshotCount = pushEntrySnapshotsBulk(pendingEntrySnapshots);\n    await replaceWorldbook(selectedWorldbookName.value, klona(draftEntries.value), { render: \'immediate\' });\n    originalEntries.value = klona(draftEntries.value);\n    pushSnapshot(\'\');\n    await refreshBindings();\n    toastr.success(`: ${selectedWorldbookName.value}`);\n    setStatus(`: ${selectedWorldbookName.value} +${savedEntrySnapshotCount}`);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n    setStatus(`: ${message}`);\n  } finally {\n    isSaving.value = false;\n  }\n}\n\nasync function createNewWorldbook(): Promise<void> {\n  const nameRaw = prompt(\'\');\n  const name = toStringSafe(nameRaw).trim();\n  if (!name) {\n    return;\n  }\n  try {\n    await createOrReplaceWorldbook(name, [], { render: \'immediate\' });\n    await reloadWorldbookNames(name);\n    await refreshBindings();\n    toastr.success(`: ${name}`);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n  }\n}\n\nasync function duplicateWorldbook(): Promise<void> {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  const suggested = `${selectedWorldbookName.value}_copy`;\n  const newNameRaw = prompt(\'\', suggested);\n  const newName = toStringSafe(newNameRaw).trim();\n  if (!newName) {\n    return;\n  }\n  try {\n    await createOrReplaceWorldbook(newName, klona(draftEntries.value), { render: \'immediate\' });\n    await reloadWorldbookNames(newName);\n    await refreshBindings();\n    toastr.success(`: ${newName}`);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n  }\n}\n\nasync function deleteCurrentWorldbook(): Promise<void> {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  const current = selectedWorldbookName.value;\n  if (!confirm(` "${current}" ?`)) {\n    return;\n  }\n  try {\n    const success = await deleteWorldbook(current);\n    if (!success) {\n      throw new Error(\' false\');\n    }\n    updatePersistedState(state => {\n      delete state.history[current];\n      delete state.entry_history[current];\n    });\n    toastr.success(`: ${current}`);\n    await reloadWorldbookNames();\n    await refreshBindings();\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    toastr.error(`: ${message}`);\n  }\n}\n\nasync function toggleGlobalBinding(): Promise<void> {\n  if (!selectedWorldbookName.value) {\n    return;\n  }\n  const next = new Set(getGlobalWorldbookNames());\n  if (next.has(selectedWorldbookName.value)) {\n    next.delete(selectedWorldbookName.value);\n  } else {\n    next.add(selectedWorldbookName.value);\n  }\n  await applyGlobalWorldbooks([...next], \'\');\n}\n\nfunction pushActivationLogs(entries: Array<{ world: string } & Record<string, unknown>>): void {\n  const logs = entries.map(item => {\n    const uid = item.uid ?? item.displayIndex ?? \'?\';\n    const name = toStringSafe(item.name ?? item.comment, `UID ${uid}`);\n    const content = toStringSafe(item.content).replace(/\\s+/g, \' \').trim().slice(0, 80);\n    return {\n      id: createId(\'activation\'),\n      time: Date.now(),\n      world: toStringSafe(item.world, \'unknown\'),\n      uid: typeof uid === \'number\' || typeof uid === \'string\' ? uid : \'?\',\n      name,\n      contentPreview: content || \'()\',\n    } satisfies ActivationLog;\n  });\n  activationLogs.value.unshift(...logs);\n  if (activationLogs.value.length > ACTIVATION_LOG_LIMIT) {\n    activationLogs.value.length = ACTIVATION_LOG_LIMIT;\n  }\n}\n\nfunction clearActivationLogs(): void {\n  activationLogs.value = [];\n}\n\nfunction resolveHostWindow(): Window {\n  return mainLayoutRef.value?.ownerDocument?.defaultView ?? editorShellRef.value?.ownerDocument?.defaultView ?? window;\n}\n\nfunction clampFloatingPanelToViewport(panel: FloatingPanelState): void {\n  const hostWin = resolveHostWindow();\n  const viewportWidth = hostWin.innerWidth;\n  const viewportHeight = hostWin.innerHeight;\n  const maxX = Math.max(8, viewportWidth - panel.width - 8);\n  const maxY = Math.max(8, viewportHeight - 68);\n  panel.x = clampNumber(panel.x, 8, maxX);\n  panel.y = clampNumber(panel.y, 8, maxY);\n}\n\nfunction handleFloatingWindowResize(): void {\n  viewportWidth.value = resolveHostWindow().innerWidth;\n  clampPaneWidths();\n  for (const key of floatingPanelKeys) {\n    if (!floatingPanels[key].visible) {\n      continue;\n    }\n    clampFloatingPanelToViewport(floatingPanels[key]);\n  }\n}\n\nfunction bringFloatingToFront(key: FloatingPanelKey): void {\n  floatingZCounter.value += 1;\n  floatingPanels[key].z = floatingZCounter.value;\n}\n\nfunction openFloatingPanel(key: FloatingPanelKey): void {\n  const panel = floatingPanels[key];\n  panel.visible = true;\n  clampFloatingPanelToViewport(panel);\n  bringFloatingToFront(key);\n}\n\nfunction closeFloatingPanel(key: FloatingPanelKey): void {\n  floatingPanels[key].visible = false;\n  if (activeFloatingDrag.value?.key === key) {\n    stopFloatingDrag();\n  }\n}\n\nfunction toggleFloatingPanel(key: FloatingPanelKey): void {\n  if (floatingPanels[key].visible) {\n    closeFloatingPanel(key);\n    return;\n  }\n  openFloatingPanel(key);\n}\n\nfunction getFloatingPanelStyle(key: FloatingPanelKey): Record<string, string> {\n  const panel = floatingPanels[key];\n  return {\n    left: `${panel.x}px`,\n    top: `${panel.y}px`,\n    zIndex: String(panel.z),\n    width: `${panel.width}px`,\n  };\n}\n\nfunction startFloatingDrag(key: FloatingPanelKey, event: PointerEvent): void {\n  if (event.pointerType === \'mouse\' && event.button !== 0) {\n    return;\n  }\n  const panel = floatingPanels[key];\n  const target = event.currentTarget as HTMLElement | null;\n  if (!target) {\n    return;\n  }\n  const hostDoc = target.ownerDocument ?? document;\n  const hostWin = hostDoc.defaultView ?? window;\n  const rect = target.getBoundingClientRect();\n  bringFloatingToFront(key);\n  const dragState = {\n    key,\n    pointerId: event.pointerId,\n    offsetX: event.clientX - panel.x,\n    offsetY: event.clientY - panel.y,\n    doc: hostDoc,\n    win: hostWin,\n  };\n  activeFloatingDrag.value = dragState;\n  target.setPointerCapture?.(event.pointerId);\n  hostDoc.addEventListener(\'pointermove\', onFloatingDragMove);\n  hostDoc.addEventListener(\'pointerup\', stopFloatingDrag);\n  hostDoc.addEventListener(\'pointercancel\', stopFloatingDrag);\n  hostWin.addEventListener(\'blur\', stopFloatingDrag);\n  panel.x = clampNumber(event.clientX - dragState.offsetX, 8, Math.max(8, hostWin.innerWidth - panel.width - 8));\n  panel.y = clampNumber(event.clientY - dragState.offsetY, 8, Math.max(8, hostWin.innerHeight - rect.height - 8));\n  event.preventDefault();\n}\n\nfunction onFloatingDragMove(event: PointerEvent): void {\n  const drag = activeFloatingDrag.value;\n  if (!drag) {\n    return;\n  }\n  if (event.pointerId !== drag.pointerId) {\n    return;\n  }\n  const panel = floatingPanels[drag.key];\n  panel.x = clampNumber(event.clientX - drag.offsetX, 8, Math.max(8, drag.win.innerWidth - panel.width - 8));\n  panel.y = clampNumber(event.clientY - drag.offsetY, 8, Math.max(8, drag.win.innerHeight - 68));\n}\n\nfunction stopFloatingDrag(): void {\n  const drag = activeFloatingDrag.value;\n  if (drag) {\n    drag.doc.removeEventListener(\'pointermove\', onFloatingDragMove);\n    drag.doc.removeEventListener(\'pointerup\', stopFloatingDrag);\n    drag.doc.removeEventListener(\'pointercancel\', stopFloatingDrag);\n    drag.win.removeEventListener(\'blur\', stopFloatingDrag);\n  }\n  activeFloatingDrag.value = null;\n}\n\nfunction clampPaneWidths(): void {\n  if (isCompactLayout.value) {\n    return;\n  }\n\n  const mainRect = mainLayoutRef.value?.getBoundingClientRect();\n  if (mainRect) {\n    const maxLeft = Math.max(MAIN_PANE_MIN, Math.floor(mainRect.width - MAIN_EDITOR_MIN - RESIZE_HANDLE_SIZE));\n    mainPaneWidth.value = clampNumber(mainPaneWidth.value, MAIN_PANE_MIN, maxLeft);\n  }\n\n  const editorRect = editorShellRef.value?.getBoundingClientRect();\n  if (editorRect) {\n    const maxSide = Math.max(EDITOR_SIDE_MIN, Math.floor(editorRect.width - EDITOR_CENTER_MIN - RESIZE_HANDLE_SIZE));\n    editorSideWidth.value = clampNumber(editorSideWidth.value, EDITOR_SIDE_MIN, maxSide);\n  }\n}\n\nfunction startContentResize(e: PointerEvent): void {\n  e.preventDefault();\n  const textarea = contentTextareaRef.value;\n  if (!textarea) return;\n\n  const startY = e.clientY;\n  const startHeight = textarea.offsetHeight;\n  const target = e.currentTarget as HTMLElement;\n  target.setPointerCapture(e.pointerId);\n\n  // Disable textarea interaction during drag to reduce reflow\n  textarea.style.pointerEvents = \'none\';\n  textarea.style.willChange = \'height\';\n\n  let rafId = 0;\n  let pendingHeight = startHeight;\n\n  const applyHeight = () => {\n    textarea.style.height = `${pendingHeight}px`;\n    textarea.style.minHeight = `${pendingHeight}px`;\n    rafId = 0;\n  };\n\n  const onMove = (ev: PointerEvent) => {\n    pendingHeight = Math.max(120, startHeight + (ev.clientY - startY));\n    if (!rafId) {\n      rafId = requestAnimationFrame(applyHeight);\n    }\n  };\n\n  const onUp = () => {\n    if (rafId) cancelAnimationFrame(rafId);\n    applyHeight();\n    textarea.style.pointerEvents = \'\';\n    textarea.style.willChange = \'\';\n    target.removeEventListener(\'pointermove\', onMove);\n    target.removeEventListener(\'pointerup\', onUp);\n  };\n\n  target.addEventListener(\'pointermove\', onMove);\n  target.addEventListener(\'pointerup\', onUp);\n}\n\nfunction startPaneResize(key: PaneResizeKey, event: PointerEvent): void {\n  if (isCompactLayout.value) {\n    return;\n  }\n  if (event.pointerType === \'mouse\' && event.button !== 0) {\n    return;\n  }\n  const target = event.currentTarget as HTMLElement | null;\n  const hostDoc = target?.ownerDocument ?? document;\n  const hostWin = hostDoc.defaultView ?? window;\n  paneResizeState.value = {\n    key,\n    pointerId: event.pointerId,\n    doc: hostDoc,\n    win: hostWin,\n  };\n  target?.setPointerCapture?.(event.pointerId);\n  hostDoc.addEventListener(\'pointermove\', onPaneResizeMove);\n  hostDoc.addEventListener(\'pointerup\', stopPaneResize);\n  hostDoc.addEventListener(\'pointercancel\', stopPaneResize);\n  hostWin.addEventListener(\'blur\', stopPaneResize);\n  event.preventDefault();\n}\n\nfunction onPaneResizeMove(event: PointerEvent): void {\n  const state = paneResizeState.value;\n  if (!state || event.pointerId !== state.pointerId) {\n    return;\n  }\n  if (state.key === \'main\') {\n    const rect = mainLayoutRef.value?.getBoundingClientRect();\n    if (!rect) {\n      return;\n    }\n    const left = Math.floor(event.clientX - rect.left);\n    const maxLeft = Math.max(MAIN_PANE_MIN, Math.floor(rect.width - MAIN_EDITOR_MIN - RESIZE_HANDLE_SIZE));\n    mainPaneWidth.value = clampNumber(left, MAIN_PANE_MIN, maxLeft);\n    return;\n  }\n\n  const rect = editorShellRef.value?.getBoundingClientRect();\n  if (!rect) {\n    return;\n  }\n  const side = Math.floor(rect.right - event.clientX);\n  const maxSide = Math.max(EDITOR_SIDE_MIN, Math.floor(rect.width - EDITOR_CENTER_MIN - RESIZE_HANDLE_SIZE));\n  editorSideWidth.value = clampNumber(side, EDITOR_SIDE_MIN, maxSide);\n}\n\nfunction stopPaneResize(): void {\n  const state = paneResizeState.value;\n  if (state) {\n    state.doc.removeEventListener(\'pointermove\', onPaneResizeMove);\n    state.doc.removeEventListener(\'pointerup\', stopPaneResize);\n    state.doc.removeEventListener(\'pointercancel\', stopPaneResize);\n    state.win.removeEventListener(\'blur\', stopPaneResize);\n  }\n  paneResizeState.value = null;\n}\n\nfunction onPanelRefresh(): void {\n  void hardRefresh();\n}\n\nfunction onPanelSave(): void {\n  void saveCurrentWorldbook();\n}\n\nfunction discardUnsavedDraft(): void {\n  if (!hasUnsavedChanges.value) {\n    const target = window as unknown as Record<string, unknown>;\n    target[DIRTY_STATE_KEY] = false;\n    return;\n  }\n  draftEntries.value = klona(originalEntries.value);\n  ensureSelectedEntryExists();\n  resetFindState();\n  setStatus(\'\');\n}\n\nfunction onPanelDiscard(): void {\n  discardUnsavedDraft();\n}\n\nconst rootRef = ref<HTMLElement | null>(null);\nlet _rootResizeObserver: ResizeObserver | null = null;\nlet _mobileResizeHandler: (() => void) | null = null;\n\nonMounted(() => {\n  // Fix mobile height: compute exact pixel height based on viewport position\n  if (isMobile.value && rootRef.value) {\n    const hostWin = (() => { try { return window.parent || window; } catch { return window; } })();\n    const el = rootRef.value;\n\n    const syncHeight = () => {\n      if (!el) return;\n      const rect = el.getBoundingClientRect();\n      const vh = hostWin.innerHeight || window.innerHeight || 0;\n      const available = vh - rect.top;\n      if (available > 0) {\n        el.style.height = available + \'px\';\n        el.style.maxHeight = available + \'px\';\n        el.style.overflow = \'hidden\';\n      }\n    };\n\n    // Initial + delayed (wait for layout)\n    syncHeight();\n    requestAnimationFrame(syncHeight);\n    setTimeout(syncHeight, 100);\n    setTimeout(syncHeight, 500);\n\n    // Respond to resize\n    _mobileResizeHandler = syncHeight;\n    hostWin.addEventListener(\'resize\', syncHeight);\n\n    // Also observe parent just in case\n    const parent = el.parentElement;\n    if (parent) {\n      _rootResizeObserver = new ResizeObserver(syncHeight);\n      _rootResizeObserver.observe(parent);\n    }\n  }\n  persistedState.value = readPersistedState();\n  syncSelectedGlobalPresetFromState();\n\n  subscriptions.push(\n    eventOn(tavern_events.WORLD_INFO_ACTIVATED, entries => {\n      pushActivationLogs(entries as Array<{ world: string } & Record<string, unknown>>);\n    }),\n  );\n  subscriptions.push(\n    eventOn(tavern_events.WORLDINFO_UPDATED, () => {\n      void hardRefresh();\n    }),\n  );\n  subscriptions.push(\n    eventOn(tavern_events.CHAT_CHANGED, () => {\n      void (async () => {\n        await refreshBindings();\n        refreshRoleBindingCandidates();\n        refreshCurrentRoleContext();\n        await autoApplyRoleBoundPreset();\n        if (globalWorldbookMode.value) {\n          ensureSelectionForGlobalMode();\n          return;\n        }\n        trySelectWorldbookByContext();\n      })();\n    }),\n  );\n\n  window.addEventListener(\'wb-helper:refresh\', onPanelRefresh);\n  window.addEventListener(\'wb-helper:save\', onPanelSave);\n  window.addEventListener(\'wb-helper:discard\', onPanelDiscard);\n  window.addEventListener(\'wb-helper:toggle-theme\', toggleTheme);\n  window.addEventListener(\'wb-helper:set-theme\', onSetThemeEvent);\n  hostResizeWindow.value = resolveHostWindow();\n  const hostDoc = hostResizeWindow.value.document;\n  hostDoc.addEventListener(\'pointerdown\', onHostPointerDownForWorldbookPicker, true);\n  hostDoc.addEventListener(\'keydown\', onHostKeyDownForWorldbookPicker, true);\n  hostResizeWindow.value.addEventListener(\'resize\', handleFloatingWindowResize);\n\n  handleFloatingWindowResize();\n  updateHostPanelTheme();\n  void hardRefresh();\n});\n\nonUnmounted(() => {\n  _rootResizeObserver?.disconnect();\n  _rootResizeObserver = null;\n  if (_mobileResizeHandler) {\n    try { (window.parent || window).removeEventListener(\'resize\', _mobileResizeHandler); } catch { /* ignore */ }\n    _mobileResizeHandler = null;\n  }\n  const target = window as unknown as Record<string, unknown>;\n  target[DIRTY_STATE_KEY] = false;\n  subscriptions.forEach(subscription => {\n    subscription.stop();\n  });\n  stopFloatingDrag();\n  stopPaneResize();\n  window.removeEventListener(\'wb-helper:refresh\', onPanelRefresh);\n  window.removeEventListener(\'wb-helper:save\', onPanelSave);\n  window.removeEventListener(\'wb-helper:discard\', onPanelDiscard);\n  window.removeEventListener(\'wb-helper:toggle-theme\', toggleTheme);\n  window.removeEventListener(\'wb-helper:set-theme\', onSetThemeEvent);\n  hostResizeWindow.value?.document.removeEventListener(\'pointerdown\', onHostPointerDownForWorldbookPicker, true);\n  hostResizeWindow.value?.document.removeEventListener(\'keydown\', onHostKeyDownForWorldbookPicker, true);\n  hostResizeWindow.value?.removeEventListener(\'resize\', handleFloatingWindowResize);\n  hostResizeWindow.value = null;\n});\n\nfunction updateHostPanelTheme() {\n  const panel = document.getElementById(\'wb-assistant-panel\');\n  if (!panel) return;\n  const theme = THEMES[currentTheme.value];\n  const colors = theme.colors;\n  \n  panel.style.setProperty(\'--wb-host-bg\', colors[\'--wb-bg-root\']);\n  panel.style.setProperty(\'--wb-host-header-bg\', colors[\'--wb-bg-panel\']);\n  panel.style.setProperty(\'--wb-host-border\', colors[\'--wb-border-main\']);\n  panel.style.setProperty(\'--wb-host-text\', colors[\'--wb-text-main\']);\n  panel.style.setProperty(\'--wb-host-tool-bg\', colors[\'--wb-input-bg\']);\n  panel.style.setProperty(\'--wb-host-tool-border\', colors[\'--wb-border-subtle\']);\n}\n\nwatch(currentTheme, () => {\n  updateHostPanelTheme();\n});\n<\/script>\n\n<style scoped>\n.wb-assistant-root {\n  flex: 1;\n  min-height: 0;\n  width: 100%;\n  box-sizing: border-box;\n  display: flex;\n  flex-direction: column;\n  padding: 10px;\n  gap: 10px;\n  background: var(--wb-bg-root);\n  color: var(--wb-text-main);\n  font-size: 13px;\n  line-height: 1.35;\n  border-radius: 10px;\n  overflow: hidden;\n}\n\n\n.wb-scroll-area {\n  flex: 1;\n  min-height: 0;\n  overflow-y: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n\n.wb-settings-wrapper {\n  width: 100%;\n}\n\n.wb-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  border-radius: 12px;\n  padding: 12px 16px;\n  background: var(--wb-bg-panel);\n  margin-bottom: 8px;\n}\n\n.wb-title {\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n}\n\n.wb-title strong {\n  font-size: 16px;\n}\n\n.wb-title span {\n  color: var(--wb-text-muted);\n}\n\n.wb-header-actions,\n.list-actions,\n.tool-line {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.wb-toolbar {\n  display: flex;\n  gap: 8px;\n  flex-wrap: wrap;\n  align-items: center;\n  border-radius: 12px;\n  padding: 10px 12px;\n  background: var(--wb-bg-panel);\n}\n\n.toolbar-label {\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n  color: var(--wb-text-muted);\n  min-width: 320px;\n  flex: 1 1 520px;\n}\n\n.toolbar-select {\n  min-width: 200px;\n}\n\n.toolbar-select.small {\n  min-width: 160px;\n}\n\n.worldbook-picker {\n  position: relative;\n  flex: 1 1 auto;\n  min-width: 240px;\n}\n\n.worldbook-picker-trigger {\n  width: 100%;\n  box-sizing: border-box;\n  border: 1px solid transparent;\n  border-radius: 8px;\n  padding: 8px 10px;\n  background: var(--wb-input-bg);\n  color: var(--wb-text-main);\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 10px;\n  cursor: pointer;\n}\n\n.worldbook-picker-trigger:hover {\n  border-color: var(--wb-primary-light);\n}\n\n.worldbook-picker-trigger-text {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  text-align: left;\n}\n\n.worldbook-picker-trigger-arrow {\n  flex-shrink: 0;\n  color: var(--wb-text-muted);\n}\n\n.worldbook-picker-dropdown {\n  position: absolute;\n  left: 0;\n  right: 0;\n  top: calc(100% + 6px);\n  z-index: 10120;\n  border: 1px solid var(--wb-border-subtle);\n  border-radius: 8px;\n  background: var(--wb-input-bg-focus);\n  box-shadow: var(--wb-shadow-main);\n  padding: 8px;\n  display: grid;\n  gap: 8px;\n}\n\n.worldbook-picker-search {\n  width: 100%;\n}\n\n.worldbook-picker-list {\n  max-height: 260px;\n  overflow: auto;\n  border: none;\n  border-radius: 8px;\n  background: var(--wb-bg-panel);\n  display: flex;\n  flex-direction: column;\n}\n\n.worldbook-picker-item {\n  width: 100%;\n  border: none;\n  border-bottom: 1px solid var(--wb-border-subtle);\n  background: transparent;\n  color: var(--wb-text-main);\n  padding: 8px 10px;\n  text-align: left;\n  cursor: pointer;\n}\n\n.worldbook-picker-item:last-child {\n  border-bottom: none;\n}\n\n.worldbook-picker-item:hover {\n  background: var(--wb-primary-soft);\n}\n\n.worldbook-picker-item.active {\n  background: var(--wb-primary-soft);\n  color: var(--wb-primary-light);\n}\n\n.wb-bindings {\n  border-radius: 12px;\n  padding: 12px;\n  display: grid;\n  gap: 8px;\n  background: var(--wb-bg-panel);\n}\n\n.wb-history-shortcuts {\n  display: flex;\n  justify-content: flex-start;\n  gap: 8px;\n  flex-wrap: wrap;\n  align-items: center;\n}\n\n.global-mode-panel {\n  border-radius: 12px;\n  background: var(--wb-bg-panel);\n  padding: 12px;\n  display: grid;\n  gap: 12px;\n}\n\n.global-mode-head {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  gap: 8px;\n}\n\n.global-mode-title {\n  color: var(--wb-primary-light);\n  font-weight: 700;\n  letter-spacing: 0.02em;\n}\n\n.global-preset-panel {\n  border-radius: 8px;\n  background: var(--wb-bg-panel);\n  padding: 10px;\n  display: grid;\n  gap: 8px;\n}\n\n.preset-role-panel {\n  border-radius: 8px;\n  background: var(--wb-bg-panel);\n  padding: 10px;\n  display: grid;\n  gap: 6px;\n}\n\n.preset-role-head {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  gap: 8px;\n  flex-wrap: wrap;\n}\n\n.preset-role-current {\n  color: var(--wb-primary);\n  font-size: 12px;\n}\n\n.preset-role-current.empty {\n  color: var(--wb-text-muted);\n}\n\n.preset-role-actions {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.role-picker {\n  position: relative;\n}\n\n.role-picker-trigger {\n  width: 100%;\n  box-sizing: border-box;\n  border: 1px solid transparent;\n  border-radius: 8px;\n  padding: 8px 10px;\n  background: var(--wb-input-bg);\n  color: var(--wb-text-main);\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 10px;\n  cursor: pointer;\n}\n\n.role-picker-trigger:disabled {\n  opacity: 0.55;\n  cursor: default;\n}\n\n.role-picker-trigger:hover:not(:disabled) {\n  border-color: var(--wb-primary-light);\n}\n\n.role-picker-trigger-text {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  text-align: left;\n}\n\n.role-picker-trigger-arrow {\n  flex-shrink: 0;\n  color: var(--wb-text-muted);\n}\n\n.role-picker-dropdown {\n  position: absolute;\n  left: 0;\n  right: 0;\n  top: calc(100% + 6px);\n  z-index: 10130;\n  border: 1px solid var(--wb-border-subtle);\n  border-radius: 8px;\n  background: var(--wb-input-bg-focus);\n  box-shadow: var(--wb-shadow-main);\n  padding: 8px;\n  display: grid;\n  gap: 8px;\n}\n\n.role-picker-search {\n  width: 100%;\n}\n\n.role-picker-list {\n  border: none;\n  border-radius: 8px;\n  background: var(--wb-bg-panel);\n  max-height: 220px;\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n}\n\n.role-picker-item {\n  width: 100%;\n  border: none;\n  border-bottom: 1px solid var(--wb-border-subtle);\n  background: transparent;\n  color: var(--wb-text-main);\n  padding: 8px 10px;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 8px;\n  text-align: left;\n  cursor: pointer;\n}\n\n.role-picker-item:last-child {\n  border-bottom: none;\n}\n\n.role-picker-item:hover:not(:disabled) {\n  background: var(--wb-primary-soft);\n}\n\n.role-picker-item:disabled {\n  opacity: 0.55;\n  cursor: default;\n}\n\n.role-picker-item .name {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.role-picker-item .meta {\n  color: var(--wb-primary-light);\n  flex-shrink: 0;\n  font-size: 11px;\n}\n\n.preset-role-tags {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.preset-role-tag {\n  border: 1px solid var(--wb-border-subtle);\n  border-radius: 999px;\n  background: var(--wb-bg-panel);\n  color: var(--wb-text-main);\n  padding: 2px 10px;\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n  cursor: pointer;\n}\n\n.preset-role-tag:hover {\n  border-color: #f43f5e;\n}\n\n.preset-role-tag .remove {\n  color: #fca5a5;\n}\n\n.global-mode-grid {\n  display: grid;\n  grid-template-columns: repeat(2, minmax(0, 1fr));\n  gap: 8px;\n}\n\n.global-mode-column {\n  border-radius: 8px;\n  padding: 10px;\n  background: var(--wb-bg-panel);\n  display: grid;\n  gap: 6px;\n  min-height: 168px;\n}\n\n.global-mode-list {\n  border-radius: 8px;\n  background: var(--wb-input-bg);\n  max-height: 176px;\n  min-height: 88px;\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n}\n\n.global-mode-item {\n  width: 100%;\n  border: none;\n  border-bottom: 1px solid var(--wb-border-subtle);\n  background: transparent;\n  color: var(--wb-text-main);\n  padding: 7px 8px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  gap: 10px;\n  cursor: pointer;\n  text-align: left;\n}\n\n.global-mode-item:last-child {\n  border-bottom: none;\n}\n\n.global-mode-item:hover {\n  background: var(--wb-primary-soft);\n}\n\n.global-mode-item.add .global-mode-item-action {\n  color: #86efac;\n}\n\n.global-mode-item.active .global-mode-item-action {\n  color: #fca5a5;\n}\n\n.global-mode-item-name {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.global-mode-item-action {\n  font-size: 12px;\n  flex-shrink: 0;\n}\n\n.global-mode-actions {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.history-btn {\n  border-color: var(--wb-primary);\n  background: var(--wb-primary-soft);\n}\n\n.utility-btn {\n  border-color: var(--wb-primary-light);\n  background: var(--wb-primary-soft);\n}\n\n.utility-btn.active {\n  border-color: var(--wb-primary-light);\n  background: var(--wb-primary-soft);\n  color: var(--wb-primary-light);\n}\n\n.wb-main-layout {\n  flex: 1;\n  min-height: 60vh;\n  display: grid;\n  grid-template-columns: 320px 10px minmax(0, 1fr);\n  gap: 0;\n}\n\n.wb-entry-list,\n.wb-editor {\n  border-radius: 12px;\n  padding: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  background: transparent;\n  min-height: 0;\n}\n\n.list-search {\n  display: grid;\n  gap: 6px;\n  padding: 0 8px;\n}\n\n.list-summary {\n  color: var(--wb-text-muted);\n  font-size: 12px;\n  padding: 0 8px;\n}\n\n.list-scroll {\n  flex: 1 1 auto;\n  min-height: 210px;\n  max-height: calc(70vh - 210px);\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n}\n\n.entry-item {\n  width: 100%;\n  text-align: left;\n  border: none;\n  background: transparent;\n  color: var(--wb-text-main);\n  border-radius: 8px;\n  padding: 10px 12px 10px 14px;\n  cursor: pointer;\n  display: grid;\n  gap: 6px;\n  position: relative;\n  transition: background-color 0.15s ease;\n  margin-bottom: 4px;\n}\n\n.entry-item::before {\n  content: \'\';\n  position: absolute;\n  left: 0;\n  top: 0;\n  bottom: 0;\n  width: 4px;\n  border-radius: 8px 0 0 8px;\n  background: linear-gradient(to bottom, #64748b, rgba(100, 116, 139, 0.05));\n}\n\n.entry-item[data-status=\'constant\']::before {\n  background: linear-gradient(to bottom, #3b82f6, rgba(59, 130, 246, 0));\n}\n\n.entry-item[data-status=\'vector\']::before {\n  background: linear-gradient(to bottom, #a855f7, rgba(168, 85, 247, 0));\n}\n\n.entry-item[data-status=\'normal\']::before {\n  background: linear-gradient(to bottom, #22c55e, rgba(34, 197, 94, 0));\n}\n\n.entry-item[data-status=\'disabled\']::before {\n  background: linear-gradient(to bottom, #6b7280, rgba(107, 114, 128, 0));\n}\n\n.entry-item:hover {\n  background: var(--wb-primary-hover);\n  transform: none;\n}\n\n.entry-item.selected {\n  background: var(--wb-primary-soft);\n  box-shadow: none;\n}\n\n.entry-item.disabled {\n  opacity: 0.74;\n}\n\n.entry-item-head {\n  display: flex;\n  align-items: center;\n  gap: 7px;\n  min-width: 0;\n}\n\n.entry-status-dot {\n  width: 9px;\n  height: 9px;\n  border-radius: 999px;\n  background: #64748b;\n  flex-shrink: 0;\n  box-shadow: 0 0 0 2px var(--wb-bg-panel);\n}\n\n.entry-status-dot[data-status=\'constant\'] {\n  background: #3b82f6;\n}\n\n.entry-status-dot[data-status=\'vector\'] {\n  background: #a855f7;\n}\n\n.entry-status-dot[data-status=\'normal\'] {\n  background: #22c55e;\n}\n\n.entry-status-dot[data-status=\'disabled\'] {\n  background: #6b7280;\n}\n\n.entry-item-title {\n  font-weight: 700;\n  flex: 1;\n  min-width: 0;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.entry-item-tags {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.entry-chip {\n  display: inline-flex;\n  align-items: center;\n  gap: 4px;\n  border: none;\n  border-radius: 999px;\n  padding: 2px 8px;\n  color: var(--wb-text-muted);\n  font-size: 11px;\n  background: var(--wb-bg-panel);\n}\n\n.entry-chip.uid {\n  color: var(--wb-primary-light);\n  font-size: 10px;\n  padding: 1px 7px;\n}\n\n.entry-chip.mono {\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \'Liberation Mono\', \'Courier New\', monospace;\n  font-size: 10px;\n}\n\n.entry-chip.status[data-status=\'constant\'] {\n  color: #93c5fd;\n  background: rgba(59, 130, 246, 0.16);\n}\n\n.entry-chip.status[data-status=\'vector\'] {\n  color: #d8b4fe;\n  background: rgba(168, 85, 247, 0.16);\n}\n\n.entry-chip.status[data-status=\'normal\'] {\n  color: #86efac;\n  background: rgba(34, 197, 94, 0.16);\n}\n\n.entry-chip.status[data-status=\'disabled\'] {\n  color: #cbd5e1;\n  background: rgba(100, 116, 139, 0.15);\n}\n\n.entry-item-preview {\n  color: var(--wb-text-muted);\n  font-size: 11px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  padding-left: 16px;\n  opacity: 0.85;\n}\n\n.entry-item-preview::before {\n  content: \'Keys: \';\n  color: var(--wb-text-muted);\n  margin-right: 4px;\n}\n\n.wb-editor {\n  max-height: 70vh;\n  overflow: hidden;\n}\n\n.wb-editor-shell {\n  height: 100%;\n  min-height: 0;\n  display: grid;\n  grid-template-columns: minmax(0, 1fr) 10px 360px;\n  gap: 0;\n}\n\n.wb-resize-handle {\n  position: relative;\n  width: 10px;\n  cursor: col-resize;\n  user-select: none;\n  touch-action: none;\n}\n\n.wb-resize-handle::before {\n  content: \'\';\n  position: absolute;\n  left: 4px;\n  top: 12px;\n  bottom: 12px;\n  width: 2px;\n  border-radius: 999px;\n  background: var(--wb-primary-hover);\n  transition: background-color 0.15s ease;\n}\n\n.wb-resize-handle:hover::before,\n.wb-resize-handle.dragging::before {\n  background: var(--wb-primary-light);\n}\n\n.editor-center {\n  border: none;\n  border-radius: 12px;\n  background: var(--wb-bg-panel);\n  padding: 16px;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n  min-height: 0;\n  overflow: auto;\n}\n\n.editor-head {\n  display: flex;\n  justify-content: space-between;\n  gap: 10px;\n  align-items: flex-end;\n  border-bottom: 1px solid var(--wb-border-subtle);\n  padding-bottom: 12px;\n}\n\n.editor-comment {\n  flex: 1;\n}\n\n.editor-badges {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n  justify-content: flex-end;\n}\n\n.editor-badge {\n  font-size: 10px;\n  border: none;\n  border-radius: 999px;\n  padding: 2px 8px;\n  color: var(--wb-text-muted);\n  background: var(--wb-bg-panel);\n  white-space: nowrap;\n}\n\n.editor-badge.mono {\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \'Liberation Mono\', \'Courier New\', monospace;\n}\n\n.editor-badge.on {\n  color: #86efac;\n  background: rgba(34, 197, 94, 0.12);\n}\n\n.editor-badge.off {\n  color: #cbd5e1;\n  background: rgba(100, 116, 139, 0.15);\n}\n\n.editor-badge.strategy[data-status=\'constant\'] {\n  color: #93c5fd;\n  background: rgba(59, 130, 246, 0.12);\n}\n\n.editor-badge.strategy[data-status=\'vector\'] {\n  color: #d8b4fe;\n  background: rgba(168, 85, 247, 0.12);\n}\n\n.editor-badge.strategy[data-status=\'normal\'] {\n  color: #86efac;\n  background: rgba(34, 197, 94, 0.12);\n}\n\n.editor-badge.strategy[data-status=\'disabled\'] {\n  color: #cbd5e1;\n  background: rgba(100, 116, 139, 0.12);\n}\n\n.editor-keyword-grid .text-area.compact {\n  min-height: 36px;\n  height: 36px;\n  line-height: 1.35;\n}\n\n.editor-content-block {\n  min-height: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n  flex: 1;\n}\n\n.editor-content-title {\n  font-size: 12px;\n  color: var(--wb-primary-light);\n  letter-spacing: 0.01em;\n}\n\n.editor-content-area {\n  min-height: 320px;\n  flex: 1;\n  resize: none;\n  line-height: 1.5;\n}\n\n.content-resize-handle {\n  display: none;\n  align-items: center;\n  justify-content: center;\n  height: 18px;\n  cursor: ns-resize;\n  background: var(--wb-bg-panel);\n  border: 1px solid var(--wb-border);\n  border-top: none;\n  border-radius: 0 0 6px 6px;\n  touch-action: none;\n  user-select: none;\n}\n\n.content-resize-grip {\n  font-size: 14px;\n  color: var(--wb-text-dim);\n  letter-spacing: 2px;\n  line-height: 1;\n}\n\n.editor-advanced {\n  border: none;\n  border-radius: 8px;\n  padding: 10px;\n  background: var(--wb-input-bg);\n}\n\n.editor-advanced > summary {\n  cursor: pointer;\n  font-size: 12px;\n  color: var(--wb-text-muted);\n}\n\n.editor-advanced[open] > summary {\n  margin-bottom: 7px;\n}\n\n.editor-side {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  min-height: 0;\n  overflow: auto;\n}\n\n.editor-card {\n  border: none;\n  border-radius: 12px;\n  padding: 12px;\n  background: var(--wb-bg-panel);\n  display: grid;\n  gap: 7px;\n}\n\n.editor-card h4 {\n  margin: 0;\n  font-size: 12px;\n  color: var(--wb-primary);\n}\n\n.strategy-switch {\n  display: grid;\n  gap: 6px;\n}\n\n.strategy-pill {\n  border: none;\n  border-radius: 6px;\n  background: var(--wb-input-bg);\n  color: var(--wb-text-muted);\n  padding: 6px 10px;\n  font-size: 12px;\n  cursor: pointer;\n  text-align: left;\n  transition: background-color 0.15s ease;\n}\n\n.strategy-pill:hover {\n  background: var(--wb-primary-hover);\n}\n\n.strategy-pill.active.constant {\n  background: rgba(59, 130, 246, 0.16);\n  color: #93c5fd;\n}\n\n.strategy-pill.active.vector {\n  background: rgba(168, 85, 247, 0.16);\n  color: #d8b4fe;\n}\n\n.strategy-pill.active.selective {\n  background: rgba(34, 197, 94, 0.16);\n  color: #86efac;\n}\n\n.editor-grid {\n  display: grid;\n  gap: 8px;\n}\n\n.editor-grid.two-cols {\n  grid-template-columns: 1fr 1fr;\n}\n\n.editor-grid.three-cols {\n  grid-template-columns: repeat(3, minmax(0, 1fr));\n}\n\n.field {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n}\n\n.field > span {\n  color: var(--wb-primary-light);\n}\n\n.field.disabled {\n  opacity: 0.56;\n}\n\n.field-end {\n  align-self: end;\n}\n\n.field-actions {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.text-input,\n.text-area,\n.toolbar-select {\n  width: 100%;\n  box-sizing: border-box;\n  border: 1px solid transparent;\n  border-radius: 6px;\n  padding: 8px 10px;\n  color: var(--wb-text-main);\n  background: var(--wb-input-bg);\n  transition: all 0.2s ease;\n}\n\n.text-input:hover,\n.text-area:hover,\n.toolbar-select:hover {\n  background: var(--wb-input-bg-hover);\n}\n\n.text-input:focus,\n.text-area:focus,\n.toolbar-select:focus {\n  background: var(--wb-input-bg-focus);\n  border-color: var(--wb-primary-glow);\n  outline: none;\n  box-shadow: 0 0 0 3px var(--wb-primary-soft);\n}\n\n.text-area {\n  min-height: 96px;\n  resize: vertical;\n}\n\n.text-area.compact {\n  min-height: 84px;\n}\n\n.text-area.large {\n  min-height: 190px;\n}\n\n.checkbox-inline {\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n}\n\n.wb-tools-grid {\n  display: grid;\n  gap: 8px;\n  grid-template-columns: repeat(2, minmax(0, 1fr));\n}\n\n.tool-card {\n  border-radius: 10px;\n  padding: 10px;\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  min-height: 170px;\n  background: var(--wb-bg-panel);\n}\n\n.tool-card h4 {\n  margin: 0;\n  font-size: 13px;\n  color: var(--wb-primary-light);\n}\n\n.tool-line.stacked {\n  display: grid;\n  gap: 6px;\n}\n\n.find-flags {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n}\n\n.find-scope-line {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  flex-wrap: wrap;\n}\n\n.find-summary-text {\n  margin-left: auto;\n  color: var(--wb-primary-light);\n  font-size: 12px;\n}\n\n.find-active-hit {\n  border: 1px solid var(--wb-border-main);\n  border-radius: 7px;\n  padding: 6px 8px;\n  display: grid;\n  gap: 2px;\n  background: var(--wb-bg-panel);\n}\n\n.find-active-hit strong {\n  color: var(--wb-text-main);\n  font-size: 12px;\n}\n\n.find-active-hit span {\n  color: var(--wb-text-muted);\n  font-size: 11px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.batch-exclude-note {\n  color: var(--wb-text-muted);\n  font-size: 11px;\n}\n\n.batch-exclude-chips {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.exclude-chip {\n  border: 1px solid var(--wb-border-subtle);\n  border-radius: 999px;\n  padding: 1px 8px;\n  font-size: 11px;\n  color: var(--wb-text-main);\n  background: var(--wb-bg-panel);\n}\n\n.tool-details {\n  border: 1px solid var(--wb-border-main);\n  border-radius: 8px;\n  padding: 6px;\n  background: var(--wb-bg-panel);\n}\n\n.tool-details > summary {\n  cursor: pointer;\n  color: var(--wb-text-main);\n  font-size: 12px;\n}\n\n.tool-details[open] > summary {\n  margin-bottom: 6px;\n}\n\n.history-compare {\n  display: grid;\n  gap: 6px;\n}\n\n.history-preview-grid {\n  display: grid;\n  grid-template-columns: repeat(2, minmax(0, 1fr));\n  gap: 6px;\n}\n\n.history-preview-card {\n  border: 1px solid var(--wb-border-main);\n  border-radius: 8px;\n  padding: 6px;\n  display: grid;\n  gap: 3px;\n  background: var(--wb-bg-panel);\n}\n\n.history-preview-card strong {\n  color: var(--wb-primary-light);\n  font-size: 11px;\n}\n\n.history-preview-card span {\n  color: var(--wb-text-muted);\n  font-size: 11px;\n  line-height: 1.35;\n}\n\n.history-note {\n  border: 1px dashed var(--wb-border-main);\n  border-radius: 8px;\n  padding: 6px;\n  color: var(--wb-text-muted);\n  font-size: 11px;\n  background: var(--wb-bg-panel);\n}\n\n.tool-scroll {\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n}\n\n.tool-list-item {\n  border-radius: 8px;\n  padding: 8px;\n  display: flex;\n  justify-content: space-between;\n  gap: 8px;\n  align-items: center;\n  background: var(--wb-input-bg);\n}\n\n.item-main {\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n  min-width: 0;\n}\n\n.item-main strong,\n.activation-main strong {\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.item-main span {\n  color: var(--wb-text-muted);\n  font-size: 12px;\n}\n\n.item-actions {\n  display: flex;\n  gap: 6px;\n}\n\n.activation-item {\n  border-radius: 8px;\n  padding: 8px;\n  display: grid;\n  gap: 3px;\n  background: var(--wb-input-bg);\n}\n\n.activation-main,\n.activation-sub {\n  display: flex;\n  justify-content: space-between;\n  gap: 6px;\n}\n\n.activation-main span,\n.activation-sub {\n  color: var(--wb-text-muted);\n  font-size: 12px;\n}\n\n.activation-sub span:last-child {\n  flex: 1;\n  text-align: right;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.wb-floating-window {\n  position: fixed;\n  max-width: calc(100vw - 16px);\n  max-height: min(74vh, 760px);\n  border: 1px solid var(--wb-border-subtle);\n  border-radius: 10px;\n  background: var(--wb-bg-root);\n  box-shadow: var(--wb-shadow-main);\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n.wb-floating-header {\n  display: flex;\n  justify-content: space-between;\n  gap: 8px;\n  align-items: center;\n  padding: 8px 10px;\n  border-bottom: 1px solid var(--wb-border-subtle);\n  background: var(--wb-bg-panel);\n  cursor: move;\n  user-select: none;\n  touch-action: none;\n}\n\n.wb-floating-header strong {\n  font-size: 12px;\n  color: var(--wb-text-main);\n}\n\n.wb-floating-header-actions {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.wb-floating-body {\n  min-height: 0;\n  padding: 8px;\n  display: grid;\n  gap: 8px;\n  overflow: auto;\n}\n\n.find-window .wb-floating-body {\n  gap: 10px;\n}\n\n.activation-window .tool-scroll {\n  max-height: min(58vh, 520px);\n}\n\n.wb-status {\n  border-radius: 10px;\n  background: var(--wb-bg-panel);\n  padding: 10px 12px;\n  display: flex;\n  justify-content: space-between;\n  gap: 8px;\n  color: var(--wb-text-main);\n  flex-wrap: wrap;\n}\n\n.btn {\n  border: 1px solid var(--wb-border-main);\n  background: var(--wb-bg-panel);\n  color: var(--wb-text-main);\n  border-radius: 7px;\n  padding: 5px 10px;\n  cursor: pointer;\n}\n\n.btn:hover:not(:disabled) {\n  border-color: var(--wb-primary-light);\n}\n\n.btn:disabled {\n  opacity: 0.5;\n  cursor: default;\n}\n\n.btn.primary {\n  background: var(--wb-primary-soft);\n  border-color: var(--wb-primary);\n}\n\n.btn.danger {\n  background: rgba(225, 29, 72, 0.12);\n  border-color: #e11d48;\n  color: #e11d48;\n}\n\n.btn.mini {\n  padding: 4px 8px;\n  font-size: 12px;\n}\n\n.empty-note,\n.empty-block {\n  color: var(--wb-text-muted);\n  font-size: 12px;\n}\n\n.empty-block {\n  padding: 14px;\n  border: 1px dashed var(--wb-border-main);\n  border-radius: 8px;\n}\n\n.hidden-input {\n  display: none;\n}\n\n.wb-modal-backdrop {\n  position: fixed;\n  inset: 0;\n  background: rgba(0, 0, 0, 0.55);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 10020;\n  padding: 14px;\n  box-sizing: border-box;\n}\n\n.wb-history-modal {\n  width: min(1260px, 100%);\n  max-height: min(88vh, 940px);\n  border: 1px solid var(--wb-border-main);\n  border-radius: 12px;\n  background: var(--wb-bg-root);\n  box-shadow: var(--wb-shadow-main);\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  box-sizing: border-box;\n}\n\n.wb-history-modal-header {\n  display: flex;\n  justify-content: space-between;\n  gap: 8px;\n  align-items: center;\n  padding: 10px 12px;\n  border-bottom: 1px solid var(--wb-border-main);\n  background: var(--wb-bg-panel);\n}\n\n.wb-history-modal-header strong {\n  display: block;\n  font-size: 14px;\n}\n\n.wb-history-modal-header span {\n  color: var(--wb-text-muted);\n  font-size: 11px;\n}\n\n.wb-history-modal-actions {\n  display: flex;\n  gap: 6px;\n  flex-wrap: wrap;\n}\n\n.wb-history-modal-main {\n  min-height: 0;\n  flex: 1;\n  display: grid;\n  grid-template-columns: 300px 1fr;\n  overflow: hidden;\n}\n\n.wb-history-versions {\n  border-right: 1px solid var(--wb-border-main);\n  background: var(--wb-bg-panel);\n  display: flex;\n  flex-direction: column;\n  min-height: 0;\n}\n\n.wb-history-versions-title {\n  padding: 8px 10px;\n  font-size: 11px;\n  color: var(--wb-text-muted);\n  border-bottom: 1px solid var(--wb-border-main);\n}\n\n.wb-history-versions-scroll {\n  flex: 1;\n  min-height: 0;\n  overflow: auto;\n  padding: 8px;\n  display: flex;\n  flex-direction: column;\n  gap: 7px;\n}\n\n.wb-history-version-item {\n  border: 1px solid var(--wb-border-main);\n  border-radius: 8px;\n  padding: 6px;\n  display: grid;\n  gap: 4px;\n  background: var(--wb-bg-panel);\n}\n\n.wb-history-version-line {\n  display: flex;\n  justify-content: space-between;\n  gap: 6px;\n  align-items: center;\n}\n\n.wb-history-version-line strong {\n  font-size: 11px;\n  color: var(--wb-text-main);\n}\n\n.wb-history-version-item span {\n  font-size: 11px;\n  color: var(--wb-text-muted);\n  word-break: break-all;\n}\n\n.wb-history-lr {\n  display: inline-flex;\n  gap: 4px;\n}\n\n.mini-lr {\n  border: 1px solid var(--wb-border-main);\n  background: var(--wb-input-bg);\n  color: var(--wb-text-muted);\n  border-radius: 6px;\n  min-width: 24px;\n  font-size: 10px;\n  cursor: pointer;\n}\n\n.mini-lr.active {\n  border-color: #22d3ee;\n  color: #67e8f9;\n}\n\n.wb-history-diff-wrap {\n  min-height: 0;\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n.wb-history-diff-head {\n  border-bottom: 1px solid var(--wb-border-main);\n  background: var(--wb-bg-panel);\n  padding: 8px 10px;\n  display: flex;\n  justify-content: space-between;\n  gap: 8px;\n  align-items: center;\n  font-size: 11px;\n  color: var(--wb-text-muted);\n}\n\n.wb-history-diff-grid {\n  min-height: 0;\n  flex: 1;\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n}\n\n.wb-history-diff-grid > div {\n  min-height: 0;\n  min-width: 0;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n.wb-history-diff-grid > div + div {\n  border-left: 1px solid var(--wb-border-main);\n}\n\n.wb-history-diff-title {\n  padding: 8px 10px;\n  border-bottom: 1px solid var(--wb-border-main);\n  font-size: 11px;\n  color: var(--wb-primary-light);\n}\n\n.wb-history-diff-body {\n  min-height: 0;\n  flex: 1;\n  overflow: auto;\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \'Liberation Mono\', \'Courier New\', monospace;\n  font-size: 11px;\n  background: var(--wb-input-bg-focus);\n  word-break: break-all;\n  overflow-wrap: break-word;\n}\n\n.diff-row {\n  display: grid;\n  grid-template-columns: 54px 1fr;\n  align-items: start;\n  border-bottom: 1px solid var(--wb-border-subtle);\n}\n\n.line-no {\n  color: var(--wb-text-muted);\n  padding: 2px 8px;\n  border-right: 1px solid var(--wb-border-subtle);\n  user-select: none;\n}\n\n.line-text {\n  white-space: pre-wrap;\n  word-break: break-word;\n  padding: 2px 8px;\n  color: var(--wb-text-main);\n}\n\n.diff-row.add {\n  background: rgba(34, 197, 94, 0.18);\n}\n\n.diff-row.del {\n  background: rgba(239, 68, 68, 0.18);\n}\n\n.diff-row.empty {\n  background: rgba(100, 116, 139, 0.08);\n}\n\n@media (max-width: 1380px) {\n  .wb-editor-shell {\n    grid-template-columns: 1fr;\n  }\n\n  .editor-side {\n    overflow: visible;\n    max-height: none;\n  }\n\n  .wb-history-modal-main {\n    grid-template-columns: 1fr;\n  }\n\n  .wb-history-versions {\n    border-right: none;\n    border-bottom: 1px solid var(--wb-border-main);\n    max-height: 120px;\n  }\n\n  .wb-modal-backdrop {\n    padding: 2px;\n  }\n\n  .wb-history-modal {\n    width: 100%;\n    max-height: calc(100vh - 4px);\n    height: calc(100vh - 4px);\n    border-radius: 6px;\n  }\n\n  .wb-history-modal-header {\n    flex-wrap: wrap;\n    gap: 4px;\n    padding: 6px 8px;\n    flex-shrink: 0;\n  }\n\n  .wb-history-modal-header strong {\n    font-size: 12px;\n  }\n\n  .wb-history-modal-header > div:first-child span {\n    display: none;\n  }\n\n  .wb-history-modal-actions {\n    gap: 4px;\n  }\n\n  .wb-history-modal-actions .btn {\n    font-size: 10px;\n    padding: 3px 6px;\n  }\n\n  .wb-history-modal-main {\n    grid-template-columns: 1fr;\n    overflow-y: auto;\n    flex: 1;\n    min-height: 0;\n  }\n\n  .wb-history-diff-wrap {\n    overflow-y: auto;\n    min-height: 0;\n  }\n\n  .wb-history-diff-grid {\n    grid-template-columns: 1fr;\n    overflow: visible;\n  }\n\n  .wb-history-diff-grid > div {\n    max-height: 30vh;\n    overflow: auto;\n  }\n\n  .wb-history-diff-grid > div + div {\n    border-left: none;\n    border-top: 1px solid var(--wb-border-main);\n  }\n\n  .diff-row {\n    grid-template-columns: 1fr;\n  }\n\n  .line-no {\n    display: none;\n  }\n\n  .wb-history-diff-body {\n    font-size: 10px;\n  }\n\n  .wb-history-diff-head {\n    flex-wrap: wrap;\n    gap: 4px;\n    padding: 6px 8px;\n  }\n\n  .wb-history-diff-head > div {\n    font-size: 10px;\n  }\n}\n\n@media (max-width: 1100px) {\n  .global-mode-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .wb-resize-handle {\n    display: none;\n  }\n\n  .wb-main-layout {\n    grid-template-columns: 1fr;\n  }\n\n  .wb-tools-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .editor-grid.two-cols,\n  .editor-grid.three-cols {\n    grid-template-columns: 1fr;\n  }\n\n  .editor-head {\n    flex-direction: column;\n    align-items: stretch;\n  }\n\n  .editor-badges {\n    justify-content: flex-start;\n  }\n\n  .history-preview-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .wb-history-diff-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .wb-history-diff-grid > div + div {\n    border-left: none;\n    border-top: 1px solid var(--wb-border-main);\n  }\n\n  .wb-status {\n    flex-direction: column;\n  }\n\n\n  .wb-floating-window {\n    width: calc(100vw - 16px) !important;\n    left: 8px !important;\n    right: 8px;\n  }\n}\n\n.editor-back-btn {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 10px 12px;\n  margin: 0 0 8px 0;\n  background: var(--wb-bg-panel);\n  border: none;\n  border-radius: 6px;\n  color: var(--wb-primary);\n  font-weight: 600;\n  cursor: pointer;\n}\n\n.editor-back-btn:hover {\n  background: var(--wb-primary-hover);\n}\n\n/*  Mobile Tab View  */\n.mobile-tab-view {\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n  min-height: 0;\n  overflow: hidden;\n}\n\n.mobile-tab-content {\n  flex: 1;\n  min-height: 0;\n  position: relative;\n}\n\n.mobile-pane {\n  position: absolute;\n  inset: 0;\n  overflow-y: auto;\n  padding: 8px;\n  -webkit-overflow-scrolling: touch;\n}\n\n.mobile-entry-list {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n}\n\n.mobile-ai-panel {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n}\n\n.mobile-ai-panel .ai-chat-area {\n  flex: 1;\n  min-height: 0;\n  display: flex;\n  flex-direction: column;\n}\n\n.mobile-danger-zone {\n  display: flex;\n  gap: 8px;\n  margin-top: 16px;\n  padding-top: 16px;\n  border-top: 1px solid var(--wb-border);\n}\n\n.mobile-danger-zone .btn {\n  flex: 1;\n}\n\n.mobile-tab-bar {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: 10100;\n  display: flex;\n  border-top: 1px solid var(--wb-border);\n  background: var(--wb-bg-secondary);\n  height: 52px;\n}\n\n.mobile-tab-bar button {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 2px;\n  border: none;\n  background: transparent;\n  color: var(--wb-text-dim);\n  font-size: 10px;\n  padding: 4px 0;\n  cursor: pointer;\n  transition: color 0.15s, background 0.15s;\n  -webkit-tap-highlight-color: transparent;\n}\n\n.mobile-tab-bar button.active {\n  color: var(--wb-accent);\n  background: color-mix(in srgb, var(--wb-accent) 8%, transparent);\n}\n\n.mobile-tab-bar .tab-icon {\n  font-size: 20px;\n  line-height: 1;\n}\n\n.mobile-tab-bar .tab-label {\n  font-weight: 500;\n}\n\n@media (max-width: 768px) {\n  .wb-assistant-root {\n    padding: 6px;\n    gap: 8px;\n  }\n\n  .wb-header,\n  .wb-bindings,\n  .global-mode-panel,\n  .wb-toolbar {\n    padding: 6px;\n    gap: 6px;\n  }\n\n  .toolbar-label {\n    min-width: 100%;\n  }\n\n  .toolbar-select {\n    width: 100%;\n  }\n\n  .worldbook-picker-trigger {\n    white-space: normal;\n  }\n\n  .wb-main-layout {\n    display: block !important;\n    height: auto !important;\n    overflow: visible !important;\n  }\n\n  .wb-entry-list,\n  .wb-editor,\n  .wb-editor-shell,\n  .editor-side {\n    width: 100% !important;\n    height: auto !important;\n    max-height: none !important;\n    border: none !important;\n    padding: 0 !important;\n  }\n\n  .wb-entry-list {\n    max-height: 80vh !important;\n    overflow-y: auto;\n  }\n\n  .wb-editor-shell {\n    display: block !important;\n  }\n\n  .list-scroll {\n    max-height: 60vh;\n  }\n\n  .wb-floating-window {\n    left: 8px !important;\n    right: 8px !important;\n    width: auto !important;\n    max-width: none !important;\n  }\n}\n\n.list-actions {\n  padding: 0 8px;\n}\n\n/* \n   Override: Force theme colors on native form elements\n   This beats SillyTavern global dark CSS which sets\n   background/color on textarea, input, select, etc.\n    */\n.wb-assistant-root input,\n.wb-assistant-root textarea,\n.wb-assistant-root select,\n.wb-assistant-root option,\n.wb-assistant-root button {\n  color: var(--wb-text-main) !important;\n}\n\n.wb-assistant-root input[type="text"],\n.wb-assistant-root input[type="number"],\n.wb-assistant-root textarea,\n.wb-assistant-root select {\n  background: var(--wb-input-bg) !important;\n  border-color: transparent !important;\n}\n\n.wb-assistant-root input[type="text"]:hover,\n.wb-assistant-root input[type="number"]:hover,\n.wb-assistant-root textarea:hover,\n.wb-assistant-root select:hover {\n  background: var(--wb-input-bg-hover) !important;\n}\n\n.wb-assistant-root input[type="text"]:focus,\n.wb-assistant-root input[type="number"]:focus,\n.wb-assistant-root textarea:focus,\n.wb-assistant-root select:focus {\n  background: var(--wb-input-bg-focus) !important;\n  border-color: var(--wb-primary-glow) !important;\n  outline: none !important;\n  box-shadow: 0 0 0 3px var(--wb-primary-soft) !important;\n}\n/* \n   AI Generator Panel\n    */\n.ai-generator-panel {\n  display: flex;\n  gap: 0;\n  flex: 1;\n  min-height: 0;\n  border-radius: var(--wb-radius);\n  overflow: hidden;\n  background: var(--wb-bg-secondary);\n}\n\n/*  Sidebar  */\n.ai-sidebar {\n  width: 220px;\n  min-width: 180px;\n  border-right: 1px solid var(--wb-border);\n  display: flex;\n  flex-direction: column;\n  background: var(--wb-bg-main);\n}\n\n.ai-sidebar-head {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 10px 12px;\n  border-bottom: 1px solid var(--wb-border);\n}\n\n.ai-sidebar-title {\n  font-weight: 600;\n  font-size: 0.9em;\n  color: var(--wb-text-main);\n}\n\n.ai-session-list {\n  flex: 1;\n  overflow-y: auto;\n  padding: 6px;\n}\n\n.ai-session-item {\n  display: flex;\n  flex-wrap: wrap;\n  align-items: center;\n  width: 100%;\n  padding: 8px 10px;\n  margin-bottom: 2px;\n  border: none;\n  border-radius: var(--wb-radius-sm, 6px);\n  background: transparent;\n  cursor: pointer;\n  text-align: left;\n  transition: background 0.15s;\n  position: relative;\n}\n\n.ai-session-item:hover {\n  background: var(--wb-bg-highlight);\n}\n\n.ai-session-item.active {\n  background: var(--wb-primary-soft);\n}\n\n.ai-session-title {\n  flex: 1;\n  font-size: 0.85em;\n  color: var(--wb-text-main);\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.ai-session-meta {\n  font-size: 0.72em;\n  color: var(--wb-text-dim);\n  width: 100%;\n  margin-top: 2px;\n}\n\n.ai-session-delete {\n  position: absolute;\n  top: 4px;\n  right: 4px;\n  width: 20px;\n  height: 20px;\n  border: none;\n  background: transparent;\n  color: var(--wb-text-dim);\n  font-size: 1em;\n  cursor: pointer;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  opacity: 0;\n  transition: opacity 0.15s, background 0.15s;\n}\n\n.ai-session-item:hover .ai-session-delete {\n  opacity: 1;\n}\n\n.ai-session-delete:hover {\n  background: var(--wb-danger, #e74c3c);\n  color: #fff;\n}\n\n/*  Chat Area  */\n.ai-chat-area {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  min-width: 0;\n}\n\n.ai-chat-empty {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 12px;\n  color: var(--wb-text-dim);\n}\n\n.ai-chat-empty-icon {\n  font-size: 3em;\n  opacity: 0.5;\n}\n\n.ai-chat-empty-text {\n  font-size: 0.95em;\n}\n\n.ai-chat-messages {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n/*  Chat bubbles  */\n.ai-chat-bubble {\n  max-width: 85%;\n  padding: 10px 14px;\n  border-radius: 12px;\n  line-height: 1.55;\n  white-space: pre-wrap;\n  word-break: break-word;\n}\n\n.ai-chat-bubble.user {\n  align-self: flex-end;\n  background: var(--wb-primary-soft);\n  border-bottom-right-radius: 4px;\n}\n\n.ai-chat-bubble.assistant {\n  align-self: flex-start;\n  background: var(--wb-bg-main);\n  border: 1px solid var(--wb-border);\n  border-bottom-left-radius: 4px;\n}\n\n.ai-chat-bubble-role {\n  font-size: 0.72em;\n  font-weight: 600;\n  color: var(--wb-text-dim);\n  margin-bottom: 4px;\n}\n\n.ai-chat-bubble-content {\n  font-size: 0.88em;\n  color: var(--wb-text-main);\n}\n\n.ai-cursor {\n  animation: ai-blink 0.7s infinite;\n  color: var(--wb-primary);\n}\n\n@keyframes ai-blink {\n  0%, 100% { opacity: 1; }\n  50% { opacity: 0; }\n}\n\n.ai-thinking {\n  color: var(--wb-text-dim);\n  font-style: italic;\n}\n\n/*  Input bar  */\n.ai-chat-input-bar {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n  padding: 12px 16px;\n  border-top: 1px solid var(--wb-border);\n  background: var(--wb-bg-main);\n  align-items: flex-end;\n}\n\n.ai-context-toggle {\n  width: 100%;\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: 0.78em;\n  color: var(--wb-text-dim);\n  cursor: pointer;\n  user-select: none;\n}\n\n.ai-context-toggle input {\n  margin: 0;\n}\n\n.ai-context-toggle span {\n  white-space: nowrap;\n}\n\n.ai-chat-input {\n  flex: 1;\n  resize: vertical;\n  min-height: 40px;\n  max-height: 140px;\n  font-size: 0.88em;\n}\n\n.ai-send-btn,\n.ai-stop-btn {\n  min-width: 64px;\n  height: 40px;\n}\n\n/* \n   Tag Review Modal\n    */\n.ai-tag-review-overlay {\n  position: fixed;\n  inset: 0;\n  z-index: 9999;\n  background: rgba(0, 0, 0, 0.55);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.ai-tag-review-modal {\n  background: var(--wb-bg-main);\n  border-radius: var(--wb-radius);\n  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);\n  width: 580px;\n  max-width: 92vw;\n  max-height: 80vh;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n.ai-tag-review-head {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 14px 18px;\n  border-bottom: 1px solid var(--wb-border);\n}\n\n.ai-tag-review-title {\n  font-weight: 600;\n  font-size: 1em;\n  color: var(--wb-text-main);\n}\n\n.ai-tag-review-close {\n  width: 28px;\n  height: 28px;\n  border: none;\n  background: transparent;\n  color: var(--wb-text-dim);\n  font-size: 1.2em;\n  cursor: pointer;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.ai-tag-review-close:hover {\n  background: var(--wb-bg-highlight);\n}\n\n.ai-tag-review-target {\n  padding: 12px 18px;\n  border-bottom: 1px solid var(--wb-border);\n}\n\n.ai-tag-list {\n  flex: 1;\n  overflow-y: auto;\n  padding: 8px 18px;\n}\n\n.ai-tag-item {\n  display: flex;\n  align-items: flex-start;\n  gap: 10px;\n  padding: 10px 0;\n  border-bottom: 1px solid var(--wb-border);\n  cursor: pointer;\n}\n\n.ai-tag-item:last-child {\n  border-bottom: none;\n}\n\n.ai-tag-item input[type="checkbox"] {\n  margin-top: 3px;\n}\n\n.ai-tag-info {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  min-width: 0;\n}\n\n.ai-tag-name {\n  font-weight: 600;\n  font-size: 0.9em;\n  color: var(--wb-primary);\n}\n\n.ai-tag-preview {\n  font-size: 0.8em;\n  color: var(--wb-text-dim);\n  white-space: pre-wrap;\n  word-break: break-all;\n  line-height: 1.4;\n}\n\n.ai-tag-review-actions {\n  display: flex;\n  gap: 8px;\n  padding: 12px 18px;\n  border-top: 1px solid var(--wb-border);\n  justify-content: flex-end;\n}\n\n.btn.primary {\n  background: var(--wb-primary);\n  color: #fff;\n  border-color: var(--wb-primary);\n}\n\n.btn.primary:hover {\n  filter: brightness(1.1);\n}\n\n.btn.primary:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* \n   Mobile Responsive\n    */\n@media (max-width: 768px) {\n  .wb-assistant-root {\n    padding: 6px;\n    gap: 6px;\n    border-radius: 0;\n  }\n\n  /*  Toolbar  */\n  .toolbar-label {\n    min-width: unset;\n    width: 100%;\n  }\n\n  .toolbar-label select {\n    flex: 1;\n    min-width: 0;\n  }\n\n  .toolbar-btns {\n    width: 100%;\n    display: flex;\n    flex-wrap: wrap;\n    gap: 4px;\n  }\n\n  .toolbar-btns .btn {\n    font-size: 0.78em;\n    padding: 4px 8px;\n  }\n\n  /*  Bindings bar  */\n  .wb-bindings {\n    flex-wrap: wrap;\n    gap: 4px;\n    padding: 6px 8px;\n    font-size: 0.78em;\n  }\n\n  /*  Main layout  */\n  .wb-main-layout {\n    display: block !important;\n    overflow: visible;\n    flex: none;\n  }\n\n  .wb-resize-handle {\n    display: none !important;\n  }\n\n  .wb-entry-list,\n  .wb-editor {\n    min-height: 0;\n    max-height: none;\n  }\n\n  /*  AI Generator Panel  */\n  .ai-generator-panel {\n    flex-direction: column;\n  }\n\n  .ai-sidebar {\n    width: 100%;\n    min-width: unset;\n    max-height: 110px;\n    border-right: none;\n    border-bottom: 1px solid var(--wb-border);\n  }\n\n  .ai-sidebar-head {\n    padding: 6px 10px;\n  }\n\n  .ai-session-list {\n    overflow-x: auto;\n    overflow-y: hidden;\n    display: flex;\n    flex-direction: row;\n    gap: 4px;\n    padding: 4px 8px;\n  }\n\n  .ai-session-item {\n    flex-shrink: 0;\n    min-width: 140px;\n    max-width: 200px;\n  }\n\n  .ai-chat-messages {\n    padding: 10px;\n    gap: 8px;\n  }\n\n  .ai-chat-bubble {\n    max-width: 95%;\n  }\n\n  .ai-chat-input-bar {\n    padding: 8px 10px;\n    gap: 6px;\n  }\n\n  .ai-chat-input {\n    min-height: 36px;\n    font-size: 0.85em;\n  }\n\n  /*  Tag review modal  */\n  .ai-tag-review-modal {\n    width: 95vw;\n    max-height: 85vh;\n  }\n\n  .ai-tag-review-actions {\n    flex-wrap: wrap;\n    gap: 6px;\n    padding: 8px 12px;\n  }\n\n  .ai-tag-review-actions .btn {\n    flex: 1;\n    min-width: 0;\n    font-size: 0.82em;\n  }\n\n  /*  Status footer  */\n  .wb-status {\n    font-size: 0.72em;\n    padding: 4px 8px;\n    gap: 6px;\n  }\n\n  /*  Editor content area  */\n  .editor-content-area {\n    flex: 1;\n    min-height: 40vh;\n  }\n\n  .content-resize-handle {\n    display: flex;\n    height: 28px;\n  }\n\n  .text-area.compact {\n    min-height: 60px;\n  }\n\n  .editor-center {\n    padding: 8px;\n  }\n\n  .editor-side {\n    padding: 8px;\n  }\n\n  .editor-grid.two-cols {\n    grid-template-columns: 1fr;\n  }\n}\n</style>\n\n'],sourceRoot:''}]);const l=i},11(e){e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var t='',a=void 0!==n[5];return n[4]&&(t+='@supports ('.concat(n[4],') {')),n[2]&&(t+='@media '.concat(n[2],' {')),a&&(t+='@layer'.concat(n[5].length>0?' '.concat(n[5]):'',' {')),t+=e(n),a&&(t+='}'),n[2]&&(t+='}'),n[4]&&(t+='}'),t}).join('')},n.i=function(e,t,a,r,o){'string'==typeof e&&(e=[[null,e,void 0]]);var i={};if(a)for(var l=0;l<this.length;l++){var s=this[l][0];null!=s&&(i[s]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);a&&i[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=o),t&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=t):c[2]=t),r&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=r):c[4]=''.concat(r)),n.push(c))}},n}},781(e){e.exports=function(e){var n=e[1],t=e[3];if(!t)return n;if('function'==typeof btoa){var a=btoa(unescape(encodeURIComponent(JSON.stringify(t)))),r='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(a),o='/*# '.concat(r,' */');return[n].concat([o]).join('\n')}return[n].join('\n')}},101(e,n,t){var a=t(480);a.__esModule&&(a=a.default),'string'==typeof a&&(a=[[e.id,a,'']]),a.locals&&(e.exports=a.locals);(0,t(424).A)('1f0d317a',a,!1,{ssrId:!0})},441(e,n){n.A=(e,n)=>{const t=e.__vccOpts||e;for(const[e,a]of n)t[e]=a;return t}},424(e,n,t){function a(e,n){for(var t=[],a={},r=0;r<n.length;r++){var o=n[r],i=o[0],l={id:e+':'+r,css:o[1],media:o[2],sourceMap:o[3]};a[i]?a[i].parts.push(l):t.push(a[i]={id:i,parts:[l]})}return t}t.d(n,{A:()=>f});var r='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!r)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var o={},i=r&&(document.head||document.getElementsByTagName('head')[0]),l=null,s=0,d=!1,c=function(){},u=null,p='data-vue-ssr-id',b='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,n,t,r){d=t,u=r||{};var i=a(e,n);return m(i),function(n){for(var t=[],r=0;r<i.length;r++){var l=i[r];(s=o[l.id]).refs--,t.push(s)}n?m(i=a(e,n)):i=[];for(r=0;r<t.length;r++){var s;if(0===(s=t[r]).refs){for(var d=0;d<s.parts.length;d++)s.parts[d]();delete o[s.id]}}}}function m(e){for(var n=0;n<e.length;n++){var t=e[n],a=o[t.id];if(a){a.refs++;for(var r=0;r<a.parts.length;r++)a.parts[r](t.parts[r]);for(;r<t.parts.length;r++)a.parts.push(v(t.parts[r]));a.parts.length>t.parts.length&&(a.parts.length=t.parts.length)}else{var i=[];for(r=0;r<t.parts.length;r++)i.push(v(t.parts[r]));o[t.id]={id:t.id,refs:1,parts:i}}}}function g(){var e=document.createElement('style');return e.type='text/css',i.appendChild(e),e}function v(e){var n,t,a=document.querySelector('style['+p+'~="'+e.id+'"]');if(a){if(d)return c;a.parentNode.removeChild(a)}if(b){var r=s++;a=l||(l=g()),n=y.bind(null,a,r,!1),t=y.bind(null,a,r,!0)}else a=g(),n=h.bind(null,a),t=function(){a.parentNode.removeChild(a)};return n(e),function(a){if(a){if(a.css===e.css&&a.media===e.media&&a.sourceMap===e.sourceMap)return;n(e=a)}else t()}}var A,C=(A=[],function(e,n){return A[e]=n,A.filter(Boolean).join('\n')});function y(e,n,t,a){var r=t?'':a.css;if(e.styleSheet)e.styleSheet.cssText=C(n,r);else{var o=document.createTextNode(r),i=e.childNodes;i[n]&&e.removeChild(i[n]),i.length?e.insertBefore(o,i[n]):e.appendChild(o)}}function h(e,n){var t=n.css,a=n.media,r=n.sourceMap;if(a&&e.setAttribute('media',a),u.ssrId&&e.setAttribute(p,n.id),r&&(t+='\n/*# sourceURL='+r.sources[0]+' */',t+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+' */'),e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},a={};function r(e){var n=a[e];if(void 0!==n)return n.exports;var o=a[e]={id:e,exports:{}};return t[e](o,o.exports,r),o.exports}r.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return r.d(n,{a:n}),n},r.d=(e,n)=>{for(var t in n)r.o(n,t)&&!r.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},r.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const o=Vue;const i={class:'mobile-tab-view'},l={class:'mobile-tab-content'},s={class:'mobile-pane'},d={class:'wb-toolbar'},c={class:'toolbar-label'},u=['title'],p={key:0,class:'worldbook-picker-dropdown'},b={class:'worldbook-picker-list'},f=['onClick'],m={key:0,class:'empty-note'},g={class:'toolbar-btns',style:{display:'flex',gap:'6px','flex-wrap':'wrap'}},v=['disabled'],A=['disabled'],C={key:0,class:'wb-bindings'},y=['title'],h=['title'],w=['title'],x=['title'],k={key:1,style:{border:'1px solid var(--wb-border-subtle)','border-radius':'8px',padding:'10px','margin-bottom':'8px',background:'var(--wb-bg-card)'}},E={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'8px'}},B={style:{'font-weight':'600','font-size':'13px'}},S=['disabled'],N={class:'field',style:{'margin-bottom':'6px'}},V=['value'],R={style:{display:'flex',gap:'4px','flex-wrap':'wrap','margin-bottom':'8px'}},F=['disabled'],T=['disabled'],P=['disabled'],I={class:'field',style:{'margin-bottom':'6px'}},M=['onKeydown'],W={key:0,style:{'max-height':'120px','overflow-y':'auto','margin-bottom':'6px'}},D=['onClick'],L={key:1,style:{'font-size':'12px','margin-bottom':'4px',opacity:'0.7'}},O={style:{display:'flex','flex-direction':'column',gap:'2px','margin-bottom':'8px'}},H=['onClick'],Y={style:{'border-top':'1px solid var(--wb-border-subtle)','padding-top':'8px','margin-top':'4px'}},G={style:{display:'flex',gap:'4px','flex-wrap':'wrap','margin-bottom':'6px'}},U=['disabled'],j=['disabled'],K={style:{'margin-bottom':'6px'}},q=['disabled'],Q={key:0,style:{'margin-top':'4px'}},Z=['onKeydown'],J={style:{'max-height':'120px','overflow-y':'auto'}},X=['disabled','onClick'],ee={key:0,style:{'font-size':'11px',opacity:'0.5',padding:'4px'}},ne={key:0,style:{display:'flex','flex-wrap':'wrap',gap:'4px'}},te=['onClick'],ae={key:0,style:{'font-size':'11px',opacity:'0.5'}},re={key:1,style:{'font-size':'11px',opacity:'0.5'}},oe={class:'mobile-entry-list'},ie=['data-status','onClick'],le={class:'entry-item-head'},se=['data-status'],de={class:'entry-item-title'},ce={class:'entry-chip uid'},ue={key:0,class:'entry-item-keys'},pe={style:{display:'flex',gap:'6px','flex-wrap':'wrap','margin-top':'4px','font-size':'10px',opacity:'0.8'}},be={style:{background:'var(--wb-input-bg)',padding:'2px 6px','border-radius':'4px'}},fe={style:{background:'var(--wb-input-bg)',padding:'2px 6px','border-radius':'4px'}},me={key:0,style:{background:'var(--wb-input-bg)',padding:'2px 6px','border-radius':'4px',color:'#f59e0b'}},ge={key:1,style:{background:'var(--wb-input-bg)',padding:'2px 6px','border-radius':'4px',color:'#f59e0b'}},ve={key:0,class:'empty-note'},Ae={class:'mobile-pane'},Ce={class:'editor-head'},ye={class:'field editor-comment'},he={class:'editor-badges'},we={class:'editor-badge mono'},xe={class:'editor-badge mono'},ke={class:'editor-grid two-cols editor-keyword-grid'},Ee={class:'field'},Be={class:'field'},Se={class:'editor-content-block'},Ne={key:1,class:'empty-block'},_e={class:'mobile-pane'},Ve={class:'editor-card'},Re={class:'field checkbox-inline'},Fe={class:'strategy-switch'},Te={class:'editor-advanced'},Pe={class:'field'},Ie=['value'],ze={class:'field'},Me={class:'field'},We={class:'editor-card'},De={class:'field'},Le=['value'],$e={class:'field'},Oe={class:'editor-grid two-cols'},He=['disabled'],Ye=['disabled'],Ge={class:'editor-card'},Ue={class:'field checkbox-inline'},je={class:'field checkbox-inline'},Ke={class:'editor-advanced'},qe={class:'field'},Qe={key:1,class:'empty-block'},Ze={class:'mobile-pane'},Je={class:'ai-generator-panel mobile-ai-panel'},Xe={class:'ai-chat-area'},en={key:0,class:'ai-chat-empty'},nn={class:'ai-chat-bubble-role'},tn={class:'ai-chat-bubble-content'},an={key:0,class:'ai-chat-bubble assistant streaming'},rn={class:'ai-chat-bubble-content'},on={key:1,class:'ai-chat-bubble assistant streaming'},ln={class:'ai-chat-input-bar'},sn={class:'ai-context-toggle',title:'AI '},dn=['disabled','onKeydown'],cn=['disabled'],un={style:{display:'flex !important','flex-shrink':'0',height:'52px',background:'#1e293b','border-top':'1px solid #334155','z-index':'99999'}},pn={class:'wb-toolbar'},bn={class:'toolbar-label'},fn=['title'],mn={class:'worldbook-picker-trigger-arrow'},gn={key:0,class:'worldbook-picker-dropdown'},vn={class:'worldbook-picker-list'},An=['onClick'],Cn={key:0,class:'empty-note'},yn=['disabled'],hn=['disabled'],wn=['disabled'],xn={class:'wb-scroll-area'},kn={class:'wb-bindings'},En={class:'wb-history-shortcuts'},Bn=['disabled'],Sn=['disabled'],Nn=['disabled'],_n={key:0,class:'global-mode-panel'},Vn={class:'global-mode-head'},Rn={class:'global-mode-title'},Fn=['disabled'],Tn={class:'global-preset-panel'},Pn={class:'field'},In=['value'],zn={class:'global-mode-actions'},Mn=['disabled'],Wn=['disabled'],Dn=['disabled'],Ln={class:'preset-role-panel'},$n={class:'preset-role-head'},On={class:'preset-role-actions'},Hn=['disabled'],Yn=['disabled'],Gn=['disabled'],Un={class:'role-picker-trigger-text'},jn={class:'role-picker-trigger-arrow'},Kn={key:0,class:'role-picker-dropdown'},qn=['onKeydown'],Qn={class:'role-picker-list'},Zn=['disabled','onClick'],Jn={class:'name'},Xn={class:'meta'},et={key:0,class:'empty-note'},nt={class:'preset-role-tags'},tt=['title','onClick'],at={key:0,class:'empty-note'},rt={key:1,class:'empty-note'},ot={class:'global-mode-grid'},it={class:'global-mode-column'},lt={class:'field'},st=['onKeydown'],dt={class:'global-mode-list'},ct=['onClick'],ut={class:'global-mode-item-name'},pt={key:0,class:'empty-note'},bt={class:'global-mode-column'},ft={class:'field'},mt={class:'global-mode-list'},gt=['onClick'],vt={class:'global-mode-item-name'},At={key:0,class:'empty-note'},Ct={class:'global-mode-actions'},yt=['disabled'],ht={key:0,class:'ai-generator-panel'},wt={class:'ai-sidebar'},xt={class:'ai-session-list'},kt=['onClick'],Et={class:'ai-session-title'},Bt={class:'ai-session-meta'},St=['onClick'],Nt={key:0,class:'empty-note'},_t={class:'ai-chat-area'},Vt={key:0,class:'ai-chat-empty'},Rt={class:'ai-chat-bubble-role'},Ft={class:'ai-chat-bubble-content'},Tt={key:0,class:'ai-chat-bubble assistant streaming'},Pt={class:'ai-chat-bubble-content'},It={key:1,class:'ai-chat-bubble assistant streaming'},zt={class:'ai-chat-input-bar'},Mt={class:'ai-context-toggle',title:'AI '},Wt=['disabled','onKeydown'],Dt=['disabled'],Lt={class:'ai-tag-review-modal'},$t={class:'ai-tag-review-head'},Ot={class:'ai-tag-review-title'},Ht={class:'ai-tag-review-target'},Yt={class:'field'},Gt=['value'],Ut={class:'ai-tag-list'},jt=['onUpdate:modelValue'],Kt={class:'ai-tag-info'},qt={class:'ai-tag-name'},Qt={class:'ai-tag-preview'},Zt={class:'ai-tag-review-actions'},Jt=['disabled'],Xt={class:'wb-entry-list'},ea={class:'list-search'},na={class:'checkbox-inline'},ta={class:'list-summary'},aa={class:'list-scroll'},ra=['data-status','onClick'],oa={class:'entry-item-head'},ia=['data-status'],la={class:'entry-item-title'},sa={class:'entry-chip uid'},da={class:'entry-item-tags'},ca=['data-status'],ua={class:'entry-chip'},pa={class:'entry-chip'},ba={class:'entry-chip mono'},fa={class:'entry-item-preview'},ma={class:'list-actions'},ga=['disabled'],va=['disabled'],Aa=['disabled'],Ca=['disabled'],ya=['disabled'],ha={class:'wb-editor'},wa={class:'editor-center'},xa={class:'editor-head'},ka={class:'field editor-comment'},Ea={class:'editor-badges'},Ba=['data-status'],Sa={class:'editor-badge mono'},Na={class:'editor-badge mono'},_a={class:'editor-badge mono'},Va={class:'editor-grid two-cols editor-keyword-grid'},Ra={class:'field'},Fa={class:'field'},Ta={class:'editor-content-block'},Pa={class:'editor-advanced'},Ia={class:'field'},za={class:'editor-side'},Ma={class:'editor-card'},Wa={class:'field checkbox-inline'},Da={class:'strategy-switch'},La={class:'editor-advanced'},$a={class:'field'},Oa=['value'],Ha={class:'field'},Ya={class:'field'},Ga={class:'editor-card'},Ua={class:'field'},ja=['value'],Ka={class:'field'},qa={class:'editor-grid two-cols'},Qa=['disabled'],Za=['disabled'],Ja={class:'editor-card'},Xa={class:'field checkbox-inline'},er={class:'field checkbox-inline'},nr={class:'field'},tr={class:'editor-grid two-cols'},ar={class:'field'},rr={class:'field'},or={class:'field'},ir={key:1,class:'empty-block'},lr={class:'wb-status'},sr={class:'wb-history-modal'},dr={class:'wb-history-modal-header'},cr={class:'wb-history-modal-actions'},ur=['disabled'],pr=['disabled'],br={class:'wb-history-modal-main'},fr={class:'wb-history-versions'},mr={class:'wb-history-versions-scroll'},gr={class:'wb-history-version-line'},vr={class:'wb-history-lr'},Ar=['onClick'],Cr=['onClick'],yr={key:0,class:'empty-note'},hr={class:'wb-history-diff-wrap'},wr={class:'wb-history-diff-head'},xr=['disabled'],kr={class:'wb-history-diff-grid'},Er=['innerHTML'],Br=['innerHTML'],Sr={class:'wb-history-modal'},Nr={class:'wb-history-modal-header'},_r={class:'wb-history-modal-actions'},Vr=['disabled'],Rr=['disabled'],Fr={class:'wb-history-modal-main'},Tr={class:'wb-history-versions'},Pr={class:'wb-history-versions-scroll'},Ir={class:'wb-history-version-line'},zr={class:'wb-history-lr'},Mr=['onClick'],Wr=['onClick'],Dr={class:'wb-history-diff-wrap'},Lr={class:'wb-history-diff-head'},$r=['disabled'],Or={class:'wb-history-diff-grid'},Hr=['innerHTML'],Yr=['innerHTML'],Gr={class:'wb-floating-header-actions'},Ur=['disabled'],jr=['disabled'],Kr=['disabled'],qr=['disabled'],Qr={class:'wb-floating-body'},Zr={class:'tool-line stacked'},Jr={class:'find-scope-line'},Xr={class:'checkbox-inline'},eo={class:'checkbox-inline'},no=['disabled'],to={class:'find-summary-text'},ao={key:0,class:'find-active-hit'},ro={class:'batch-exclude-note'},oo={key:1,class:'batch-exclude-chips'},io={class:'find-flags'},lo={class:'checkbox-inline'},so={class:'checkbox-inline'},co={class:'checkbox-inline'},uo={class:'checkbox-inline'},po={class:'tool-details'},bo={class:'tool-line'},fo=['disabled'],mo=['disabled'],go={class:'tool-line'},vo=['disabled'],Ao=['disabled'],Co={class:'wb-floating-header-actions'},yo=['disabled'],ho={class:'wb-floating-body'},wo={class:'tool-scroll'},xo={class:'activation-main'},ko={class:'activation-sub'},Eo={key:0,class:'empty-note'},Bo='worldbook_assistant_state_v1',So='__WB_ASSISTANT_HAS_UNSAVED_CHANGES__',No=10,_o=220,Vo=540,Ro=280,Fo=420,To=(0,o.defineComponent)({__name:'App',setup(t){const a={ocean:{name:'Ocean (Deep)',label:'',colors:{'--wb-bg-root':'#0f172a','--wb-bg-panel':'#1e293b','--wb-text-main':'#f1f5f9','--wb-text-muted':'#94a3b8','--wb-primary':'#0ea5e9','--wb-primary-light':'#38bdf8','--wb-primary-hover':'rgba(56, 189, 248, 0.15)','--wb-primary-soft':'rgba(14, 165, 233, 0.15)','--wb-primary-glow':'rgba(14, 165, 233, 0.4)','--wb-input-bg':'rgba(0, 0, 0, 0.25)','--wb-input-bg-hover':'rgba(0, 0, 0, 0.35)','--wb-input-bg-focus':'rgba(0, 0, 0, 0.45)','--wb-border-subtle':'rgba(255, 255, 255, 0.08)','--wb-border-main':'rgba(255, 255, 255, 0.12)','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.5)','--wb-scrollbar-thumb':'rgba(255, 255, 255, 0.2)'}},nebula:{name:'Nebula (Dark)',label:'',colors:{'--wb-bg-root':'#170b25','--wb-bg-panel':'#261836','--wb-text-main':'#f3e8ff','--wb-text-muted':'#a855f7','--wb-primary':'#c084fc','--wb-primary-light':'#d8b4fe','--wb-primary-hover':'rgba(192, 132, 252, 0.15)','--wb-primary-soft':'rgba(168, 85, 247, 0.15)','--wb-primary-glow':'rgba(192, 132, 252, 0.4)','--wb-input-bg':'rgba(0, 0, 0, 0.25)','--wb-input-bg-hover':'rgba(0, 0, 0, 0.35)','--wb-input-bg-focus':'rgba(0, 0, 0, 0.45)','--wb-border-subtle':'rgba(255, 255, 255, 0.08)','--wb-border-main':'rgba(255, 255, 255, 0.12)','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.5)','--wb-scrollbar-thumb':'rgba(255, 255, 255, 0.2)'}},forest:{name:'Forest',label:'',colors:{'--wb-bg-root':'#051812','--wb-bg-panel':'#0d2b21','--wb-text-main':'#ecfdf5','--wb-text-muted':'#34d399','--wb-primary':'#10b981','--wb-primary-light':'#34d399','--wb-primary-hover':'rgba(16, 185, 129, 0.15)','--wb-primary-soft':'rgba(5, 150, 105, 0.15)','--wb-primary-glow':'rgba(16, 185, 129, 0.4)','--wb-input-bg':'rgba(0, 0, 0, 0.25)','--wb-input-bg-hover':'rgba(0, 0, 0, 0.35)','--wb-input-bg-focus':'rgba(0, 0, 0, 0.45)','--wb-border-subtle':'rgba(255, 255, 255, 0.08)','--wb-border-main':'rgba(255, 255, 255, 0.12)','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.5)','--wb-scrollbar-thumb':'rgba(255, 255, 255, 0.2)'}},sunset:{name:'Sunset',label:'',colors:{'--wb-bg-root':'#1a0f0f','--wb-bg-panel':'#2e1818','--wb-text-main':'#fff1f2','--wb-text-muted':'#fb7185','--wb-primary':'#fb923c','--wb-primary-light':'#fdba74','--wb-primary-hover':'rgba(251, 146, 60, 0.15)','--wb-primary-soft':'rgba(234, 88, 12, 0.15)','--wb-primary-glow':'rgba(251, 146, 60, 0.4)','--wb-input-bg':'rgba(0, 0, 0, 0.25)','--wb-input-bg-hover':'rgba(0, 0, 0, 0.35)','--wb-input-bg-focus':'rgba(0, 0, 0, 0.45)','--wb-border-subtle':'rgba(255, 255, 255, 0.08)','--wb-border-main':'rgba(255, 255, 255, 0.12)','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.5)','--wb-scrollbar-thumb':'rgba(255, 255, 255, 0.2)'}},coffee:{name:'Coffee',label:'',colors:{'--wb-bg-root':'#161009','--wb-bg-panel':'#291e16','--wb-text-main':'#fffbeb','--wb-text-muted':'#d97706','--wb-primary':'#fbbf24','--wb-primary-light':'#fcd34d','--wb-primary-hover':'rgba(251, 191, 36, 0.15)','--wb-primary-soft':'rgba(217, 119, 6, 0.15)','--wb-primary-glow':'rgba(251, 191, 36, 0.4)','--wb-input-bg':'rgba(0, 0, 0, 0.25)','--wb-input-bg-hover':'rgba(0, 0, 0, 0.35)','--wb-input-bg-focus':'rgba(0, 0, 0, 0.45)','--wb-border-subtle':'rgba(255, 255, 255, 0.08)','--wb-border-main':'rgba(255, 255, 255, 0.12)','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.5)','--wb-scrollbar-thumb':'rgba(255, 255, 255, 0.2)'}},paper:{name:'Paper (Light)',label:'',colors:{'--wb-bg-root':'#fbf9f5','--wb-bg-panel':'#f0eadd','--wb-text-main':'#4a3b32','--wb-text-muted':'#8c7b70','--wb-primary':'#d97706','--wb-primary-light':'#b45309','--wb-primary-hover':'rgba(217, 119, 6, 0.1)','--wb-primary-soft':'rgba(180, 83, 9, 0.1)','--wb-primary-glow':'rgba(217, 119, 6, 0.25)','--wb-input-bg':'#f7f3ec','--wb-input-bg-hover':'#f2ece2','--wb-input-bg-focus':'#ffffff','--wb-border-subtle':'rgba(74, 59, 50, 0.12)','--wb-border-main':'rgba(74, 59, 50, 0.2)','--wb-shadow-main':'0 8px 24px rgba(74, 59, 50, 0.12)','--wb-scrollbar-thumb':'rgba(74, 59, 50, 0.25)'}},snow:{name:'Snow (Light)',label:'',colors:{'--wb-bg-root':'#ffffff','--wb-bg-panel':'#f4f4f5','--wb-text-main':'#18181b','--wb-text-muted':'#71717a','--wb-primary':'#2563eb','--wb-primary-light':'#3b82f6','--wb-primary-hover':'rgba(37, 99, 235, 0.1)','--wb-primary-soft':'rgba(37, 99, 235, 0.08)','--wb-primary-glow':'rgba(37, 99, 235, 0.25)','--wb-input-bg':'#ffffff','--wb-input-bg-hover':'#fafafa','--wb-input-bg-focus':'#ffffff','--wb-border-subtle':'#e4e4e7','--wb-border-main':'#d4d4d8','--wb-shadow-main':'0 12px 28px rgba(0, 0, 0, 0.08)','--wb-scrollbar-thumb':'#a1a1aa'}}},r=['constant','selective','vectorized'],To=['and_any','and_all','not_all','not_any'],Po=['before_character_definition','after_character_definition','before_example_messages','after_example_messages','before_author_note','after_author_note','at_depth'],Io=(0,o.ref)([]),zo=(0,o.ref)(''),Mo=(0,o.ref)(!1),Wo=(0,o.ref)(''),Do=(0,o.ref)(null),Lo=(0,o.ref)(null),$o=(0,o.ref)(!1),Oo=(0,o.ref)(null),Ho=(0,o.ref)(null),Yo=(0,o.ref)('ocean'),Go=(0,o.ref)(!1),Uo=(0,o.ref)(!1),jo=(0,o.ref)(!1),Ko=(0,o.ref)(!1),qo=(0,o.ref)(null),Qo=(0,o.ref)(''),Zo=(0,o.ref)([]),Jo=(0,o.ref)(!1),Xo=(0,o.ref)(''),ei=(0,o.ref)(''),ni=(0,o.ref)(!0),ti=(0,o.ref)(null),ai=(0,o.ref)(''),ri=(0,o.ref)(null),oi=(0,o.ref)([]),ii=(0,o.ref)([]),li=(0,o.ref)([]),si=(0,o.ref)(null),di=(0,o.ref)(''),ci=(0,o.ref)(!1),ui=(0,o.ref)(null),pi=(0,o.ref)(''),bi=(0,o.ref)(''),fi=(0,o.ref)(''),mi=(0,o.ref)(''),gi=(0,o.ref)(''),vi=(0,o.ref)(''),Ai=(0,o.ref)(''),Ci=(0,o.ref)(!1),yi=(0,o.ref)(!0),hi=(0,o.ref)(!0),wi=(0,o.ref)(!1),xi=(0,o.ref)('all'),ki=(0,o.ref)([]),Ei=(0,o.ref)(-1),Bi=(0,o.ref)(''),Si=(0,o.ref)(!1),Ni=(0,o.ref)(!1),_i=(0,o.ref)(!1),Vi=(0,o.ref)(!1),Ri=(0,o.ref)(''),Fi=(0,o.ref)(''),Ti=(0,o.ref)(''),Pi=(0,o.ref)(''),Ii=(0,o.ref)(10005),zi=(0,o.reactive)({find:{visible:!1,x:420,y:170,z:10006,width:500},activation:{visible:!1,x:760,y:230,z:10008,width:480}}),Mi=(0,o.ref)(null),Wi=['find','activation'],Di=(0,o.ref)('undefined'!=typeof window?window.innerWidth:1440),Li=(0,o.ref)(null),$i=(0,o.ref)(null),Oi=(0,o.ref)(null),Hi=(0,o.ref)(320),Yi=(0,o.ref)(360),Gi=(0,o.ref)(null),Ui=(0,o.ref)(null),ji=(0,o.ref)(''),Ki=(()=>{const e=[];try{e.push(`win.iW=${window.innerWidth}`),e.push(`scr=${window.screen.width}x${window.screen.height}`),e.push(`tp=${navigator.maxTouchPoints}`),e.push(`parent==win:${window.parent===window}`);try{const n=window.parent;e.push(`p.scr=${n.screen.width}x${n.screen.height}`),e.push(`p.iW=${n.innerWidth}`)}catch(n){e.push('p.err:cross-origin')}}catch(n){e.push(`ERR:${n}`)}ji.value=e.join(' | ');const n=window.screen.width,t=window.screen.height,a=Math.min(n,t);return a<=768||navigator.maxTouchPoints>0&&a<=1024})(),qi=(0,o.computed)(()=>Ki),Qi=(0,o.computed)(()=>qi.value&&null!==si.value),Zi=(0,o.ref)('list'),Ji=(0,o.reactive)({global:[],charPrimary:null,charAdditional:[],chat:null}),Xi=(0,o.ref)([]),el=(0,o.ref)({last_worldbook:'',history:{},entry_history:{},global_presets:[],last_global_preset_id:'',role_override_baseline:null,theme:'ocean',ai_chat:{sessions:[],activeSessionId:null}}),nl=[],tl=(0,o.computed)(()=>null===si.value?null:li.value.find(e=>e.uid===si.value)??null),al=(0,o.computed)(()=>tl.value?li.value.findIndex(e=>e.uid===tl.value?.uid):-1),rl=(0,o.computed)(()=>{const e=di.value.trim().toLowerCase();return li.value.filter(n=>{if(ci.value&&!n.enabled)return!1;if(!e)return!0;const t=n.strategy.keys.map(es).join(' ').toLowerCase();return n.name.toLowerCase().includes(e)||n.content.toLowerCase().includes(e)||t.includes(e)})}),ol=(0,o.computed)(()=>li.value.filter(e=>e.enabled).length),il=(0,o.computed)(()=>li.value.reduce((e,n)=>e+n.content.length,0)),ll=(0,o.computed)(()=>JSON.stringify(li.value)!==JSON.stringify(ii.value)),sl=(0,o.computed)(()=>Di.value<=1100),dl=(0,o.computed)(()=>qi.value?{display:'block',height:'auto',overflow:'visible'}:sl.value?void 0:{gridTemplateColumns:`minmax(220px, min(${Hi.value}px, calc(100% - 550px))) 10px minmax(0, 1fr)`}),cl=(0,o.computed)(()=>{if(!sl.value)return{gridTemplateColumns:`minmax(0, 1fr) 10px minmax(280px, min(${Yi.value}px, calc(100% - 430px)))`}}),ul=(0,o.computed)(()=>a[Yo.value].colors),pl=(0,o.computed)(()=>Uo.value?Ji.global.filter(e=>Io.value.includes(e)):Io.value),bl=(0,o.computed)(()=>el.value.global_presets??[]),fl=(0,o.computed)(()=>bl.value.find(e=>e.id===ai.value)??null),ml=(0,o.computed)(()=>fl.value?.role_bindings??[]),gl=(0,o.computed)(()=>{const e=ri.value,n=fl.value;return!(!e||!n)&&n.role_bindings.some(n=>n.key===e.key)}),vl=(0,o.computed)(()=>{const e=mi.value.trim().toLowerCase(),n=new Set(ml.value.map(e=>e.key)),t=oi.value;return(e?t.filter(n=>n.name.toLowerCase().includes(e)||n.avatar.toLowerCase().includes(e)||n.key.toLowerCase().includes(e)):t).map(e=>({...e,bound:n.has(e.key)}))}),Al=(0,o.computed)(()=>{const e=Wo.value.trim().toLowerCase();return e?pl.value.filter(n=>n.toLowerCase().includes(e)):pl.value}),Cl=(0,o.computed)(()=>{const e=bi.value.trim().toLowerCase();return Io.value.filter(n=>!Ji.global.includes(n)&&(!e||n.toLowerCase().includes(e)))}),yl=(0,o.computed)(()=>{const e=fi.value.trim().toLowerCase();return e?Ji.global.filter(n=>n.toLowerCase().includes(e)):Ji.global}),hl=(0,o.computed)(()=>!!zo.value&&Ji.global.includes(zo.value)),wl=(0,o.computed)(()=>zo.value?el.value.history[zo.value]??[]:[]),xl=(0,o.computed)(()=>{if(!zo.value||!tl.value)return[];return(el.value.entry_history[zo.value]??{})[String(tl.value.uid)]??[]}),kl=(0,o.computed)(()=>{if(!tl.value)return[];const e=ii.value.find(e=>e.uid===tl.value?.uid)??null,n={id:'__current__',label:'',ts:Date.now(),name:tl.value.name,entry:tl.value,isCurrent:!0},t=e?{id:'__baseline__',label:'',ts:0,name:e.name,entry:e,isCurrent:!1}:null;return[n,...t?[t]:[],...xl.value.map(e=>({id:e.id,label:e.label,ts:e.ts,name:e.name,entry:e.entry,isCurrent:!1}))]}),El=(0,o.computed)(()=>kl.value.find(e=>e.id===Ri.value)??null),Bl=(0,o.computed)(()=>kl.value.find(e=>e.id===Fi.value)??null),Sl=(0,o.computed)(()=>Boolean(tl.value&&El.value&&!El.value.isCurrent)),Nl=(0,o.computed)(()=>{if(!zo.value)return[];const e={id:'__current__',label:'',ts:Date.now(),entries:li.value,isCurrent:!0},n={id:'__baseline__',label:'',ts:0,entries:ii.value,isCurrent:!1},t=wl.value.map(e=>({id:e.id,label:e.label,ts:e.ts,entries:e.entries,isCurrent:!1}));return[e,...ii.value.length?[n]:[],...t]}),_l=(0,o.computed)(()=>Nl.value.find(e=>e.id===Ti.value)??null),Vl=(0,o.computed)(()=>Nl.value.find(e=>e.id===Pi.value)??null),Rl=(0,o.computed)(()=>Boolean(_l.value&&!_l.value.isCurrent)),Fl=(0,o.computed)(()=>zs(Ai.value)),Tl=(0,o.computed)(()=>Ei.value<0||Ei.value>=ki.value.length?null:ki.value[Ei.value]??null),Pl=(0,o.computed)(()=>gi.value.trim()?ki.value.length?Tl.value?` ${Ei.value+1} / ${ki.value.length}`:` 0 / ${ki.value.length}`:'':''),Il=(0,o.computed)(()=>Is(Ts(El.value),Ts(Bl.value))),zl=(0,o.computed)(()=>function(n,t){if(!n||!t)return'';const a=Ts(n),r=Ts(t),o=e(a,r);let i=0,l=0;for(const e of o){const n=e.value.split('\n');n.length&&''===n[n.length-1]&&n.pop(),e.added?i+=n.length:e.removed&&(l+=n.length)}const s=Math.min(i,l),d=Math.max(0,i-s),c=Math.max(0,l-s);return` ${d} /  ${s} /  ${c}`}(El.value,Bl.value)),Ml=(0,o.computed)(()=>Is(Ps(_l.value),Ps(Vl.value))),Wl=(0,o.computed)({get:()=>tl.value?tl.value.strategy.keys.map(es).join(', '):'',set:e=>{tl.value&&(tl.value.strategy.keys=as(e))}}),Dl=(0,o.computed)({get:()=>tl.value?tl.value.strategy.keys_secondary.keys.map(es).join(', '):'',set:e=>{tl.value&&(tl.value.strategy.keys_secondary.keys=as(e))}}),Ll=(0,o.computed)({get:()=>{if(!tl.value)return'';const e=tl.value.strategy.scan_depth;return'number'==typeof e?String(e):'same_as_global'},set:e=>{tl.value&&(tl.value.strategy.scan_depth=cs(e))}}),$l=(0,o.computed)({get:()=>tl.value?Xl(tl.value.recursion.delay_until):'',set:e=>{tl.value&&(tl.value.recursion.delay_until=Jl(e))}}),Ol=(0,o.computed)({get:()=>tl.value?Xl(tl.value.effect.sticky):'',set:e=>{tl.value&&(tl.value.effect.sticky=Jl(e))}}),Hl=(0,o.computed)({get:()=>tl.value?Xl(tl.value.effect.cooldown):'',set:e=>{tl.value&&(tl.value.effect.cooldown=Jl(e))}}),Yl=(0,o.computed)({get:()=>tl.value?Xl(tl.value.effect.delay):'',set:e=>{tl.value&&(tl.value.effect.delay=Jl(e))}}),Gl=(0,o.computed)(()=>tl.value?.content.length??0),Ul=(0,o.computed)(()=>{const e=Gl.value;return e<=0?0:Math.max(1,Math.round(e/3.6))});function jl(e){return`${e}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,9)}`}function Kl(e){return e&&'object'==typeof e&&!Array.isArray(e)?e:null}function ql(e,n=''){return'string'==typeof e?e:null==e?n:String(e)}function Ql(e,n){if('number'==typeof e&&Number.isFinite(e))return e;if('string'==typeof e&&e.trim()){const n=Number(e);if(Number.isFinite(n))return n}return n}function Zl(e,n,t){return Math.min(t,Math.max(n,e))}function Jl(e){if(null==e)return null;if('string'==typeof e&&!e.trim())return null;const n=Number(e);return Number.isFinite(n)?Math.max(0,Math.floor(n)):null}function Xl(e){return null===e?'':String(e)}function es(e){return e instanceof RegExp?e.toString():e}function ns(e){const n=e.trim();if(!n)return'';const t=n.match(/^\/(.+)\/([dgimsuy]*)$/);if(!t)return n;try{return new RegExp(t[1],t[2])}catch{return n}}function ts(e){const n=Array.isArray(e)?e:'string'==typeof e?e.split(/[\n,]/g):[],t=[],a=new Set;for(const e of n){const n=e instanceof RegExp?e:ns(ql(e).trim()),r=es(n);if(!r)continue;const o=r.toLowerCase();a.has(o)||(a.add(o),t.push(n))}return t}function as(e){return ts(e.split(/[\n,]/g))}function rs(e){if(!Array.isArray(e))return[];const n=[],t=new Set;for(const a of e){const e=Kl(a);if(!e)continue;const r=ql(e.key).trim();r&&!t.has(r)&&(t.add(r),n.push({key:r,name:ql(e.name,r),avatar:ql(e.avatar),updated_at:Ql(e.updated_at,Date.now())}))}return n}function os(e){return{and_any:' (and_any)',and_all:' (and_all)',not_all:' (not_all)',not_any:' (not_any)'}[e]}function is(e){return{before_character_definition:'',after_character_definition:'',before_example_messages:'',after_example_messages:'',before_author_note:'',after_author_note:'',at_depth:''}[e]}function ls(e){return e.enabled?'constant'===e.strategy.type?'constant':'vectorized'===e.strategy.type?'vector':'normal':'disabled'}function ss(e){const n=ls(e);return'disabled'===n?' ':'constant'===n?' ':'vector'===n?' ':' '}function ds(e){const n=e.strategy.keys.slice(0,3).map(e=>es(e)).join(' / ');return n?e.strategy.keys.length>3?`${n} ...`:n:''}function cs(e){if('same_as_global'===e)return'same_as_global';const n=Math.floor(Ql(e,NaN));return Number.isFinite(n)&&n>0?n:'same_as_global'}function us(e){return{uid:e,name:` ${e}`,enabled:!0,strategy:{type:'selective',keys:[],keys_secondary:{logic:'and_any',keys:[]},scan_depth:'same_as_global'},position:{type:'after_character_definition',role:'system',depth:4,order:100},content:'',probability:100,recursion:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}}}function ps(e,t){const a=Kl(e)??{},o=us(t),i=Kl(a.strategy),l=Kl(a.position),s=Kl(a.recursion),d=Kl(a.effect),c=Kl(i?.keys_secondary),u=Math.max(0,Math.floor(Ql(a.uid??a.id,t))),p=ql(a.name??a.comment,` ${u}`).trim()||` ${u}`,b=function(e,n){const t=n?.type;return'string'==typeof t&&r.includes(t)?t:e.constant?'constant':e.vectorized?'vectorized':'selective'}(a,i),f=ts(i?.keys??a.keys??a.key),m=ts(c?.keys??a.secondary_keys??a.keysecondary??a.filters),g=function(e){if('string'==typeof e&&To.includes(e))return e;if('number'==typeof e)return['and_any','and_all','not_all','not_any'][e]??'and_any';return'and_any'}(c?.logic??a.logic??a.selectiveLogic),v=function(e){if('string'==typeof e){if(Po.includes(e))return e;if(e.match(/^at_depth_as_(system|assistant|user)$/))return'at_depth'}if('number'==typeof e)return{0:'before_character_definition',1:'after_character_definition',2:'before_example_messages',3:'after_example_messages',4:'before_author_note',5:'after_author_note',6:'at_depth'}[e]??'after_character_definition';return'after_character_definition'}(l?.type??a.position),A=function(e){if('assistant'===e||'user'===e||'system'===e)return e;if('number'==typeof e)return{0:'system',1:'assistant',2:'user'}[e]??'system';if('string'==typeof e){if(e.includes('assistant'))return'assistant';if(e.includes('user'))return'user'}return'system'}(l?.role??a.role),C=Math.max(1,Math.floor(Ql(l?.depth??a.depth,4))),y=Math.floor(Ql(l?.order??a.insertion_order??a.order,100)),h=Zl(Ql(a.probability,100),0,100),w=s?.prevent_incoming??a.preventRecursion,x=s?.prevent_outgoing??a.excludeRecursion,k={...o,uid:u,name:p,enabled:void 0===a.enabled?!Boolean(a.disable):Boolean(a.enabled),strategy:{type:b,keys:f,keys_secondary:{logic:g,keys:m},scan_depth:cs(i?.scan_depth??a.scan_depth)},position:{type:v,role:'at_depth'===v?A:'system',depth:'at_depth'===v?C:4,order:y},content:ql(a.content),probability:h,recursion:{prevent_incoming:Boolean(w),prevent_outgoing:Boolean(x),delay_until:Jl(s?.delay_until??a.delayUntilRecursion)},effect:{sticky:Jl(d?.sticky??a.sticky),cooldown:Jl(d?.cooldown??a.cooldown),delay:Jl(d?.delay??a.delay)}},E=Kl(a.extra);if(E&&Object.keys(E).length>0)k.extra=n(E);else{const e=function(e){const n=new Set(['uid','id','name','comment','enabled','disable','strategy','position','content','probability','recursion','effect','extra','keys','key','secondary_keys','keysecondary','filters','logic','selectiveLogic','scan_depth','constant','vectorized','selective','insertion_order','order','role','depth','preventRecursion','excludeRecursion','delayUntilRecursion','sticky','cooldown','delay','useProbability']),t={};for(const[a,r]of Object.entries(e))n.has(a)||(t[a]=r);if(0!==Object.keys(t).length)return t}(a);e&&(k.extra=n(e))}return k}function bs(e){const n=[],t=new Set;for(let a=0;a<e.length;a+=1){const r=Kl(e[a]);let o=Math.max(0,Math.floor(Ql(r?.uid??r?.id,a)));for(;t.has(o);)o+=1;t.add(o),n.push(ps(e[a],o))}return n}function fs(e){return 0===e.length?0:Math.max(...e.map(e=>e.uid))+1}function ms(){return function(e){const n=Kl(e);if(!n)return{last_worldbook:'',history:{},entry_history:{},global_presets:[],last_global_preset_id:'',role_override_baseline:null,theme:'ocean',ai_chat:{sessions:[],activeSessionId:null}};const t=Kl(n.history)??{},a={};for(const[e,n]of Object.entries(t))Array.isArray(n)&&(a[e]=n.map(e=>{const n=Kl(e);if(!n)return null;const t=Array.isArray(n.entries)?n.entries:[];return{id:ql(n.id,jl('snapshot')),label:ql(n.label,''),ts:Ql(n.ts,Date.now()),entries:bs(t)}}).filter(e=>null!==e).slice(0,12));const r=Kl(n.entry_history)??{},o={};for(const[e,n]of Object.entries(r)){const t=Kl(n);if(!t)continue;const a={};for(const[e,n]of Object.entries(t)){if(!Array.isArray(n))continue;const t=Math.max(0,Math.floor(Ql(e,0)));a[e]=n.map(e=>{const n=Kl(e);return n?{id:ql(n.id,jl('entry-snapshot')),label:ql(n.label,''),ts:Ql(n.ts,Date.now()),uid:t,name:ql(n.name,` ${t}`),entry:ps(n.entry,t)}:null}).filter(e=>null!==e).slice(0,7)}Object.keys(a).length>0&&(o[e]=a)}const i=(Array.isArray(n.global_presets)?n.global_presets:[]).map(e=>{const n=Kl(e);if(!n)return null;const t=Array.isArray(n.worldbooks)?n.worldbooks:[],a=[...new Set(t.map(e=>ql(e).trim()).filter(Boolean))],r=rs(n.role_bindings);return{id:ql(n.id,jl('global-preset')),name:ql(n.name,''),worldbooks:a,role_bindings:r,updated_at:Ql(n.updated_at,Date.now())}}).filter(e=>null!==e).slice(0,64),l=Kl(n.role_override_baseline);let s=null;if(l){const e=Array.isArray(l.worldbooks)?l.worldbooks.map(e=>ql(e).trim()).filter(Boolean):[];s={preset_id:ql(l.preset_id),worldbooks:[...new Set(e)]}}const d=Kl(n.ai_chat),c={sessions:[],activeSessionId:null};return d&&(c.activeSessionId=ql(d.activeSessionId)||null,Array.isArray(d.sessions)&&(c.sessions=d.sessions.map(e=>{const n=Kl(e);if(!n)return null;const t=Array.isArray(n.messages)?n.messages.map(e=>{const n=Kl(e);return n?{role:'assistant'===n.role?'assistant':'user',content:ql(n.content),timestamp:Ql(n.timestamp,Date.now())}:null}).filter(e=>null!==e):[];return{id:ql(n.id,jl('ai-chat')),title:ql(n.title,''),createdAt:Ql(n.createdAt,Date.now()),messages:t.slice(0,200)}}).filter(e=>null!==e).slice(0,50))),{last_worldbook:ql(n.last_worldbook),history:a,entry_history:o,global_presets:i,last_global_preset_id:ql(n.last_global_preset_id),role_override_baseline:s,theme:ql(n.theme)||'ocean',ai_chat:c}}(getVariables({type:'script',script_id:getScriptId()})[Bo])}function gs(){const e=el.value.global_presets,n=new Set(e.map(e=>e.id)),t=el.value.last_global_preset_id;t&&n.has(t)?ai.value=t:ai.value&&n.has(ai.value)||(ai.value='')}function vs(e){const n=ms();e(n),function(e){const n=getVariables({type:'script',script_id:getScriptId()});n[Bo]=e,replaceVariables(n,{type:'script',script_id:getScriptId()}),el.value=e,gs()}(n)}(0,o.watch)(zo,e=>{if(ec(),!e)return li.value=[],ii.value=[],void(si.value=null);vs(n=>{n.last_worldbook=e}),cc(e)}),(0,o.watch)(()=>si.value,()=>{!function(){if(!tl.value||!tl.value.extra)return void(pi.value='');pi.value=JSON.stringify(tl.value.extra,null,2)}()}),(0,o.watch)([gi,vi,Ai,Ci,yi,hi,wi,xi],()=>{Gs()}),(0,o.watch)(kl,e=>{if(!e.length)return Ri.value='',void(Fi.value='');const n=new Set(e.map(e=>e.id));if(n.has(Fi.value)||(Fi.value='__current__'),!n.has(Ri.value)){const n=e.find(e=>!e.isCurrent)??e[0];Ri.value=n.id}if(Ri.value===Fi.value&&e.length>1){const n=e.find(e=>e.id!==Fi.value);n&&(Ri.value=n.id)}},{immediate:!0}),(0,o.watch)(Nl,e=>{if(!e.length)return Ti.value='',void(Pi.value='');const n=new Set(e.map(e=>e.id));if(n.has(Pi.value)||(Pi.value='__current__'),!n.has(Ti.value)){const n=e.find(e=>!e.isCurrent)??e[0];Ti.value=n.id}if(Ti.value===Pi.value&&e.length>1){const n=e.find(e=>e.id!==Pi.value);n&&(Ti.value=n.id)}},{immediate:!0}),(0,o.watch)(()=>tl.value?.position.type,()=>{tl.value&&'at_depth'!==tl.value.position.type&&(tl.value.position.role='system',tl.value.position.depth=4)}),(0,o.watch)(ll,e=>{window[So]=e},{immediate:!0});const As=(0,o.computed)(()=>el.value.ai_chat.sessions),Cs=(0,o.computed)(()=>{const e=el.value.ai_chat.activeSessionId;return e?As.value.find(n=>n.id===e)??null:null}),ys=(0,o.computed)(()=>Cs.value?.messages??[]);function hs(){const e=jl('ai-chat'),n={id:e,title:` ${As.value.length+1}`,createdAt:Date.now(),messages:[]};vs(t=>{t.ai_chat.sessions.unshift(n),t.ai_chat.activeSessionId=e}),Ns('')}function ws(e,n){const t=el.value.ai_chat.activeSessionId;t&&vs(a=>{const r=a.ai_chat.sessions.find(e=>e.id===t);r&&(r.messages.push({role:e,content:n,timestamp:Date.now()}),r.messages.length>200&&(r.messages=r.messages.slice(-200)))})}let xs=null;async function ks(){const e=ei.value.trim();if(!e||Ko.value)return;el.value.ai_chat.activeSessionId||hs(),ei.value='',ws('user',e);const n=el.value.ai_chat.sessions.find(e=>e.id===el.value.ai_chat.activeSessionId);if(!n)return;const t=n.messages.slice(0,-1).map(e=>({role:e.role,content:e.content})),a=jl('ai-gen');qo.value=a,Ko.value=!0,Qo.value='',xs=eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY,(e,n)=>{n===a&&(Qo.value=e)});try{const n={generation_id:a,user_input:e,should_stream:!0,should_silence:!0};ni.value||(n.overrides={chat_history:{prompts:t}});const r=await generate(n);ws('assistant',r),Qo.value='';const o=function(e){const n=/<([^/<>\s]+)>([\s\S]*?)<\/\1>/g,t=[];let a;for(;null!==(a=n.exec(e));)t.push({tag:a[1],content:a[0],selected:!0});return t}(r);o.length>0&&(Zo.value=o,Jo.value=!0)}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`AI : ${n}`),Ns(`AI : ${n}`)}finally{Ko.value=!1,qo.value=null,xs?.stop(),xs=null}}function Es(){qo.value&&stopGenerationById(qo.value)}async function Bs(){const e=Zo.value.filter(e=>e.selected);if(0===e.length)return void toastr.warning('');const n=Xo.value;if(n)try{const t=e.map(e=>({name:e.tag,content:e.content}));await createWorldbookEntries(n,t),toastr.success(` ${e.length}  "${n}"`),Ns(` ${e.length}  "${n}"`),Jo.value=!1,Zo.value=[]}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`)}else toastr.warning('')}function Ss(){jo.value=!jo.value,jo.value&&(Uo.value=!1)}function Ns(e){Bi.value=e}function _s(e){try{return new Date(e).toLocaleString('zh-CN',{hour12:!1})}catch{return String(e)}}function Vs(e,n,t){return t?'Current':''===e||n<=0?e:`${e}  ${_s(n)}`}function Rs(e,n){if(!e||!n)return'';const t=new Map,a=new Map;e.entries.forEach(e=>t.set(e.uid,e)),n.entries.forEach(e=>a.set(e.uid,e));let r=0,o=0,i=0;for(const[e,n]of a){const a=t.get(e);a?JSON.stringify(a)!==JSON.stringify(n)&&(i+=1):r+=1}for(const e of t.keys())a.has(e)||(o+=1);return` ${r} /  ${i} /  ${o}`}function Fs(e){return e.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll('\'','&#39;')}function Ts(e){if(!e)return'';const n=e.entry,t={uid:n.uid,name:n.name,enabled:n.enabled,strategy:n.strategy,position:n.position,probability:n.probability,recursion:n.recursion,effect:n.effect,content:n.content,extra:n.extra??null};return JSON.stringify(t,null,2)}function Ps(e){if(!e)return'';const n=e.entries.map(e=>({uid:e.uid,name:e.name,enabled:e.enabled,type:e.strategy.type,keys:e.strategy.keys.map(es),position:e.position,probability:e.probability,content:e.content})).sort((e,n)=>e.uid-n.uid);return JSON.stringify({entries:n},null,2)}function Is(n,t){const a=[],r=[];let o=1,i=1;const l=e(n,t);for(const e of l){const n=e.value.split('\n');if(n.length&&''===n[n.length-1]&&n.pop(),n.length)if(e.added)for(const e of n)a.push('<div class="diff-row empty"><span class="line-no"></span><span class="line-text">&nbsp;</span></div>'),r.push(`<div class="diff-row add"><span class="line-no">${i}</span><span class="line-text">${Fs(e)||'&nbsp;'}</span></div>`),i+=1;else if(e.removed)for(const e of n)a.push(`<div class="diff-row del"><span class="line-no">${o}</span><span class="line-text">${Fs(e)||'&nbsp;'}</span></div>`),r.push('<div class="diff-row empty"><span class="line-no"></span><span class="line-text">&nbsp;</span></div>'),o+=1;else for(const e of n){const n=Fs(e)||'&nbsp;';a.push(`<div class="diff-row"><span class="line-no">${o}</span><span class="line-text">${n}</span></div>`),r.push(`<div class="diff-row"><span class="line-no">${i}</span><span class="line-text">${n}</span></div>`),o+=1,i+=1}}return{leftHtml:a.join(''),rightHtml:r.join('')}}function zs(e){const n=new Set,t=[];for(const a of e.split(/[\n,]/g)){const e=a.trim().toLowerCase();e&&!n.has(e)&&(n.add(e),t.push(e))}return t}function Ms(e,n){if(!n.length)return!1;const t=e.name.toLowerCase(),a=e.content.toLowerCase(),r=e.strategy.keys.map(e=>es(e).toLowerCase()).join(' '),o=e.strategy.keys_secondary.keys.map(e=>es(e).toLowerCase()).join(' ');for(const i of n){const n=i.match(/^(?:#|uid:)?(\d+)$/);if(n&&Number(n[1])===e.uid)return!0;const l=i.match(/^(name|content|keys|secondary|secondary_keys):(.+)$/);if(l){const e=l[1],n=l[2].trim();if(!n)continue;if('name'===e&&t.includes(n))return!0;if('content'===e&&a.includes(n))return!0;if('keys'===e&&r.includes(n))return!0;if(('secondary'===e||'secondary_keys'===e)&&o.includes(n))return!0;continue}const s=i.trim();if(s&&(t.includes(s)||a.includes(s)||r.includes(s)||o.includes(s)))return!0}return!1}function Ws(e){return'name'===e?'':'content'===e?'':''}function Ds(e){if(!Ci.value)return null;try{return new RegExp(e,'g')}catch(e){return toastr.error(`: ${e instanceof Error?e.message:String(e)}`),null}}function Ls(){return'current'===xi.value?tl.value?[tl.value]:[]:li.value}function $s(){const e=[];return yi.value&&e.push('name'),hi.value&&e.push('content'),wi.value&&e.push('keys'),e}function Os(e,n){return'name'===n?e.name:'content'===n?e.content:e.strategy.keys.map(e=>es(e)).join(', ')}function Hs(e,n,t){const a=[];if(!e||!n)return a;if(!t){let t=0;for(;t<=e.length;){const r=e.indexOf(n,t);if(r<0)break;const o=r+n.length;a.push({start:r,end:o,matchedText:e.slice(r,o)}),t=Math.max(o,r+1)}return a}const r=new RegExp(t.source,t.flags.includes('g')?t.flags:`${t.flags}g`);let o=null;for(;null!==(o=r.exec(e));){const e=o[0]??'';if(!e){r.lastIndex+=1;continue}const n=o.index,t=n+e.length;a.push({start:n,end:t,matchedText:e})}return a}function Ys(e,n,t){const a=Math.max(0,n-18),r=Math.min(e.length,t+22),o=a>0?'...':'',i=r<e.length?'...':'';return`${o}${e.slice(a,r).replace(/\s+/g,' ')}${i}`}function Gs(){ki.value=[],Ei.value=-1}function Us(e){const n=$i.value;return n?'name'===e?n.querySelector('.editor-comment input.text-input'):'content'===e?n.querySelector('.editor-content-area'):n.querySelector('.editor-keyword-grid .field textarea'):null}function js(e,n){const t=function(e){const n=window.getComputedStyle(e),t=Number.parseFloat(n.lineHeight);if(Number.isFinite(t)&&t>0)return t;const a=Number.parseFloat(n.fontSize);return Number.isFinite(a)&&a>0?1.4*a:18}(e),a=e.value.slice(0,n).split('\n').length-1,r=Math.max(0,a*t-.35*e.clientHeight);e.scrollTop=r}function Ks(e,n,t){Ei.value=n,si.value=e.entryUid,async function(e){await(0,o.nextTick)();let n=Us(e.field);if(!n&&(await(0,o.nextTick)(),n=Us(e.field),!n))return;const t=n.value.length,a=Math.max(0,Math.min(e.start,t)),r=Math.max(a,Math.min(e.end,t));n.focus(),n.setSelectionRange(a,r),n instanceof HTMLTextAreaElement&&js(n,a),n.scrollIntoView({block:'center',inline:'nearest'}),requestAnimationFrame(()=>{n?.scrollIntoView({block:'center',inline:'nearest'}),n instanceof HTMLTextAreaElement&&js(n,a)})}(e);Ns(` ${n+1}/${t}: ${e.entryName||` ${e.entryUid}`}  ${Ws(e.field)}  ${e.preview}`)}function qs(e){const n=gi.value;if(!n)return void toastr.warning('');if(!$s().length)return void toastr.warning('');if('current'===xi.value&&!tl.value)return void toastr.warning('');const t=zs(Ai.value),a=Ds(n);if(Ci.value&&!a)return;const r=function(e,n,t){const a=$s();if(!a.length)return[];const r=Ls(),o=[];for(const i of r)if(!Ms(i,t))for(const t of a){const a=Os(i,t),r=Hs(a,e,n);for(const e of r)o.push({entryUid:i.uid,entryName:i.name,field:t,start:e.start,end:e.end,matchedText:e.matchedText,preview:Ys(a,e.start,e.end)})}return o}(n,a,t);if(ki.value=r,!r.length)return Ei.value=-1,Ns(''),void toastr.info('');if(0===e)return void Ks(r[0],0,r.length);const o=Tl.value,i=o?r.findIndex(e=>{return t=o,(n=e).entryUid===t.entryUid&&n.field===t.field&&n.start===t.start&&n.end===t.end&&n.matchedText===t.matchedText;var n,t}):Ei.value;let l;l=i<0?e>0?0:r.length-1:(i+e+r.length)%r.length,Ks(r[l],l,r.length)}function Qs(){qs(0)}function Zs(){qs(1)}function Js(){qs(-1)}function Xs(){if(!li.value.length)return void(si.value=null);if(null===si.value)return void(si.value=li.value[0].uid);li.value.some(e=>e.uid===si.value)||(si.value=li.value[0].uid)}function ed(e){si.value=e,qi.value&&(Zi.value='edit')}function nd(){si.value=null,Zi.value='list'}function td(e,t,a,r){return{id:jl('entry-snapshot'),label:e,ts:Date.now(),uid:t,name:a||` ${t}`,entry:ps(n(r),t)}}function ad(e){if(!zo.value||!e.length)return 0;let n=0;const t=zo.value;return vs(a=>{const r=a.entry_history[t]??{};for(const t of e){const e=String(t.uid),a=td(t.label,t.uid,t.name,t.entry),o=r[e]??[];o[0]&&JSON.stringify(o[0].entry)===JSON.stringify(a.entry)||(o.unshift(a),o.length>7&&(o.length=7),r[e]=o,n+=1)}a.entry_history[t]=r}),n}function rd(e,n){return ad([{label:e,uid:n.uid,name:n.name,entry:n}])>0}function od(e){if(!zo.value)return;const t=zo.value,a={id:jl('snapshot'),label:e,ts:Date.now(),entries:n(li.value)};vs(e=>{const n=e.history[t]??[];n.unshift(a),n.length>12&&(n.length=12),e.history[t]=n})}function id(){zo.value?(od(''),toastr.success('')):toastr.warning('')}function ld(){if(!tl.value)return void toastr.warning('');const e=kl.value.find(e=>!e.isCurrent)??null;Fi.value='__current__',Ri.value=e?.id??'__current__',_i.value=!0}function sd(){if(!zo.value)return void toastr.warning('');const e=Nl.value.find(e=>!e.isCurrent)??null;Pi.value='__current__',Ti.value=e?.id??'__current__',Vi.value=!0}function dd(){if(!tl.value)return void toastr.warning('');rd('',tl.value)?toastr.success(''):toastr.info('')}function cd(){const e=_l.value;e&&!e.isCurrent&&confirm(` Left  "${e.label}" ? `)&&(li.value=bs(n(e.entries)),Xs(),Ns(`${e.label}`),toastr.success(' Left '))}function ud(){zo.value&&wl.value.length&&confirm(` "${zo.value}" `)&&vs(e=>{delete e.history[zo.value]})}function pd(){const e=El.value;if(!e||e.isCurrent)return;if(!tl.value||al.value<0)return;if(!confirm(` "${e.label}" ?`))return;rd('',tl.value);const t=ps(n(e.entry),tl.value.uid);t.uid=tl.value.uid,li.value.splice(al.value,1,t),si.value=t.uid,Ns(`${e.label}`),toastr.success(' Left ')}function bd(){if(!zo.value||!tl.value||!xl.value.length)return;if(!confirm(` #${tl.value.uid} `))return;const e=zo.value,n=String(tl.value.uid);vs(t=>{const a=t.entry_history[e]??{};delete a[n],t.entry_history[e]=a})}function fd(){tl.value&&'at_depth'!==tl.value.position.type&&(tl.value.position.role='system',tl.value.position.depth=4)}function md(){if(!tl.value)return;const e=pi.value.trim();if(e)try{const t=Kl(JSON.parse(e));if(!t)throw new Error('extra  JSON ');tl.value.extra=n(t),toastr.success('extra ')}catch(e){toastr.error(`extra JSON : ${e instanceof Error?e.message:String(e)}`)}else tl.value.extra=void 0}function gd(){tl.value&&(tl.value.extra=void 0,pi.value='')}function vd(){const e=fs(li.value),n=us(e);li.value.push(n),si.value=e,Ns(` #${e}`)}function Ad(){if(!tl.value||al.value<0)return;const e=fs(li.value),t=ps(n(tl.value),e);t.uid=e,t.name=`${t.name} ()`,li.value.splice(al.value+1,0,t),si.value=e,Ns(` #${tl.value.uid}`)}function Cd(){!tl.value||al.value<0||confirm(` "${tl.value.name}" ?`)&&(rd('',tl.value),li.value.splice(al.value,1),qi.value?si.value=null:Xs(),Ns(''))}function yd(e){if(al.value<0)return;const n=al.value+e;if(n<0||n>=li.value.length)return;const[t]=li.value.splice(al.value,1);li.value.splice(n,0,t),si.value=t.uid}function hd(){li.value=bs(li.value.map(e=>n(e))),Xs(),Ns('')}function wd(){li.value.sort((e,n)=>n.position.order-e.position.order),Xs(),Ns(' order ')}function xd(e){li.value.forEach(n=>{n.enabled=e}),Ns(e?'':'')}function kd(){const e=gi.value;if(!e)return void toastr.warning('');if(!$s().length)return void toastr.warning('');if('current'===xi.value&&!tl.value)return void toastr.warning('');const n=Ls();if(!n.length)return void toastr.warning('');const t=zs(Ai.value),a=Ds(e);if(Ci.value&&!a)return;let r=0,o=0;for(const i of n){if(Ms(i,t)){o+=1;continue}let n=!1;if(yi.value){const t=a?i.name.replace(a,vi.value):i.name.split(e).join(vi.value);t!==i.name&&(i.name=t,n=!0)}if(hi.value){const t=a?i.content.replace(a,vi.value):i.content.split(e).join(vi.value);t!==i.content&&(i.content=t,n=!0)}if(wi.value){const t=ts(i.strategy.keys.map(n=>{const t=es(n);return a?t.replace(a,vi.value):t.split(e).join(vi.value)}));JSON.stringify(t.map(es))!==JSON.stringify(i.strategy.keys.map(es))&&(i.strategy.keys=t,n=!0)}n&&(r+=1)}Gs(),Ns(`${'current'===xi.value?'':''} ${r}  ${o} `)}function Ed(){if(!zo.value)return;const e={format:'worldbook_assistant_v1',name:zo.value,exported_at:(new Date).toISOString(),entries:li.value};!function(e,n){const t=JSON.stringify(n,null,2),a=new Blob([t],{type:'application/json'}),r=URL.createObjectURL(a),o=document.createElement('a');o.href=r,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}(`${zo.value.replace(/[\\/:*?"<>|]/g,'_')}.json`,e)}function Bd(e,n){const t=JSON.parse(n),a=e.replace(/\.[^/.]+$/,'')||'';if(Array.isArray(t))return{name:a,entries:bs(t)};const r=Kl(t);if(!r)throw new Error(' JSON ');const o=function(e){if(Array.isArray(e.entries))return e.entries;const n=Kl(e.entries);if(n)return Object.values(n);const t=Kl(e.data);if(t){if(Array.isArray(t.entries))return t.entries;const e=Kl(t.entries);if(e)return Object.values(e)}return[]}(r);if(!o.length)throw new Error(' entries');const i=Kl(r.data);return{name:ql(r.name??i?.name,a).trim()||a,entries:bs(o)}}function Sd(){ui.value?.click()}async function Nd(e){const n=e.target,t=n?.files?.[0];if(!t)return;const a=await t.text();try{const e=Bd(t.name,a),n=e.name||t.name.replace(/\.[^/.]+$/,''),r=ql(prompt('',n)).trim();if(!r)return;await createOrReplaceWorldbook(r,e.entries,{render:'immediate'}),await uc(r),await _d(),toastr.success(`: ${r}`)}catch(e){const n=e instanceof Error?e.message:String(e);if(!confirm(`: ${n}\n`))return;const r=await importRawWorldbook(t.name,a);if(!r.ok)throw new Error(`: HTTP ${r.status}`);await pc(),toastr.success('')}finally{n&&(n.value='')}}async function _d(){Ji.global=[...getGlobalWorldbookNames()];try{const e=getCharWorldbookNames('current');Ji.charPrimary=e.primary,Ji.charAdditional=[...e.additional]}catch{Ji.charPrimary=null,Ji.charAdditional=[]}try{Ji.chat=getChatWorldbookName('current')}catch{Ji.chat=null}Uo.value&&Vd()}function Vd(){if(!Uo.value)return;const e=pl.value;e.length?e.includes(zo.value)||(zo.value=e[0]):zo.value=''}function Rd(e={}){if(Uo.value)return!1;if(e.preferWhenEmptyOnly&&zo.value)return!1;const n=function(){const e=Io.value;if(!e.length)return null;const n=ql(Ji.chat).trim();if(n&&e.includes(n))return n;const t=ql(Ji.charPrimary).trim();return t&&e.includes(t)?t:Ji.charAdditional.find(n=>e.includes(n))??null}();return!(!n||n===zo.value)&&(!e.force&&ll.value?(Ns('/'),!1):(zo.value=n,Ns(`: ${n}`),!0))}function Fd(){if(Uo.value=!Uo.value,Uo.value)return jo.value=!1,Vd(),void Ns('');zo.value||Rd({force:!0}),Ns('')}async function Td(e,n=''){const t=[...new Set(e.map(e=>e.trim()).filter(Boolean))].filter(e=>Io.value.includes(e));try{return await rebindGlobalWorldbooks(t),await _d(),Vd(),Ns(`${n}${t.length} `),!0}catch(e){const n=e instanceof Error?e.message:String(e);return toastr.error(`: ${n}`),!1}}function Pd(){const e=Cl.value[0];e&&Id(e)}async function Id(e){if(!e||Ji.global.includes(e))return;await Td([...Ji.global,e],`: ${e}`)&&(bi.value='',vs(e=>{e.role_override_baseline=null}))}async function zd(e){if(!e||!Ji.global.includes(e))return;await Td(Ji.global.filter(n=>n!==e),`: ${e}`)&&vs(e=>{e.role_override_baseline=null})}async function Md(){if(!Ji.global.length)return;if(!confirm(''))return;await Td([],'')&&vs(e=>{e.role_override_baseline=null})}function Wd(){return[...new Set(Ji.global.map(e=>e.trim()).filter(Boolean))]}function Dd(e){return[...new Set(e.map(e=>e.trim()).filter(Boolean))]}function Ld(){let e=[];try{e='function'==typeof getCharacterNames?getCharacterNames():[]}catch(e){console.warn('[WorldbookAssistant] getCharacterNames failed:',e)}const n=new Set,t=[];for(const a of e){const e=a.trim();if(!e)continue;const r=`char:${e}`;n.has(r)||(n.add(r),t.push({key:r,name:e,avatar:'',updated_at:Date.now()}))}t.sort((e,n)=>e.name.localeCompare(n.name,'zh-Hans-CN'));const a=$d();a&&!t.some(e=>e.key===a.key)&&t.unshift(a),oi.value=t}function $d(){let e=null;try{e='function'==typeof getCurrentCharacterName?getCurrentCharacterName():null}catch(e){console.warn('[WorldbookAssistant] getCurrentCharacterName failed:',e)}if(!e)return null;const n=e.trim();return n?{key:`char:${n}`,name:n,avatar:'',updated_at:Date.now()}:null}function Od(){ri.value=$d()}async function Hd(e,n={}){const t=Dd(e.worldbooks),a=t.filter(e=>!Io.value.includes(e)),r=t.filter(e=>Io.value.includes(e));if(n.silentWhenSame&&function(e,n){const t=[...Dd(e)].sort(),a=[...Dd(n)].sort();if(t.length!==a.length)return!1;for(let e=0;e<t.length;e+=1)if(t[e]!==a[e])return!1;return!0}(Wd(),r))return vs(n=>{n.last_global_preset_id=e.id}),!0;const o=n.statusPrefix??'';return!!await Td(r,`${o}: ${e.name}`)&&(vs(n=>{n.last_global_preset_id=e.id}),a.length&&toastr.warning(` ${a.length} `),!0)}async function Yd(){const e=function(){const e=ri.value;return e?bl.value.find(n=>n.role_bindings.some(n=>n.key===e.key))??null:null}();if(!e){const e=el.value.role_override_baseline;if(e)if(vs(n=>{n.role_override_baseline=null,n.last_global_preset_id=e.preset_id}),ai.value=e.preset_id,e.preset_id){const n=bl.value.find(n=>n.id===e.preset_id);n?await Hd(n,{statusPrefix:'',silentWhenSame:!0}):await Td(e.worldbooks,'')}else await Td(e.worldbooks,'');return}el.value.role_override_baseline||vs(e=>{e.role_override_baseline={preset_id:ai.value,worldbooks:Wd()}}),ai.value=e.id,await Hd(e,{statusPrefix:`${ri.value?.name??''}`,silentWhenSame:!0})}function Gd(){if(nc(),!ai.value)return vs(e=>{e.last_global_preset_id='',e.role_override_baseline=null}),void(Ji.global.length?Td([],''):Ns(''));!async function(){const e=fl.value;if(!e)return;await Hd(e)&&vs(e=>{e.role_override_baseline=null})}()}function Ud(e){const n=fl.value;n?(vs(t=>{t.global_presets=(t.global_presets??[]).map(t=>{if(t.id!==n.id)return t;const a=rs([...t.role_bindings.filter(n=>n.key!==e.key),{key:e.key,name:e.name,avatar:e.avatar,updated_at:Date.now()}]);return{...t,role_bindings:a,updated_at:Date.now()}}),t.last_global_preset_id=n.id}),Ns(`: ${e.name}  ${n.name}`)):toastr.warning('')}function jd(){const e=ri.value;e?Ud(e):toastr.warning('')}function Kd(e){e.bound||(Ud(e),nc())}function qd(e){const n=fl.value;n&&e&&vs(t=>{t.global_presets=(t.global_presets??[]).map(t=>t.id!==n.id?t:{...t,role_bindings:t.role_bindings.filter(n=>n.key!==e),updated_at:Date.now()})})}function Qd(){const e=ri.value;e?(qd(e.key),Ns(`: ${e.name}`)):toastr.warning('')}function Zd(){const e=Wd();if(!e.length)return void toastr.warning('');const n=fl.value?.name||` ${bl.value.length+1}`,t=ql(prompt('',n)).trim();if(!t)return;const a=bl.value.find(e=>e.name===t);if(a&&!confirm(` "${t}" `))return;const r=a?.id||jl('global-preset'),o={id:r,name:t,worldbooks:e,role_bindings:a?.role_bindings??[],updated_at:Date.now()};vs(e=>{const n=(e.global_presets??[]).filter(e=>e.id!==r);n.unshift(o),e.global_presets=n.slice(0,64),e.last_global_preset_id=r}),ai.value=r,Ns(`: ${t}${e.length} `),toastr.success(`: ${t}`)}function Jd(){const e=fl.value;if(!e)return;const n=Wd();n.length?confirm(` "${e.name}" `)&&(vs(t=>{t.global_presets=(t.global_presets??[]).map(t=>t.id!==e.id?t:{...t,worldbooks:n,updated_at:Date.now()}),t.last_global_preset_id=e.id}),Ns(`: ${e.name}${n.length} `),toastr.success(`: ${e.name}`)):toastr.warning('')}function Xd(){const e=fl.value;e&&confirm(` "${e.name}" `)&&(vs(n=>{n.global_presets=(n.global_presets??[]).filter(n=>n.id!==e.id),n.last_global_preset_id===e.id&&(n.last_global_preset_id='')}),ai.value='',Ns(`: ${e.name}`))}function ec(){Mo.value=!1}function nc(){$o.value=!1}function tc(){Mo.value?ec():(Wo.value='',Mo.value=!0,(0,o.nextTick)(()=>{Lo.value?.focus()}))}function ac(){$o.value?nc():fl.value&&(mi.value='',Ld(),$o.value=!0,(0,o.nextTick)(()=>{Ho.value?.focus()}))}function rc(){const e=Object.keys(a),n=(e.indexOf(Yo.value)+1)%e.length;Yo.value=e[n],Ns(`: ${a[Yo.value].name}`)}function oc(e){const n=e.detail;n&&n in a&&function(e){Yo.value=e,Go.value=!1,Ns(`: ${a[e].label}`)}(n)}function ic(e){e&&(zo.value=e,ec())}function lc(){const e=vl.value.find(e=>!e.bound);e&&Kd(e)}function sc(e){if(!Mo.value&&!$o.value&&!Go.value)return;const n=e.target;if(!n)return ec(),nc(),void(Go.value=!1);if(Mo.value){const e=Do.value;e&&e.contains(n)||ec()}if($o.value){const e=Oo.value;e&&e.contains(n)||nc()}Go.value&&(Go.value=!1)}function dc(e){(Mo.value||$o.value)&&'Escape'===e.key&&(ec(),nc())}async function cc(e){if(e){Si.value=!0;try{const t=bs(await getWorldbook(e));li.value=n(t),ii.value=n(t),Xs(),Ns(` "${e}" ${t.length}`)}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`),Ns(`: ${n}`)}finally{Si.value=!1}}}async function uc(e){const n=[...getWorldbookNames()].sort((e,n)=>e.localeCompare(n,'zh-Hans-CN'));if(Io.value=n,!n.length)return zo.value='',li.value=[],ii.value=[],void(si.value=null);const t=el.value.last_worldbook,a=e&&n.includes(e)&&e||t&&n.includes(t)&&t||zo.value||n[0];a&&zo.value!==a?zo.value=a:zo.value&&!li.value.length&&await cc(zo.value)}async function pc(){el.value=ms(),gs(),await uc(zo.value||void 0),await _d(),Ld(),Od(),await Yd(),Uo.value?Vd():Rd({preferWhenEmptyOnly:!0}),Ns('')}async function bc(){if(zo.value)if(ll.value){Ni.value=!0;try{li.value=bs(li.value.map(e=>n(e)));const e=ad(function(){const e=[],n=new Map;li.value.forEach(e=>{n.set(e.uid,e)});for(const t of ii.value){const a=n.get(t.uid);a?JSON.stringify(t)!==JSON.stringify(a)&&e.push({label:'',uid:t.uid,name:t.name,entry:t}):e.push({label:'',uid:t.uid,name:t.name,entry:t})}return e}());await replaceWorldbook(zo.value,n(li.value),{render:'immediate'}),ii.value=n(li.value),od(''),await _d(),toastr.success(`: ${zo.value}`),Ns(`: ${zo.value} +${e}`)}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`),Ns(`: ${n}`)}finally{Ni.value=!1}}else Ns('');else toastr.warning('')}async function fc(){const e=ql(prompt('')).trim();if(e)try{await createOrReplaceWorldbook(e,[],{render:'immediate'}),await uc(e),await _d(),toastr.success(`: ${e}`)}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`)}}async function mc(){if(!zo.value)return;const e=`${zo.value}_copy`,t=ql(prompt('',e)).trim();if(t)try{await createOrReplaceWorldbook(t,n(li.value),{render:'immediate'}),await uc(t),await _d(),toastr.success(`: ${t}`)}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`)}}async function gc(){if(!zo.value)return;const e=zo.value;if(confirm(` "${e}" ?`))try{if(!await deleteWorldbook(e))throw new Error(' false');vs(n=>{delete n.history[e],delete n.entry_history[e]}),toastr.success(`: ${e}`),await uc(),await _d()}catch(e){const n=e instanceof Error?e.message:String(e);toastr.error(`: ${n}`)}}async function vc(){if(!zo.value)return;const e=new Set(getGlobalWorldbookNames());e.has(zo.value)?e.delete(zo.value):e.add(zo.value),await Td([...e],'')}function Ac(){Xi.value=[]}function Cc(){return Li.value?.ownerDocument?.defaultView??$i.value?.ownerDocument?.defaultView??window}function yc(e){const n=Cc(),t=n.innerWidth,a=n.innerHeight,r=Math.max(8,t-e.width-8),o=Math.max(8,a-68);e.x=Zl(e.x,8,r),e.y=Zl(e.y,8,o)}function hc(){Di.value=Cc().innerWidth,function(){if(sl.value)return;const e=Li.value?.getBoundingClientRect();if(e){const n=Math.max(_o,Math.floor(e.width-Vo-No));Hi.value=Zl(Hi.value,_o,n)}const n=$i.value?.getBoundingClientRect();if(n){const e=Math.max(Ro,Math.floor(n.width-Fo-No));Yi.value=Zl(Yi.value,Ro,e)}}();for(const e of Wi)zi[e].visible&&yc(zi[e])}function wc(e){Ii.value+=1,zi[e].z=Ii.value}function xc(e){zi[e].visible=!1,Mi.value?.key===e&&Nc()}function kc(e){zi[e].visible?xc(e):function(e){const n=zi[e];n.visible=!0,yc(n),wc(e)}(e)}function Ec(e){const n=zi[e];return{left:`${n.x}px`,top:`${n.y}px`,zIndex:String(n.z),width:`${n.width}px`}}function Bc(e,n){if('mouse'===n.pointerType&&0!==n.button)return;const t=zi[e],a=n.currentTarget;if(!a)return;const r=a.ownerDocument??document,o=r.defaultView??window,i=a.getBoundingClientRect();wc(e);const l={key:e,pointerId:n.pointerId,offsetX:n.clientX-t.x,offsetY:n.clientY-t.y,doc:r,win:o};Mi.value=l,a.setPointerCapture?.(n.pointerId),r.addEventListener('pointermove',Sc),r.addEventListener('pointerup',Nc),r.addEventListener('pointercancel',Nc),o.addEventListener('blur',Nc),t.x=Zl(n.clientX-l.offsetX,8,Math.max(8,o.innerWidth-t.width-8)),t.y=Zl(n.clientY-l.offsetY,8,Math.max(8,o.innerHeight-i.height-8)),n.preventDefault()}function Sc(e){const n=Mi.value;if(!n)return;if(e.pointerId!==n.pointerId)return;const t=zi[n.key];t.x=Zl(e.clientX-n.offsetX,8,Math.max(8,n.win.innerWidth-t.width-8)),t.y=Zl(e.clientY-n.offsetY,8,Math.max(8,n.win.innerHeight-68))}function Nc(){const e=Mi.value;e&&(e.doc.removeEventListener('pointermove',Sc),e.doc.removeEventListener('pointerup',Nc),e.doc.removeEventListener('pointercancel',Nc),e.win.removeEventListener('blur',Nc)),Mi.value=null}function _c(e){e.preventDefault();const n=Oi.value;if(!n)return;const t=e.clientY,a=n.offsetHeight,r=e.currentTarget;r.setPointerCapture(e.pointerId),n.style.pointerEvents='none',n.style.willChange='height';let o=0,i=a;const l=()=>{n.style.height=`${i}px`,n.style.minHeight=`${i}px`,o=0},s=e=>{i=Math.max(120,a+(e.clientY-t)),o||(o=requestAnimationFrame(l))},d=()=>{o&&cancelAnimationFrame(o),l(),n.style.pointerEvents='',n.style.willChange='',r.removeEventListener('pointermove',s),r.removeEventListener('pointerup',d)};r.addEventListener('pointermove',s),r.addEventListener('pointerup',d)}function Vc(e,n){if(sl.value)return;if('mouse'===n.pointerType&&0!==n.button)return;const t=n.currentTarget,a=t?.ownerDocument??document,r=a.defaultView??window;Gi.value={key:e,pointerId:n.pointerId,doc:a,win:r},t?.setPointerCapture?.(n.pointerId),a.addEventListener('pointermove',Rc),a.addEventListener('pointerup',Fc),a.addEventListener('pointercancel',Fc),r.addEventListener('blur',Fc),n.preventDefault()}function Rc(e){const n=Gi.value;if(!n||e.pointerId!==n.pointerId)return;if('main'===n.key){const n=Li.value?.getBoundingClientRect();if(!n)return;const t=Math.floor(e.clientX-n.left),a=Math.max(_o,Math.floor(n.width-Vo-No));return void(Hi.value=Zl(t,_o,a))}const t=$i.value?.getBoundingClientRect();if(!t)return;const a=Math.floor(t.right-e.clientX),r=Math.max(Ro,Math.floor(t.width-Fo-No));Yi.value=Zl(a,Ro,r)}function Fc(){const e=Gi.value;e&&(e.doc.removeEventListener('pointermove',Rc),e.doc.removeEventListener('pointerup',Fc),e.doc.removeEventListener('pointercancel',Fc),e.win.removeEventListener('blur',Fc)),Gi.value=null}function Tc(){pc()}function Pc(){bc()}function Ic(){!function(){if(!ll.value)return void(window[So]=!1);li.value=n(ii.value),Xs(),Gs(),Ns('')}()}const zc=(0,o.ref)(null);let Mc=null,Wc=null;function Dc(){const e=document.getElementById('wb-assistant-panel');if(!e)return;const n=a[Yo.value].colors;e.style.setProperty('--wb-host-bg',n['--wb-bg-root']),e.style.setProperty('--wb-host-header-bg',n['--wb-bg-panel']),e.style.setProperty('--wb-host-border',n['--wb-border-main']),e.style.setProperty('--wb-host-text',n['--wb-text-main']),e.style.setProperty('--wb-host-tool-bg',n['--wb-input-bg']),e.style.setProperty('--wb-host-tool-border',n['--wb-border-subtle'])}return(0,o.onMounted)(()=>{if(qi.value&&zc.value){const e=(()=>{try{return window.parent||window}catch{return window}})(),n=zc.value,t=()=>{if(!n)return;const t=n.getBoundingClientRect(),a=(e.innerHeight||window.innerHeight||0)-t.top;a>0&&(n.style.height=a+'px',n.style.maxHeight=a+'px',n.style.overflow='hidden')};t(),requestAnimationFrame(t),setTimeout(t,100),setTimeout(t,500),Wc=t,e.addEventListener('resize',t);const a=n.parentElement;a&&(Mc=new ResizeObserver(t),Mc.observe(a))}el.value=ms(),gs(),nl.push(eventOn(tavern_events.WORLD_INFO_ACTIVATED,e=>{!function(e){const n=e.map(e=>{const n=e.uid??e.displayIndex??'?',t=ql(e.name??e.comment,`UID ${n}`),a=ql(e.content).replace(/\s+/g,' ').trim().slice(0,80);return{id:jl('activation'),time:Date.now(),world:ql(e.world,'unknown'),uid:'number'==typeof n||'string'==typeof n?n:'?',name:t,contentPreview:a||'()'}});Xi.value.unshift(...n),Xi.value.length>120&&(Xi.value.length=120)}(e)})),nl.push(eventOn(tavern_events.WORLDINFO_UPDATED,()=>{pc()})),nl.push(eventOn(tavern_events.CHAT_CHANGED,()=>{(async()=>{await _d(),Ld(),Od(),await Yd(),Uo.value?Vd():Rd()})()})),window.addEventListener('wb-helper:refresh',Tc),window.addEventListener('wb-helper:save',Pc),window.addEventListener('wb-helper:discard',Ic),window.addEventListener('wb-helper:toggle-theme',rc),window.addEventListener('wb-helper:set-theme',oc),Ui.value=Cc();const e=Ui.value.document;e.addEventListener('pointerdown',sc,!0),e.addEventListener('keydown',dc,!0),Ui.value.addEventListener('resize',hc),hc(),Dc(),pc()}),(0,o.onUnmounted)(()=>{if(Mc?.disconnect(),Mc=null,Wc){try{(window.parent||window).removeEventListener('resize',Wc)}catch{}Wc=null}window[So]=!1,nl.forEach(e=>{e.stop()}),Nc(),Fc(),window.removeEventListener('wb-helper:refresh',Tc),window.removeEventListener('wb-helper:save',Pc),window.removeEventListener('wb-helper:discard',Ic),window.removeEventListener('wb-helper:toggle-theme',rc),window.removeEventListener('wb-helper:set-theme',oc),Ui.value?.document.removeEventListener('pointerdown',sc,!0),Ui.value?.document.removeEventListener('keydown',dc,!0),Ui.value?.removeEventListener('resize',hc),Ui.value=null}),(0,o.watch)(Yo,()=>{Dc()}),(e,n)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{ref_key:'rootRef',ref:zc,class:'wb-assistant-root',style:(0,o.normalizeStyle)((0,o.unref)(ul))},[(0,o.createCommentVNode)('  Mobile Tab View  '),(0,o.unref)(qi)?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:0},[(0,o.createElementVNode)('div',i,[(0,o.createElementVNode)('div',l,[(0,o.createCommentVNode)(' Tab:  '),(0,o.withDirectives)((0,o.createElementVNode)('div',s,[(0,o.createElementVNode)('section',d,[(0,o.createElementVNode)('label',c,[n[101]||(n[101]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.createElementVNode)('div',{ref_key:'worldbookPickerRef',ref:Do,class:'worldbook-picker'},[(0,o.createElementVNode)('button',{class:'worldbook-picker-trigger',type:'button',onClick:tc},[(0,o.createElementVNode)('span',{class:'worldbook-picker-trigger-text',title:(0,o.unref)(zo)||''},(0,o.toDisplayString)((0,o.unref)(zo)||''),9,u),n[100]||(n[100]=(0,o.createElementVNode)('span',{class:'worldbook-picker-arrow'},'',-1))]),(0,o.unref)(Mo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',p,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>(0,o.isRef)(Wo)?Wo.value=e:null),type:'text',class:'text-input worldbook-picker-search',placeholder:'...',onKeydown:n[1]||(n[1]=(0,o.withKeys)((0,o.withModifiers)(e=>(0,o.unref)(Al)[0]&&ic((0,o.unref)(Al)[0]),['prevent']),['enter']))},null,544),[[o.vModelText,(0,o.unref)(Wo)]]),(0,o.createElementVNode)('div',b,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Al),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`wb-pick-m-${e}`,class:(0,o.normalizeClass)(['worldbook-picker-item',{active:e===(0,o.unref)(zo)}]),type:'button',onClick:n=>ic(e)},(0,o.toDisplayString)(e),11,f))),128)),(0,o.unref)(Al).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',m,''))])])):(0,o.createCommentVNode)('v-if',!0)],512)]),(0,o.createElementVNode)('div',g,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(ll),onClick:bc,style:{padding:'8px 14px','font-size':'13px'}},' ',8,v),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:vd,style:{padding:'8px 14px','font-size':'13px'}},'+ '),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:Sd,style:{padding:'8px 14px','font-size':'13px'}},' '),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(zo),onClick:Ed,style:{padding:'8px 14px','font-size':'13px'}},' ',8,A),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:Fd,style:(0,o.normalizeStyle)({padding:'8px 14px',fontSize:'13px',background:(0,o.unref)(Uo)?'#2563eb':'',color:(0,o.unref)(Uo)?'#fff':''})},' ',4)])]),(0,o.unref)(Ji).global.length||(0,o.unref)(Ji).charPrimary||(0,o.unref)(Ji).charAdditional.length||(0,o.unref)(Ji).chat?((0,o.openBlock)(),(0,o.createElementBlock)('div',C,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Ji).global,e=>((0,o.openBlock)(),(0,o.createElementBlock)('span',{key:`bg-m-${e}`,class:'binding-chip global',title:e},(0,o.toDisplayString)(e),9,y))),128)),(0,o.unref)(Ji).charPrimary?((0,o.openBlock)(),(0,o.createElementBlock)('span',{key:`bc-m-${(0,o.unref)(Ji).charPrimary}`,class:'binding-chip char',title:(0,o.unref)(Ji).charPrimary},(0,o.toDisplayString)((0,o.unref)(Ji).charPrimary),9,h)):(0,o.createCommentVNode)('v-if',!0),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Ji).charAdditional,e=>((0,o.openBlock)(),(0,o.createElementBlock)('span',{key:`bca-m-${e}`,class:'binding-chip char',title:e},(0,o.toDisplayString)(e),9,w))),128)),(0,o.unref)(Ji).chat?((0,o.openBlock)(),(0,o.createElementBlock)('span',{key:`bch-m-${(0,o.unref)(Ji).chat}`,class:'binding-chip chat',title:(0,o.unref)(Ji).chat},(0,o.toDisplayString)((0,o.unref)(Ji).chat),9,x)):(0,o.createCommentVNode)('v-if',!0)])):(0,o.createCommentVNode)('v-if',!0),(0,o.createCommentVNode)(' Global Mode Panel (mobile) '),(0,o.unref)(Uo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',k,[(0,o.createElementVNode)('div',E,[(0,o.createElementVNode)('span',B,' '+(0,o.toDisplayString)((0,o.unref)(Ji).global.length)+'',1),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(Ji).global.length,onClick:Md,style:{'font-size':'11px'}},'',8,S)]),(0,o.createElementVNode)('label',N,[n[103]||(n[103]=(0,o.createElementVNode)('span',{style:{'font-size':'12px'}},'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[2]||(n[2]=e=>(0,o.isRef)(ai)?ai.value=e:null),class:'text-input',onChange:Gd,style:{'font-size':'12px'}},[n[102]||(n[102]=(0,o.createElementVNode)('option',{value:''},'',-1)),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(bl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('option',{key:e.id,value:e.id},(0,o.toDisplayString)(e.name)+''+(0,o.toDisplayString)(e.worldbooks.length)+' ',9,V))),128))],544),[[o.vModelSelect,(0,o.unref)(ai)]])]),(0,o.createElementVNode)('div',R,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(Ji).global.length,onClick:Zd,style:{'font-size':'11px'}},'',8,F),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(fl),onClick:Jd,style:{'font-size':'11px'}},'',8,T),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(fl),onClick:Xd,style:{'font-size':'11px'}},'',8,P)]),(0,o.createElementVNode)('label',I,[n[104]||(n[104]=(0,o.createElementVNode)('span',{style:{'font-size':'12px'}},'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[3]||(n[3]=e=>(0,o.isRef)(bi)?bi.value=e:null),type:'text',class:'text-input',placeholder:'...',onKeydown:(0,o.withKeys)((0,o.withModifiers)(Pd,['prevent']),['enter']),style:{'font-size':'12px'}},null,40,M),[[o.vModelText,(0,o.unref)(bi)]])]),(0,o.unref)(Cl).length?((0,o.openBlock)(),(0,o.createElementBlock)('div',W,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Cl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`m-add-${e}`,type:'button',style:{display:'flex','justify-content':'space-between','align-items':'center',width:'100%',padding:'6px 8px',border:'none',background:'var(--wb-input-bg)','border-radius':'4px',color:'var(--wb-text-main)','font-size':'12px','margin-bottom':'2px',cursor:'pointer'},onClick:n=>Id(e)},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e),1),n[105]||(n[105]=(0,o.createElementVNode)('span',{style:{color:'#22c55e'}},'+ ',-1))],8,D))),128))])):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(yl).length?((0,o.openBlock)(),(0,o.createElementBlock)('div',L,'')):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('div',O,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(yl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`m-gl-${e}`,type:'button',style:{display:'flex','justify-content':'space-between','align-items':'center',width:'100%',padding:'6px 8px',border:'none',background:'var(--wb-input-bg)','border-radius':'4px',color:'var(--wb-text-main)','font-size':'12px',cursor:'pointer'},onClick:n=>zd(e)},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e),1),n[106]||(n[106]=(0,o.createElementVNode)('span',{style:{color:'#ef4444'}},'',-1))],8,H))),128))]),(0,o.createCommentVNode)(' Role Binding Section '),(0,o.createElementVNode)('div',Y,[n[108]||(n[108]=(0,o.createElementVNode)('div',{style:{'font-size':'12px','font-weight':'600','margin-bottom':'6px'}},'',-1)),(0,o.createElementVNode)('div',{style:(0,o.normalizeStyle)([{'font-size':'11px','margin-bottom':'6px',opacity:'0.8'},{color:(0,o.unref)(ri)?'#60a5fa':'#94a3b8'}])},(0,o.toDisplayString)((0,o.unref)(ri)?`: ${(0,o.unref)(ri).name}`:''),5),(0,o.createElementVNode)('div',G,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(fl)||!(0,o.unref)(ri),onClick:jd,style:{'font-size':'11px'}},'',8,U),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(fl)||!(0,o.unref)(gl),onClick:Qd,style:{'font-size':'11px'}},'',8,j)]),(0,o.createElementVNode)('div',K,[(0,o.createElementVNode)('button',{type:'button',disabled:!(0,o.unref)(fl),onClick:ac,style:{display:'flex','justify-content':'space-between','align-items':'center',width:'100%',padding:'6px 8px',border:'1px solid var(--wb-border-subtle)','border-radius':'4px',background:'var(--wb-input-bg)',color:'var(--wb-text-main)','font-size':'12px',cursor:'pointer'}},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)(fl)?'':''),1),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)($o)?'':''),1)],8,q),(0,o.unref)($o)?((0,o.openBlock)(),(0,o.createElementBlock)('div',Q,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>(0,o.isRef)(mi)?mi.value=e:null),type:'text',class:'text-input',placeholder:'...',style:{'font-size':'12px','margin-bottom':'4px'},onKeydown:(0,o.withKeys)((0,o.withModifiers)(lc,['prevent']),['enter'])},null,40,Z),[[o.vModelText,(0,o.unref)(mi)]]),(0,o.createElementVNode)('div',J,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(vl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`m-role-${e.key}`,type:'button',disabled:e.bound,style:(0,o.normalizeStyle)([{display:'flex','justify-content':'space-between','align-items':'center',width:'100%',padding:'6px 8px',border:'none',background:'var(--wb-input-bg)','border-radius':'4px',color:'var(--wb-text-main)','font-size':'12px','margin-bottom':'2px',cursor:'pointer',opacity:'1'},{opacity:e.bound?'0.5':'1'}]),onClick:n=>Kd(e)},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e.name),1),(0,o.createElementVNode)('span',{style:(0,o.normalizeStyle)({color:e.bound?'#94a3b8':'#22c55e'})},(0,o.toDisplayString)(e.bound?'':''),5)],12,X))),128)),(0,o.unref)(vl).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',ee,''))])])):(0,o.createCommentVNode)('v-if',!0)]),(0,o.unref)(fl)?((0,o.openBlock)(),(0,o.createElementBlock)('div',ne,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(ml),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`m-rb-${(0,o.unref)(fl)?.id}-${e.key}`,type:'button',style:{display:'inline-flex','align-items':'center',gap:'4px',padding:'4px 8px',border:'1px solid var(--wb-border-subtle)','border-radius':'4px',background:'var(--wb-input-bg)',color:'var(--wb-text-main)','font-size':'11px',cursor:'pointer'},onClick:n=>qd(e.key)},[(0,o.createTextVNode)((0,o.toDisplayString)(e.name)+' ',1),n[107]||(n[107]=(0,o.createElementVNode)('span',{style:{color:'#ef4444'}},'',-1))],8,te))),128)),(0,o.unref)(ml).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',ae,''))])):((0,o.openBlock)(),(0,o.createElementBlock)('div',re,''))])])):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('div',oe,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(rl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`me-${e.uid}`,type:'button',class:(0,o.normalizeClass)(['entry-item',{selected:e.uid===(0,o.unref)(si),disabled:!e.enabled}]),'data-status':ls(e),onClick:n=>ed(e.uid),style:{border:'1px solid var(--wb-border-subtle)','border-radius':'8px',padding:'8px 10px','margin-bottom':'4px'}},[(0,o.createElementVNode)('div',le,[(0,o.createElementVNode)('span',{class:'entry-status-dot','data-status':ls(e)},null,8,se),(0,o.createElementVNode)('div',de,(0,o.toDisplayString)(e.name||` ${e.uid}`),1),(0,o.createElementVNode)('span',ce,'#'+(0,o.toDisplayString)(e.uid),1)]),e.strategy.keys?.length?((0,o.openBlock)(),(0,o.createElementBlock)('div',ue,(0,o.toDisplayString)(e.strategy.keys.join(', ')),1)):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('div',pe,[(0,o.createElementVNode)('span',be,' '+(0,o.toDisplayString)(is(e.position.type)),1),(0,o.createElementVNode)('span',fe,' #'+(0,o.toDisplayString)(e.position.order),1),e.recursion.prevent_incoming?((0,o.openBlock)(),(0,o.createElementBlock)('span',me,'')):(0,o.createCommentVNode)('v-if',!0),e.recursion.prevent_outgoing?((0,o.openBlock)(),(0,o.createElementBlock)('span',ge,'')):(0,o.createCommentVNode)('v-if',!0)])],10,ie))),128)),(0,o.unref)(rl).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',ve,''))])],512),[[o.vShow,'list'===(0,o.unref)(Zi)]]),(0,o.createCommentVNode)(' Tab:  '),(0,o.withDirectives)((0,o.createElementVNode)('div',Ae,[(0,o.unref)(tl)?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:0},[(0,o.createElementVNode)('header',Ce,[(0,o.createElementVNode)('label',ye,[n[109]||(n[109]=(0,o.createElementVNode)('span',null,' (COMMENT)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>(0,o.unref)(tl).name=e),type:'text',class:'text-input'},null,512),[[o.vModelText,(0,o.unref)(tl).name]])]),(0,o.createElementVNode)('div',he,[(0,o.createElementVNode)('span',{class:(0,o.normalizeClass)(['editor-badge',(0,o.unref)(tl).enabled?'on':'off'])},(0,o.toDisplayString)((0,o.unref)(tl).enabled?'EN':'OFF'),3),(0,o.createElementVNode)('span',we,'#'+(0,o.toDisplayString)((0,o.unref)(tl).uid),1),(0,o.createElementVNode)('span',xe,'~'+(0,o.toDisplayString)((0,o.unref)(Ul))+'T',1)])]),(0,o.createElementVNode)('section',ke,[(0,o.createElementVNode)('label',Ee,[n[110]||(n[110]=(0,o.createElementVNode)('span',null,' (KEYS)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[6]||(n[6]=e=>(0,o.isRef)(Wl)?Wl.value=e:null),class:'text-area compact'},null,512),[[o.vModelText,(0,o.unref)(Wl)]])]),(0,o.createElementVNode)('label',Be,[n[111]||(n[111]=(0,o.createElementVNode)('span',null,' (SECONDARY)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[7]||(n[7]=e=>(0,o.isRef)(Dl)?Dl.value=e:null),class:'text-area compact'},null,512),[[o.vModelText,(0,o.unref)(Dl)]])])]),(0,o.createElementVNode)('section',Se,[n[113]||(n[113]=(0,o.createElementVNode)('div',{class:'editor-content-title'},' /  (CONTENT)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{ref_key:'contentTextareaRef',ref:Oi,'onUpdate:modelValue':n[8]||(n[8]=e=>(0,o.unref)(tl).content=e),class:'text-area large editor-content-area',style:{'min-height':'calc(100vh - 500px)'}},null,512),[[o.vModelText,(0,o.unref)(tl).content]]),(0,o.createElementVNode)('div',{class:'content-resize-handle',onPointerdown:_c},[...n[112]||(n[112]=[(0,o.createElementVNode)('span',{class:'content-resize-grip'},'',-1)])],32)])],64)):((0,o.openBlock)(),(0,o.createElementBlock)('div',Ne,''))],512),[[o.vShow,'edit'===(0,o.unref)(Zi)]]),(0,o.createCommentVNode)(' Tab:  '),(0,o.withDirectives)((0,o.createElementVNode)('div',_e,[(0,o.unref)(tl)?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:0},[(0,o.createElementVNode)('article',Ve,[n[119]||(n[119]=(0,o.createElementVNode)('h4',null,' (STRATEGY)',-1)),(0,o.createElementVNode)('label',Re,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[9]||(n[9]=e=>(0,o.unref)(tl).enabled=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).enabled]]),n[114]||(n[114]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('div',Fe,[(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill constant',{active:'constant'===(0,o.unref)(tl).strategy.type}]),onClick:n[10]||(n[10]=e=>(0,o.unref)(tl).strategy.type='constant')},' ',2),(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill vector',{active:'vectorized'===(0,o.unref)(tl).strategy.type}]),onClick:n[11]||(n[11]=e=>(0,o.unref)(tl).strategy.type='vectorized')},' ',2),(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill selective',{active:'selective'===(0,o.unref)(tl).strategy.type}]),onClick:n[12]||(n[12]=e=>(0,o.unref)(tl).strategy.type='selective')},' ',2)]),(0,o.createElementVNode)('details',Te,[n[118]||(n[118]=(0,o.createElementVNode)('summary',null,'',-1)),(0,o.createElementVNode)('label',Pe,[n[115]||(n[115]=(0,o.createElementVNode)('span',null,' (LOGIC)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[13]||(n[13]=e=>(0,o.unref)(tl).strategy.keys_secondary.logic=e),class:'text-input'},[((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(To,e=>(0,o.createElementVNode)('option',{key:`ml-${e}`,value:e},(0,o.toDisplayString)(os(e)),9,Ie)),64))],512),[[o.vModelSelect,(0,o.unref)(tl).strategy.keys_secondary.logic]])]),(0,o.createElementVNode)('label',ze,[n[116]||(n[116]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[14]||(n[14]=e=>(0,o.isRef)(Ll)?Ll.value=e:null),type:'text',class:'text-input',placeholder:' same_as_global'},null,512),[[o.vModelText,(0,o.unref)(Ll)]])]),(0,o.createElementVNode)('label',Me,[n[117]||(n[117]=(0,o.createElementVNode)('span',null,'(0-100)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[15]||(n[15]=e=>(0,o.unref)(tl).probability=e),type:'number',class:'text-input',min:'0',max:'100',step:'1'},null,512),[[o.vModelText,(0,o.unref)(tl).probability,void 0,{number:!0}]])])])]),(0,o.createElementVNode)('article',We,[n[125]||(n[125]=(0,o.createElementVNode)('h4',null,' (INSERTION)',-1)),(0,o.createElementVNode)('label',De,[n[120]||(n[120]=(0,o.createElementVNode)('span',null,' (Position)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[16]||(n[16]=e=>(0,o.unref)(tl).position.type=e),class:'text-input',onChange:fd},[((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(Po,e=>(0,o.createElementVNode)('option',{key:`mp-${e}`,value:e},(0,o.toDisplayString)(is(e)),9,Le)),64))],544),[[o.vModelSelect,(0,o.unref)(tl).position.type]])]),(0,o.createElementVNode)('label',$e,[n[121]||(n[121]=(0,o.createElementVNode)('span',null,' (Order)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[17]||(n[17]=e=>(0,o.unref)(tl).position.order=e),type:'number',class:'text-input',step:'1'},null,512),[[o.vModelText,(0,o.unref)(tl).position.order,void 0,{number:!0}]])]),(0,o.createElementVNode)('div',Oe,[(0,o.createElementVNode)('label',{class:(0,o.normalizeClass)(['field',{disabled:'at_depth'!==(0,o.unref)(tl).position.type}])},[n[123]||(n[123]=(0,o.createElementVNode)('span',null,'at_depth role',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[18]||(n[18]=e=>(0,o.unref)(tl).position.role=e),class:'text-input',disabled:'at_depth'!==(0,o.unref)(tl).position.type},[...n[122]||(n[122]=[(0,o.createElementVNode)('option',{value:'system'},'system',-1),(0,o.createElementVNode)('option',{value:'assistant'},'assistant',-1),(0,o.createElementVNode)('option',{value:'user'},'user',-1)])],8,He),[[o.vModelSelect,(0,o.unref)(tl).position.role]])],2),(0,o.createElementVNode)('label',{class:(0,o.normalizeClass)(['field',{disabled:'at_depth'!==(0,o.unref)(tl).position.type}])},[n[124]||(n[124]=(0,o.createElementVNode)('span',null,'at_depth depth',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[19]||(n[19]=e=>(0,o.unref)(tl).position.depth=e),type:'number',class:'text-input',min:'1',step:'1',disabled:'at_depth'!==(0,o.unref)(tl).position.type},null,8,Ye),[[o.vModelText,(0,o.unref)(tl).position.depth,void 0,{number:!0}]])],2)])]),(0,o.createElementVNode)('article',Ge,[n[128]||(n[128]=(0,o.createElementVNode)('h4',null,' (RECURSION)',-1)),(0,o.createElementVNode)('label',Ue,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[20]||(n[20]=e=>(0,o.unref)(tl).recursion.prevent_incoming=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).recursion.prevent_incoming]]),n[126]||(n[126]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('label',je,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[21]||(n[21]=e=>(0,o.unref)(tl).recursion.prevent_outgoing=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).recursion.prevent_outgoing]]),n[127]||(n[127]=(0,o.createElementVNode)('span',null,'',-1))])]),(0,o.createElementVNode)('details',Ke,[n[130]||(n[130]=(0,o.createElementVNode)('summary',null,' / extra JSON',-1)),(0,o.createElementVNode)('label',qe,[n[129]||(n[129]=(0,o.createElementVNode)('span',null,'extra JSON',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[22]||(n[22]=e=>(0,o.isRef)(pi)?pi.value=e:null),class:'text-area compact',placeholder:'{ ... }'},null,512),[[o.vModelText,(0,o.unref)(pi)]])]),(0,o.createElementVNode)('div',{class:'field-actions'},[(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:md},' extra'),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:gd},' extra')])]),(0,o.createElementVNode)('div',{class:'mobile-danger-zone'},[(0,o.createElementVNode)('button',{class:'btn danger',type:'button',onClick:Cd},' '),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:Ad},' ')])],64)):((0,o.openBlock)(),(0,o.createElementBlock)('div',Qe,''))],512),[[o.vShow,'settings'===(0,o.unref)(Zi)]]),(0,o.createCommentVNode)(' Tab: AI '),(0,o.withDirectives)((0,o.createElementVNode)('div',Ze,[(0,o.createElementVNode)('section',Je,[(0,o.createElementVNode)('div',Xe,[(0,o.unref)(Cs)?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:1},[(0,o.createElementVNode)('div',{class:'ai-chat-messages',ref_key:'aiChatMessagesRef',ref:ti},[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(ys),(e,n)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:`mmsg-${n}`,class:(0,o.normalizeClass)(['ai-chat-bubble',e.role])},[(0,o.createElementVNode)('div',nn,(0,o.toDisplayString)('user'===e.role?' ':' AI'),1),(0,o.createElementVNode)('div',tn,(0,o.toDisplayString)(e.content),1)],2))),128)),(0,o.unref)(Ko)&&(0,o.unref)(Qo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',an,[n[134]||(n[134]=(0,o.createElementVNode)('div',{class:'ai-chat-bubble-role'},' AI',-1)),(0,o.createElementVNode)('div',rn,[(0,o.createTextVNode)((0,o.toDisplayString)((0,o.unref)(Qo)),1),n[133]||(n[133]=(0,o.createElementVNode)('span',{class:'ai-cursor'},'',-1))])])):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(Ko)&&!(0,o.unref)(Qo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',on,[...n[135]||(n[135]=[(0,o.createElementVNode)('div',{class:'ai-chat-bubble-role'},' AI',-1),(0,o.createElementVNode)('div',{class:'ai-chat-bubble-content'},[(0,o.createElementVNode)('span',{class:'ai-thinking'},'...')],-1)])])):(0,o.createCommentVNode)('v-if',!0)],512),(0,o.createElementVNode)('div',ln,[(0,o.createElementVNode)('label',sn,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[23]||(n[23]=e=>(0,o.isRef)(ni)?ni.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(ni)]]),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)(ni)?' ':' '),1)]),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[24]||(n[24]=e=>(0,o.isRef)(ei)?ei.value=e:null),class:'text-input ai-chat-input',placeholder:'...',rows:'2',disabled:(0,o.unref)(Ko),onKeydown:(0,o.withKeys)((0,o.withModifiers)(ks,['exact','prevent']),['enter'])},null,40,dn),[[o.vModelText,(0,o.unref)(ei)]]),(0,o.unref)(Ko)?((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:1,class:'btn danger ai-stop-btn',type:'button',onClick:Es},'')):((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:0,class:'btn ai-send-btn',type:'button',disabled:!(0,o.unref)(ei).trim(),onClick:ks},'',8,cn))])],64)):((0,o.openBlock)(),(0,o.createElementBlock)('div',en,[n[131]||(n[131]=(0,o.createElementVNode)('div',{class:'ai-chat-empty-icon'},'',-1)),n[132]||(n[132]=(0,o.createElementVNode)('div',{class:'ai-chat-empty-text'},'',-1)),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:hs},'+ ')]))])])],512),[[o.vShow,'ai'===(0,o.unref)(Zi)]])])]),(0,o.createCommentVNode)(' Tab Bar: bottom, direct child of wb-assistant-root via fragment '),(0,o.createElementVNode)('div',un,[(0,o.createElementVNode)('button',{onClick:n[25]||(n[25]=e=>Zi.value='list'),style:(0,o.normalizeStyle)({flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',border:'none',borderTop:'list'===(0,o.unref)(Zi)?'2px solid #60a5fa':'2px solid transparent',background:'transparent',color:'list'===(0,o.unref)(Zi)?'#e2e8f0':'#94a3b8',fontSize:'10px',padding:'4px 0',gap:'2px'})},[...n[136]||(n[136]=[(0,o.createElementVNode)('span',{style:{'font-size':'20px'}},'',-1),(0,o.createElementVNode)('span',null,'',-1)])],4),(0,o.createElementVNode)('button',{onClick:n[26]||(n[26]=e=>Zi.value='edit'),style:(0,o.normalizeStyle)({flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',border:'none',borderTop:'edit'===(0,o.unref)(Zi)?'2px solid #60a5fa':'2px solid transparent',background:'transparent',color:'edit'===(0,o.unref)(Zi)?'#e2e8f0':'#94a3b8',fontSize:'10px',padding:'4px 0',gap:'2px'})},[...n[137]||(n[137]=[(0,o.createElementVNode)('span',{style:{'font-size':'20px'}},'',-1),(0,o.createElementVNode)('span',null,'',-1)])],4),(0,o.createElementVNode)('button',{onClick:n[27]||(n[27]=e=>Zi.value='settings'),style:(0,o.normalizeStyle)({flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',border:'none',borderTop:'settings'===(0,o.unref)(Zi)?'2px solid #60a5fa':'2px solid transparent',background:'transparent',color:'settings'===(0,o.unref)(Zi)?'#e2e8f0':'#94a3b8',fontSize:'10px',padding:'4px 0',gap:'2px'})},[...n[138]||(n[138]=[(0,o.createElementVNode)('span',{style:{'font-size':'20px'}},'',-1),(0,o.createElementVNode)('span',null,'',-1)])],4),(0,o.createElementVNode)('button',{onClick:n[28]||(n[28]=e=>Zi.value='ai'),style:(0,o.normalizeStyle)({flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',border:'none',borderTop:'ai'===(0,o.unref)(Zi)?'2px solid #60a5fa':'2px solid transparent',background:'transparent',color:'ai'===(0,o.unref)(Zi)?'#e2e8f0':'#94a3b8',fontSize:'10px',padding:'4px 0',gap:'2px'})},[...n[139]||(n[139]=[(0,o.createElementVNode)('span',{style:{'font-size':'20px'}},'',-1),(0,o.createElementVNode)('span',null,'AI',-1)])],4)])],64)):(0,o.createCommentVNode)('v-if',!0),(0,o.createCommentVNode)('  Desktop Layout  '),(0,o.unref)(qi)?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:1},[(0,o.createElementVNode)('section',pn,[(0,o.createElementVNode)('label',bn,[n[140]||(n[140]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.createElementVNode)('div',{ref_key:'worldbookPickerRef',ref:Do,class:'worldbook-picker'},[(0,o.createElementVNode)('button',{class:'worldbook-picker-trigger',type:'button',onClick:tc},[(0,o.createElementVNode)('span',{class:'worldbook-picker-trigger-text',title:(0,o.unref)(zo)||''},(0,o.toDisplayString)((0,o.unref)(zo)||''),9,fn),(0,o.createElementVNode)('span',mn,(0,o.toDisplayString)((0,o.unref)(Mo)?'':''),1)]),(0,o.unref)(Mo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',gn,[(0,o.withDirectives)((0,o.createElementVNode)('input',{ref_key:'worldbookPickerSearchInputRef',ref:Lo,'onUpdate:modelValue':n[29]||(n[29]=e=>(0,o.isRef)(Wo)?Wo.value=e:null),type:'text',class:'text-input worldbook-picker-search',placeholder:'...',onKeydown:n[30]||(n[30]=(0,o.withKeys)((0,o.withModifiers)(e=>(0,o.unref)(Al)[0]&&ic((0,o.unref)(Al)[0]),['prevent']),['enter']))},null,544),[[o.vModelText,(0,o.unref)(Wo)]]),(0,o.createElementVNode)('div',vn,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Al),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`worldbook-${e}`,class:(0,o.normalizeClass)(['worldbook-picker-item',{active:e===(0,o.unref)(zo)}]),type:'button',onClick:n=>ic(e)},(0,o.toDisplayString)(e),11,An))),128)),(0,o.unref)(Al).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',Cn,''))])])):(0,o.createCommentVNode)('v-if',!0)],512)]),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:fc},''),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(zo),onClick:mc},'  ',8,yn),(0,o.createElementVNode)('button',{class:'btn danger',type:'button',disabled:!(0,o.unref)(zo),onClick:gc},'  ',8,hn),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(zo),onClick:Ed},'  ',8,wn),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:Sd},''),(0,o.createElementVNode)('input',{ref_key:'importFileInput',ref:ui,class:'hidden-input',type:'file',accept:'.json,application/json',onChange:Nd},null,544)]),(0,o.createElementVNode)('div',xn,[(0,o.createElementVNode)('section',kn,[(0,o.createElementVNode)('div',En,[(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['btn history-btn utility-btn',{active:(0,o.unref)(Uo)}]),type:'button',onClick:Fd},'   ',2),(0,o.createElementVNode)('button',{class:'btn history-btn',type:'button',disabled:!(0,o.unref)(tl),onClick:ld},'   ',8,Bn),(0,o.createElementVNode)('button',{class:'btn history-btn',type:'button',disabled:!(0,o.unref)(zo),onClick:sd},'   ',8,Sn),(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['btn history-btn utility-btn',{active:(0,o.unref)(zi).find.visible}]),type:'button',disabled:!(0,o.unref)(li).length,onClick:n[31]||(n[31]=e=>kc('find'))},'   ',10,Nn),(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['btn history-btn utility-btn',{active:(0,o.unref)(zi).activation.visible}]),type:'button',onClick:n[32]||(n[32]=e=>kc('activation'))},'   ',2),(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['btn history-btn utility-btn',{active:(0,o.unref)(jo)}]),type:'button',onClick:Ss},'  AI  ',2)]),(0,o.unref)(Uo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',_n,[(0,o.createElementVNode)('div',Vn,[(0,o.createElementVNode)('span',Rn,''+(0,o.toDisplayString)((0,o.unref)(Ji).global.length)+'',1),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(Ji).global.length,onClick:Md},'  ',8,Fn)]),(0,o.createElementVNode)('div',Tn,[(0,o.createElementVNode)('label',Pn,[n[142]||(n[142]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[33]||(n[33]=e=>(0,o.isRef)(ai)?ai.value=e:null),class:'text-input',onChange:Gd},[n[141]||(n[141]=(0,o.createElementVNode)('option',{value:''},'',-1)),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(bl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('option',{key:e.id,value:e.id},(0,o.toDisplayString)(e.name)+''+(0,o.toDisplayString)(e.worldbooks.length)+' ',9,In))),128))],544),[[o.vModelSelect,(0,o.unref)(ai)]])]),(0,o.createElementVNode)('div',zn,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(Ji).global.length,onClick:Zd},'  ',8,Mn),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(fl),onClick:Jd},'  ',8,Wn),(0,o.createElementVNode)('button',{class:'btn danger',type:'button',disabled:!(0,o.unref)(fl),onClick:Xd},'  ',8,Dn)]),(0,o.createElementVNode)('div',Ln,[(0,o.createElementVNode)('div',$n,[n[143]||(n[143]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.createElementVNode)('span',{class:(0,o.normalizeClass)(['preset-role-current',{empty:!(0,o.unref)(ri)}])},(0,o.toDisplayString)((0,o.unref)(ri)?`: ${(0,o.unref)(ri).name}`:''),3)]),(0,o.createElementVNode)('div',On,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(fl)||!(0,o.unref)(ri),onClick:jd},'  ',8,Hn),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(fl)||!(0,o.unref)(gl),onClick:Qd},'  ',8,Yn)]),(0,o.createElementVNode)('div',{ref_key:'rolePickerRef',ref:Oo,class:'role-picker'},[(0,o.createElementVNode)('button',{class:'role-picker-trigger',type:'button',disabled:!(0,o.unref)(fl),onClick:ac},[(0,o.createElementVNode)('span',Un,(0,o.toDisplayString)((0,o.unref)(fl)?'':''),1),(0,o.createElementVNode)('span',jn,(0,o.toDisplayString)((0,o.unref)($o)?'':''),1)],8,Gn),(0,o.unref)($o)?((0,o.openBlock)(),(0,o.createElementBlock)('div',Kn,[(0,o.withDirectives)((0,o.createElementVNode)('input',{ref_key:'rolePickerSearchInputRef',ref:Ho,'onUpdate:modelValue':n[34]||(n[34]=e=>(0,o.isRef)(mi)?mi.value=e:null),type:'text',class:'text-input role-picker-search',placeholder:' / avatar...',onKeydown:(0,o.withKeys)((0,o.withModifiers)(lc,['prevent']),['enter'])},null,40,qn),[[o.vModelText,(0,o.unref)(mi)]]),(0,o.createElementVNode)('div',Qn,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(vl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`role-candidate-${e.key}`,class:'role-picker-item',type:'button',disabled:e.bound,onClick:n=>Kd(e)},[(0,o.createElementVNode)('span',Jn,(0,o.toDisplayString)(e.name),1),(0,o.createElementVNode)('span',Xn,(0,o.toDisplayString)(e.bound?'':''),1)],8,Zn))),128)),(0,o.unref)(vl).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',et,''))])])):(0,o.createCommentVNode)('v-if',!0)],512),(0,o.createElementVNode)('div',nt,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(ml),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`binding-${(0,o.unref)(fl)?.id}-${e.key}`,class:'preset-role-tag',type:'button',title:`: ${e.name}`,onClick:n=>qd(e.key)},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e.name),1),n[144]||(n[144]=(0,o.createElementVNode)('span',{class:'remove'},'',-1))],8,tt))),128)),(0,o.unref)(fl)&&!(0,o.unref)(ml).length?((0,o.openBlock)(),(0,o.createElementBlock)('div',at,'  ')):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(fl)?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',rt,''))])])]),(0,o.createElementVNode)('div',ot,[(0,o.createElementVNode)('div',it,[(0,o.createElementVNode)('label',lt,[n[145]||(n[145]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[35]||(n[35]=e=>(0,o.isRef)(bi)?bi.value=e:null),type:'text',class:'text-input',placeholder:'...',onKeydown:(0,o.withKeys)((0,o.withModifiers)(Pd,['prevent']),['enter'])},null,40,st),[[o.vModelText,(0,o.unref)(bi)]])]),(0,o.createElementVNode)('div',dt,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Cl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`add-${e}`,class:'global-mode-item add',type:'button',onClick:n=>Id(e)},[(0,o.createElementVNode)('span',ut,(0,o.toDisplayString)(e),1),n[146]||(n[146]=(0,o.createElementVNode)('span',{class:'global-mode-item-action'},'',-1))],8,ct))),128)),(0,o.unref)(Cl).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',pt,''))])]),(0,o.createElementVNode)('div',bt,[(0,o.createElementVNode)('label',ft,[n[147]||(n[147]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[36]||(n[36]=e=>(0,o.isRef)(fi)?fi.value=e:null),type:'text',class:'text-input',placeholder:'...'},null,512),[[o.vModelText,(0,o.unref)(fi)]])]),(0,o.createElementVNode)('div',mt,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(yl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:`global-${e}`,class:'global-mode-item active',type:'button',onClick:n=>zd(e)},[(0,o.createElementVNode)('span',vt,(0,o.toDisplayString)(e),1),n[148]||(n[148]=(0,o.createElementVNode)('span',{class:'global-mode-item-action'},'',-1))],8,gt))),128)),(0,o.unref)(yl).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',At,(0,o.toDisplayString)((0,o.unref)(Ji).global.length?'':''),1))])])]),(0,o.createElementVNode)('div',Ct,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(zo),onClick:vc},(0,o.toDisplayString)((0,o.unref)(hl)?'':''),9,yt)])])):(0,o.createCommentVNode)('v-if',!0)]),(0,o.createCommentVNode)('  AI Generator Panel  '),(0,o.unref)(jo)?((0,o.openBlock)(),(0,o.createElementBlock)('section',ht,[(0,o.createElementVNode)('div',wt,[(0,o.createElementVNode)('div',{class:'ai-sidebar-head'},[n[149]||(n[149]=(0,o.createElementVNode)('span',{class:'ai-sidebar-title'},'',-1)),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',onClick:hs},'+ ')]),(0,o.createElementVNode)('div',xt,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(As),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:e.id,class:(0,o.normalizeClass)(['ai-session-item',{active:e.id===(0,o.unref)(Cs)?.id}]),type:'button',onClick:n=>{return t=e.id,void vs(e=>{e.ai_chat.activeSessionId=t});var t}},[(0,o.createElementVNode)('span',Et,(0,o.toDisplayString)(e.title),1),(0,o.createElementVNode)('span',Bt,(0,o.toDisplayString)(e.messages.length)+' ',1),(0,o.createElementVNode)('button',{class:'ai-session-delete',type:'button',title:'',onClick:(0,o.withModifiers)(n=>{return t=e.id,vs(e=>{e.ai_chat.sessions=e.ai_chat.sessions.filter(e=>e.id!==t),e.ai_chat.activeSessionId===t&&(e.ai_chat.activeSessionId=e.ai_chat.sessions[0]?.id??null)}),void Ns('');var t},['stop'])},'',8,St)],10,kt))),128)),(0,o.unref)(As).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',Nt,''))])]),(0,o.createElementVNode)('div',_t,[(0,o.unref)(Cs)?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:1},[(0,o.createElementVNode)('div',{class:'ai-chat-messages',ref_key:'aiChatMessagesRef',ref:ti},[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(ys),(e,n)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:`msg-${n}`,class:(0,o.normalizeClass)(['ai-chat-bubble',e.role])},[(0,o.createElementVNode)('div',Rt,(0,o.toDisplayString)('user'===e.role?' ':' AI'),1),(0,o.createElementVNode)('div',Ft,(0,o.toDisplayString)(e.content),1)],2))),128)),(0,o.unref)(Ko)&&(0,o.unref)(Qo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',Tt,[n[152]||(n[152]=(0,o.createElementVNode)('div',{class:'ai-chat-bubble-role'},' AI',-1)),(0,o.createElementVNode)('div',Pt,[(0,o.createTextVNode)((0,o.toDisplayString)((0,o.unref)(Qo)),1),n[151]||(n[151]=(0,o.createElementVNode)('span',{class:'ai-cursor'},'',-1))])])):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(Ko)&&!(0,o.unref)(Qo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',It,[...n[153]||(n[153]=[(0,o.createElementVNode)('div',{class:'ai-chat-bubble-role'},' AI',-1),(0,o.createElementVNode)('div',{class:'ai-chat-bubble-content'},[(0,o.createElementVNode)('span',{class:'ai-thinking'},'...')],-1)])])):(0,o.createCommentVNode)('v-if',!0)],512),(0,o.createElementVNode)('div',zt,[(0,o.createElementVNode)('label',Mt,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[37]||(n[37]=e=>(0,o.isRef)(ni)?ni.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(ni)]]),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)(ni)?' ':' '),1)]),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[38]||(n[38]=e=>(0,o.isRef)(ei)?ei.value=e:null),class:'text-input ai-chat-input',placeholder:' AI ...',rows:'2',disabled:(0,o.unref)(Ko),onKeydown:(0,o.withKeys)((0,o.withModifiers)(ks,['exact','prevent']),['enter'])},null,40,Wt),[[o.vModelText,(0,o.unref)(ei)]]),(0,o.unref)(Ko)?((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:1,class:'btn danger ai-stop-btn',type:'button',onClick:Es},'')):((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:0,class:'btn ai-send-btn',type:'button',disabled:!(0,o.unref)(ei).trim(),onClick:ks},'',8,Dt))])],64)):((0,o.openBlock)(),(0,o.createElementBlock)('div',Vt,[...n[150]||(n[150]=[(0,o.createElementVNode)('div',{class:'ai-chat-empty-icon'},'',-1),(0,o.createElementVNode)('div',{class:'ai-chat-empty-text'},'',-1)])]))])])):(0,o.createCommentVNode)('v-if',!0),(0,o.createCommentVNode)('  Tag Review Modal  '),(0,o.unref)(Jo)?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:1,class:'ai-tag-review-overlay',onClick:n[43]||(n[43]=(0,o.withModifiers)(e=>Jo.value=!1,['self']))},[(0,o.createElementVNode)('div',Lt,[(0,o.createElementVNode)('div',$t,[(0,o.createElementVNode)('span',Ot,' '+(0,o.toDisplayString)((0,o.unref)(Zo).length)+'',1),(0,o.createElementVNode)('button',{class:'ai-tag-review-close',type:'button',onClick:n[39]||(n[39]=e=>Jo.value=!1)},'')]),(0,o.createElementVNode)('div',Ht,[(0,o.createElementVNode)('label',Yt,[n[155]||(n[155]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[40]||(n[40]=e=>(0,o.isRef)(Xo)?Xo.value=e:null),class:'text-input'},[n[154]||(n[154]=(0,o.createElementVNode)('option',{value:''},'',-1)),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Io),e=>((0,o.openBlock)(),(0,o.createElementBlock)('option',{key:`ai-wb-${e}`,value:e},(0,o.toDisplayString)(e),9,Gt))),128))],512),[[o.vModelSelect,(0,o.unref)(Xo)]])])]),(0,o.createElementVNode)('div',Ut,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Zo),(e,n)=>((0,o.openBlock)(),(0,o.createElementBlock)('label',{key:`tag-${n}`,class:'ai-tag-item'},[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n=>e.selected=n,type:'checkbox'},null,8,jt),[[o.vModelCheckbox,e.selected]]),(0,o.createElementVNode)('div',Kt,[(0,o.createElementVNode)('span',qt,(0,o.toDisplayString)(e.tag),1),(0,o.createElementVNode)('span',Qt,(0,o.toDisplayString)(e.content.slice(0,120))+(0,o.toDisplayString)(e.content.length>120?'...':''),1)])]))),128))]),(0,o.createElementVNode)('div',Zt,[(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:n[41]||(n[41]=e=>(0,o.unref)(Zo).forEach(e=>e.selected=!0))},''),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:n[42]||(n[42]=e=>(0,o.unref)(Zo).forEach(e=>e.selected=!1))},''),(0,o.createElementVNode)('button',{class:'btn primary',type:'button',disabled:!(0,o.unref)(Xo)||!(0,o.unref)(Zo).some(e=>e.selected),onClick:Bs},''+(0,o.toDisplayString)((0,o.unref)(Zo).filter(e=>e.selected).length)+'',9,Jt)])])])):(0,o.createCommentVNode)('v-if',!0),(0,o.withDirectives)((0,o.createElementVNode)('section',{ref_key:'mainLayoutRef',ref:Li,class:'wb-main-layout',style:(0,o.normalizeStyle)((0,o.unref)(dl))},[(0,o.withDirectives)((0,o.createElementVNode)('aside',Xt,[(0,o.createElementVNode)('div',ea,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[44]||(n[44]=e=>(0,o.isRef)(di)?di.value=e:null),type:'text',class:'text-input',placeholder:' /  / '},null,512),[[o.vModelText,(0,o.unref)(di)]]),(0,o.createElementVNode)('label',na,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[45]||(n[45]=e=>(0,o.isRef)(ci)?ci.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(ci)]]),n[156]||(n[156]=(0,o.createElementVNode)('span',null,'',-1))])]),(0,o.createElementVNode)('div',ta,'  '+(0,o.toDisplayString)((0,o.unref)(rl).length)+' / '+(0,o.toDisplayString)((0,o.unref)(li).length)+' |  '+(0,o.toDisplayString)((0,o.unref)(ol)),1),(0,o.createElementVNode)('div',aa,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(rl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:e.uid,type:'button',class:(0,o.normalizeClass)(['entry-item',{selected:e.uid===(0,o.unref)(si),disabled:!e.enabled}]),'data-status':ls(e),onClick:n=>ed(e.uid)},[(0,o.createElementVNode)('div',oa,[(0,o.createElementVNode)('span',{class:'entry-status-dot','data-status':ls(e)},null,8,ia),(0,o.createElementVNode)('div',la,(0,o.toDisplayString)(e.name||` ${e.uid}`),1),(0,o.createElementVNode)('span',sa,'#'+(0,o.toDisplayString)(e.uid),1)]),(0,o.createElementVNode)('div',da,[(0,o.createElementVNode)('span',{class:'entry-chip status','data-status':ls(e)},(0,o.toDisplayString)(ss(e)),9,ca),(0,o.createElementVNode)('span',ua,' '+(0,o.toDisplayString)(e.strategy.keys.length),1),(0,o.createElementVNode)('span',pa,' '+(0,o.toDisplayString)(e.probability),1),(0,o.createElementVNode)('span',ba,'#'+(0,o.toDisplayString)(e.position.order),1)]),(0,o.createElementVNode)('div',fa,(0,o.toDisplayString)(ds(e)),1)],10,ra))),128))]),(0,o.createElementVNode)('div',ma,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(zo),onClick:vd},'',8,ga),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(tl),onClick:Ad},'  ',8,va),(0,o.createElementVNode)('button',{class:'btn danger',type:'button',disabled:!(0,o.unref)(tl),onClick:Cd},'  ',8,Aa),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(tl),onClick:n[46]||(n[46]=e=>yd(-1))},'  ',8,Ca),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(tl),onClick:n[47]||(n[47]=e=>yd(1))},'',8,ya)])],512),[[o.vShow,!(0,o.unref)(Qi)]]),(0,o.withDirectives)((0,o.createElementVNode)('div',{class:(0,o.normalizeClass)(['wb-resize-handle main',{dragging:'main'===(0,o.unref)(Gi)?.key}]),onPointerdown:n[48]||(n[48]=e=>Vc('main',e))},null,34),[[o.vShow,!(0,o.unref)(qi)]]),(0,o.withDirectives)((0,o.createElementVNode)('main',ha,[(0,o.unref)(tl)?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:0,ref_key:'editorShellRef',ref:$i,class:'wb-editor-shell',style:(0,o.normalizeStyle)((0,o.unref)(cl))},[(0,o.createElementVNode)('section',wa,[(0,o.createElementVNode)('header',xa,[(0,o.unref)(qi)?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:0,class:'editor-back-btn',onClick:nd},'   ')):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('label',ka,[n[157]||(n[157]=(0,o.createElementVNode)('span',null,' (COMMENT)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[49]||(n[49]=e=>(0,o.unref)(tl).name=e),type:'text',class:'text-input'},null,512),[[o.vModelText,(0,o.unref)(tl).name]])]),(0,o.createElementVNode)('div',Ea,[(0,o.createElementVNode)('span',{class:(0,o.normalizeClass)(['editor-badge',(0,o.unref)(tl).enabled?'on':'off'])},(0,o.toDisplayString)((0,o.unref)(tl).enabled?'EN':'OFF'),3),(0,o.createElementVNode)('span',{class:'editor-badge strategy','data-status':ls((0,o.unref)(tl))},(0,o.toDisplayString)(ss((0,o.unref)(tl))),9,Ba),(0,o.createElementVNode)('span',Sa,'#'+(0,o.toDisplayString)((0,o.unref)(tl).uid),1),(0,o.createElementVNode)('span',Na,'Chars '+(0,o.toDisplayString)((0,o.unref)(Gl)),1),(0,o.createElementVNode)('span',_a,'~'+(0,o.toDisplayString)((0,o.unref)(Ul))+'T',1)])]),(0,o.createElementVNode)('section',Va,[(0,o.createElementVNode)('label',Ra,[n[158]||(n[158]=(0,o.createElementVNode)('span',null,' (KEYS)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[50]||(n[50]=e=>(0,o.isRef)(Wl)?Wl.value=e:null),class:'text-area compact'},null,512),[[o.vModelText,(0,o.unref)(Wl)]])]),(0,o.createElementVNode)('label',Fa,[n[159]||(n[159]=(0,o.createElementVNode)('span',null,' (SECONDARY)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[51]||(n[51]=e=>(0,o.isRef)(Dl)?Dl.value=e:null),class:'text-area compact'},null,512),[[o.vModelText,(0,o.unref)(Dl)]])])]),(0,o.createElementVNode)('section',Ta,[n[161]||(n[161]=(0,o.createElementVNode)('div',{class:'editor-content-title'},' /  (CONTENT)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{ref_key:'contentTextareaRef',ref:Oi,'onUpdate:modelValue':n[52]||(n[52]=e=>(0,o.unref)(tl).content=e),class:'text-area large editor-content-area'},null,512),[[o.vModelText,(0,o.unref)(tl).content]]),(0,o.createElementVNode)('div',{class:'content-resize-handle',onPointerdown:_c},[...n[160]||(n[160]=[(0,o.createElementVNode)('span',{class:'content-resize-grip'},'',-1)])],32)]),(0,o.createElementVNode)('details',Pa,[n[163]||(n[163]=(0,o.createElementVNode)('summary',null,' / extra JSON',-1)),(0,o.createElementVNode)('label',Ia,[n[162]||(n[162]=(0,o.createElementVNode)('span',null,'extra JSON',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':n[53]||(n[53]=e=>(0,o.isRef)(pi)?pi.value=e:null),class:'text-area compact',placeholder:'{ ... }'},null,512),[[o.vModelText,(0,o.unref)(pi)]])]),(0,o.createElementVNode)('div',{class:'field-actions'},[(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:md},' extra'),(0,o.createElementVNode)('button',{class:'btn',type:'button',onClick:gd},' extra')])])]),(0,o.withDirectives)((0,o.createElementVNode)('div',{class:(0,o.normalizeClass)(['wb-resize-handle editor',{dragging:'editor'===(0,o.unref)(Gi)?.key}]),onPointerdown:n[54]||(n[54]=e=>Vc('editor',e))},null,34),[[o.vShow,!(0,o.unref)(qi)]]),(0,o.createElementVNode)('aside',za,[(0,o.createElementVNode)('article',Ma,[n[169]||(n[169]=(0,o.createElementVNode)('h4',null,' (STRATEGY)',-1)),(0,o.createElementVNode)('label',Wa,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[55]||(n[55]=e=>(0,o.unref)(tl).enabled=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).enabled]]),n[164]||(n[164]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('div',Da,[(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill constant',{active:'constant'===(0,o.unref)(tl).strategy.type}]),onClick:n[56]||(n[56]=e=>(0,o.unref)(tl).strategy.type='constant')},'   (Constant) ',2),(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill vector',{active:'vectorized'===(0,o.unref)(tl).strategy.type}]),onClick:n[57]||(n[57]=e=>(0,o.unref)(tl).strategy.type='vectorized')},'   (Vector) ',2),(0,o.createElementVNode)('button',{type:'button',class:(0,o.normalizeClass)(['strategy-pill selective',{active:'selective'===(0,o.unref)(tl).strategy.type}]),onClick:n[58]||(n[58]=e=>(0,o.unref)(tl).strategy.type='selective')},'   (Selective) ',2)]),(0,o.createElementVNode)('details',La,[n[168]||(n[168]=(0,o.createElementVNode)('summary',null,'',-1)),(0,o.createElementVNode)('label',$a,[n[165]||(n[165]=(0,o.createElementVNode)('span',null,' (LOGIC)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[59]||(n[59]=e=>(0,o.unref)(tl).strategy.keys_secondary.logic=e),class:'text-input'},[((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(To,e=>(0,o.createElementVNode)('option',{key:e,value:e},(0,o.toDisplayString)(os(e)),9,Oa)),64))],512),[[o.vModelSelect,(0,o.unref)(tl).strategy.keys_secondary.logic]])]),(0,o.createElementVNode)('label',Ha,[n[166]||(n[166]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[60]||(n[60]=e=>(0,o.isRef)(Ll)?Ll.value=e:null),type:'text',class:'text-input',placeholder:' same_as_global'},null,512),[[o.vModelText,(0,o.unref)(Ll)]])]),(0,o.createElementVNode)('label',Ya,[n[167]||(n[167]=(0,o.createElementVNode)('span',null,'(0-100)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[61]||(n[61]=e=>(0,o.unref)(tl).probability=e),type:'number',class:'text-input',min:'0',max:'100',step:'1'},null,512),[[o.vModelText,(0,o.unref)(tl).probability,void 0,{number:!0}]])])])]),(0,o.createElementVNode)('article',Ga,[n[175]||(n[175]=(0,o.createElementVNode)('h4',null,' (INSERTION)',-1)),(0,o.createElementVNode)('label',Ua,[n[170]||(n[170]=(0,o.createElementVNode)('span',null,' (Position)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[62]||(n[62]=e=>(0,o.unref)(tl).position.type=e),class:'text-input',onChange:fd},[((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(Po,e=>(0,o.createElementVNode)('option',{key:e,value:e},(0,o.toDisplayString)(is(e)),9,ja)),64))],544),[[o.vModelSelect,(0,o.unref)(tl).position.type]])]),(0,o.createElementVNode)('label',Ka,[n[171]||(n[171]=(0,o.createElementVNode)('span',null,' (Order)',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[63]||(n[63]=e=>(0,o.unref)(tl).position.order=e),type:'number',class:'text-input',step:'1'},null,512),[[o.vModelText,(0,o.unref)(tl).position.order,void 0,{number:!0}]])]),(0,o.createElementVNode)('div',qa,[(0,o.createElementVNode)('label',{class:(0,o.normalizeClass)(['field',{disabled:'at_depth'!==(0,o.unref)(tl).position.type}])},[n[173]||(n[173]=(0,o.createElementVNode)('span',null,'at_depth role',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':n[64]||(n[64]=e=>(0,o.unref)(tl).position.role=e),class:'text-input',disabled:'at_depth'!==(0,o.unref)(tl).position.type},[...n[172]||(n[172]=[(0,o.createElementVNode)('option',{value:'system'},'system',-1),(0,o.createElementVNode)('option',{value:'assistant'},'assistant',-1),(0,o.createElementVNode)('option',{value:'user'},'user',-1)])],8,Qa),[[o.vModelSelect,(0,o.unref)(tl).position.role]])],2),(0,o.createElementVNode)('label',{class:(0,o.normalizeClass)(['field',{disabled:'at_depth'!==(0,o.unref)(tl).position.type}])},[n[174]||(n[174]=(0,o.createElementVNode)('span',null,'at_depth depth',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[65]||(n[65]=e=>(0,o.unref)(tl).position.depth=e),type:'number',class:'text-input',min:'1',step:'1',disabled:'at_depth'!==(0,o.unref)(tl).position.type},null,8,Za),[[o.vModelText,(0,o.unref)(tl).position.depth,void 0,{number:!0}]])],2)])]),(0,o.createElementVNode)('article',Ja,[n[182]||(n[182]=(0,o.createElementVNode)('h4',null,' (RECURSION)',-1)),(0,o.createElementVNode)('label',Xa,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[66]||(n[66]=e=>(0,o.unref)(tl).recursion.prevent_incoming=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).recursion.prevent_incoming]]),n[176]||(n[176]=(0,o.createElementVNode)('span',null,' (Exclude Incoming)',-1))]),(0,o.createElementVNode)('label',er,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[67]||(n[67]=e=>(0,o.unref)(tl).recursion.prevent_outgoing=e),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(tl).recursion.prevent_outgoing]]),n[177]||(n[177]=(0,o.createElementVNode)('span',null,' (Prevent Outgoing)',-1))]),(0,o.createElementVNode)('label',nr,[n[178]||(n[178]=(0,o.createElementVNode)('span',null,'',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[68]||(n[68]=e=>(0,o.isRef)($l)?$l.value=e:null),type:'text',class:'text-input',placeholder:' null'},null,512),[[o.vModelText,(0,o.unref)($l)]])]),(0,o.createElementVNode)('div',tr,[(0,o.createElementVNode)('label',ar,[n[179]||(n[179]=(0,o.createElementVNode)('span',null,'sticky',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[69]||(n[69]=e=>(0,o.isRef)(Ol)?Ol.value=e:null),type:'text',class:'text-input',placeholder:' null'},null,512),[[o.vModelText,(0,o.unref)(Ol)]])]),(0,o.createElementVNode)('label',rr,[n[180]||(n[180]=(0,o.createElementVNode)('span',null,'cooldown',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[70]||(n[70]=e=>(0,o.isRef)(Hl)?Hl.value=e:null),type:'text',class:'text-input',placeholder:' null'},null,512),[[o.vModelText,(0,o.unref)(Hl)]])])]),(0,o.createElementVNode)('label',or,[n[181]||(n[181]=(0,o.createElementVNode)('span',null,'delay',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[71]||(n[71]=e=>(0,o.isRef)(Yl)?Yl.value=e:null),type:'text',class:'text-input',placeholder:' null'},null,512),[[o.vModelText,(0,o.unref)(Yl)]])])])])],4)):((0,o.openBlock)(),(0,o.createElementBlock)('div',ir,''))],512),[[o.vShow,!(0,o.unref)(qi)||(0,o.unref)(Qi)]])],4),[[o.vShow,!(0,o.unref)(jo)]])]),(0,o.createElementVNode)('footer',lr,[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)(Si)?'...':(0,o.unref)(Bi)),1),(0,o.createElementVNode)('span',null,' : '+(0,o.toDisplayString)((0,o.unref)(li).length)+' | : '+(0,o.toDisplayString)((0,o.unref)(il))+' | '+(0,o.toDisplayString)((0,o.unref)(ll)?'':''),1)])],64)),(0,o.createCommentVNode)('  End Desktop Layout  '),(0,o.unref)(_i)?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:2,class:'wb-modal-backdrop',onClick:n[73]||(n[73]=(0,o.withModifiers)(e=>_i.value=!1,['self']))},[(0,o.createElementVNode)('div',sr,[(0,o.createElementVNode)('div',dr,[(0,o.createElementVNode)('div',null,[n[183]||(n[183]=(0,o.createElementVNode)('strong',null,' ',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((0,o.unref)(zl)),1)]),(0,o.createElementVNode)('div',cr,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(tl),onClick:dd},'  ',8,ur),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(xl).length,onClick:bd},'  ',8,pr),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',onClick:n[72]||(n[72]=e=>_i.value=!1)},'')])]),(0,o.createElementVNode)('div',br,[(0,o.createElementVNode)('aside',fr,[n[184]||(n[184]=(0,o.createElementVNode)('div',{class:'wb-history-versions-title'},'L/R',-1)),(0,o.createElementVNode)('div',mr,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(kl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:e.id,class:'wb-history-version-item'},[(0,o.createElementVNode)('div',gr,[(0,o.createElementVNode)('strong',null,(0,o.toDisplayString)(Vs(e.label,e.ts,e.isCurrent)),1),(0,o.createElementVNode)('div',vr,[(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['mini-lr',{active:(0,o.unref)(Ri)===e.id}]),onClick:n=>Ri.value=e.id},'L',10,Ar),(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['mini-lr',{active:(0,o.unref)(Fi)===e.id}]),onClick:n=>Fi.value=e.id},'R',10,Cr)])]),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e.name),1)]))),128)),(0,o.unref)(kl).length<=1?((0,o.openBlock)(),(0,o.createElementBlock)('div',yr,'')):(0,o.createCommentVNode)('v-if',!0)])]),(0,o.createElementVNode)('section',hr,[(0,o.createElementVNode)('div',wr,[(0,o.createElementVNode)('div',null,' Left: '+(0,o.toDisplayString)((0,o.unref)(El)?Vs((0,o.unref)(El).label,(0,o.unref)(El).ts,(0,o.unref)(El).isCurrent):'-')+' | Right: '+(0,o.toDisplayString)((0,o.unref)(Bl)?Vs((0,o.unref)(Bl).label,(0,o.unref)(Bl).ts,(0,o.unref)(Bl).isCurrent):'-'),1),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(Sl),onClick:pd},'  Left ',8,xr)]),(0,o.createElementVNode)('div',kr,[(0,o.createElementVNode)('div',null,[n[185]||(n[185]=(0,o.createElementVNode)('div',{class:'wb-history-diff-title'},'Left',-1)),(0,o.createElementVNode)('div',{class:'wb-history-diff-body',innerHTML:(0,o.unref)(Il).leftHtml},null,8,Er)]),(0,o.createElementVNode)('div',null,[n[186]||(n[186]=(0,o.createElementVNode)('div',{class:'wb-history-diff-title'},'Right',-1)),(0,o.createElementVNode)('div',{class:'wb-history-diff-body',innerHTML:(0,o.unref)(Il).rightHtml},null,8,Br)])])])])])])):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(Vi)?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:3,class:'wb-modal-backdrop',onClick:n[75]||(n[75]=(0,o.withModifiers)(e=>Vi.value=!1,['self']))},[(0,o.createElementVNode)('div',Sr,[(0,o.createElementVNode)('div',Nr,[(0,o.createElementVNode)('div',null,[n[187]||(n[187]=(0,o.createElementVNode)('strong',null,' ',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(Rs((0,o.unref)(_l),(0,o.unref)(Vl))),1)]),(0,o.createElementVNode)('div',_r,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(zo),onClick:id},'  ',8,Vr),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(wl).length,onClick:ud},'  ',8,Rr),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',onClick:n[74]||(n[74]=e=>Vi.value=!1)},'')])]),(0,o.createElementVNode)('div',Fr,[(0,o.createElementVNode)('aside',Tr,[n[188]||(n[188]=(0,o.createElementVNode)('div',{class:'wb-history-versions-title'},'L/R',-1)),(0,o.createElementVNode)('div',Pr,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Nl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:e.id,class:'wb-history-version-item'},[(0,o.createElementVNode)('div',Ir,[(0,o.createElementVNode)('strong',null,(0,o.toDisplayString)(Vs(e.label,e.ts,e.isCurrent)),1),(0,o.createElementVNode)('div',zr,[(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['mini-lr',{active:(0,o.unref)(Ti)===e.id}]),onClick:n=>Ti.value=e.id},'L',10,Mr),(0,o.createElementVNode)('button',{class:(0,o.normalizeClass)(['mini-lr',{active:(0,o.unref)(Pi)===e.id}]),onClick:n=>Pi.value=e.id},'R',10,Wr)])]),(0,o.createElementVNode)('span',null,'entries: '+(0,o.toDisplayString)(e.entries.length),1)]))),128))])]),(0,o.createElementVNode)('section',Dr,[(0,o.createElementVNode)('div',Lr,[(0,o.createElementVNode)('div',null,' Left: '+(0,o.toDisplayString)((0,o.unref)(_l)?Vs((0,o.unref)(_l).label,(0,o.unref)(_l).ts,(0,o.unref)(_l).isCurrent):'-')+' | Right: '+(0,o.toDisplayString)((0,o.unref)(Vl)?Vs((0,o.unref)(Vl).label,(0,o.unref)(Vl).ts,(0,o.unref)(Vl).isCurrent):'-'),1),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(Rl),onClick:cd},'  Left ',8,$r)]),(0,o.createElementVNode)('div',Or,[(0,o.createElementVNode)('div',null,[n[189]||(n[189]=(0,o.createElementVNode)('div',{class:'wb-history-diff-title'},'Left',-1)),(0,o.createElementVNode)('div',{class:'wb-history-diff-body',innerHTML:(0,o.unref)(Ml).leftHtml},null,8,Hr)]),(0,o.createElementVNode)('div',null,[n[190]||(n[190]=(0,o.createElementVNode)('div',{class:'wb-history-diff-title'},'Right',-1)),(0,o.createElementVNode)('div',{class:'wb-history-diff-body',innerHTML:(0,o.unref)(Ml).rightHtml},null,8,Yr)])])])])])])):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(zi).find.visible?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:4,class:'wb-floating-window find-window',style:(0,o.normalizeStyle)(Ec('find')),onPointerdown:n[94]||(n[94]=e=>wc('find'))},[(0,o.createElementVNode)('div',{class:'wb-floating-header',onPointerdown:n[82]||(n[82]=e=>Bc('find',e))},[n[191]||(n[191]=(0,o.createElementVNode)('strong',null,' ',-1)),(0,o.createElementVNode)('div',Gr,[(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(li).length,onPointerdown:n[76]||(n[76]=(0,o.withModifiers)(()=>{},['stop'])),onClick:Qs},'  ',40,Ur),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(li).length,onPointerdown:n[77]||(n[77]=(0,o.withModifiers)(()=>{},['stop'])),onClick:Js},'  ',40,jr),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(li).length,onPointerdown:n[78]||(n[78]=(0,o.withModifiers)(()=>{},['stop'])),onClick:Zs},'  ',40,Kr),(0,o.createElementVNode)('button',{class:'btn mini',type:'button',disabled:!(0,o.unref)(li).length,onPointerdown:n[79]||(n[79]=(0,o.withModifiers)(()=>{},['stop'])),onClick:kd},'  ',40,qr),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',onPointerdown:n[80]||(n[80]=(0,o.withModifiers)(()=>{},['stop'])),onClick:n[81]||(n[81]=e=>xc('find'))},'  ',32)])],32),(0,o.createElementVNode)('div',Qr,[(0,o.createElementVNode)('div',Zr,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[83]||(n[83]=e=>(0,o.isRef)(gi)?gi.value=e:null),type:'text',class:'text-input',placeholder:' / '},null,512),[[o.vModelText,(0,o.unref)(gi)]]),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[84]||(n[84]=e=>(0,o.isRef)(vi)?vi.value=e:null),type:'text',class:'text-input',placeholder:''},null,512),[[o.vModelText,(0,o.unref)(vi)]]),(0,o.createElementVNode)('div',Jr,[(0,o.createElementVNode)('label',Xr,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[85]||(n[85]=e=>(0,o.isRef)(xi)?xi.value=e:null),type:'radio',value:'all'},null,512),[[o.vModelRadio,(0,o.unref)(xi)]]),n[192]||(n[192]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('label',eo,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[86]||(n[86]=e=>(0,o.isRef)(xi)?xi.value=e:null),type:'radio',value:'current',disabled:!(0,o.unref)(tl)},null,8,no),[[o.vModelRadio,(0,o.unref)(xi)]]),n[193]||(n[193]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('span',to,(0,o.toDisplayString)((0,o.unref)(Pl)),1)]),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[87]||(n[87]=e=>(0,o.isRef)(Ai)?Ai.value=e:null),type:'text',class:'text-input',placeholder:'#UID /  /  / '},null,512),[[o.vModelText,(0,o.unref)(Ai)]]),(0,o.unref)(Tl)?((0,o.openBlock)(),(0,o.createElementBlock)('div',ao,[(0,o.createElementVNode)('strong',null,'#'+(0,o.toDisplayString)((0,o.unref)(Tl).entryUid)+' '+(0,o.toDisplayString)((0,o.unref)(Tl).entryName||` ${(0,o.unref)(Tl).entryUid}`),1),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(Ws((0,o.unref)(Tl).field))+'  '+(0,o.toDisplayString)((0,o.unref)(Tl).preview),1)])):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('div',ro,' : `#12, name:, content:'+(0,o.toDisplayString)(e.user)+', keys:`// ',1),(0,o.unref)(Fl).length?((0,o.openBlock)(),(0,o.createElementBlock)('div',oo,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Fl),e=>((0,o.openBlock)(),(0,o.createElementBlock)('span',{key:e,class:'exclude-chip'},(0,o.toDisplayString)(e),1))),128))])):(0,o.createCommentVNode)('v-if',!0),(0,o.createElementVNode)('div',io,[(0,o.createElementVNode)('label',lo,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[88]||(n[88]=e=>(0,o.isRef)(Ci)?Ci.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(Ci)]]),n[194]||(n[194]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('label',so,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[89]||(n[89]=e=>(0,o.isRef)(yi)?yi.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(yi)]]),n[195]||(n[195]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('label',co,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[90]||(n[90]=e=>(0,o.isRef)(hi)?hi.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(hi)]]),n[196]||(n[196]=(0,o.createElementVNode)('span',null,'',-1))]),(0,o.createElementVNode)('label',uo,[(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':n[91]||(n[91]=e=>(0,o.isRef)(wi)?wi.value=e:null),type:'checkbox'},null,512),[[o.vModelCheckbox,(0,o.unref)(wi)]]),n[197]||(n[197]=(0,o.createElementVNode)('span',null,'',-1))])])]),(0,o.createElementVNode)('details',po,[n[198]||(n[198]=(0,o.createElementVNode)('summary',null,'',-1)),(0,o.createElementVNode)('div',bo,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(li).length,onClick:hd},'  ',8,fo),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(li).length,onClick:wd},'  order  ',8,mo)]),(0,o.createElementVNode)('div',go,[(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(li).length,onClick:n[92]||(n[92]=e=>xd(!0))},'  ',8,vo),(0,o.createElementVNode)('button',{class:'btn',type:'button',disabled:!(0,o.unref)(li).length,onClick:n[93]||(n[93]=e=>xd(!1))},'  ',8,Ao)])])])],36)):(0,o.createCommentVNode)('v-if',!0),(0,o.unref)(zi).activation.visible?((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:5,class:'wb-floating-window activation-window',style:(0,o.normalizeStyle)(Ec('activation')),onPointerdown:n[99]||(n[99]=e=>wc('activation'))},[(0,o.createElementVNode)('div',{class:'wb-floating-header',onPointerdown:n[98]||(n[98]=e=>Bc('activation',e))},[n[199]||(n[199]=(0,o.createElementVNode)('strong',null,' WORLD_INFO_ACTIVATED',-1)),(0,o.createElementVNode)('div',Co,[(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',disabled:!(0,o.unref)(Xi).length,onPointerdown:n[95]||(n[95]=(0,o.withModifiers)(()=>{},['stop'])),onClick:Ac},'  ',40,yo),(0,o.createElementVNode)('button',{class:'btn mini danger',type:'button',onPointerdown:n[96]||(n[96]=(0,o.withModifiers)(()=>{},['stop'])),onClick:n[97]||(n[97]=e=>xc('activation'))},'  ',32)])],32),(0,o.createElementVNode)('div',ho,[(0,o.createElementVNode)('div',wo,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)((0,o.unref)(Xi),e=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:e.id,class:'activation-item'},[(0,o.createElementVNode)('div',xo,[(0,o.createElementVNode)('strong',null,(0,o.toDisplayString)(e.world),1),(0,o.createElementVNode)('span',null,'#'+(0,o.toDisplayString)(e.uid)+'  '+(0,o.toDisplayString)(e.name),1)]),(0,o.createElementVNode)('div',ko,[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(_s(e.time)),1),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(e.contentPreview),1)])]))),128)),(0,o.unref)(Xi).length?(0,o.createCommentVNode)('v-if',!0):((0,o.openBlock)(),(0,o.createElementBlock)('div',Eo,''))])])],36)):(0,o.createCommentVNode)('v-if',!0)],4))}});r(101);const Po=(0,r(441).A)(To,[['__scopeId','data-v-ff2a69a2']]),Io='wb-assistant-menu-item',zo='wb-assistant-panel',Mo='wb-assistant-panel-style',Wo='wb-assistant-panel-body',Do='.wbAssistantMenu',Lo='__WB_ASSISTANT_HAS_UNSAVED_CHANGES__';let $o=null,Oo=null,Ho=null,Yo=null,Go=null,Uo=!1;function jo(){return window.parent||window}function Ko(){return jo().document}function qo(){if(Oo?.length)return;const e=Ko().getElementById(Wo);e&&(Oo=$('<div>').attr('script_id',getScriptId()).appendTo(e),Ho=function(e='head'){const n=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>n.remove()}}().destroy,$o=(0,o.createApp)(Po),$o.mount(Oo[0]))}function Qo(){const e=Ko();let n=$(`#${zo}`,e);if(n.length)return n;!function(){const e=Ko();if(e.getElementById(Mo))return;const n=e.createElement('style');n.id=Mo,n.textContent=`\n#${zo} {\n  position: fixed;\n  z-index: 10020;\n  left: 50%;\n  top: 50%;\n  transform: translate(-50%, -50%);\n  width: min(1280px, calc(100vw - 120px));\n  height: calc(100vh - 16px);\n  min-width: 920px;\n  min-height: 560px;\n  max-width: calc(100vw - 16px);\n  max-height: calc(100vh - 16px);\n  display: none;\n  border: 1px solid var(--wb-host-border, #334155);\n  border-radius: 10px;\n  background: var(--wb-host-bg, #0b1220);\n  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.45);\n  overflow: hidden;\n  resize: both;\n}\n\n#${zo}.active {\n  display: flex;\n  flex-direction: column;\n}\n\n#${zo} .wb-assistant-header {\n  height: 44px;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 0 10px 0 12px;\n  background: var(--wb-host-header-bg, #111827);\n  border-bottom: 1px solid var(--wb-host-border, #334155);\n  cursor: move;\n  user-select: none;\n}\n\n#${zo} .wb-assistant-header-title {\n  color: var(--wb-host-text, #e2e8f0);\n  font-size: 14px;\n  font-weight: 600;\n}\n\n#${zo} .wb-assistant-header-actions {\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n}\n\n#${zo} .wb-assistant-tool {\n  width: 30px;\n  height: 30px;\n  border: 1px solid var(--wb-host-tool-border, #475569);\n  border-radius: 6px;\n  background: var(--wb-host-tool-bg, #1f2937);\n  color: var(--wb-host-text, #e2e8f0);\n  cursor: pointer;\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 14px;\n}\n\n#${zo} .wb-assistant-tool:hover {\n  border-color: #60a5fa;\n}\n\n#${zo} .wb-assistant-theme:hover {\n  border-color: #a78bfa;\n}\n\n#${zo} .wb-assistant-save:hover {\n  border-color: #34d399;\n}\n\n#${zo} .wb-assistant-close {\n  width: 30px;\n  height: 30px;\n  border: 1px solid var(--wb-host-tool-border, #475569);\n  border-radius: 6px;\n  background: var(--wb-host-tool-bg, #1f2937);\n  color: var(--wb-host-text, #e2e8f0);\n  cursor: pointer;\n}\n\n#${zo} .wb-assistant-close:hover {\n  border-color: #f43f5e;\n}\n\n#${Wo} {\n  flex: 1;\n  min-height: 0;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n#${Wo} > div {\n  flex: 1;\n  min-height: 0;\n  display: flex;\n  flex-direction: column;\n}\n\n#${Io}.active {\n  background-color: rgba(56, 189, 248, 0.18) !important;\n}\n\n#${zo} .wb-theme-dropdown {\n  position: absolute;\n  top: 100%;\n  right: 0;\n  z-index: 10300;\n  margin-top: 4px;\n  border: 1px solid var(--wb-host-border, #334155);\n  border-radius: 8px;\n  background: var(--wb-host-header-bg, #111827);\n  box-shadow: 0 8px 24px rgba(0,0,0,0.45);\n  padding: 4px;\n  min-width: 140px;\n}\n\n#${zo} .wb-theme-dropdown button {\n  display: block;\n  width: 100%;\n  border: none;\n  border-radius: 6px;\n  background: transparent;\n  color: var(--wb-host-text, #e2e8f0);\n  padding: 6px 12px;\n  text-align: left;\n  cursor: pointer;\n  font-size: 13px;\n  white-space: nowrap;\n}\n\n#${zo} .wb-theme-dropdown button:hover {\n  background: rgba(124, 58, 237, 0.15);\n}\n\n#${zo} .wb-theme-dropdown button.active {\n  background: rgba(124, 58, 237, 0.25);\n  color: #c4b5fd;\n}\n\n@media (max-width: 768px) {\n  #${zo} {\n    left: 0;\n    top: 0;\n    transform: none;\n    width: 100vw !important;\n    height: 100vh !important;\n    min-width: unset;\n    min-height: unset;\n    max-width: none;\n    max-height: none;\n    border-radius: 0;\n    border: none;\n    box-shadow: none;\n    resize: none;\n  }\n\n  #${zo} .wb-assistant-header {\n    cursor: default;\n  }\n\n  #${Wo} {\n    flex: 1;\n    min-height: 0;\n    overflow: hidden;\n  }\n\n  #${Wo} > div {\n    flex: 1;\n    min-height: 0;\n    display: flex;\n    flex-direction: column;\n  }\n}\n`,e.head.append(n)}();const t=`\n<div id="${zo}">\n  <div class="wb-assistant-header">\n    <div class="wb-assistant-header-title"></div>\n    <div class="wb-assistant-header-actions">\n      <button type="button" class="wb-assistant-tool wb-assistant-refresh" title=""></button>\n      <button type="button" class="wb-assistant-tool wb-assistant-theme" title=""></button>\n      <button type="button" class="wb-assistant-tool wb-assistant-save" title=""></button>\n      <button type="button" class="wb-assistant-close" title=""></button>\n    </div>\n  </div>\n  <div id="${Wo}"></div>\n</div>\n`;return $('body',e).append(t),n=$(`#${zo}`,e),function(e){const n=jo(),t=e.querySelector('.wb-assistant-header');if(!t)return;let a=!1,r=0,o=0;const i=t=>{if(!a)return;const i=e.getBoundingClientRect(),l=Math.max(8,n.innerWidth-i.width-8),s=Math.max(8,n.innerHeight-i.height-8),d=Math.min(l,Math.max(8,t.clientX-r)),c=Math.min(s,Math.max(8,t.clientY-o));e.style.left=`${d}px`,e.style.top=`${c}px`,e.style.right='auto',e.style.bottom='auto',e.style.transform='none'},l=()=>{a&&(a=!1,n.document.removeEventListener('mousemove',i,!0),n.document.removeEventListener('mouseup',l,!0))};t.addEventListener('mousedown',t=>{if(0!==t.button)return;if(t.target.closest('button'))return;const s=e.getBoundingClientRect();r=t.clientX-s.left,o=t.clientY-s.top,a=!0,e.style.left=`${s.left}px`,e.style.top=`${s.top}px`,e.style.right='auto',e.style.bottom='auto',e.style.transform='none',n.document.addEventListener('mousemove',i,!0),n.document.addEventListener('mouseup',l,!0),t.preventDefault()})}(n[0]),n.off(`click${Do}`,'.wb-assistant-refresh').on(`click${Do}`,'.wb-assistant-refresh',()=>{window.dispatchEvent(new Event('wb-helper:refresh'))}),n.off(`click${Do}`,'.wb-assistant-save').on(`click${Do}`,'.wb-assistant-save',()=>{window.dispatchEvent(new Event('wb-helper:save'))}),n.off(`click${Do}`,'.wb-assistant-theme').on(`click${Do}`,'.wb-assistant-theme',e=>{e.stopPropagation(),function(e){const n=e.querySelector('.wb-theme-dropdown');if(n)return void n.remove();const t=e.querySelector('.wb-assistant-theme');t&&(t.style.position='relative');const a=document.createElement('div');a.className='wb-theme-dropdown';for(const e of Zo){const n=document.createElement('button');n.type='button',n.textContent=e.label,n.dataset.themeKey=e.key,n.addEventListener('click',()=>{window.dispatchEvent(new CustomEvent('wb-helper:set-theme',{detail:e.key})),a.remove()}),a.appendChild(n)}t?t.appendChild(a):e.querySelector('.wb-assistant-header-actions')?.appendChild(a)}(n[0])}),Ko().addEventListener('pointerdown',Jo,!0),n.off(`click${Do}`,'.wb-assistant-close').on(`click${Do}`,'.wb-assistant-close',()=>{ti()}),n}const Zo=[{key:'ocean',label:''},{key:'nebula',label:''},{key:'forest',label:''},{key:'sunset',label:''},{key:'coffee',label:''},{key:'paper',label:''},{key:'snow',label:''}];function Jo(e){const n=e.target;if(!n)return;if(n.closest('.wb-assistant-theme')||n.closest('.wb-theme-dropdown'))return;const t=Ko().querySelector('.wb-theme-dropdown');t&&t.remove()}function Xo(e){const n=jo(),t=e.getBoundingClientRect(),a=Math.max(8,n.innerWidth-t.width-8),r=Math.max(8,n.innerHeight-t.height-8),o=Math.min(a,Math.max(8,Math.round((n.innerWidth-t.width)/2))),i=Math.min(r,Math.max(8,Math.round((n.innerHeight-t.height)/2)));e.style.left=`${o}px`,e.style.top=`${i}px`,e.style.right='auto',e.style.bottom='auto',e.style.transform='none'}function ei(e){const n=Ko(),t=$(`#${Io}`,n);t.length&&t.toggleClass('active',e)}function ni(){const e=window,n=jo();return!0===e[Lo]||!0===n[Lo]}function ti(){const e=ni();if(ni()&&!confirm(''))return!1;if(e){window.dispatchEvent(new Event('wb-helper:discard'));const e=window,n=jo();e[Lo]=!1,n[Lo]=!1}const n=Ko();return $(`#${zo}`,n).removeClass('active'),Uo=!1,ei(!1),!0}function ai(){Uo?ti():function(){const e=Ko(),n=Qo();qo(),n.css('visibility','hidden'),n.addClass('active');const t=n[0];Xo(t),n.css('visibility',''),requestAnimationFrame(()=>{Xo(t)}),Uo=!0,ei(!0),window.dispatchEvent(new Event('wb-helper:refresh')),$(`#${Io}`,e).blur()}()}function ri(){const e=Ko(),n=$('#extensionsMenu',e);if(!n.length)return!1;const t=$(`#${Io}`,e);if(t.length&&!t.closest('#extensionsMenu').length&&t.remove(),!$(`#${Io}`,e).length){const e=`\n<div id="${Io}" class="list-group-item flex-container flexGap5 interactable" title="" tabIndex="0">\n  <i class="fa-solid fa-book-open"></i>\n  <span></span>\n</div>\n`;n.append(e)}return ei(Uo),!0}function oi(){replaceScriptButtons([]);const e=Ko();$(e).off(`click${Do}`,`#${Io}`).on(`click${Do}`,`#${Io}`,e=>{e.preventDefault(),ai()}),Qo(),ri()||null===Go&&(Go=window.setInterval(()=>{ri()&&(window.clearInterval(Go),Go=null)},1e3)),function(){const e=Ko();Yo||(Yo=new MutationObserver(()=>{ri()}),Yo.observe(e.body,{childList:!0,subtree:!0}))}(),toastr.success('','Worldbook Assistant')}function ii(){const e=Ko();null!==Go&&(window.clearInterval(Go),Go=null),Yo?.disconnect(),Yo=null,$(e).off(Do),$(`#${Io}`,e).remove(),$(`#${zo}`,e).remove(),e.getElementById(Mo)?.remove(),$o?.unmount(),$o=null,Oo?.remove(),Oo=null,Ho?.(),Ho=null}$(()=>{errorCatched(oi)()}),$(window).on('pagehide',()=>{ii()});
//# sourceMappingURL=index.js.map